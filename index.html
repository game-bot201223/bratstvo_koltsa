<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
 <meta name="theme-color" content="#cfb389" />
 <title>–ë—Ä–∞—Ç—Å—Ç–≤–æ –ö–æ–Ω—Ü–∞ ‚Äî Mobile TG Edition</title>
 <script src="https://telegram.org/js/telegram-web-app.js"></script>
 <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@500;700;900&display=swap" rel="stylesheet">
 <style>
 :root{
   --tg-vh: 100dvh;
   --paper:#d8c09a;
   --paper2:#cfb389;
   --paper3:#bf9f71;
   --ink:rgba(36,24,14,.96);
   --inkMuted:rgba(36,24,14,.74);
   --paperLine:rgba(36,24,14,.26);
   --bg0:var(--paper); --bg1:var(--paper2); --bg2:var(--paper3);
   --glass:rgba(255,255,255,.22);
   --glass2:rgba(255,255,255,.16);
   --line:var(--paperLine);
   --text:var(--ink);
   --muted:var(--inkMuted);
   --surface0:rgba(36,24,14,.06);
   --surface1:rgba(36,24,14,.10);
   --sheet0:rgba(223,200,166,.98);
   --sheet1:rgba(206,176,138,.98);
   --btn0:rgba(255,255,255,.22);
   --btn1:rgba(255,255,255,.12);
   --accent:#c084fc;
   --accent2:#a855f7;
  --energy:#22d3ee;
  --gold:#fbbf24;
  --silver:#e2e8f0;
  --tooth:#d946ef;
  --win:#34d399;
  --lose:#fb7185;
  --r:18px;
  --r2:14px;
   --shadow:0 18px 42px rgba(0,0,0,.55);
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
html,body{height:100%;}
 body{
   font-family:'Cinzel',serif;
   color:var(--text);
   background: var(--paper);
   overflow:hidden;
 }

/* Background grain */
body:before{content:'';position:fixed;inset:0;background:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.05'/%3E%3C/svg%3E");pointer-events:none;z-index:0;}

#app{
  position:relative;
  z-index:1;
  height:var(--tg-vh);
  display:flex;
  flex-direction:column;
  padding-top:env(safe-area-inset-top);
}

 /* Top HUD */
 .hud{
   padding:12px 14px 10px;
  background:var(--sheet0);
  border-bottom:1px solid rgba(32,22,14,.26);
   backdrop-filter: blur(16px);
 }
.hudRow{display:flex;align-items:center;justify-content:space-between;gap:10px;}
.name{
  display:flex;align-items:center;gap:10px;
  min-width:0;
  font-weight:900;
  letter-spacing:1.5px;
  cursor:pointer;
}
.name span{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:52vw;}
.nameCol{display:flex;flex-direction:column;min-width:0;gap:2px;}
.nameLine{display:flex;align-items:center;gap:8px;min-width:0;}
.utcRow{display:flex;align-items:baseline;gap:6px;opacity:.78;}
.utcTag{font-size:9px;letter-spacing:2px;opacity:.75;}
 .lvl{font-size:11px;opacity:.92;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:var(--surface0)}

.pills{display:flex;align-items:center;gap:8px;}
 .pill{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;border:1px solid var(--line);background:var(--surface0);font-size:12px;}
.energyPill{flex-direction:column;align-items:flex-start;gap:2px;line-height:1.05;}
.energyPill .eRow{display:flex;align-items:center;gap:8px;}
.energyPill .eTimer{font-size:10px;letter-spacing:2px;opacity:.70;margin-left:22px;}
.pill strong{font-weight:900;letter-spacing:1px;}

.xp{
  margin-top:0px;
  margin-bottom:6px;
  position:relative;
  height:22px;
  border-radius:999px;
  background:rgba(255,255,255,.12);
  border:1px solid rgba(32,22,14,.24);
  overflow:hidden;
}
.xpFill{
  position:absolute;
  inset:0;
  width:0%;
  background:linear-gradient(90deg, rgba(234,214,191,.90), rgba(217,194,163,.92));
  box-shadow:0 0 24px rgba(217,194,163,.22);
}
.xpText{
  position:relative;
  z-index:1;
  font-size:11px;
  letter-spacing:2px;
  text-align:center;
  line-height:22px;
  opacity:.92
}

/* Main */
.main{
  padding: 0 14px 16px;
  flex:1;
  min-height:0;
  overflow:hidden;
  display:flex;
  flex-direction:column;
  background:var(--paper);
}
.hero{
  margin:12px 14px 0;
  border-radius:var(--r);
  border:1px solid rgba(32,22,14,.26);
  background:var(--paper);
  box-shadow: var(--shadow);
  overflow:hidden;
  position:relative;
}
.heroTop{padding:14px 14px 12px;display:flex;align-items:center;justify-content:space-between;gap:10px;}
.heroTitle{font-weight:900;letter-spacing:4px;font-size:12px;opacity:.90}
.heroSub{font-size:11px;opacity:.78;margin-top:4px;letter-spacing:2px}

.timeCenter{margin:10px 14px 0;text-align:center;font-size:11px;letter-spacing:2px;opacity:.78;}
.timeTop{padding:8px 14px 0;text-align:center;font-size:11px;letter-spacing:2px;opacity:.78;}

.heroGrid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:4px;padding:0 8px 8px;}
 .tile{border-radius:12px;border:1px solid rgba(32,22,14,.24);background:rgba(255,255,255,.10);padding:5px 5px;min-height:40px;display:flex;flex-direction:column;justify-content:center;gap:3px;}
.tile .k{font-size:10px;opacity:.78;letter-spacing:2px}
.tile .v{font-weight:900;letter-spacing:1px;font-size:9px;}
 .tile.gold,.tile.silver,.tile.tooth{align-items:center;text-align:center;}
.tile.gold .v,.tile.silver .v,.tile.tooth .v{font-size:14px;line-height:1;}
.tile.shop{padding:8px;}
.tile.shop .k{margin-bottom:2px;}
.tile.shop{padding:6px;}
.tile.shop .k{font-size:9px;letter-spacing:2px;}
.tile.shop .shopMini{width:100%;height:28px;border-radius:10px;font-size:9px;letter-spacing:1px;padding:0 6px;}
.shopIconBtn{
  width:100%;
  height:28px;
  border-radius:10px;
  border:1px solid rgba(192,132,252,.28);
  background:
    radial-gradient(circle at 30% 30%, rgba(192,132,252,.22), transparent 60%),
    rgba(0,0,0,.20);
  box-shadow: 0 10px 28px rgba(58,36,18,.25), inset 0 1px 0 rgba(255,255,255,.06);
  cursor:pointer;
  padding:0;
  position:relative;
}
.shopIconBtn:active{transform:translateY(1px)}
.shopIconBtn:before{
  content:'';
  position:absolute;
  inset:0;
  background-repeat:no-repeat;
  background-position:center;
  background-size:18px 18px;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'%3E%3Cpath fill='white' fill-opacity='0.92' d='M6 7h15l-1.5 8.5a2 2 0 0 1-2 1.5H9a2 2 0 0 1-2-1.6L5.3 4H2V2h4a1 1 0 0 1 .97.76L7.4 5H22v2H6.6l.4 2z'/%3E%3Cpath fill='white' fill-opacity='0.92' d='M9 22a2 2 0 1 1 0-4a2 2 0 0 1 0 4zm10 0a2 2 0 1 1 0-4a2 2 0 0 1 0 4z'/%3E%3C/svg%3E");
}
.statGrid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:6px;margin-top:10px;}
 .statTile{border-radius:14px;border:1px solid var(--line);background:rgba(255,255,255,.10);padding:8px;min-height:64px;display:flex;flex-direction:column;gap:5px;}
.statTile .stK{font-size:10px;letter-spacing:2px;opacity:.78;}
.statTile .stV{font-weight:900;letter-spacing:1px;font-size:12px;}
.statTile .stMeta{font-size:10px;opacity:.72;line-height:1.25;}
.statTile .stBtn{margin-top:auto;}

 #arenaSectionGym .statGrid{gap:4px;margin-top:8px;}
 #arenaSectionGym .statTile{padding:7px;min-height:60px;gap:4px;}
 #arenaSectionGym .statTile .stK{font-size:9px;letter-spacing:1.6px;}
 #arenaSectionGym .statTile .stV{font-size:12px;}
 #arenaSectionGym .statTile .stMeta{font-size:9.5px;line-height:1.2;}

 .petRow{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:6px;}
 .petCard{border-radius:14px;border:1px solid var(--line);background:rgba(255,255,255,.10);padding:8px;display:flex;flex-direction:column;gap:6px;min-height:96px;}
.petCard .pTop{display:flex;align-items:center;justify-content:center;}
.petCard .petPic{position:relative;width:100%;aspect-ratio:1/1;border-radius:12px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.16);display:flex;align-items:center;justify-content:center;overflow:hidden;}
.petCard .pIco{font-size:28px;}
.petCard .petPct{position:absolute;left:0;right:0;bottom:0;padding:4px 6px;font-size:10px;letter-spacing:1px;text-align:center;background:linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(0,0,0,.65) 100%);}
.petCard .pBtn{margin-top:auto;}

.costRow{display:grid;grid-template-columns:1fr auto;align-items:center;gap:10px;}
.ctaMini{padding:9px 12px;border-radius:999px;font-size:11px;letter-spacing:1px;white-space:nowrap;justify-self:center;}

 .feed{
   margin:12px 14px;
   border-radius:var(--r);
   border:1px solid var(--line);
  background:rgba(255,255,255,.10);
   overflow:hidden;
 }
.feedHead{padding:12px 14px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;gap:10px;}
.feedHead .t{font-weight:900;letter-spacing:3px;font-size:11px;opacity:.88}
.feedBody{max-height:22vh;overflow:auto;padding:10px 14px;display:flex;flex-direction:column;gap:8px;}
 .feedItem{font-size:11px;opacity:.90;line-height:1.35;padding:8px 10px;border-radius:14px;border:1px solid var(--line);background:var(--glass2)}
 .feedItem{background:rgba(255,255,255,.10)}

 /* Friends */
 .friendsPanel{margin:10px 14px 12px; flex:0 0 auto;}
 .friendsBody{padding:12px 14px;}
 .friendsRow{display:flex;gap:10px;overflow:auto;scroll-snap-type:x mandatory;touch-action:pan-x;-webkit-overflow-scrolling:touch;}
 .friendsRow::-webkit-scrollbar{height:6px;}
 .friendsRow::-webkit-scrollbar-thumb{background:var(--line);border-radius:999px;}
 .friendCard{scroll-snap-align:start;min-width:90px;max-width:90px;border-radius:18px;border:1px solid var(--line);background:var(--glass2);padding:12px;display:flex;flex-direction:column;gap:8px;}
 .friendCard{background:rgba(255,255,255,.10)}
 .friendTop{display:flex;align-items:center;justify-content:space-between;gap:10px;}
 .dot{width:10px;height:10px;border-radius:999px;background:rgba(255,255,255,.25);box-shadow:0 0 0 2px rgba(0,0,0,.15) inset;}
 .dot.on{background:rgba(52,211,153,.90);box-shadow:0 0 18px rgba(52,211,153,.35);}
 .friendName{font-weight:900;letter-spacing:1px;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
 .friendMeta{font-size:11px;opacity:.75;line-height:1.25}

 /* Bottom dock */
 .bottomStack{margin-top:auto;display:flex;flex-direction:column;}
 .dock{padding:10px 12px calc(10px + env(safe-area-inset-bottom));background:var(--sheet0);backdrop-filter: blur(16px);}
 .dockRow{display:grid;grid-template-columns:repeat(6,minmax(0,1fr));gap:8px;}
 .dockRow .dockBtn{padding:0;border-radius:50%;aspect-ratio:1/1;overflow:hidden;min-width:0;}
 .dockRow .dockBtn img{display:block;width:100%;height:100%;object-fit:cover;}
 @media (max-width: 380px){
  .dock{padding:8px 10px calc(8px + env(safe-area-inset-bottom));}
  .dockRow{gap:6px;}
 }

 .btn{
  border:none;
  border-radius:999px;
  padding:10px 10px;
  background:linear-gradient(180deg, var(--btn0), var(--btn1));
  border:1px solid rgba(36,24,14,.20);
  box-shadow: 0 10px 26px rgba(36,24,14,.14), inset 0 1px 0 rgba(255,255,255,.16);
  color:var(--ink);
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  font-weight:900;
  letter-spacing:1px;
  font-size:12px;
 }
 .btn:active{transform:translateY(1px)}
 .btnSmall{font-size:11px;padding:9px 10px;opacity:.95}

 .diceTitle{display:flex; align-items:center; justify-content:center; gap:10px; letter-spacing:4px; font-weight:900; font-size:14px; opacity:.92; margin-top:2px;}
 .diceTitle .ico{font-size:18px;}
 .dicePrice{margin-top:10px; text-align:center; font-size:12px; opacity:.85;}
 .diceGrid{margin-top:14px; display:grid; grid-template-columns:repeat(5,1fr); gap:14px;}
 .dieBox{aspect-ratio:1/1; border-radius:14px; border:2px solid rgba(255,255,255,.85);
   background:rgba(255,255,255,.26);
   border-color:rgba(45,30,18,.22);
   display:flex; align-items:center; justify-content:center;
   font-weight:900; font-size:30px; letter-spacing:2px;
   box-shadow: 0 18px 45px rgba(45,30,18,.18), inset 0 1px 0 rgba(255,255,255,.22);
   cursor:pointer;
 }
 .dieBox:active{ transform: translateY(1px); }
 .dicePrimary{ margin-top:24px; padding:14px 16px; font-size:12px; letter-spacing:4px; width:min(320px, 76%); margin-left:auto; margin-right:auto; display:block; }

 .bossRow{display:grid;grid-template-columns:140px 1fr;gap:12px;align-items:flex-start;}
 .bossMini{width:140px;height:140px;border-radius:26px;border:2px solid rgba(45,30,18,.18);background:linear-gradient(145deg, rgba(255,255,255,.26), rgba(255,255,255,.14));background-size:cover;background-position:center;background-repeat:no-repeat;display:flex;align-items:center;justify-content:center;font-size:56px;}
  .bossName{font-weight:900;letter-spacing:2px;line-height:1.15;}
  .bossSub{font-size:11px;opacity:.75;margin-top:4px;}
  .bossReward{margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
 .bossWinnerTop{font-size:11px;letter-spacing:1px;opacity:.75;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
 .bossWinnerNm{font-size:12px;letter-spacing:1px;opacity:.9;white-space:nowrap;max-width:260px;overflow:hidden;text-overflow:ellipsis;}

 .districtStack{margin-top:8px;display:flex;flex-direction:column;gap:10px;}
 .districtNick{font-size:11px;font-weight:900;opacity:.95;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
 .districtStatBox{border:1px solid rgba(255,255,255,.10);border-radius:14px;padding:10px;background:rgba(0,0,0,.10);}
 .districtStatRow{display:flex;align-items:center;justify-content:space-between;gap:10px;min-width:0;}
 .districtFear{font-size:12px;font-weight:900;opacity:.92;white-space:nowrap;}
 .districtTag{font-size:10px;letter-spacing:2px;font-weight:900;opacity:.75;text-align:right;white-space:nowrap;}

 .districtLeftCol{width:140px;flex:0 0 auto;display:flex;flex-direction:column;gap:8px;align-items:flex-start;}
 .districtActions{display:flex;flex-direction:column;gap:6px;flex-wrap:nowrap;justify-content:flex-start;width:100%;}
 .districtBtn{font-size:10px;padding:7px 9px;letter-spacing:1px;width:100%;}

 #mDistricts .sheetBody{overflow-x:hidden;}
 #districtList{max-width:100%;}
 #districtList .card{max-width:100%; box-sizing:border-box; overflow:hidden;}
 .districtCardGrid{display:grid; grid-template-columns:140px 1fr; gap:10px; align-items:start;}
 .districtCardRight{min-width:0;}
 .districtCardTop{display:flex; align-items:flex-start; justify-content:space-between; gap:10px;}
 .districtCardBadge{flex:0 0 auto;}

 .bossFightHero{display:flex;align-items:center;justify-content:space-between;gap:12px;}
 .bossFightBig{width:180px;height:180px;border-radius:34px;border:2px solid rgba(45,30,18,.18);background:linear-gradient(145deg, rgba(255,255,255,.26), rgba(255,255,255,.14));background-size:cover;background-position:center;background-repeat:no-repeat;display:flex;align-items:center;justify-content:center;font-size:78px;flex:0 0 auto;}
 .bossFightMeta{min-width:0;flex:1;}

 .toothBtn{position:relative; width:44px; height:40px; border-radius:14px; border:1px solid rgba(217,70,239,.55); background:linear-gradient(180deg, rgba(217,70,239,.24) 0%, rgba(42,30,20,.70) 100%); color:rgba(217,70,239,.95); cursor:pointer; display:flex; flex-direction:column; align-items:center; justify-content:center; line-height:1; box-shadow: 0 10px 26px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.06);}
 .toothBtn .ico{font-size:18px;}
 .toothBtn .tm{font-size:9px; opacity:.82; margin-top:2px; letter-spacing:1px; color:rgba(255,255,255,.92)}
 .toothBtn.ready{border-color: rgba(217,70,239,.95); box-shadow: 0 0 0 2px rgba(217,70,239,.18) inset, 0 0 22px rgba(217,70,239,.35), 0 10px 26px rgba(0,0,0,.45);}
 .toothBtn.ready .tm{opacity:1;}

 #bossToothBtn{border-color: rgba(255,255,255,.55); color: rgba(255,255,255,.92);}
 #bossToothBtn.ready{border-color: rgba(255,255,255,.95); box-shadow: 0 0 0 2px rgba(255,255,255,.18) inset, 0 0 22px rgba(255,255,255,.35), 0 10px 26px rgba(0,0,0,.45);}

 .bossAtkBtn{font-size:9px !important; padding:5px 7px !important; letter-spacing:1px; min-height:28px;}

/* Modals */
.overlay{position:fixed;inset:0;background:rgba(45,30,18,.22);backdrop-filter: blur(10px);display:none;z-index:4900;}
.overlay.show{display:block;}

.modal{
  position:fixed;
  inset:0;
  z-index:5000;
  display:none;
  padding: calc(14px + env(safe-area-inset-top)) 14px calc(14px + env(safe-area-inset-bottom));
}
.modalBossFight{ z-index: 5300; }
.modalBfShop{ z-index: 5400; }
.modalBossFightRes{ z-index: 5500; }
.modal.show{display:block;}
.modal.modalMini{ z-index: 5200; display:none; align-items:center; justify-content:center; }
.modal.modalMini.show{ display:flex; }
.modal.modalMini.modalBfShop{ z-index: 5400; }
.modal.modalMini.modalBossFightRes{ z-index: 5500; }
.sheet{
  height:100%;
  border-radius:22px;
  border:1px solid var(--paperLine);
  background:linear-gradient(180deg, var(--sheet0) 0%, var(--sheet1) 100%);
  box-shadow: 0 30px 80px rgba(32,22,14,.34);
  overflow:hidden;
  display:flex;
  flex-direction:column;
}

.sheetScreen{
  border-radius:0;
  border:none;
  box-shadow:none;
}

 #mBoss .sheet{border-radius:0;border:none;box-shadow:none;}

.sheetScreen .sheetBody{
  padding:0;
}

 #mBattle .hpMini{display:flex;align-items:center;gap:10px;min-width:0;}
 #mBattle .hpBar{position:relative;width:120px;max-width:32vw;height:6px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.22);overflow:hidden;box-shadow: inset 0 1px 0 rgba(255,255,255,.06);}
 #mBattle .hpFill{height:100%;width:0%;background:linear-gradient(90deg, rgba(52,211,153,.95), rgba(34,211,238,.85));}
 #mBattle .hpIn{position:absolute;inset:-8px 0 auto 0;height:22px;display:flex;align-items:center;justify-content:center;font-size:10px;letter-spacing:1px;white-space:nowrap;color:rgba(255,255,255,.98);font-weight:900;text-shadow:0 2px 4px rgba(0,0,0,.95);pointer-events:none;}
 #mBattle .hpTxt{font-size:11px;letter-spacing:1px;white-space:nowrap;}
  #mBattle #bLog .feedItem{padding:5px 7px;border-radius:12px;font-size:10px;line-height:1.2;}
  #mBattle #bMyTeam .badge,
  #mBattle #bEnemyTeam .badge{width:100%;}
  #mBattle #bMyTeam .hpBar,
  #mBattle #bEnemyTeam .hpBar{width:100% !important; max-width:none !important; border-color:rgba(45,30,18,.20) !important; background:rgba(255,255,255,.22) !important; box-shadow:none !important;}
  #mBattle #bMyTeam .hpIn,
  #mBattle #bEnemyTeam .hpIn{color:rgba(45,30,18,.92) !important; text-shadow:none !important;}
 #mBattle .battleTeamsGrid{max-width:100%; gap:2px !important;}
 #mBattle .battleCol{background:rgba(45,30,18,.09) !important; border:1px solid rgba(45,30,18,.16) !important; border-radius:16px !important; padding:6px !important;}
 #mBattle .battleAtkCol{background:rgba(45,30,18,.12) !important;}
 #mBattle .battleCol:not(:first-child){border-left:none !important;}
 #mBattle .battleCol:not(:last-child){border-right:none !important;}
 #mBattle .battleCol:first-child{border-top-right-radius:0 !important; border-bottom-right-radius:0 !important;}
 #mBattle .battleCol:last-child{border-top-left-radius:0 !important; border-bottom-left-radius:0 !important;}
  #mBattle .battleAtkCol{display:flex; flex-direction:column; align-items:center;}
  #mBattle #bAtkList{width:100%;}
  #mBattle #bAtkList .btn{justify-content:center;}
  #mBattle #bAtkList .btnSmall{width:100%;}
  #mBattle .gfAtkBtn{width:44px !important; height:44px !important; min-height:44px !important; padding:0 !important; border-radius:999px !important; display:flex !important; align-items:center !important; justify-content:center !important; margin:0 auto !important; font-size:18px !important; letter-spacing:0 !important; line-height:1 !important;}
  #mBattle #bMyTeam .badge,
  #mBattle #bEnemyTeam .badge{min-height:48px;}
  #mBattle .gfAtkSlot{min-height:48px; display:flex; align-items:center; justify-content:center; width:100%;}
 #mBattle #bMyTeam .badge,
 #mBattle #bEnemyTeam .badge{display:flex; flex-direction:column; align-items:stretch; gap:2px; justify-content:flex-start;}
 #mBattle #bMyTeam .badge > div:first-child,
 #mBattle #bEnemyTeam .badge > div:first-child{white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
 #mBattle .battleEnemyCol{min-width:0;}
 #mBattle .battleEnemyCol{min-width:0;}
 #mBattle .gfEnemyRow{display:flex; flex-direction:column; gap:8px; width:100%; padding:8px; border-radius:16px; border:1px solid rgba(45,30,18,.14); background:rgba(255,255,255,.16); box-sizing:border-box;}
 #mBattle .gfEnemyRowTop{display:flex; align-items:center; justify-content:space-between; gap:8px;}
 #mBattle .gfEnemyBtn{width:100%; min-height:36px;}

 @media (max-width: 380px){
   #mBattle .battleTeamsGrid{grid-template-columns:1fr !important;}
   #mBattle .battleEnemyCol > div:first-child{ text-align:left !important; }
 }

 #mConsumables.consFull{padding:0;}
 #mConsumables.consFull.modalMini{align-items:stretch;justify-content:stretch;}
 #mConsumables.consFull .sheet{width:100vw;max-width:none;height:100vh;max-height:none;border-radius:0;border:none;box-shadow:none;}
 #mConsumables.consFull .sheetBody{padding:12px;overflow:auto;}

 .modalPage{
  padding:0;
 }

.sheetMini{
  border:1px solid var(--paperLine);
  background:var(--sheet0);
  box-shadow: 0 28px 70px rgba(32,22,14,.36);
  height:auto;
  max-height: calc(100vh - 28px - env(safe-area-inset-top) - env(safe-area-inset-bottom));
}

.sheetOpaque{
  background:var(--sheet0);
  box-shadow: 0 34px 90px rgba(32,22,14,.38);
}

/* Arena compact */
#mArena .sheetHead{padding:10px 10px;}
#mArena .sheetBody{padding:0;}
#mArena .card{padding:10px; margin-top:6px !important; border-radius:16px;}
#mArena .btn{padding:10px 10px;}
#mArena .btnSmall{padding:7px 9px;}
#mArena .badge{padding:6px 8px;}
#mArena #arenaSectionGroup .row{align-items:center;}
#mArena #arenaGroupHint{margin-top:6px !important;}
#mArena .grid3{gap:8px;}
.sheetHead{padding:12px 12px;border-bottom:1px solid rgba(32,22,14,.22);display:flex;align-items:center;justify-content:space-between;gap:10px;}
.sheetHead .title{font-weight:900;letter-spacing:4px;font-size:12px;opacity:.9}
.iconBtn{width:44px;height:40px;border-radius:14px;border:1px solid rgba(36,24,14,.20);background:rgba(255,255,255,.14);color:rgba(36,24,14,.92);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:20px;}
.sheetBody{flex:1;min-height:0;overflow:auto;padding:12px;}

.card{border-radius:18px;border:1px solid rgba(32,22,14,.24);background:var(--surface0);padding:12px;}
.row{display:flex;align-items:center;justify-content:space-between;gap:12px;}
.k{font-size:11px;opacity:.78;letter-spacing:2px}
.v{font-weight:900;}

.grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;}
.slot{border-radius:16px;border:1px solid rgba(32,22,14,.24);background:rgba(255,255,255,.12);padding:10px;min-height:78px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;cursor:pointer;}
.slot .ico{font-size:28px;}
.slot .nm{font-size:10px;letter-spacing:1.5px;opacity:.88;text-align:center;line-height:1.2}

.toggle{display:flex;align-items:center;gap:10px;}
.toggle input{width:20px;height:20px;}

.badge{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:8px 10px;border-radius:999px;border:1px solid rgba(32,22,14,.24);background:var(--surface0);font-size:12px;}

.toastWrap{position:fixed;left:0;right:0;bottom:calc(84px + env(safe-area-inset-bottom));z-index:9000;display:flex;justify-content:center;pointer-events:none;padding:0 14px;}
.toast{max-width:min(92vw,520px);border-radius:16px;border:1px solid rgba(32,22,14,.26);background:rgba(184,152,112,.96);backdrop-filter: blur(16px);box-shadow:0 20px 60px rgba(32,22,14,.34);padding:12px 14px;font-size:12px;letter-spacing:1px;opacity:0;transform:translateY(8px);transition:opacity .18s ease, transform .18s ease;}
.toast.show{opacity:1;transform:translateY(0)}
.toast.win{border-color:rgba(52,211,153,.35)}
.toast.lose{border-color:rgba(251,113,133,.35)}
 .toast.tooth{border-color:rgba(217,70,239,.35)}
.toast.gold{border-color:rgba(251,191,36,.35)}

@media (max-width:420px){
  .dockRow{gap:6px}
  .btn{font-size:11px}
  .heroGrid{gap:4px;padding:0 8px 8px}
  .tile{min-height:38px;padding:5px}
  .tile.shop .shopMini{height:28px;font-size:9px}
}

@media (prefers-reduced-motion: reduce){
  *{scroll-behavior:auto !important;transition:none !important;animation:none !important;}
}
</style>
</head>
<body>
<div id="app">
  <div class="hud">
    <div class="hudRow">
      <div class="name" id="nameBtn">
        <div style="opacity:.9">üëë</div>
        <div class="nameCol">
          <div class="nameLine"><span id="playerName">PLAYER</span><div class="lvl" id="playerLevel">1</div></div>
          <div class="utcRow"><span class="utcMini" id="utc">00:00</span><span class="utcTag">UTC</span></div>
        </div>
      </div>
      <div class="pills">
        <div class="pill energyPill" style="border-color:rgba(34,211,238,.20)">
          <div class="eRow">‚ö° <strong id="energy">100</strong>/<span id="energyMax">100</span></div>
          <div class="eTimer" id="energyTimer">02:00</div>
        </div>
        <button class="iconBtn" id="settingsBtn" aria-label="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">‚öôÔ∏è</button>
        <div class="badge" id="syncState" style="opacity:.8; display:none;">–°–ï–ô–í: OK</div>
      </div>
    </div>
    <div class="xp">
      <div class="xpFill" id="xpFill"></div>
      <div class="xpText" id="xpText">0 / 0 XP</div>
    </div>

    <div class="heroGrid">
      <div class="tile gold" id="tileGold"><div class="v">ü™ô <span id="gold">0</span></div></div>
      <div class="tile silver" id="tileSilver"><div class="v">ü•à <span id="silver">0</span></div></div>
      <div class="tile tooth" id="tileTooth"><div class="v">ü¶∑ <span id="tooth">0</span></div></div>
      <div class="tile shop" id="tileShop"><button class="shopIconBtn" id="shopBtn" aria-label="–ú–∞–≥–∞–∑–∏–Ω"></button></div>
    </div>
  </div>

  <div class="main">
    <div class="bottomStack">
      <div class="dock">
        <div class="dockRow">
          <button class="btn dockBtn" id="btnDistricts" aria-label="–†–∞–π–æ–Ω—ã"><img src="—Ä–∞–π–æ–Ω—ã.jpg" alt=""></button>
          <button class="btn dockBtn" id="btnArena" aria-label="–ê—Ä–µ–Ω–∞"><img src="–∞—Ä–µ–Ω–∞.jpg" alt=""></button>
          <button class="btn dockBtn" id="btnBoss" aria-label="–ë–æ—Å—Å—ã"><img src="–±–æ—Å—Å—ã.jpg" alt=""></button>
          <button class="btn dockBtn" id="btnDice" aria-label="–ö–æ—Å—Ç–∏"><img src="–∫–æ—Å—Ç–∏.jpg" alt=""></button>
          <button class="btn dockBtn" id="btnTop" aria-label="–¢–æ–ø"><img src="—Ç–æ–ø.jpg" alt=""></button>
          <button class="btn dockBtn" id="btnClans" aria-label="–ö–ª–∞–Ω—ã"><img src="–∫–ª–∞–Ω—ã.jpg" alt=""></button>
        </div>
      </div>

      <div class="feed friendsPanel">
        <div class="feedHead">
          <div class="t">–¢–û–ü –ë–†–ê–¢–ö–û–í</div>
          <button class="btn btnSmall" id="openTopBros">–¢–û–ü</button>
        </div>
        <div class="friendsBody">
          <div class="friendsRow" id="friendsRow"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal modalMini" id="mGFJoin" role="dialog" aria-modal="true">
  <div class="sheet sheetMini">
    <div class="sheetHead">
      <button class="iconBtn" data-close="mGFJoin">‚Äπ</button>
      <div class="title">–ì–†–£–ü–ü–û–í–û–ô –ë–û–ô</div>
      <div style="width:44px"></div>
    </div>
    <div class="sheetBody">
      <div class="card">
        <div class="row"><div><div class="k">–°–¢–ê–†–¢ (UTC)</div><div style="font-size:12px;opacity:.75">–°–±–æ—Ä 1 –º–∏–Ω—É—Ç–∞</div></div><div class="badge" id="gfJoinStart">--:--</div></div>
        <div class="row" style="margin-top:10px;"><div><div class="k">–¶–ï–ù–ê –í–•–û–î–ê</div><div style="font-size:12px;opacity:.75">–ó–∞–≤–∏—Å–∏—Ç –æ—Ç —á–∞—Å–∞</div></div><div class="badge" style="color:var(--gold)" id="gfJoinCost">0 ü™ô</div></div>
        <div class="row" style="margin-top:10px;"><div class="k">–î–û –°–¢–ê–†–¢–ê</div><div class="badge" id="gfJoinLeft">--:--</div></div>
        <div style="margin-top:12px; display:flex; gap:10px; align-items:center;">
          <button class="btn" style="flex:1" id="gfJoinBtn">–ü–û–î–ê–¢–¨ –ó–ê–Ø–í–ö–£</button>
          <div class="badge" id="gfJoinBtnTimer">--:--</div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal" id="mGF1010" role="dialog" aria-modal="true">
  <div class="sheet">
    <div class="sheetHead">
      <button class="iconBtn" data-close="mGF1010">‚Äπ</button>
      <div class="title">–ì–†–£–ü–ü–û–í–û–ô –ë–û–ô 10√ó10</div>
      <div style="width:44px"></div>
    </div>
    <div class="sheetBody">
      <div class="card">
        <div class="row"><div><div class="k">–°–¢–ê–†–¢ (UTC)</div><div style="font-size:12px;opacity:.75">–°–±–æ—Ä 1 –º–∏–Ω—É—Ç–∞</div></div><div class="badge" id="gf10Start">--:--</div></div>
        <div class="row" style="margin-top:10px;"><div><div class="k">–¶–ï–ù–ê –í–•–û–î–ê</div><div style="font-size:12px;opacity:.75">–ß–µ—Ä–µ–¥–æ–≤–∞–Ω–∏–µ –ø–æ —á–∞—Å—É</div></div><div class="badge" style="color:var(--gold)" id="gf10Cost">0 ü™ô</div></div>
        <div class="row" style="margin-top:10px;"><div class="k">–°–û–ë–†–ê–ù–û</div><div class="badge" id="gf10Count">0</div></div>
        <div style="margin-top:10px; font-size:12px; opacity:.85; line-height:1.35" id="gf10Status">‚Äî</div>
        <div style="margin-top:10px; display:flex; gap:10px;">
          <button class="btn" id="gf10Join">–ü–û–î–ê–¢–¨ –ó–ê–Ø–í–ö–£</button>
          <button class="btn" id="gf10Leave" style="display:none; opacity:.85;">–û–¢–ú–ï–ù–ê</button>
        </div>
      </div>

      <div class="card" style="margin-top:12px; display:none;" id="gf10FightCard">
        <div class="row"><div class="k">–†–ê–£–ù–î</div><div class="badge" id="gf10Round">1</div></div>
        <div class="row" style="margin-top:10px;"><div class="k">–¢–ê–ô–ú–ï–†</div><div class="badge" id="gf10Timer">10</div></div>
        <div class="row" style="margin-top:10px;"><div class="k">–¶–ï–õ–¨</div><div class="badge" id="gf10Target">–ê–≤—Ç–æ</div></div>
      </div>

      <div class="card" style="margin-top:12px; display:none;" id="gf10TargetsCard">
        <div class="row"><div class="k">–í–†–ê–ì–ò</div><div style="font-size:12px;opacity:.75">–í—ã–±–µ—Ä–∏ —Ü–µ–ª—å –∑–∞ 10 —Å–µ–∫</div></div>
        <div class="gfList" id="gf10Targets"></div>
      </div>

      <div class="card" style="margin-top:12px; display:none;" id="gf10LogCard">
        <div class="row"><div class="k">–õ–û–ì</div></div>
        <div style="margin-top:10px; display:flex; flex-direction:column; gap:8px;" id="gf10Log"></div>
      </div>
    </div>
  </div>
</div>

<div class="overlay" id="overlay"></div>

<!-- Settings -->
<div class="modal" id="mSettings" role="dialog" aria-modal="true">
  <div class="sheet">
    <div class="sheetHead">
      <button class="iconBtn" data-close="mSettings">‚Äπ</button>
      <div class="title">–ù–ê–°–¢–†–û–ô–ö–ò</div>
      <div style="width:44px"></div>
    </div>
    <div class="sheetBody">
      <div class="card" style="display:flex; flex-direction:column; gap:12px;">
        <div class="row"><div><div class="k">–ó–í–£–ö</div><div style="font-size:12px; opacity:.75">–≠—Ñ—Ñ–µ–∫—Ç—ã</div></div><div class="toggle"><input id="setSound" type="checkbox"></div></div>
        <div class="row"><div><div class="k">–•–ê–ü–¢–ò–ö–ê</div><div style="font-size:12px; opacity:.75">–í–∏–±—Ä–æ</div></div><div class="toggle"><input id="setHaptics" type="checkbox"></div></div>
        <div class="row"><div><div class="k">–ú–ï–ù–¨–®–ï –ê–ù–ò–ú–ê–¶–ò–ô</div><div style="font-size:12px; opacity:.75">–î–ª—è —Å–ª–∞–±—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤</div></div><div class="toggle"><input id="setReduced" type="checkbox"></div></div>
      </div>
      <div class="card" style="margin-top:12px;">
        <div class="row"><div class="k">–°–ë–†–û–° –ü–†–û–ì–†–ï–°–°–ê</div><button class="btn btnSmall" id="resetBtn">–°–ë–†–û–°</button></div>
        <div style="margin-top:10px; font-size:12px; opacity:.75; line-height:1.35">–°–±—Ä–æ—Å —É–¥–∞–ª–∏—Ç –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–µ–π–≤ –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ.</div>
      </div>
    </div>
  </div>
</div>

<!-- Arena -->
<div class="modal modalPage" id="mArena" role="dialog" aria-modal="true">
  <div class="sheet sheetOpaque sheetScreen">
    <div class="sheetHead">
      <button class="iconBtn" data-close="mArena">‚Äπ</button>
      <div class="title">–ê–†–ï–ù–ê</div>
      <button class="iconBtn" id="arenaConsOpen" aria-label="–†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏">üéí</button>
    </div>
    <div class="sheetBody">
      <div class="card" style="margin-top:10px;">
        <div class="row"><div><div class="k">–ë–û–ô–¶–û–í–°–ö–ò–ô –ö–õ–£–ë</div></div><div class="badge" id="arenaCdCard" style="display:none; font-size:11px; padding:7px 9px;"><span style="opacity:.75; letter-spacing:1px;">–ö–£–õ–î–ê–£–ù</span> <span id="arenaCd">00:00</span></div></div>
        <div style="margin-top:10px; display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px;">
          <button class="btn btnSmall" id="arenaWeak">–°–ª–∞–±—ã–π</button>
          <button class="btn btnSmall" id="arenaNorm">–†–∞–≤–Ω—ã–π</button>
          <button class="btn btnSmall" id="arenaElite">–°–∏–ª—å–Ω—ã–π</button>
        </div>
      </div>

      <div class="card" style="margin-top:10px;" id="arenaSectionGroup">
        <div class="row"><div class="k">–ì–†–£–ü–ü–û–í–û–ô –ë–û–ô</div><button class="btn btnMini" id="gf1010Open">–í–•–û–î</button></div>
        <div style="margin-top:10px; font-size:12px; opacity:.8; line-height:1.35" id="arenaGroupHint"></div>
        <div style="margin-top:12px; display:flex; flex-direction:column; gap:10px;">
          <div class="row"><div><div class="k">–°–¢–ê–†–¢ (UTC)</div><div style="font-size:12px;opacity:.75">–ö–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É</div></div><div class="badge" id="gfStart">--:--</div></div>
          <div class="costRow">
            <div><div class="k">–¶–ï–ù–ê –í–•–û–î–ê</div><div style="font-size:12px;opacity:.75">–ó–∞–≤–∏—Å–∏—Ç –æ—Ç —á–∞—Å–∞</div></div>
            <div class="badge" style="color:var(--gold)" id="gfCost">0 ü™ô</div>
          </div>
          <div style="font-size:12px; opacity:.85; line-height:1.35" id="gfStatus">‚Äî</div>
          <button class="btn" id="gfEnter" style="display:none;">–í–û–ô–¢–ò –í –ë–û–ô</button>
        </div>
      </div>

      <div class="card" style="margin-top:10px;" id="arenaSectionGym">
        <div class="row"><div class="k">–°–ü–û–†–¢–ó–ê–õ</div><div style="display:flex; align-items:center; gap:8px;"><div class="k">–ü–ò–¢–û–ú–ï–¶ + –ë–ò–ó–ù–ï–°–´ =</div><div class="badge" id="gymPetBonus">0%</div></div></div>
        <div id="gymList"></div>

        <div class="card" style="margin-top:8px;" id="arenaPetShopWrap">
          <div class="row"><div class="k">–ü–ò–¢–û–ú–¶–´</div><div style="font-size:12px;opacity:.75">–ö—É–ø–∏—Ç—å –∑–∞ –∑–æ–ª–æ—Ç–æ</div></div>
          <div style="margin-top:8px" class="petRow" id="arenaPetShop"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal modalPage" id="mArenaRes" role="dialog" aria-modal="true">
  <div class="sheet sheetOpaque sheetScreen">
    <div class="sheetHead">
      <button class="iconBtn" data-close="mArenaRes">‚Äπ</button>
      <div class="title">–†–ï–ó–£–õ–¨–¢–ê–¢ –ë–û–Ø</div>
      <div style="width:44px"></div>
    </div>
    <div class="sheetBody">
      <div class="card">
        <div class="row"><div class="k">–ü–†–û–¢–ò–í–ù–ò–ö</div><div class="badge" id="arOpponent">‚Äî</div></div>
        <div class="row" style="margin-top:10px;"><div class="k">–¢–í–û–ô –£–†–û–ù</div><div class="badge" id="arYouDmg">0</div></div>
        <div class="row" style="margin-top:10px;"><div class="k">–£–†–û–ù –í–†–ê–ì–ê</div><div class="badge" id="arEnemyDmg">0</div></div>
        <div class="row" style="margin-top:10px;"><div class="k">–ò–¢–û–ì</div><div class="badge" id="arOutcome">‚Äî</div></div>
      </div>
      <div class="card" style="margin-top:12px;">
        <div class="row"><div class="k">–õ–û–ì –ü–û –†–ê–£–ù–î–ê–ú</div></div>
        <div id="arenaCombatLog" style="margin-top:10px; display:flex; flex-direction:column; gap:8px;"></div>
      </div>
    </div>
  </div>
</div>

<div class="modal modalMini" id="mBossAttack" role="dialog" aria-modal="true">
  <div class="sheet sheetMini">
    <div class="sheetHead">
      <button class="iconBtn" data-close="mBossAttack">‚Äπ</button>
      <div class="title">–ë–û–°–°</div>
      <div style="width:44px"></div>
    </div>
    <div class="sheetBody">
      <div class="card">
        <div class="row"><div class="k">–í–´–ë–†–ê–ù</div><div class="badge" id="baBossName">‚Äî</div></div>
        <div class="row" style="margin-top:10px;"><div class="k">–î–û–°–¢–£–ü</div><div class="badge" id="baAccess">‚Äî</div></div>
        <div style="margin-top:12px; display:flex; gap:10px; align-items:center;">
          <button class="btn" style="flex:1" id="baGo">–í –ë–û–ô</button>
          <button class="btn" style="width:56px; padding:0; font-size:20px; letter-spacing:0" id="baBuyRing" aria-label="–ö—É–ø–∏—Ç—å 1 –∞—Ç–∞–∫—É –∑–∞ –∫–æ–∑—ã—Ä–Ω—ã–µ –∫–æ–ª—å—Ü–∞">üíç</button>
        </div>
      </div>

      <div class="card" style="margin-top:12px;">
        <div class="row"><div class="k">–ö–õ–Æ–ß–ò –î–õ–Ø –ë–û–°–°–û–í</div></div>
        <div style="margin-top:10px; display:flex; flex-direction:column; gap:10px;" id="baTable"></div>
      </div>
    </div>
  </div>
</div>

<div class="modal modalBossFight" id="mBossFight" role="dialog" aria-modal="true">
  <div class="sheet sheetOpaque">
    <div class="sheetHead">
      <button class="iconBtn" data-close="mBossFight">‚Äπ</button>
      <div class="title">–ë–û–ô –° –ë–û–°–°–û–ú</div>
      <div style="width:44px"></div>
    </div>
    <div class="sheetBody">
      <div class="card">
        <div class="bossFightHero">
          <div class="bossFightBig" id="bfEmoji">üëπ</div>
          <div class="bossFightMeta">
            <div class="bossName" id="bfName">–ë–û–°–°</div>
            <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; align-items:center">
              <div class="badge" id="bfHp">HP ‚Äî</div>
              <div class="badge" id="bfTimer">‚Äî</div>
              <div class="badge" style="color:var(--gold)" id="bfHits">–£–î–ê–†–´ x0</div>
            </div>
            <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end" id="bfHitQty"></div>
          </div>
        </div>

        <div style="margin-top:12px; display:flex; flex-direction:column; gap:10px;">
          <button class="btn" id="bfFreeHit">–ü–ò–ù–û–ö –ü–û–î –ó–ê–î (–ë–ï–°–ü–õ–ê–¢–ù–û)</button>
          <button class="btn" id="bfHit1">–£–î–ê–† 2 (–ù–û–ì–û–ô)</button>
          <button class="btn" id="bfHit2">–£–î–ê–† 3 (–ö–û–°–¢–ï–¢–û–ú)</button>
          <button class="btn" id="bfHit3">–£–î–ê–† 4 (–ö–õ–ò–ó–ú–ê)</button>
        </div>

        <div style="margin-top:10px; font-size:12px; opacity:.8; line-height:1.3" id="bfHint">‚Äî</div>
      </div>

      <div class="card" style="margin-top:12px;">
        <div class="row"><div class="k">–£–î–ê–†–´</div><button class="btn btnSmall" id="bfShopOpen">–ú–ê–ì–ê–ó–ò–ù</button></div>
      </div>

      <div class="card" style="margin-top:12px;">
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; align-items:start;">
          <div>
            <div class="row"><div class="k">–õ–û–ì –£–†–û–ù–ê</div></div>
            <div style="margin-top:10px; display:flex; flex-direction:column; gap:8px;" id="bfLog"></div>
          </div>
          <div>
            <div class="row"><div class="k">–¢–û–ü –£–†–û–ù–ê</div></div>
            <div style="margin-top:10px; display:flex; flex-direction:column; gap:8px;" id="bfTop"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal modalMini modalBfShop" id="mBfShop" role="dialog" aria-modal="true">
  <div class="sheet sheetMini">
    <div class="sheetHead">
      <button class="iconBtn" data-close="mBfShop">‚Äπ</button>
      <div class="title">–ú–ê–ì–ê–ó–ò–ù –£–î–ê–†–û–í</div>
      <div style="width:44px"></div>
    </div>
    <div class="sheetBody">
      <div class="card">
        <div class="row"><div class="k">–¢–í–û–ò –ú–û–ù–ï–¢–´</div><div class="badge" style="color:var(--gold)" id="bfShopGold">0 ü™ô</div></div>
        <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end" id="bfShopQty"></div>
        <div style="margin-top:12px; display:flex; flex-direction:column; gap:10px;">
          <button class="btn" id="bfShopBuyKick">–ü–ò–ù–û–ö: +1 –∑–∞ 3 ü™ô</button>
          <button class="btn" id="bfShopBuyKnuckle">–ö–û–°–¢–ï–¢: +1 –∑–∞ 5 ü™ô</button>
          <button class="btn" id="bfShopBuyEnema">–ö–õ–ò–ó–ú–ê: +1 –∑–∞ 8 ü™ô</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal modalMini modalBossFightRes" id="mBossFightRes" role="dialog" aria-modal="true">
  <div class="sheet sheetMini">
    <div class="sheetHead">
      <div style="width:44px"></div>
      <div class="title" id="bfrTitle">–†–ï–ó–£–õ–¨–¢–ê–¢</div>
      <div style="width:44px"></div>
    </div>
    <div class="sheetBody">
      <div class="card">
        <div class="bossFightHero">
          <div class="bossFightBig" id="bfrEmoji">üëπ</div>
          <div class="bossFightMeta">
            <div class="k">–ë–û–°–°</div>
            <div style="margin-top:6px; font-weight:900; letter-spacing:2px; line-height:1.2" id="bfrName">‚Äî</div>
            <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; align-items:center">
              <div class="badge" id="bfrOutcome">‚Äî</div>
            </div>
          </div>
        </div>
      </div>
      <div class="card" style="margin-top:12px;" id="bfrRewardCard">
        <div class="row"><div class="k">–ù–ê–ì–†–ê–î–ê</div></div>
        <div style="margin-top:10px; display:flex; flex-direction:column; gap:8px;" id="bfrReward">‚Äî</div>
        <button class="btn" style="margin-top:12px; display:none;" id="bfrClaim">–ó–ê–ë–†–ê–¢–¨ –ù–ê–ì–†–ê–î–£</button>
      </div>
      <div class="card" style="margin-top:12px;">
        <div class="row"><div class="k">–¢–û–ü-10 –£–†–û–ù–ê</div></div>
        <div style="margin-top:10px; display:grid; grid-template-columns:1fr 1fr; gap:12px;" id="bfrTop">
          <div id="bfrTopL" style="display:flex; flex-direction:column; gap:8px;">‚Äî</div>
          <div id="bfrTopR" style="display:flex; flex-direction:column; gap:8px;">‚Äî</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Group Fight Battle -->
<div class="modal modalPage" id="mBattle" role="dialog" aria-modal="true">
  <div class="sheet sheetOpaque sheetScreen">
    <div class="sheetHead">
      <button class="iconBtn" data-close="mBattle">‚Äπ</button>
      <div class="title" id="bHeadInfo">–†–ê–£–ù–î 1 ¬∑ 30</div>
      <button class="btn btnMini" id="bLeave" type="button">–ü–û–ö–ò–ù–£–¢–¨</button>
    </div>
    <div class="sheetBody">
      <div class="card">
        <div class="row" style="margin-top:3px;"><div class="k">–¢–´ –ê–¢–ê–ö–£–ï–®–¨</div><div class="badge" id="bTarget">–ê–≤—Ç–æ</div></div>
        <div class="row" style="margin-top:3px;"><div class="k">–ê–¢–ê–ö–ê –ó–ê –•–û–î</div><div class="badge" id="bAct">‚Äî</div></div>
      </div>

      <div class="card" style="margin-top:10px;">
        <div class="row"><div class="k">–ö–û–ú–ê–ù–î–´</div><button class="btn btnMini" id="battleConsOpen" type="button">üéí</button></div>
        <div class="battleTeamsGrid" style="margin-top:10px; display:grid; grid-template-columns:1fr 56px 1fr; gap:10px;">
          <div class="battleCol" style="padding:10px; border-radius:16px; border:1px solid rgba(255,255,255,.10); background:rgba(0,0,0,.10);">
            <div style="font-size:7px;opacity:.55; margin-bottom:6px;">–¢–í–û–Ø –ö–û–ú–ê–ù–î–ê</div>
            <div id="bMyTeam" style="display:flex; flex-direction:column; gap:4px;"></div>
          </div>
          <div class="battleCol battleAtkCol" style="padding:10px; border-radius:16px; border:1px solid rgba(255,255,255,.10); background:rgba(0,0,0,.10);">
            <div style="font-size:7px;opacity:.55; margin-bottom:6px; text-align:center;">–ê–¢–ê–ö–ê</div>
            <div id="bAtkList" style="display:flex; flex-direction:column; gap:4px;"></div>
          </div>
          <div class="battleCol battleEnemyCol" style="padding:10px; border-radius:16px; border:1px solid rgba(255,255,255,.10); background:rgba(0,0,0,.10);">
            <div style="font-size:7px;opacity:.55; margin-bottom:6px; text-align:right;">–ü–†–û–¢–ò–í–ù–ò–ö</div>
            <div id="bEnemyTeam" style="display:flex; flex-direction:column; gap:4px;"></div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:10px;">
        <div class="row"><div class="k">–õ–û–ì –ë–û–Ø</div></div>
        <div style="margin-top:8px; display:flex; flex-direction:column; gap:4px;" id="bLog"></div>
      </div>
    </div>
  </div>
</div>

<div class="modal modalMini" id="mBattleRes" role="dialog" aria-modal="true">
  <div class="sheet sheetMini">
    <div class="sheetHead">
      <div style="width:44px"></div>
      <div class="title" id="brTitle">–†–ï–ó–£–õ–¨–¢–ê–¢</div>
      <div style="width:44px"></div>
    </div>
    <div class="sheetBody">
      <div class="card">
        <div class="row"><div class="k">–ò–¢–û–ì</div><div class="badge" id="brOutcome">‚Äî</div></div>
        <div class="row" style="margin-top:10px;"><div class="k">–ù–ê–ì–†–ê–î–ê</div><div class="badge" id="brReward">‚Äî</div></div>
        <button class="btn" style="margin-top:12px" id="brOk">–ù–ê–ó–ê–î</button>
      </div>
    </div>
  </div>
</div>

<div class="modal modalMini" id="mConsumables" role="dialog" aria-modal="true">
  <div class="sheet sheetMini">
    <div class="sheetHead">
      <button class="iconBtn" data-close="mConsumables">‚Äπ</button>
      <div class="title">–†–ê–°–•–û–î–ù–ò–ö–ò</div>
      <div style="width:44px"></div>
    </div>
    <div class="sheetBody">
      <div class="card">
        <div class="row"><div class="k">–¢–í–û–ô –ò–ù–í–ï–ù–¢–ê–†–¨</div><div class="badge" id="consCtx">‚Äî</div></div>
        <div style="margin-top:10px; display:flex; flex-direction:column; gap:10px;" id="consList">‚Äî</div>
      </div>
      <div class="card" style="margin-top:12px;" id="consShopCard">
        <div class="row"><div class="k">–ú–ê–ì–ê–ó–ò–ù (–ê–†–ï–ù–ê)</div><div class="badge" style="color:var(--gold)" id="consGold">0 ü™ô</div></div>
        <div style="margin-top:10px; display:flex; flex-direction:column; gap:10px;" id="consShop">‚Äî</div>
      </div>
    </div>
  </div>
</div>

<!-- Clans -->
<div class="modal modalPage" id="mClans" role="dialog" aria-modal="true">
  <div class="sheet sheetOpaque sheetScreen">
    <div class="sheetHead">
      <button class="iconBtn" data-close="mClans">‚Äπ</button>
      <div class="title">–ö–õ–ê–ù–´</div>
      <div style="width:44px"></div>
    </div>
    <div class="sheetBody">
      <div class="card">
        <div class="row"><div class="k">–¢–í–û–ô –ö–õ–ê–ù</div><div class="badge" id="clanStatus">‚Äî</div></div>
        <div style="margin-top:10px; font-size:12px; opacity:.8; line-height:1.35" id="clanDesc">‚Äî</div>
        <button class="btn" style="margin-top:12px;" id="clanCreate">–°–û–ó–î–ê–¢–¨ –ö–õ–ê–ù –ó–ê 1000 ü™ô</button>
        <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
          <button class="btn btnSmall" id="clanSetDeputy" style="display:none;">–ó–ê–ú–ï–°–¢–ò–¢–ï–õ–¨</button>
          <button class="btn btnSmall" id="clanSetFilters" style="display:none;">–§–ò–õ–¨–¢–†</button>
          <button class="btn btnSmall" id="clanTopOpen" style="display:none;">–¢–û–ü</button>
          <button class="btn btnSmall" id="clanChatOpen" style="display:none;">–ß–ê–¢</button>
          <button class="btn btnSmall" id="clanTransfer" style="display:none;">–ü–ï–†–ï–î–ê–¢–¨</button>
          <button class="btn btnSmall" id="clanDelete" style="display:none; opacity:.9">–£–î–ê–õ–ò–¢–¨</button>
          <button class="btn btnSmall" id="clanLeave" style="display:none;">–í–´–ô–¢–ò</button>
        </div>
      </div>
      <div class="card" style="margin-top:12px;">
        <div class="row"><div class="k">–ó–ê–Ø–í–ö–ò</div><div class="badge" id="clanAppsBadge">‚Äî</div></div>
        <div style="margin-top:10px; display:flex; flex-direction:column; gap:8px;" id="clanAppsList">‚Äî</div>
      </div>
      <div class="card" style="margin-top:12px;">
        <div class="row"><div class="k">–°–ü–ò–°–û–ö –ö–õ–ê–ù–û–í</div><div class="badge" id="clanListBadge">‚Äî</div></div>
        <div style="margin-top:10px; display:flex; flex-direction:column; gap:8px;" id="clanList">‚Äî</div>
      </div>
      <div class="card" style="margin-top:12px;">
        <div class="row"><div class="k">–ë–ê–ù–ö –ö–õ–ê–ù–ê</div><div class="badge" style="color:var(--gold)" id="clanBankGold">‚Äî</div></div>
        <button class="btn" style="margin-top:12px;" id="clanBankAdd">–í–ù–ï–°–¢–ò ü™ô</button>
      </div>
      <div class="card" style="margin-top:12px;">
        <div class="row"><div class="k">–õ–û–ì–ò –ö–õ–ê–ù–ê</div><div class="badge" id="clanLogBadge">‚Äî</div></div>
        <div style="margin-top:10px; display:flex; flex-direction:column; gap:8px;" id="clanLogList">‚Äî</div>
      </div>
    </div>
  </div>
</div>


<!-- Top Brothers (Home) -->
<div class="modal modalPage" id="mTopBros" role="dialog" aria-modal="true">
  <div class="sheet sheetOpaque sheetScreen">
    <div class="sheetHead">
      <button class="iconBtn" data-close="mTopBros">‚Äπ</button>
      <div class="title">–¢–û–ü –ë–†–ê–¢–ö–û–í</div>
      <div style="width:44px"></div>
    </div>
    <div class="sheetBody">
      <div class="card">
        <div class="row"><div class="k">–°–ü–ò–°–û–ö</div><div class="badge" id="topBrosBadge">‚Äî</div></div>
        <div style="margin-top:10px; display:flex; flex-direction:column; gap:8px;" id="topBrosList">‚Äî</div>
      </div>
    </div>
  </div>
</div>

<!-- Clan Top -->
<div class="modal modalPage" id="mClanTop" role="dialog" aria-modal="true">
  <div class="sheet sheetOpaque sheetScreen">
    <div class="sheetHead">
      <button class="iconBtn" data-close="mClanTop">‚Äπ</button>
      <div class="title">–¢–û–ü –ö–õ–ê–ù–ê</div>
      <div style="width:44px"></div>
    </div>
    <div class="sheetBody">
      <div class="card">
        <div class="row"><div class="k">–£–ß–ê–°–¢–ù–ò–ö–ò</div><div class="badge" id="clanTopBadgeFull">‚Äî</div></div>
        <div style="margin-top:10px; display:flex; flex-direction:column; gap:8px;" id="clanTopMembersFull">‚Äî</div>
      </div>
    </div>
  </div>
</div>

<!-- Clan Chat -->
<div class="modal modalPage" id="mClanChat" role="dialog" aria-modal="true">
  <div class="sheet sheetOpaque sheetScreen">
    <div class="sheetHead">
      <button class="iconBtn" data-close="mClanChat">‚Äπ</button>
      <div class="title">–ß–ê–¢ –ö–õ–ê–ù–ê</div>
      <div style="width:44px"></div>
    </div>
    <div class="sheetBody">
      <div class="card">
        <div class="row"><div class="k">–°–û–û–ë–©–ï–ù–ò–Ø</div><div class="badge" id="clanChatBadgeFull">‚Äî</div></div>
        <div style="margin-top:10px; display:flex; flex-direction:column; gap:8px; overflow-y:auto; max-height:60vh; padding-right:4px;" id="clanChatListFull">‚Äî</div>
        <button class="btn" style="margin-top:12px;" id="clanChatSendFull">–ù–ê–ü–ò–°–ê–¢–¨</button>
      </div>
    </div>
  </div>
</div>


<!-- Shop -->
<div class="modal" id="mShop" role="dialog" aria-modal="true">
  <div class="sheet">
    <div class="sheetHead">
      <button class="iconBtn" data-close="mShop">‚Äπ</button>
      <div class="title">–ú–ê–ì–ê–ó–ò–ù</div>
      <div style="width:44px"></div>
    </div>
    <div class="sheetBody" id="shopList"></div>
  </div>
</div>

<!-- Districts -->
<div class="modal modalPage" id="mDistricts" role="dialog" aria-modal="true">
  <div class="sheet sheetOpaque sheetScreen">
    <div class="sheetHead">
      <button class="iconBtn" data-close="mDistricts">‚Äπ</button>
      <div class="title">–†–ê–ô–û–ù–´</div>
      <button class="toothBtn" id="bizRewardBtn" type="button"><div class="ico">üè™</div><div class="tm" id="bizRewardTimer">00:00</div></button>
    </div>
    <div class="sheetBody">
      <div style="margin:10px; display:flex; flex-direction:column; gap:10px;" id="districtList"></div>
    </div>
  </div>
</div>

<div class="modal modalMini" id="mDistrictBiz" role="dialog" aria-modal="true">
  <div class="sheet sheetMini">
    <div class="sheetHead">
      <button class="iconBtn" data-close="mDistrictBiz">‚Äπ</button>
      <div class="title" id="dbTitle">–ë–ò–ó–ù–ï–°</div>
      <div style="width:44px"></div>
    </div>
    <div class="sheetBody">
      <div class="card">
        <div class="row"><div class="k">–†–ê–ô–û–ù</div><div class="badge" id="dbDistrict">‚Äî</div></div>
        <div style="margin-top:10px; display:flex; flex-direction:column; gap:10px;" id="dbList">‚Äî</div>
      </div>
    </div>
  </div>
</div>

<!-- District Nightmare -->
<div class="modal modalPage" id="mDistrictNightmare" role="dialog" aria-modal="true">
  <div class="sheet sheetOpaque sheetScreen">
    <div class="sheetHead">
      <button class="iconBtn" data-close="mDistrictNightmare">‚Äπ</button>
      <div class="title" id="dnTitle">–†–ê–ô–û–ù</div>
      <div style="width:44px"></div>
    </div>
    <div class="sheetBody" style="padding:12px;">
      <div class="card">
        <div class="row"><div class="k">–ö–û–®–ú–ê–†</div><div class="badge" id="dnDiff">‚Äî</div></div>
        <div style="margin-top:10px; font-size:12px; opacity:.8; line-height:1.35" id="dnDesc">‚Äî</div>
      </div>
    </div>
  </div>
</div>

<!-- Bosses -->
<div class="modal modalPage" id="mBoss" role="dialog" aria-modal="true">
  <div class="sheet sheetOpaque sheetScreen">
    <div class="sheetHead">
      <button class="iconBtn" data-close="mBoss">‚Äπ</button>
      <div class="title">–ë–û–°–°–´</div>
      <div style="display:flex; gap:8px; align-items:center;">
        <div class="badge" id="bossRingBadge" style="padding:8px 10px; border-color:rgba(255,255,255,.10); background:rgba(0,0,0,.18)">üíç <b id="bossRingVal" style="letter-spacing:1px">0</b></div>
        <button class="toothBtn" id="bossToothBtn" type="button"><div class="ico">ü¶∑</div><div class="tm" id="bossToothTimer">00:00</div></button>
      </div>
    </div>
    <div class="sheetBody" id="bossList"></div>
  </div>
</div>

<div class="modal modalMini" id="mFriendHelp" role="dialog" aria-modal="true">
  <div class="sheet sheetMini">
    <div class="sheetHead">
      <button class="iconBtn" data-close="mFriendHelp">‚Äπ</button>
      <div class="title">–ü–û–ú–û–©–¨ –ë–†–ê–¢–í–´</div>
      <div style="width:44px"></div>
    </div>
    <div class="sheetBody">
      <div class="card">
        <div class="row"><div class="k">–£–†–û–í–ï–ù–¨</div><div class="badge" id="fhLvl">0</div></div>
        <div class="row" style="margin-top:10px;"><div class="k">–õ–ò–ú–ò–¢ –ù–ê –î–†–£–ì–ê</div><div class="badge" id="fhPct">10%</div></div>
        <div style="margin-top:10px; font-size:12px; opacity:.8; line-height:1.35">–ö–∞–∂–¥—ã–π —É—Ä–æ–≤–µ–Ω—å —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –ª–∏–º–∏—Ç –ø–æ–º–æ—â–∏ –¥—Ä—É–∑–µ–π –≤ –±–æ—é —Å –±–æ—Å—Å–æ–º –Ω–∞ +1%.</div>
        <button class="btn" style="margin-top:12px;" id="fhUp">–ü–†–û–ö–ê–ß–ê–¢–¨</button>
      </div>
    </div>
  </div>
</div>

<!-- Top -->
<div class="modal modalPage" id="mTop" role="dialog" aria-modal="true">
  <div class="sheet sheetOpaque sheetScreen">
    <div class="sheetHead">
      <button class="iconBtn" data-close="mTop">‚Äπ</button>
      <div class="title">–¢–û–ü</div>
      <div style="width:44px"></div>
    </div>
    <div class="sheetBody">
      <div class="card" style="font-size:12px; opacity:.8; line-height:1.35">–î–ª—è –∏–¥–µ–∞–ª—å–Ω–æ–≥–æ mobile-first —Å–¥–µ–ª–∞—é Supabase-—Ç–æ–ø –≤–æ 2-–π –∏—Ç–µ—Ä–∞—Ü–∏–∏. –°–µ–π—á–∞—Å ‚Äî –ª–æ–∫–∞–ª—å–Ω—ã–π —Ç–æ–ø-100.</div>
      <div class="card" style="margin-top:12px;">
        <div class="row"><div class="k">–¢–û–ü-100</div><div style="font-size:12px;opacity:.75">–ª–æ–∫–∞–ª—å–Ω–æ</div></div>
        <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
          <button class="btn btnSmall" id="top100Lvl">–£–†–û–í–ï–ù–¨</button>
          <button class="btn btnSmall" id="top100Wealth">–•–ê–†–ê–ö–¢–ï–†–ò–°–¢–ò–ö–ò</button>
          <button class="btn btnSmall" id="top100Boss">–ë–û–°–°–´</button>
          <button class="btn btnSmall" id="top100Clans">–ö–õ–ê–ù–´</button>
        </div>
        <div style="margin-top:10px; display:flex; flex-direction:column; gap:8px;" id="top100List"></div>
      </div>
    </div>
  </div>
</div>

<!-- Dice -->
<div class="modal modalPage" id="mDice" role="dialog" aria-modal="true">
  <div class="sheet sheetOpaque sheetScreen">
    <div class="sheetHead">
      <button class="iconBtn" data-close="mDice">‚Äπ</button>
      <div class="title">–ö–û–°–¢–ò</div>
      <div style="width:44px"></div>
    </div>
    <div class="sheetBody">
      <div class="card">
        <div class="diceTitle"><span class="ico">üé≤</span><span>–ë–†–ê–¢–°–¢–í–û –ö–û–ù–¶–ê</span></div>
        <div class="dicePrice">–¶–µ–Ω–∞: <span style="color:var(--gold); font-weight:900">1 ü™ô</span></div>
        <div class="diceGrid" id="diceRow"></div>
        <button class="btn dicePrimary" id="diceRoll">–ë–†–û–°–ò–¢–¨</button>
        <div style="margin-top:12px; font-size:12px; opacity:.85; text-align:center" id="diceRes">‚Äî</div>
      </div>

      <div class="card" style="margin-top:12px;">
        <div class="row"><div class="k">–ù–ê–ì–†–ê–î–´</div><div style="font-size:12px;opacity:.75">–∑–∞ 4 –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö</div></div>
        <div style="margin-top:10px; display:flex; flex-direction:column; gap:8px; font-size:12px; opacity:.9; line-height:1.25">
          <div class="row"><div style="min-width:0">4√ó1</div><div class="badge">15 üíç –ö–æ–∑—ã—Ä–Ω—ã—Ö –∫–æ–ª–µ—Ü</div></div>
          <div class="row"><div style="min-width:0">4√ó2</div><div class="badge">+1 –ü–∏–Ω–æ–∫</div></div>
          <div class="row"><div style="min-width:0">4√ó3</div><div class="badge">+1 –ö–æ—Å—Ç–µ—Ç</div></div>
          <div class="row"><div style="min-width:0">4√ó4</div><div class="badge">+1 –ö–ª–∏–∑–º–∞</div></div>
          <div class="row"><div style="min-width:0">4√ó5</div><div class="badge">–ö–æ–ª—å—Ü–æ –Ω–∞ –±–æ—Å—Å–∞ ¬´–ü–∞—É—á–∏—Ö–∞¬ª</div></div>
          <div class="row"><div style="min-width:0">4√ó6</div><div class="badge">–ö–æ–ª—å—Ü–æ –Ω–∞ –±–æ—Å—Å–∞ ¬´–°–∞—Ä—É–º—è–Ω¬ª</div></div>
        </div>
        <div style="margin-top:10px; font-size:11px; opacity:.75; line-height:1.35">–ï—Å–ª–∏ 4 –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö –Ω–µ —Å–æ–±—Ä–∞–Ω—ã ‚Äî –Ω–∞–≥—Ä–∞–¥–∞: <b>+50 –∑—É–±–æ–≤</b></div>
        <div style="margin-top:8px; font-size:11px; opacity:.75; line-height:1.35">–ï—Å–ª–∏ —Å–æ–±—Ä–∞–Ω—ã <b>5 –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö</b> ‚Äî –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ: <b>+20 ü™ô</b></div>
      </div>
    </div>
  </div>
</div>

<div class="modal modalMini" id="mDiceReward" role="dialog" aria-modal="true">
  <div class="sheet sheetMini">
    <div class="sheetHead">
      <div style="width:44px"></div>
      <div class="title">–ù–ê–ì–†–ê–î–ê</div>
      <div style="width:44px"></div>
    </div>
    <div class="sheetBody">
      <div class="card">
        <div class="row"><div class="k">–ü–û–õ–£–ß–ï–ù–û</div><div class="badge" style="color:var(--gold)" id="diceRewardVal">50 ü¶∑</div></div>
        <button class="btn" style="margin-top:12px" id="diceRewardOk">–û–ö</button>
      </div>
    </div>
  </div>
</div>

<div class="toastWrap"><div class="toast" id="toast"></div></div>

<script>
(function(){
  'use strict';

  const tg = window.Telegram && window.Telegram.WebApp;
  if (tg && tg.ready) tg.ready();
  try { if (tg) tg.expand(); } catch (e) {}

  const IS_DEV = (function(){
    try {
      const qs = new URLSearchParams(location.search||'');
      if (qs.get('dev')==='1') return true;
      if (localStorage && localStorage.getItem('dev')==='1') return true;
    } catch (e) {}
    return false;
  })();

  const SHOP_X2_FORCE = 'OFF'; // 'AUTO' | 'ON' | 'OFF' !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! –ú –ù –û –ñ –ò –¢ –ï –õ –¨ !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  function shopX2Enabled(){
    if (SHOP_X2_FORCE==='ON') return true;
    if (SHOP_X2_FORCE==='OFF') return false;
    return !!state.shopX2;
  }

  function gfBattleTopDamagerId(b){
    try {
      if (!b || !b.dmgBy || typeof b.dmgBy !== 'object') return '';
      let bestId = '';
      let best = -1;
      Object.keys(b.dmgBy).forEach(k=>{
        const v = parseInt(b.dmgBy[k]||0,10)||0;
        if (v > best){ best = v; bestId = k; }
      });
      return bestId;
    } catch (e) { return ''; }
  }

  function gfBattleComputeReward(b, win){
    try {
      const cost = parseInt(b && b.cost || 0, 10) || 0;
      const youAlive = (parseInt(b && b.myHp || 0, 10) || 0) > 0;
      const topId = gfBattleTopDamagerId(b);
      const isTop = (topId && String(topId) === 'YOU');
      let gold = 0;
      if (win){
        if (cost === 2){
          gold += 3;
          if (youAlive) gold += 1;
          if (isTop) gold += 1;
        } else if (cost === 20){
          gold += 30;
          if (youAlive) gold += 10;
          if (isTop) gold += 10;
        }
      } else {
        if (isTop){
          if (cost === 2) gold += 2;
          else if (cost === 20) gold += 20;
        }
      }
      return { gold: Math.max(0, Math.floor(gold)) };
    } catch (e) { return { gold:0 }; }
  }

  function gfEffStat(k){
    const cur = gymVal(k);
    const pct = gymBonusPct();
    let add = Math.round(cur*pct);
    if (pct>0 && cur>0 && add<=0) add = 1;
    return cur + add;
  }
  function gfEffForMatch(v){
    v = parseFloat(v);
    if (isNaN(v) || v < 0) v = 0;
    return Math.log10(1 + v);
  }
  function gfClamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
  function gfMitigation(ee){
    return gfClamp(ee * 0.07, 0, 0.45);
  }
  function gfDodgeChance(ea){
    return gfClamp(ea * 0.04, 0, 0.25);
  }
  function gfCritChance(em){
    return gfClamp(em * 0.05, 0, 0.35);
  }
  function gfMaxHp(eh){
    return Math.floor(140 + eh * 80);
  }
  function gfBaseDamage(es){
    return (18 + es * 18);
  }
  function gfDoHit(attDmgBase, attCritChance, defDodgeChance, defMit, allowCrit){
    const dodged = Math.random() < defDodgeChance;
    if (dodged) return { dmg: 0, crit: false, dodge: true };
    let dmg = attDmgBase * (0.90 + Math.random() * 0.20);
    let isCrit = false;
    if (allowCrit && Math.random() < attCritChance) {
      isCrit = true;
      dmg = dmg * (1.5 + Math.random() * 0.5);
    }
    dmg = dmg * (1 - defMit);
    dmg = Math.max(1, Math.floor(dmg));
    return { dmg: dmg, crit: isCrit, dodge: false };
  }

  function districtFearLeaderUpdate(dIdx){
    try {
      const fk = 'D'+String(dIdx);
      const val = Math.max(0, (state.districtFear && state.districtFear[fk]) ? (parseInt(state.districtFear[fk]||0,10)||0) : 0);
      if (!state.districtFearLeaders || typeof state.districtFearLeaders !== 'object') state.districtFearLeaders = {};
      const cur = state.districtFearLeaders[fk];
      const best = cur && cur.fear ? (parseInt(cur.fear||0,10)||0) : 0;
      if (!cur || val > best){
        state.districtFearLeaders[fk] = { name:(state.playerName||'PLAYER'), fear: val, ts: now() };
      }
    } catch (e) {}
  }

  function bizDailyClaimAll(){
    try {
      const dayKey = utcDayKey();
      if (!state.districtBizDaily || typeof state.districtBizDaily !== 'object') state.districtBizDaily = { day:'', claimed:{} };
      if (!state.districtBizDaily.claimed || typeof state.districtBizDaily.claimed !== 'object') state.districtBizDaily.claimed = {};
      if (state.districtBizDaily.day !== dayKey){
        state.districtBizDaily.day = dayKey;
        state.districtBizDaily.claimed = {};
      }

      let addFearSum = 0;
      let addGoldSum = 0;

      for (let id=0; id<12; id++){
        const c2k = bizKey(id, 1);
        const c4k = bizKey(id, 3);

        if (!state.districtBizDaily.claimed[c2k]){
          const lvl2 = bizLvl(id, 1);
          const addFear = lvl2>0 ? (BIZ2_FEAR_PER_LVL[lvl2-1]||0) : 0;
          if (addFear>0){
            const fk = 'D'+String(id);
            const curFear = Math.max(0, (state.districtFear && state.districtFear[fk]) ? (parseInt(state.districtFear[fk]||0,10)||0) : 0);
            if (!state.districtFear || typeof state.districtFear !== 'object') state.districtFear = {};
            state.districtFear[fk] = curFear + addFear;
            addFearSum += addFear;
          }
          state.districtBizDaily.claimed[c2k] = now();
        }

        if (!state.districtBizDaily.claimed[c4k]){
          const lvl4 = bizLvl(id, 3);
          const addGold = lvl4>0 ? (BIZ4_GOLD_PER_LVL[lvl4-1]||0) : 0;
          if (addGold>0){
            state.gold = Math.min(CURRENCY_CAP, (parseInt(state.gold||0,10)||0) + addGold);
            addGoldSum += addGold;
          }
          state.districtBizDaily.claimed[c4k] = now();
        }
      }

      // district holder / day leader daily gold rewards (UTC 00:00)
      try {
        const you = String(state.playerName||'PLAYER').trim().toUpperCase();
        for (let id=0; id<12; id++){
          const fk = 'D'+String(id);

          // holder reward +50 ü™ô
          const holderKey = 'HOLDG_'+fk;
          if (!state.districtBizDaily.claimed[holderKey]){
            const top = (state.districtFearLeaders && state.districtFearLeaders[fk]) ? state.districtFearLeaders[fk] : null;
            const nm = top && top.name ? String(top.name).trim().toUpperCase() : '';
            if (nm && nm === you){
              state.gold = Math.min(CURRENCY_CAP, (parseInt(state.gold||0,10)||0) + 50);
              addGoldSum += 50;
              state.districtBizDaily.claimed[holderKey] = now();
            }
          }

          // day leader reward +30 ü™ô
          const dayKey2 = 'DAYG_'+fk;
          if (!state.districtBizDaily.claimed[dayKey2]){
            const box = (state.districtDailyFear && state.districtDailyFear.day===dayKey && state.districtDailyFear.byDistrict) ? state.districtDailyFear.byDistrict : null;
            const cur = box && box[fk] ? box[fk] : null;
            const nm2 = cur && cur.name ? String(cur.name).trim().toUpperCase() : '';
            if (nm2 && nm2 === you){
              state.gold = Math.min(CURRENCY_CAP, (parseInt(state.gold||0,10)||0) + 30);
              addGoldSum += 30;
              state.districtBizDaily.claimed[dayKey2] = now();
            }
          }
        }
      } catch (e) {}

      if (addFearSum>0 || addGoldSum>0){
        save();
        renderHUD();
        toast('–ë–ò–ó–ù–ï–°: +' + fmt4(addFearSum) + ' üò± ¬∑ +' + fmt4(addGoldSum) + ' ü™ô','win');
        haptic('heavy');
      } else {
        toast('–ë–∏–∑–Ω–µ—Å –Ω–∞–≥—Ä–∞–¥–∞ —É–∂–µ —Å–æ–±—Ä–∞–Ω–∞','lose');
      }
    } catch (e) {}
  }

  function msToNextUtcMidnight(){
    try {
      const d = new Date();
      const next = Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate()+1, 0,0,0,0);
      return Math.max(0, next - Date.now());
    } catch (e) { return 0; }
  }
  function bizRewardBtnUpdate(){
    try {
      const ms = msToNextUtcMidnight();
      const tm = $('bizRewardTimer');
      if (tm) tm.textContent = fmtHHMMSS(ms);
    } catch (e) {}
  }
  function districtDailyEnsure(){
    try {
      if (!state.districtDailyFear || typeof state.districtDailyFear !== 'object') state.districtDailyFear = { day:'', byDistrict:{} };
      if (!state.districtDailyFear.byDistrict || typeof state.districtDailyFear.byDistrict !== 'object') state.districtDailyFear.byDistrict = {};
      const k = utcDayKey();
      if (state.districtDailyFear.day !== k){
        state.districtDailyFear.day = k;
        state.districtDailyFear.byDistrict = {};
      }
    } catch (e) {}
  }
  function districtDailyFearAdd(dIdx, addFear){
    try {
      districtDailyEnsure();
      const fk = 'D'+String(dIdx);
      const box = state.districtDailyFear.byDistrict;
      const cur = box && box[fk] ? box[fk] : null;
      const curVal = cur && cur.fear ? (parseInt(cur.fear||0,10)||0) : 0;
      const next = curVal + Math.max(0, parseInt(addFear||0,10)||0);
      if (!state.districtDailyFear.byDistrict || typeof state.districtDailyFear.byDistrict !== 'object') state.districtDailyFear.byDistrict = {};
      state.districtDailyFear.byDistrict[fk] = { name:(state.playerName||'PLAYER'), fear: next, ts: now() };
    } catch (e) {}
  }

  function consOpen(ctx){
    state._consCtx = String(ctx||'');
    try {
      const m = $('mConsumables');
      if (m) m.classList.toggle('consFull', String(ctx||'')==='arena');
    } catch (e) {}
    showModal('mConsumables');
    renderConsumables();
    haptic('light');
  }
  function renderConsumables(){
    const ctx = String(state._consCtx||'');
    try { $('consCtx').textContent = (ctx==='arena' ? '–ü–û–ö–£–ü–ö–ê' : '–ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï'); } catch (e) {}
    try { $('consGold').textContent = String(state.gold||0) + ' ü™ô'; } catch (e) {}

    const med = parseInt(state.consumables && state.consumables.med || 0, 10) || 0;
    const nade = parseInt(state.consumables && state.consumables.nade || 0, 10) || 0;

    const list = $('consList');
    if (list){
      list.innerHTML = '';

      const row1 = document.createElement('div');
      row1.className = 'row';
      row1.innerHTML = '<div><div class="k">ü©π –ê–ü–¢–ï–ß–ö–ê</div><div style="font-size:12px;opacity:.75;line-height:1.25">–õ–µ—á–∏—Ç —Ç–µ–±—è –Ω–∞ 30% HP</div></div>';
      const b1 = document.createElement('button');
      b1.className = 'btn btnSmall';
      b1.textContent = '–ò–°–ü. ('+med+')';
      b1.disabled = (med<=0) || (ctx!=='battle');
      b1.onclick = ()=>consUse('med');
      row1.appendChild(b1);
      list.appendChild(row1);

      const row2 = document.createElement('div');
      row2.className = 'row';
      row2.innerHTML = '<div><div class="k">üí£ –ì–†–ê–ù–ê–¢–ê</div><div style="font-size:12px;opacity:.75;line-height:1.25">–ù–∞–Ω–æ—Å–∏—Ç 25 —É—Ä–æ–Ω–∞ —Ü–µ–ª–∏</div></div>';
      const b2 = document.createElement('button');
      b2.className = 'btn btnSmall';
      b2.textContent = '–ò–°–ü. ('+nade+')';
      b2.disabled = (nade<=0) || (ctx!=='battle');
      b2.onclick = ()=>consUse('nade');
      row2.appendChild(b2);
      list.appendChild(row2);
    }

    const shopCard = $('consShopCard');
    if (shopCard) shopCard.style.display = (ctx==='arena' ? '' : 'none');
    const shop = $('consShop');
    if (shop){
      shop.innerHTML = '';
      if (ctx==='arena'){
        const s1 = document.createElement('div');
        s1.className = 'row';
        s1.innerHTML = '<div><div class="k">ü©π –ê–ü–¢–ï–ß–ö–ê</div><div style="font-size:12px;opacity:.75">–¶–µ–Ω–∞: 30 ü™ô</div></div>';
        const sb1 = document.createElement('button');
        sb1.className = 'btn btnSmall';
        sb1.textContent = '–ö–£–ü–ò–¢–¨';
        sb1.disabled = (state.gold||0) < 30;
        sb1.onclick = ()=>consBuy('med', 30);
        s1.appendChild(sb1);
        shop.appendChild(s1);

        const s2 = document.createElement('div');
        s2.className = 'row';
        s2.innerHTML = '<div><div class="k">üí£ –ì–†–ê–ù–ê–¢–ê</div><div style="font-size:12px;opacity:.75">–¶–µ–Ω–∞: 50 ü™ô</div></div>';
        const sb2 = document.createElement('button');
        sb2.className = 'btn btnSmall';
        sb2.textContent = '–ö–£–ü–ò–¢–¨';
        sb2.disabled = (state.gold||0) < 50;
        sb2.onclick = ()=>consBuy('nade', 50);
        s2.appendChild(sb2);
        shop.appendChild(s2);
      }
    }
  }
  function consBuy(kind, cost){
    if (String(state._consCtx||'')!=='arena'){ toast('–ü–æ–∫—É–ø–∫–∞ —Ç–æ–ª—å–∫–æ –Ω–∞ –ê—Ä–µ–Ω–µ','lose'); return; }
    const c = parseInt(cost||0,10)||0;
    if ((state.gold||0) < c){ toast('–ù—É–∂–Ω–æ '+c+' ü™ô','lose'); return; }
    state.gold -= c;
    if (!state.consumables) state.consumables = { med:0, nade:0 };
    if (kind==='med') state.consumables.med = (parseInt(state.consumables.med||0,10)||0) + 1;
    if (kind==='nade') state.consumables.nade = (parseInt(state.consumables.nade||0,10)||0) + 1;
    save();
    renderAll();
    renderConsumables();
    toast('–ö—É–ø–ª–µ–Ω–æ','win');
    haptic('light');
  }
  function consUse(kind){
    if (String(state._consCtx||'')!=='battle'){ toast('–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–æ–ª—å–∫–æ –≤ –±–æ—é','lose'); return; }
    const b = state.groupFight && state.groupFight.battle;
    if (!b){ toast('–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –±–æ—è','lose'); return; }
    if ((parseInt(b.myHp||0,10)||0) <= 0){ toast('–¢—ã –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—å','lose'); return; }
    if (b.acted){ toast('–£–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –¥–µ–π—Å—Ç–≤–∏–µ –≤ —ç—Ç–æ—Ç —Ö–æ–¥','lose'); return; }
    if (!state.consumables) state.consumables = { med:0, nade:0 };

    if (kind==='med'){
      const have = parseInt(state.consumables.med||0,10)||0;
      if (have<=0){ toast('–ù–µ—Ç –∞–ø—Ç–µ—á–µ–∫','lose'); return; }
      state.consumables.med = have - 1;
      const heal = Math.max(1, Math.round((parseInt(b.myMaxHp||0,10)||0) * 0.30));
      const before = parseInt(b.myHp||0,10)||0;
      b.myHp = clamp(before + heal, 0, parseInt(b.myMaxHp||0,10)||0);
      b.acted = true;
      b.log.unshift({ kind:'SYS', text:'–¢—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª –∞–ø—Ç–µ—á–∫—É –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–ª ' + (b.myHp-before) + ' HP' });
      save();
      renderBattle();
      renderConsumables();
      haptic('light');
      return;
    }

    if (kind==='nade'){
      const have = parseInt(state.consumables.nade||0,10)||0;
      if (have<=0){ toast('–ù–µ—Ç –≥—Ä–∞–Ω–∞—Ç','lose'); return; }
      const t = (b.myTarget ? (b.targets||[]).find(x=>x.id===b.myTarget) : null) || battleWeakestTarget(b);
      if (!t || (parseInt(t.hp||0,10)||0) <= 0){ toast('–ù–µ—Ç —Ü–µ–ª–∏','lose'); return; }
      state.consumables.nade = have - 1;
      const dmg = 25;
      const real = Math.min(parseInt(t.hp||0,10)||0, dmg);
      t.hp = Math.max(0, (parseInt(t.hp||0,10)||0) - real);
      b.acted = true;
      b.log.unshift({ kind:'HIT', text:'–¢—ã –±—Ä–æ—Å–∏–ª –≥—Ä–∞–Ω–∞—Ç—É –∏ –Ω–∞–Ω–µ—Å ' + real + ' —É—Ä–æ–Ω–∞ —Ü–µ–ª–∏ ' + t.id });
      save();
      renderBattle();
      renderConsumables();
      haptic('light');
      return;
    }
  }

  function renderFriendHelp(){
    try {
      const lvl = clamp(parseInt(state.friendHelpLvl||0,10)||0, 0, 10);
      $('fhLvl').textContent = String(lvl);
      $('fhPct').textContent = String(10 + lvl) + '%';
      const btn = $('fhUp');
      if (btn) {
        const cost = (lvl>=10) ? 0 : (20 * (lvl+1));
        btn.textContent = (lvl>=10) ? '–ú–ê–ö–°. –£–†–û–í–ï–ù–¨' : ('–ü–†–û–ö–ê–ß–ê–¢–¨ –ó–ê ' + cost + ' –∑—É–±–æ–≤');
        btn.disabled = lvl>=10;
        btn.style.opacity = btn.disabled ? '.6' : '1';
        btn.onclick = ()=>{
          const cur = clamp(parseInt(state.friendHelpLvl||0,10)||0, 0, 10);
          if (cur>=10) return;
          const cost2 = 20 * (cur+1);
          if ((state.tooth||0) < cost2){ toast('–ù—É–∂–Ω–æ '+cost2+' –∑—É–±–æ–≤','lose'); return; }
          state.tooth -= cost2;
          state.friendHelpLvl = cur + 1;
          save();
          renderFriendHelp();
          renderHUD();
          haptic('light');
        };
      }
    } catch (e) {}
  }

  function districtData(){
    return [
      { name:'–®–∏—Ä—Å–∫–∏–π –∫—Ä–∞–π', diff:'–õ–ï–ì–ö–û', tasks:[
        '–ó–∞–±—Ä–∞—Ç—å —É —Ö–æ–±–±–∏—Ç–∞ –∫–æ–Ω—Ñ–µ—Ç–∫—É üç¨',
        '–û—Ç–æ–±—Ä–∞—Ç—å —Å–∏–≥–∞—Ä—É —É –§—Ä–æ–¥–æ',
        '–ü–æ–º–æ—á—å –°—ç–º—É –¥–æ—Å—Ç–∞—Ç—å –≤–µ–¥—Ä–æ',
        '–ü–æ–≥–æ–Ω—è—Ç—å –ø–æ –¥–µ—Ä–µ–≤–Ω–µ —Å–ª—É—á–∞–π–Ω—ã—Ö —Ö–æ–±–±–∏—Ç–æ–≤',
        '–ù–∞–π—Ç–∏ –ø—Ä–æ–ø–∞–≤—à—É—é –∫—É—Ä–∏—Ü—É —É –ë–∏–ª—å–±–æ',
        '–î–æ—Å—Ç–∞–≤–∏—Ç—å –ø–∏—Ä–æ–∂–æ–∫ —Å–æ—Å–µ–¥—É',
        '–ü–æ–π–º–∞—Ç—å –±–µ–≥—É—â–µ–≥–æ –∫—Ä–æ–ª–∏–∫–∞'
      ]},
      { name:'–ë—Ä–∏–π—Å–∫–∏–µ –∑–µ–º–ª–∏', diff:'–õ–ï–ì–ö–û', tasks:[
        '–ó–∞–±—Ä–∞—Ç—å —É —Ç—Ä–∞–∫—Ç–∏—Ä–Ω–æ–≥–æ –±–∞—Ä–º–µ–Ω–∞ –∫—Ä—É–∂–∫—É –ø–∏–≤–∞ üç∫',
        '–ü–æ–π–º–∞—Ç—å –≥–æ–ø–Ω–∏–∫–∞ —Å –º–µ—à–∫–æ–º –º–æ–Ω–µ—Ç',
        '–î–æ—Å—Ç–∞–≤–∏—Ç—å –ø–∞–∫–µ—Ç —Å –ø–∏—Ä–æ–≥–∞–º–∏',
        '–£—Å—Ç—Ä–æ–∏—Ç—å –ø–æ–≥–æ–Ω—é –∑–∞ –∫–æ—à–∫–æ–π',
        '–ü–æ–¥–∂–∞—Ä–∏—Ç—å –ø–∞—Ä—É ‚Äú—Ç–æ–ø–æ—Ä–∏–∫–æ–≤‚Äù –¥–ª—è –æ—Ö—Ä–∞–Ω—ã',
        '–ü–æ–º–æ—á—å –º–µ—Å—Ç–Ω–æ–º—É –∫—É–∑–Ω–µ—Ü—É –ø–æ—á–∏–Ω–∏—Ç—å –º–µ—á',
        '–ù–∞–π—Ç–∏ –ø–æ—Ç–µ—Ä—è–Ω–Ω—É—é —à–ª—è–ø—É –æ—Ö—Ä–∞–Ω–Ω–∏–∫–∞'
      ]},
      { name:'–†–∏–≤–µ–Ω–¥–µ–ª–ª', diff:'–õ–ï–ì–ö–û', tasks:[
        '–ó–∞–±—Ä–∞—Ç—å —É —ç–ª—å—Ñ–∞ –±–ª–µ—Å—Ç—è—â–∏–π –∫–∞–º–µ—à–µ–∫',
        '–ü–µ—Ä–µ–∫–∏–Ω—É—Ç—å —Å–≤–∏—Ç–æ–∫ —á–µ—Ä–µ–∑ –º–æ—Å—Ç',
        '–°–æ—Ä–≤–∞—Ç—å –ø–∞—Ä—É –º–∞–≥–∏—á–µ—Å–∫–∏—Ö —Ç—Ä–∞–≤',
        '–ü–æ–¥—Å–ª—É—à–∞—Ç—å —Ä–∞–∑–≥–æ–≤–æ—Ä —ç–ª—å—Ñ–æ–≤',
        '–ü–æ–π–º–∞—Ç—å –º–∞–ª–µ–Ω—å–∫–æ–≥–æ —ç–ª—å—Ñ–∏–π—Å–∫–æ–≥–æ –∫–æ—Ç—ë–Ω–∫–∞',
        '–ù–∞–π—Ç–∏ –ø–æ—Ç–µ—Ä—è–Ω–Ω—ã–µ –æ—á–∫–∏ –≠–ª—Ä–æ–Ω–¥–∞',
        '–û—Ç–æ–±—Ä–∞—Ç—å —É —ç–ª—å—Ñ–∞ –±–∞–Ω–∞–Ω üçå'
      ]},
      { name:'–ú–æ—Ä–∏–π—Å–∫–∏–µ –∫–æ–ø–∏', diff:'–õ–ï–ì–ö–û', tasks:[
        '–û—Ç–æ–±—Ä–∞—Ç—å —É –≥–æ–±–ª–∏–Ω–∞ –∫–∏—Ä–∫—É ‚õè',
        '–ù–∞–π—Ç–∏ —Ä—é–∫–∑–∞–∫ —à–∞—Ö—Ç—ë—Ä–∞',
        '–ó–∞–±—Ä–∞—Ç—å —É —Ç—Ä–æ–ª–ª—è —à–ª—è–ø—É',
        '–†–∞–∑–∂–µ—á—å –∫–æ—Å—Ç—ë—Ä –≤ —à–∞—Ö—Ç–µ',
        '–ü–æ–π–º–∞—Ç—å —Ä–µ–¥–∫–æ–≥–æ –ø–∞—É—á–∫–∞',
        '–î–æ—Å—Ç–∞–≤–∏—Ç—å –∫–∏—Ä–∫—É –∫ —Å—Ç–∞—Ä–æ–º—É –≥–æ–±–ª–∏–Ω—É',
        '–ù–∞–π—Ç–∏ –ø–æ—Ç–µ—Ä—è–Ω–Ω—ã–π —à–ª–µ–º —à–∞—Ö—Ç—ë—Ä–∞'
      ]},
      { name:'–õ–æ—Ç–ª–æ—Ä–∏—ç–Ω', diff:'–°–†–ï–î–ù–ï', tasks:[
        '–ó–∞–±—Ä–∞—Ç—å —É –ª—É—á–Ω–∏–∫–∞ —Å—Ç—Ä–µ–ª—É',
        '–ü–æ–π–º–∞—Ç—å –º–∞–≥–∏—á–µ—Å–∫–∏–π –∫—Ä–∏—Å—Ç–∞–ª–ª',
        '–ü–æ–¥—Å–º–æ—Ç—Ä–µ—Ç—å –∑–∞ —ç–ª—å—Ñ–∞–º–∏ –∏ –∑–∞–±—Ä–∞—Ç—å —Å–≤–∏—Ç–æ–∫',
        '–ù–∞–π—Ç–∏ —Å—É–Ω–¥—É–∫ —Å –æ—Ä–µ—à–∫–∞–º–∏',
        '–û–±–µ–∑–≤—Ä–µ–¥–∏—Ç—å –ª–µ—Å–Ω—É—é –ª–æ–≤—É—à–∫—É',
        '–ü–æ–π–º–∞—Ç—å –ª–µ—Å–Ω–æ–≥–æ –∫–æ—Ç–∞',
        '–î–æ—Å—Ç–∞–≤–∏—Ç—å –º–∞–≥–∏—á–µ—Å–∫–∏–µ —Ü–≤–µ—Ç—ã –∫ —ç–ª—å—Ñ–∏–π—Å–∫–æ–º—É –º—É–¥—Ä–µ—Ü—É'
      ]},
      { name:'–ò–∑–µ–Ω–≥–∞—Ä–¥', diff:'–°–†–ï–î–ù–ï', tasks:[
        '–ó–∞–±—Ä–∞—Ç—å —É —É—Ä—É–∫-—Ö–∞–π –º–µ—á ‚öî',
        '–°—Ç–∞—â–∏—Ç—å –∂–µ–ª–µ–∑–æ —Å–æ —Å–∫–ª–∞–¥–∞ –°–∞—Ä—É–º–∞–Ω–∞',
        '–û—Å–≤–æ–±–æ–¥–∏—Ç—å –∑–∞–ª–æ–∂–Ω–∏–∫–∞ –∏ —É–∫—Ä–∞—Å—Ç—å —è–±–ª–æ–∫–æ üçé',
        '–ü–æ–¥–∂–µ—á—å –¥—Ä–æ–≤—è–Ω—É—é –∫—É—á—É',
        '–†–∞–∑—Ä—É—à–∏—Ç—å –ª–∞–≥–µ—Ä—å –º–æ–±–æ–≤',
        '–ó–∞–±—Ä–∞—Ç—å —à–ª–µ–º —É –≤–∞—Ä–≤–∞—Ä–∞',
        '–ü–æ–π–º–∞—Ç—å —Ä–∞–∑–±–µ–≥–∞—é—â–µ–≥–æ—Å—è –æ—Ä–∫–∞'
      ]},
      { name:'–†–æ—Ö–∞–Ω', diff:'–°–†–ï–î–ù–ï', tasks:[
        '–ó–∞–±—Ä–∞—Ç—å —É –≤—Å–∞–¥–Ω–∏–∫–∞ –∫–æ–Ω—è üê¥',
        '–î–æ—Å—Ç–∞–≤–∏—Ç—å –ø–∏—Å—å–º–æ, –Ω–µ –ø–æ–ø–∞–≤—à–∏—Å—å —Å—Ç—Ä–∞–∂–Ω–∏–∫–∞–º',
        '–°—Ç–∞—â–∏—Ç—å –º–µ—à–æ–∫ –æ–≤—Å–∞',
        '–°–ø–∞—Å—Ç–∏ –ø–æ—Ç–µ—Ä—è–≤—à–µ–≥–æ—Å—è –ª–æ—à–∞–¥–µ–Ω—ã—à–∞',
        '–ü–æ–≥–æ–Ω—è—Ç—å –æ—Ä–∫–æ–≤ –ø–æ —Å—Ç–µ–ø–∏',
        '–ó–∞–±—Ä–∞—Ç—å —à–ª—è–ø—É —É —Ä—ã—Ü–∞—Ä—è',
        '–ù–∞–π—Ç–∏ –ø–æ—Ç–µ—Ä—è–Ω–Ω—ã–π –º–µ—á –≤ —Å—Ç–µ–ø–∏'
      ]},
      { name:'–ì–æ–Ω–¥–æ—Ä', diff:'–°–†–ï–î–ù–ï', tasks:[
        '–ó–∞–±—Ä–∞—Ç—å —É —Å—Ç—Ä–∞–∂–∏ –∫–ª—é—á –æ—Ç –±–∞—à–Ω–∏ üîë',
        '–î–æ—Å—Ç–∞–≤–∏—Ç—å —Å–≤–∏—Ç–æ–∫ —á–µ—Ä–µ–∑ –≥–æ—Ä–æ–¥',
        '–ü–æ–¥–º–µ–Ω–∏—Ç—å –æ—Ä—É–∂–∏–µ —É —Å—Ç—Ä–∞–∂–Ω–∏–∫–æ–≤',
        '–û—Å–≤–æ–±–æ–¥–∏—Ç—å –≥—Ä–∞–∂–¥–∞–Ω, –∑–∞–±—Ä–∞–≤ –∏—Ö —à–ª—è–ø—ã üé©',
        '–£–Ω–∏—á—Ç–æ–∂–∏—Ç—å —Å–∫–ª–∞–¥ —Å –ø—Ä–∏–ø–∞—Å–∞–º–∏ –≤—Ä–∞–≥–∞',
        '–ü–æ–π–º–∞—Ç—å –±–µ–≥—É—â–µ–≥–æ –≥—Ä–∞–∂–¥–∞–Ω–∏–Ω–∞',
        '–ó–∞–±—Ä–∞—Ç—å –º–∞–≥–∏—á–µ—Å–∫–∏–π –∫–∞–º–µ–Ω—å —É —Å—Ç—Ä–∞–∂–Ω–∏–∫–∞'
      ]},
      { name:'–û—Å–≥–∏–ª–∏–∞—Ç', diff:'–ñ–ï–°–¢–ö–û', tasks:[
        '–û—Ç–æ–±—Ä–∞—Ç—å –∫–∞—Ä—Ç—É —É –ª–∞–≥–µ—Ä—è –æ—Ä–∫–æ–≤',
        '–°—Ç–∞—â–∏—Ç—å –ø–æ—Å–æ—Ö —É —Ç–µ–º–Ω–æ–≥–æ –º–∞–≥–∞',
        '–î–æ—Å—Ç–∞–≤–∏—Ç—å —Ä–µ–¥–∫–∏–π –∞—Ä—Ç–µ—Ñ–∞–∫—Ç —á–µ—Ä–µ–∑ –æ–ø–∞—Å–Ω—É—é –∑–æ–Ω—É',
        '–ü–æ–±–µ–¥–∏—Ç—å –º–∏–Ω–∏-–±–æ—Å—Å–æ–≤',
        '–ó–∞–±—Ä–∞—Ç—å –º–∞–≥–∏—á–µ—Å–∫–∏–π –∫—Ä–∏—Å—Ç–∞–ª–ª —É –≤—Ä–∞–≥–∞',
        '–ü–æ–π–º–∞—Ç—å —Ç–µ–º–Ω–æ–≥–æ –∫–æ—Ç–∞ üê±',
        '–£–Ω–∏—á—Ç–æ–∂–∏—Ç—å –≤—Ä–∞–∂–µ—Å–∫–∏–π —Å–∫–ª–∞–¥'
      ]},
      { name:'–ú–∏–Ω–∞—Å –ú–æ—Ä–≥—É–ª', diff:'–ñ–ï–°–¢–ö–û', tasks:[
        '–ó–∞–±—Ä–∞—Ç—å —É –Ω–∞–∑–≥—É–ª–∞ –ø–æ—Å–æ—Ö',
        '–°—Ç–∞—â–∏—Ç—å –º–∞–≥–∏—á–µ—Å–∫–∏–π –∫—Ä–∏—Å—Ç–∞–ª–ª',
        '–†–∞–∑—Ä—É—à–∏—Ç—å –º–∏–Ω–∏-–∫—Ä–µ–ø–æ—Å—Ç—å –∏ –ø—Ä–∏—Ö–≤–∞—Ç–∏—Ç—å —Ñ–ª–∞–≥',
        '–î–æ—Å—Ç–∞–≤–∏—Ç—å —Ä–µ–¥–∫–∏–π –∞—Ä—Ç–µ—Ñ–∞–∫—Ç',
        '–ü–æ–π–º–∞—Ç—å ‚Äú—Ç–µ–º–Ω–æ–≥–æ –∫–æ—Ç—ë–Ω–∫–∞‚Äù üê±',
        '–°—Ç–∞—â–∏—Ç—å —á–µ—Ä–Ω—É—é –º–∞—Å–∫—É —É –≤—Ä–∞–≥–∞',
        '–û—Ç–æ–±—Ä–∞—Ç—å –∫–∞—Ä—Ç—É —É –ª–∞–≥–µ—Ä—è –æ—Ä–∫–æ–≤'
      ]},
      { name:'–ú–æ—Ä–¥–æ—Ä', diff:'–ñ–ï–°–¢–ö–û', tasks:[
        '–£–∫—Ä–∞—Å—Ç—å —É —ç–ª–∏—Ç–Ω–æ–≥–æ –æ—Ä–∫–∞ —à–ª–µ–º',
        '–ó–∞–±—Ä–∞—Ç—å —É –º–∏–Ω–∏-–±–æ—Å—Å–æ–≤ —Ä–µ–ª–∏–∫–≤–∏—é',
        '–ü–æ–¥–∂–µ—á—å —Å–∫–ª–∞–¥—ã –°–∞—ÉÃÅ—Ä–æ–Ω–∞',
        '–ó–∞–±—Ä–∞—Ç—å –º–∞–≥–∏—á–µ—Å–∫—É—é –ø–µ—á–µ–Ω—å–∫—É üç™',
        '–£–Ω–∏—á—Ç–æ–∂–∏—Ç—å –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ —Ç–æ—á–∫–∏',
        '–ü–æ–π–º–∞—Ç—å –æ—Ä–∫–∞-–ø–æ—Å—ã–ª—å–Ω–æ–≥–æ',
        '–ó–∞–±—Ä–∞—Ç—å —á–µ—Ä–Ω—ã–π –º–µ—á —Å –ø–æ–ª—è –±–æ—è'
      ]},
      { name:'–ë–∞—Ä–∞–¥-–î—É—Ä', diff:'–ñ–ï–°–¢–ö–û', tasks:[
        '–ó–∞–±—Ä–∞—Ç—å –∫–æ—Ä–æ–Ω—É —É –æ—Ö—Ä–∞–Ω—ã',
        '–£–Ω–∏—á—Ç–æ–∂–∏—Ç—å —Ç–æ–ø-–±–æ—Å—Å–æ–≤ –∏ –ø—Ä–∏—Ö–≤–∞—Ç–∏—Ç—å —à–º–æ—Ç',
        '–î–æ—Å—Ç–∞–≤–∏—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã',
        '–ü–æ–π–º–∞—Ç—å ‚Äú—Å—É–ø–µ—Ä-–∫–æ—Ç–∞‚Äù üê±‚Äçüë§',
        '–†–∞–∑—Ä—É—à–∏—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ –∑–¥–∞–Ω–∏–µ –∏ –∑–∞–±—Ä–∞—Ç—å —Ñ–ª–∞–≥',
        '–ó–∞–±—Ä–∞—Ç—å –º–∞–≥–∏—á–µ—Å–∫—É—é –ª–∞–º–ø—É',
        '–ü–æ–±–µ–¥–∏—Ç—å –≤—Å–µ—Ö –æ—Ö—Ä–∞–Ω–Ω–∏–∫–æ–≤ –±–∞—à–Ω–∏'
      ]}
    ];
  }

  function firstRunSeed(){
    if (state.inventory && Array.isArray(state.inventory) && state.inventory.every(x=>x===' ')){
      state.inventory[0] = '‚ù§Ô∏è';
      state.inventory[1] = 'üìú';
    }
    feedAdd('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Enhanced Mobile TG Edition','SYS');
  }

  function hardReset(){
    try { localStorage.removeItem(SAVE_KEY); } catch (e) {}
    state = JSON.parse(JSON.stringify(defaults));
    try {
      while (stack.length) {
        const id = stack.pop();
        const mm = $(id);
        if (mm) mm.classList.remove('show');
      }
    } catch (e) {}
    try { document.querySelectorAll('.modal.show').forEach(m=>m.classList.remove('show')); } catch (e) {}
    try { setOverlay(); } catch (e) {}
    try { updateBackButton(); } catch (e) {}
    firstRunSeed();
    toast('–°–±—Ä–æ—à–µ–Ω–æ','lose');
    save();
    renderAll();
  }


  // --- Telegram viewport binding
  function updateTgVh(){
    try {
      let h = 0;
      if (tg) {
        if (typeof tg.viewportStableHeight === 'number' && tg.viewportStableHeight > 0) h = tg.viewportStableHeight;
        if (typeof tg.viewportHeight === 'number' && tg.viewportHeight > 0) h = Math.max(h, tg.viewportHeight);
      }
      if (window.visualViewport && typeof window.visualViewport.height === 'number' && window.visualViewport.height > 0) h = Math.max(h, window.visualViewport.height);
      if (!h) h = window.innerHeight || 0;
      if (h) document.documentElement.style.setProperty('--tg-vh', h + 'px');
    } catch (e) {}
  }
  updateTgVh();
  try { window.addEventListener('resize', updateTgVh); } catch (e) {}
  try { if (window.visualViewport) window.visualViewport.addEventListener('resize', updateTgVh); } catch (e) {}
  try { if (tg && typeof tg.onEvent === 'function') tg.onEvent('viewportChanged', updateTgVh); } catch (e) {}

  // --- Utilities
  const $ = (id)=>document.getElementById(id);
  const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
  const pad2 = (n)=>String(n).padStart(2,'0');
  const now = ()=>Date.now();

  function toast(msg, kind){
    const el = $('toast');
    if (!el) return;
    el.className = 'toast ' + (kind||'');
    el.textContent = String(msg||'');
    el.classList.add('show');
    clearTimeout(window.__toastT);
    window.__toastT = setTimeout(()=>{ el.classList.remove('show'); }, 1400);
  }

  function haptic(style){
    try {
      if (!tg || !tg.HapticFeedback) return;
      if (!state.settings.haptics) return;
      tg.HapticFeedback.impactOccurred(style||'light');
    } catch (e) {}
  }

  // --- Storage
  const SAVE_KEY = 'mora_mobile_save_v2';
  const CURRENCY_CAP = 999999999999;
  function load(){
    try { return JSON.parse(localStorage.getItem(SAVE_KEY) || 'null'); } catch (e) { return null; }
  }
  function save(){
    try {
      state.gold = Math.min(CURRENCY_CAP, Math.max(0, Math.floor(state.gold||0)));
      state.silver = Math.min(CURRENCY_CAP, Math.max(0, Math.floor(state.silver||0)));
      state.tooth = Math.min(CURRENCY_CAP, Math.max(0, Math.floor(state.tooth||0)));
      state.rings = Math.min(CURRENCY_CAP, Math.max(0, Math.floor(state.rings||0)));
      localStorage.setItem(SAVE_KEY, JSON.stringify(state));
      $('syncState').textContent = '–°–ï–ô–í: OK';
      $('syncState').style.opacity = '.85';
    } catch (e) {
      try {
        $('syncState').textContent = '–°–ï–ô–í: ERR';
        $('syncState').style.opacity = '1';
      } catch (e2) {}
    }
  }

  // --- Game data
  const ITEMS = [
    { key:'VIP', name:'VIP —Å—Ç–∞—Ç—É—Å', desc:'–û—Ç–∫—Ä—ã–≤–∞–µ—Ç VIP –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏', cost:500, currency:'TOOTH', apply:()=>{ if (state.vip){ toast('VIP —É–∂–µ –∞–∫—Ç–∏–≤–µ–Ω','lose'); return; } state.vip = true; toast('VIP –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω','win'); } },
    { key:'G1', name:'–ó–æ–ª–æ—Ç–æ', desc:'+50 ü™ô', cost:'1$', currency:'TOOTH', goldAdd:50 },
    { key:'G2', name:'–ó–æ–ª–æ—Ç–æ', desc:'+100 ü™ô', cost:'2$', currency:'TOOTH', goldAdd:100 },
    { key:'G3', name:'–ó–æ–ª–æ—Ç–æ', desc:'+300 ü™ô', cost:'6$', currency:'TOOTH', goldAdd:300 },
    { key:'G4', name:'–ó–æ–ª–æ—Ç–æ', desc:'+500 ü™ô', cost:'10$', currency:'TOOTH', goldAdd:500 },
    { key:'G5', name:'–ó–æ–ª–æ—Ç–æ', desc:'+1 000 ü™ô', cost:'20$', currency:'TOOTH', goldAdd:1000 },
    { key:'G6', name:'–ó–æ–ª–æ—Ç–æ', desc:'+2 500 ü™ô', cost:'50$', currency:'TOOTH', goldAdd:2500 },
    { key:'G7', name:'–ó–æ–ª–æ—Ç–æ', desc:'+5 000 ü™ô', cost:'100$', currency:'TOOTH', goldAdd:5000 },
    { key:'G8', name:'–ó–æ–ª–æ—Ç–æ', desc:'+10 000 ü™ô', cost:'200$', currency:'TOOTH', goldAdd:10000 }
  ];

  const PETS = [
    { id:1, name:'–°—Ç—Ä–∞–∂ –ü–µ–ø–ª–∞', emoji:'üêæ', cost:100, pct:0.20 },
    { id:2, name:'–í–æ–ª–∫ –ù–æ—á–∏', emoji:'üê∫', cost:300, pct:0.30 },
    { id:3, name:'–¢–µ–Ω—å –î—Ä–∞–∫–æ–Ω–∞', emoji:'üêâ', cost:700, pct:0.40 },
    { id:4, name:'–ú–æ—Ä—Å–∫–æ–π –§–µ–Ω–∏–∫—Å', emoji:'ü¶Ö', cost:1500, pct:0.50 }
  ];

  const BOSSES = [
    { id:1, name:'–§—ë–¥–æ—Ä', emoji:'ü¶à', img:'—Ñ—ë–¥–æ—Ä.png', maxHP:1000, reward:{ xp:50, tooth:100, gold:0 } },
    { id:2, name:'–ì–∏–≤–∏', emoji:'üß®', img:'–≥–∏–≤–∏.png', maxHP:10000, reward:{ xp:100, tooth:300, gold:0 } },
    { id:3, name:'–õ–æ–≥–æ–≤–∞–∑', emoji:'ü¶¥', img:'–ª–æ–≥–æ–≤–∞–∑.png', maxHP:50000, reward:{ xp:200, tooth:500, gold:0 } },
    { id:4, name:'–¢–µ–æ–¥–µ–¥', emoji:'ü™ì', img:'—Ç–µ–æ–¥–µ–¥.png', maxHP:200000, reward:{ xp:500, tooth:800, gold:0 } },
    { id:5, name:'–§–∞—Ä–∞–º–∏—Ä', emoji:'üî•', img:'—Ñ–∞—Ä–∞–º–∏—Ä.png', maxHP:1000000, reward:{ xp:1000, tooth:1200, gold:0 } },
    { id:6, name:'–ü–∞—É—á–∏—Ö–∞', emoji:'üï∑Ô∏è', maxHP:2000000, reward:{ xp:2000, tooth:2000, gold:0 } },
    { id:7, name:'–ë–æ—Ä—è –ú–µ–º', emoji:'üå™Ô∏è', img:'–±–æ—Ä—è–º–µ–º.png', maxHP:5000000, reward:{ xp:5000, tooth:5000, gold:0 } },
    { id:8, name:'–°–∞—Ä—É–º—è–Ω', emoji:'üßø', maxHP:10000000, reward:{ xp:10000, tooth:10000, gold:0 } },
    { id:9, name:'–î—Ä–æ–≤–æ—Ä—É–±', emoji:'ü™µ', maxHP:20000000, reward:{ xp:20000, tooth:20000, gold:0 } },
    { id:10, name:'–ü–µ–Ω–¥–∞–ª—å—Ñ', emoji:'üßô', maxHP:50000000, reward:{ xp:50000, tooth:50000, gold:0 } },
    { id:11, name:'–≠–ª—Ä–æ–Ω–¥ –í–µ—á–Ω–æ–ø—Ä–∞–≤', emoji:'üó°Ô∏è', maxHP:100000000, reward:{ xp:100000, tooth:100000, gold:0 } },
    { id:12, name:'–ù–∞–∑–≥—É–ª', emoji:'üó°Ô∏è', maxHP:200000000, reward:{ xp:200000, tooth:200000, gold:0 } }
  ];

  const GYM_STATS = [
    { key:'health', name:'–ó–¥–æ—Ä–æ–≤—å–µ' },
    { key:'strength', name:'–°–∏–ª–∞' },
    { key:'agility', name:'–õ–æ–≤–∫–æ—Å—Ç—å' },
    { key:'initiative', name:'–ò–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞' },
    { key:'endurance', name:'–í—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å' },
    { key:'might', name:'–ú–æ—â—å' },
    { key:'charisma', name:'–•–∞—Ä–∏–∑–º–∞' }
  ];

  // --- State
  const defaults = {
    v:2,
    playerName:'PLAYER',
    level:1,
    xp:0,
    totalXp:0,
    gold:1000000,
    silver:5200,
    tooth:12,
    rings:0,
    energy:100,
    energyMax:100,
    lastEnergyTs: now(),
    nextWinBonus:0,
    settings:{ sound:true, haptics:true, reduced:false },
    inventory: Array(9).fill(' '),
    petsOwned:{},
    activePetId:0,
    gym:{},
    arena:{ cdUntil:0, wins:0, losses:0 },
    groupFight:{ joined:false, startTs:0, resolvedTs:0, battle:null, autoShownStartTs:0, pendingReward:null },
    gf1010:{ joined:false, startTs:0, costPaid:0, gathered:0, matchId:'', fight:{ round:1, turnLeft:10, myTarget:'', targets:[], log:[] } },
    diceGame:{ active:false, rolls:0, max:10, dice:[1,1,1,1,1] },
    consumables:{ med:0, nade:0 },
    clan:{ id:'', name:'', owner:'', createdTs:0, role:'', deputy:'', joinedTs:0 },
    clansDb:{ nextId:1, order:[], clans:{}, myApps:{} },
    promoUsedCodes:{},
    districtTasksDone:{},
    districtTaskCounts:{},
    districtFear:{},
    districtBonusClaimed:{},
    districtClearedEver:{},
    districtFearLeaders:{},
    districtDailyFear:{ day:'', byDistrict:{} },
    districtBizLvls:{},
    districtBizDaily:{ day:'', claimed:{} },
    _bizEnergyApplied:0,
    bosses:{ hp:{}, strikes:10, lastWinners:{}, keys:{}, hitStocks:{ kick:0, knuckle:0, enema:0 }, shopQty:1, hitUseQty:1, fights:{}, dmgLog:{}, dmgTop:{}, daily:{ day:'', counts:{} }, toothNextTs:0 },
    friendHelpLvl:0,
    vip:false,
    shopX2:false,
    feed:[],
    friends:[
      { id:1, name:'–õ–æ—Ä–¥ –¢–µ–Ω–∏', lvl:12, power:1540, online:true },
      { id:2, name:'–ö—Ä–∏—Å—Ç–∞–ª–ª', lvl:7, power:980, online:true },
      { id:3, name:'–í–æ–ª–∫', lvl:19, power:2100, online:false },
      { id:4, name:'–ú–æ—Ä–∞', lvl:3, power:420, online:true },
      { id:5, name:'–§–µ–Ω–∏–∫—Å', lvl:25, power:3200, online:false },
      { id:6, name:'–°—Ñ–µ—Ä–∞', lvl:10, power:1100, online:true }
    ]
  };

  let state = Object.assign({}, defaults, load()||{});
  // normalize
  if (!state.settings) state.settings = Object.assign({}, defaults.settings);
  if (typeof state.totalXp !== 'number') state.totalXp = 0;
  if (!Array.isArray(state.inventory)) state.inventory = Array(9).fill(' ');
  if (!state.petsOwned) state.petsOwned = {};
  if (!state.gym) state.gym = {};
  if (!state.arena) state.arena = Object.assign({}, defaults.arena);
  if (!state.groupFight) state.groupFight = Object.assign({}, defaults.groupFight);
  if (typeof state.groupFight.autoShownStartTs !== 'number') state.groupFight.autoShownStartTs = 0;
  if (typeof state.groupFight.resolvedTs !== 'number') state.groupFight.resolvedTs = 0;
  if (typeof state.groupFight.pendingReward === 'undefined') state.groupFight.pendingReward = null;
  if (!state.gf1010) state.gf1010 = Object.assign({}, defaults.gf1010);
  if (!state.diceGame) state.diceGame = Object.assign({}, defaults.diceGame);
  if (!state.consumables) state.consumables = Object.assign({}, defaults.consumables);
  if (typeof state.consumables.med !== 'number') state.consumables.med = 0;
  if (typeof state.consumables.nade !== 'number') state.consumables.nade = 0;
  if (!state.clan) state.clan = Object.assign({}, defaults.clan);
  if (typeof state.clan.createdTs !== 'number') state.clan.createdTs = 0;
  if (typeof state.clan.id !== 'string') state.clan.id = '';
  if (typeof state.clan.name !== 'string') state.clan.name = '';
  if (typeof state.clan.owner !== 'string') state.clan.owner = '';
  if (typeof state.clan.role !== 'string') state.clan.role = '';
  if (typeof state.clan.deputy !== 'string') state.clan.deputy = '';
  if (typeof state.clan.joinedTs !== 'number') state.clan.joinedTs = 0;
  if (!state.clansDb) state.clansDb = Object.assign({}, defaults.clansDb);
  if (typeof state.clansDb.nextId !== 'number') state.clansDb.nextId = 1;
  if (!Array.isArray(state.clansDb.order)) state.clansDb.order = [];
  if (!state.clansDb.clans || typeof state.clansDb.clans !== 'object') state.clansDb.clans = {};
  if (!state.clansDb.myApps || typeof state.clansDb.myApps !== 'object') state.clansDb.myApps = {};
  if (!state.districtTasksDone || typeof state.districtTasksDone !== 'object') state.districtTasksDone = {};
  if (!state.districtTaskCounts || typeof state.districtTaskCounts !== 'object') state.districtTaskCounts = {};
  if (!state.districtFear || typeof state.districtFear !== 'object') state.districtFear = {};
  if (!state.districtBonusClaimed || typeof state.districtBonusClaimed !== 'object') state.districtBonusClaimed = {};
  if (!state.districtClearedEver || typeof state.districtClearedEver !== 'object') state.districtClearedEver = {};
  if (!state.districtFearLeaders || typeof state.districtFearLeaders !== 'object') state.districtFearLeaders = {};
  if (!state.districtDailyFear || typeof state.districtDailyFear !== 'object') state.districtDailyFear = { day:'', byDistrict:{} };
  if (!state.districtDailyFear.byDistrict || typeof state.districtDailyFear.byDistrict !== 'object') state.districtDailyFear.byDistrict = {};
  if (!state.districtBizLvls || typeof state.districtBizLvls !== 'object') state.districtBizLvls = {};
  if (!state.districtBizDaily || typeof state.districtBizDaily !== 'object') state.districtBizDaily = { day:'', claimed:{} };
  if (!state.districtBizDaily.claimed || typeof state.districtBizDaily.claimed !== 'object') state.districtBizDaily.claimed = {};
  if (typeof state._bizEnergyApplied !== 'number') state._bizEnergyApplied = 0;

  try {
    if (state.districtTasksDone && typeof state.districtTasksDone === 'object'){
      Object.keys(state.districtTasksDone).forEach(k=>{
        if (!state.districtTaskCounts[k]) state.districtTaskCounts[k] = 1;
      });
    }
  } catch (e) {}
  if (!state.bosses) state.bosses = Object.assign({}, defaults.bosses);
  if (!state.bosses.hp) state.bosses.hp = {};
  if (!state.bosses.lastWinners) state.bosses.lastWinners = {};
  if (!state.bosses.keys) state.bosses.keys = {};
  if (!state.bosses.fights) state.bosses.fights = {};
  if (!state.bosses.dmgLog) state.bosses.dmgLog = {};
  if (!state.bosses.dmgTop) state.bosses.dmgTop = {};
  if (!state.bosses.daily) state.bosses.daily = { day:'', counts:{} };
  if (!state.bosses.daily.counts) state.bosses.daily.counts = {};
  if (!state.bosses.hitStocks) state.bosses.hitStocks = { kick:0, knuckle:0, enema:0 };
  if (!state.bosses || typeof state.bosses.toothNextTs === 'undefined') state.bosses.toothNextTs = 0;
  if (typeof state.bosses.shopQty !== 'number') state.bosses.shopQty = 1;
  if (typeof state.bosses.hitUseQty !== 'number') state.bosses.hitUseQty = 1;
  if (typeof state.rings !== 'number') state.rings = 0;
  if (!state.promoUsedCodes || typeof state.promoUsedCodes !== 'object') state.promoUsedCodes = {};

  // migration: old boss key 'ring' conflicted with currency üíç (state.rings)
  try {
    const oldRingKey = parseInt(state.bosses.keys['ring']||0,10)||0;
    if (oldRingKey>0 && (typeof state.bosses.keys['pass'] === 'undefined')) {
      state.bosses.keys['pass'] = oldRingKey;
      delete state.bosses.keys['ring'];
    }
  } catch (e) {}

  state.bosses.hitStocks.kick = clamp(parseInt(state.bosses.hitStocks.kick||0,10)||0, 0, 999999);
  state.bosses.hitStocks.knuckle = clamp(parseInt(state.bosses.hitStocks.knuckle||0,10)||0, 0, 999999);
  state.bosses.hitStocks.enema = clamp(parseInt(state.bosses.hitStocks.enema||0,10)||0, 0, 999999);
  state.bosses.shopQty = clamp(parseInt(state.bosses.shopQty||1,10)||1, 1, 1000);
  state.friendHelpLvl = clamp(parseInt(state.friendHelpLvl||0,10)||0, 0, 10);
  if (!Array.isArray(state.feed)) state.feed = [];
  if (!Array.isArray(state.friends)) state.friends = defaults.friends.slice();

  state.gold = Math.min(CURRENCY_CAP, Math.max(0, Math.floor(state.gold||0)));
  state.silver = Math.min(CURRENCY_CAP, Math.max(0, Math.floor(state.silver||0)));
  state.tooth = Math.min(CURRENCY_CAP, Math.max(0, Math.floor(state.tooth||0)));
  state.rings = Math.min(CURRENCY_CAP, Math.max(0, Math.floor(state.rings||0)));

  // --- Core math
  function xpNeed(level){
    const lvl = Math.max(1, parseInt(level||1,10)||1);
    const base = 1000;
    const targetLvl = 201;
    const targetNeed = 20000000;
    const k = Math.pow((targetNeed / base), (1 / Math.max(1, (targetLvl-1))));
    return Math.max(1, Math.round(base * Math.pow(k, (lvl-1))));
  }
  function addXp(n){
    const add = Math.max(0, Math.floor(n||0));
    state.totalXp = Math.max(0, Math.floor(state.totalXp||0) + add);
    state.xp = Math.max(0, (state.xp||0) + add);
    while (state.xp >= xpNeed(state.level)) {
      state.xp -= xpNeed(state.level);
      state.level += 1;
      state.energy = clamp(Math.floor(state.energyMax||100), 0, Math.floor(state.energyMax||100));
      state.lastEnergyTs = now();
      toast('–£—Ä–æ–≤–µ–Ω—å –ø–æ–≤—ã—à–µ–Ω: ' + state.level,'win');
      haptic('heavy');
    }
  }

  const DISTRICT_REQ_XP = [
    0,
    50,
    150,
    300,
    500,
    800,
    1200,
    1700,
    2300,
    3000,
    3800,
    4700
  ];
  function districtReqXp(idx){
    const i = clamp(parseInt(idx||0,10)||0, 0, 11);
    return parseInt(DISTRICT_REQ_XP[i]||0,10)||0;
  }
  function districtPrevCleared(idx){
    try {
      const i = clamp(parseInt(idx||0,10)||0, 0, 11);
      if (i<=0) return true;
      const prev = i-1;
      const bk = 'D'+String(prev);
      if (state.districtClearedEver && state.districtClearedEver[bk]) return true;
      const data = districtData();
      const d = data[prev];
      if (!d) return true;
      const tasks = Array.isArray(d.tasks) ? d.tasks : [];
      return tasks.every((t, ti)=>{
        const m = districtTaskMeta(d.diff, ti, prev);
        const k = districtTaskKey(prev, ti);
        const c = Math.max(0, (state.districtTaskCounts && state.districtTaskCounts[k]) ? (parseInt(state.districtTaskCounts[k]||0,10)||0) : 0);
        return c >= m.max;
      });
    } catch (e) { return false; }
  }
  function districtReqOk(idx){
    try {
      const need = districtReqXp(idx);
      const cur = Math.max(0, Math.floor(state.totalXp||0));
      return cur >= need;
    } catch (e) { return false; }
  }
  const DEBUG_UNLOCK_ALL_DISTRICTS = true;
  function districtUnlocked(idx){
    if (DEBUG_UNLOCK_ALL_DISTRICTS) return true;
    return districtPrevCleared(idx) && districtReqOk(idx);
  }

  function districtAllTasksDone(dIdx){
    try {
      const data = districtData();
      const d = data[dIdx];
      if (!d) return false;
      const tasks = Array.isArray(d.tasks) ? d.tasks : [];
      return tasks.every((t, ti)=>{
        const m = districtTaskMeta(d.diff, ti, dIdx);
        const k = districtTaskKey(dIdx, ti);
        const c = Math.max(0, (state.districtTaskCounts && state.districtTaskCounts[k]) ? (parseInt(state.districtTaskCounts[k]||0,10)||0) : 0);
        return c >= m.max;
      });
    } catch (e) { return false; }
  }
  function districtResetTasks(dIdx){
    try {
      const data = districtData();
      const d = data[dIdx];
      if (!d) return;
      const tasks = Array.isArray(d.tasks) ? d.tasks : [];
      if (!state.districtTaskCounts || typeof state.districtTaskCounts !== 'object') state.districtTaskCounts = {};
      tasks.forEach((t, ti)=>{
        const k = districtTaskKey(dIdx, ti);
        state.districtTaskCounts[k] = 0;
      });
    } catch (e) {}
  }

  function districtCompletionAutoReward(dIdx){
    try {
      const id = clamp(parseInt(dIdx||0,10)||0, 0, 11);
      if (!districtAllTasksDone(id)) return;
      const mult = (id + 1) * 100;
      const bk = 'D'+String(id);

      addXp(mult);
      state.tooth = Math.min(CURRENCY_CAP, (parseInt(state.tooth||0,10)||0) + mult);

      const curFear = Math.max(0, (state.districtFear && state.districtFear[bk]) ? (parseInt(state.districtFear[bk]||0,10)||0) : 0);
      if (!state.districtFear || typeof state.districtFear !== 'object') state.districtFear = {};
      state.districtFear[bk] = curFear + mult;

      try {
        if (!state.districtClearedEver || typeof state.districtClearedEver !== 'object') state.districtClearedEver = {};
        state.districtClearedEver[bk] = now();
      } catch (e0) {}

      try {
        districtFearLeaderUpdate(id);
        districtDailyFearAdd(id, mult);
      } catch (e1) {}

      districtResetTasks(id);

      toast('–ù–ê–ì–†–ê–î–ê: +'+mult+' XP, +'+mult+' ü¶∑, +'+mult+' üò±','win');
      feedAdd('–ù–∞–≥—Ä–∞–¥–∞ —Ä–∞–π–æ–Ω–∞: +'+mult+' XP, +'+mult+' ü¶∑, +'+mult+' üò±','SYS');
      haptic('heavy');
    } catch (e) {}
  }

  const DISTRICT_BIZ = [
    ['–û–≥–æ—Ä–æ–¥ —Ö–æ–±–±–∏—Ç–æ–≤','–¢–∞–±–∞—á–Ω–∞—è –ª–∞–≤–∫–∞','–ü–µ–∫–∞—Ä–Ω—è','–ú–∞–ª—ã–π —Ç—Ä–∞–∫—Ç–∏—Ä'],
    ['–¢—Ä–∞–∫—Ç–∏—Ä ¬´–ì–∞—Ä—Ü—É—é—â–∏–π –ø–æ–Ω–∏¬ª','–¢–æ—Ä–≥–æ–≤–∞—è –ª–∞–≤–∫–∞','–ö–æ–Ω—é—à–Ω—è','–ö–∞—Ä–∞–≤–∞–Ω–Ω–∞—è —Å—Ç–æ—è–Ω–∫–∞'],
    ['–≠–ª—å—Ñ–∏–π—Å–∫–∞—è –∫—É–∑–Ω–∏—Ü–∞','–ú–∞–≥–∏—á–µ—Å–∫–∞—è –ª–∞–≤–∫–∞','–°–∫–ª–∞–¥ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤','–≠–ª—å—Ñ–∏–π—Å–∫–∞—è –º–∞—Å—Ç–µ—Ä—Å–∫–∞—è'],
    ['–®–∞—Ö—Ç–∞','–°–∫–ª–∞–¥ —Ä—É–¥—ã','–ì–æ–±–ª–∏–Ω—Å–∫–∏–π —Ä—ã–Ω–æ–∫','–ö—É–∑–Ω–∏—Ü–∞ –≥–Ω–æ–º–æ–≤'],
    ['–ú–∞–≥–∏—á–µ—Å–∫–∏–π —Å–∞–¥','–≠–ª—å—Ñ–∏–π—Å–∫–∞—è –º–∞—Å—Ç–µ—Ä—Å–∫–∞—è','–¢–∞–π–Ω—ã–π —Å–∫–ª–∞–¥','–ö—Ä–∏—Å—Ç–∞–ª—å–Ω–∞—è —Ä–æ—â–∞'],
    ['–ö—É–∑–Ω–∏—Ü–∞ —É—Ä—É–∫-—Ö–∞–π','–õ–µ—Å–æ–ø–∏–ª–∫–∞','–í–æ–µ–Ω–Ω—ã–π –ª–∞–≥–µ—Ä—å','–û—Ä—É–∂–µ–π–Ω—ã–π —Å–∫–ª–∞–¥'],
    ['–ö–æ–Ω—é—à–Ω—è','–û—Ä—É–∂–µ–π–Ω–∞—è','–¢–æ—Ä–≥–æ–≤—ã–π –¥–≤–æ—Ä','–§–µ—Ä–º–µ—Ä—Å–∫–æ–µ –ø–æ–¥–≤–æ—Ä—å–µ'],
    ['–û—Ä—É–∂–µ–π–Ω—ã–π —Å–∫–ª–∞–¥','–ë–∞—à–Ω—è –¥–æ–∑–æ—Ä–∞','–ì–æ—Ä–æ–¥—Å–∫–æ–π —Ä—ã–Ω–æ–∫','–ö–∞–∑–∞—Ä–º—ã'],
    ['–†–∞–∑—Ä—É—à–µ–Ω–Ω—ã–π —Å–∫–ª–∞–¥','–í–æ–µ–Ω–Ω–∞—è –±–∞–∑–∞','–¢–∞–π–Ω–∏–∫','–ü–æ–ª–µ–≤–æ–π –ª–∞–≥–µ—Ä—å'],
    ['–¢–µ–º–Ω–∞—è –±–∞—à–Ω—è','–ú–∞–≥–∏—á–µ—Å–∫–∏–π –∞–ª—Ç–∞—Ä—å','–ß–µ—Ä–Ω—ã–π —Ä—ã–Ω–æ–∫','–ö—Ä–µ–ø–æ—Å—Ç–Ω–æ–π –¥–≤–æ—Ä'],
    ['–û—Ä—É–∂–µ–π–Ω—ã–π –∑–∞–≤–æ–¥','–õ–∞–≥–µ—Ä—å –æ—Ä–∫–æ–≤','–°–∫–ª–∞–¥ —Ä–µ—Å—É—Ä—Å–æ–≤','–¢–µ–º–Ω–∞—è –∫—É–∑–Ω–∏—Ü–∞'],
    ['–ì–ª–∞–≤–Ω–∞—è –∫—Ä–µ–ø–æ—Å—Ç—å','–ë–∞—à–Ω—è –°–∞—É—Ä–æ–Ω–∞','–ß–µ—Ä–Ω–∞—è —Å–æ–∫—Ä–æ–≤–∏—â–Ω–∏—Ü–∞','–¢—Ä–æ–Ω–Ω—ã–π –∑–∞–ª']
  ];
  const BIZ_MAX_LVL = 10;
  const BIZ_LVL_COSTS = [
    5000,
    10000,
    50000,
    100000,
    500000,
    1000000,
    5000000,
    10000000,
    50000000,
    100000000
  ];

  const BIZ2_FEAR_PER_LVL = [200,400,600,800,1000,1200,1400,1600,1800,2000];
  const BIZ3_PCT_PER_LVL = [0.005,0.01,0.015,0.02,0.025,0.03,0.035,0.04,0.045,0.05];
  const BIZ4_GOLD_PER_LVL = [1,2,3,4,5,6,7,8,9,10];

  function bizKey(dIdx, bIdx){
    return 'D' + String(dIdx) + 'B' + String(bIdx);
  }
  function bizLvl(dIdx, bIdx){
    try {
      const k = bizKey(dIdx, bIdx);
      const v = state.districtBizLvls && typeof state.districtBizLvls === 'object' ? state.districtBizLvls[k] : 0;
      return clamp(parseInt(v||0,10)||0, 0, BIZ_MAX_LVL);
    } catch (e) { return 0; }
  }
  function bizSetLvl(dIdx, bIdx, lvl){
    if (!state.districtBizLvls || typeof state.districtBizLvls !== 'object') state.districtBizLvls = {};
    state.districtBizLvls[bizKey(dIdx, bIdx)] = clamp(parseInt(lvl||0,10)||0, 0, BIZ_MAX_LVL);
  }
  function bizCostNext(lvl){
    const nxt = clamp((parseInt(lvl||0,10)||0) + 1, 1, BIZ_MAX_LVL);
    const c = BIZ_LVL_COSTS[nxt-1];
    return (typeof c === 'number' && c>0) ? c : 0;
  }

  function bizTotalLvl(bIdx){
    try {
      let sum = 0;
      for (let d=0; d<12; d++) sum += bizLvl(d, bIdx);
      return clamp(sum, 0, 999999);
    } catch (e) { return 0; }
  }
  function bizGymBonusPct(){
    try {
      let pct = 0;
      for (let d=0; d<12; d++){
        const lvl = bizLvl(d, 2);
        if (lvl<=0) continue;
        pct += (BIZ3_PCT_PER_LVL[lvl-1]||0);
      }
      return Math.max(0, pct);
    } catch (e) { return 0; }
  }
  function bizSyncEnergyMax(){
    try {
      const want = bizTotalLvl(0) * 2;
      const cur = Math.max(0, Math.floor(state._bizEnergyApplied||0));
      const delta = want - cur;
      if (delta!==0){
        state.energyMax = Math.max(1, Math.floor(state.energyMax||100) + delta);
        state._bizEnergyApplied = want;
        state.energy = clamp(Math.floor(state.energy||0), 0, state.energyMax);
      }
    } catch (e) {}
  }

  try { bizSyncEnergyMax(); } catch (e) {}

  function bizDailyClaimForDistrict(dIdx){
    try {
      const dayKey = utcDayKey();
      if (!state.districtBizDaily || typeof state.districtBizDaily !== 'object') state.districtBizDaily = { day:'', claimed:{} };
      if (!state.districtBizDaily.claimed || typeof state.districtBizDaily.claimed !== 'object') state.districtBizDaily.claimed = {};
      if (state.districtBizDaily.day !== dayKey){
        state.districtBizDaily.day = dayKey;
        state.districtBizDaily.claimed = {};
      }
      const id = clamp(parseInt(dIdx||0,10)||0, 0, 11);
      const c2k = bizKey(id, 1);
      const c4k = bizKey(id, 3);

      let didAny = false;
      let txt = '';

      if (!state.districtBizDaily.claimed[c2k]){
        const lvl2 = bizLvl(id, 1);
        const addFear = lvl2>0 ? (BIZ2_FEAR_PER_LVL[lvl2-1]||0) : 0;
        if (addFear>0){
          const fk = 'D'+String(id);
          const curFear = Math.max(0, (state.districtFear && state.districtFear[fk]) ? (parseInt(state.districtFear[fk]||0,10)||0) : 0);
          if (!state.districtFear || typeof state.districtFear !== 'object') state.districtFear = {};
          state.districtFear[fk] = curFear + addFear;
          didAny = true;
          txt += (txt?' ¬∑ ':'') + '+'+fmt4(addFear)+' üò±';
        }
        state.districtBizDaily.claimed[c2k] = now();
      }

      if (!state.districtBizDaily.claimed[c4k]){
        const lvl4 = bizLvl(id, 3);
        const addGold = lvl4>0 ? (BIZ4_GOLD_PER_LVL[lvl4-1]||0) : 0;
        if (addGold>0){
          state.gold = Math.min(CURRENCY_CAP, (parseInt(state.gold||0,10)||0) + addGold);
          didAny = true;
          txt += (txt?' ¬∑ ':'') + '+'+fmt4(addGold)+' ü™ô';
        }
        state.districtBizDaily.claimed[c4k] = now();
      }

      if (didAny){
        save();
        renderHUD();
        toast('–ë–ò–ó–ù–ï–°: ' + txt,'win');
      }
    } catch (e) {}
  }

  function renderDistrictBiz(dIdx){
    try {
      const data = districtData();
      const id = clamp(parseInt(dIdx||0,10)||0, 0, data.length-1);
      const unlocked = districtUnlocked(id);
      if (!unlocked) { toast('–†–∞–π–æ–Ω –∑–∞–∫—Ä—ã—Ç','lose'); return; }

      const d = data[id];
      const nm = d && d.name ? d.name : '–†–ê–ô–û–ù';
      const list = Array.isArray(DISTRICT_BIZ[id]) ? DISTRICT_BIZ[id] : [];
      try { $('dbTitle').textContent = '–ë–ò–ó–ù–ï–°'; } catch (e) {}
      try { $('dbDistrict').textContent = String(nm).toUpperCase(); } catch (e) {}
      const box = $('dbList');
      if (!box) return;
      let html = '';
      for (let i=0;i<4;i++){
        const bn = list[i] ? String(list[i]) : ('–ë–∏–∑–Ω–µ—Å '+(i+1));
        const lvl = bizLvl(id, i);
        const maxed = lvl >= BIZ_MAX_LVL;
        const cost = maxed ? 0 : bizCostNext(lvl);
        const hasCost = cost>0;
        let eff = '‚Äî';
        if (i===0){
          const curAdd = lvl*2;
          const nextAdd = (lvl+1)*2;
          eff = '+2 –∫ –º–∞–∫—Å–∏–º—É–º—É —ç–Ω–µ—Ä–≥–∏–∏ –∑–∞ —É—Ä–æ–≤–µ–Ω—å (—Å–µ–π—á–∞—Å +' + curAdd + (maxed?')':(', —Å–ª–µ–¥—É—é—â–∏–π: +' + nextAdd + ')'));
        } else if (i===1){
          const addFear = lvl>0 ? (BIZ2_FEAR_PER_LVL[lvl-1]||0) : 0;
          const nextFear = maxed ? addFear : (BIZ2_FEAR_PER_LVL[lvl]||addFear);
          eff = '–ï–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 00:00 UTC: +' + fmt4(addFear) + ' üò± (–≤ —ç—Ç–æ–º —Ä–∞–π–æ–Ω–µ)' + (maxed ? '' : (' ¬∑ —Å–ª–µ–¥—É—é—â–∏–π: +' + fmt4(nextFear) + ' üò±'));
        } else if (i===2){
          const pct = lvl>0 ? (BIZ3_PCT_PER_LVL[lvl-1]||0) : 0;
          const nextPct = maxed ? pct : (BIZ3_PCT_PER_LVL[lvl]||pct);
          eff = '–ë–æ–Ω—É—Å –∫ —Å–ø–æ—Ä—Ç–∑–∞–ª—É: +' + (pct*100).toFixed(1) + '% (—Å—É–º–º–∏—Ä—É–µ—Ç—Å—è –ø–æ —Ä–∞–π–æ–Ω–∞–º)' + (maxed ? '' : (' ¬∑ —Å–ª–µ–¥—É—é—â–∏–π: +' + (nextPct*100).toFixed(1) + '%'));
        } else if (i===3){
          const addGold = lvl>0 ? (BIZ4_GOLD_PER_LVL[lvl-1]||0) : 0;
          const nextGold = maxed ? addGold : (BIZ4_GOLD_PER_LVL[lvl]||addGold);
          eff = '–ï–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 00:00 UTC: +' + fmt4(addGold) + ' ü™ô' + (maxed ? '' : (' ¬∑ —Å–ª–µ–¥—É—é—â–∏–π: +' + fmt4(nextGold) + ' ü™ô'));
        }
        html += '<div class="card" style="margin:0;">'
          + '<div class="row"><div style="min-width:0"><div class="k">'+String(bn).toUpperCase()+'</div><div style="margin-top:6px; font-size:12px; opacity:.8; line-height:1.35">'+eff+'</div></div>'
          + '<div style="display:flex; flex-direction:column; align-items:flex-end; gap:8px">'
          + '<div class="badge">–£–†–û–í–ï–ù–¨ '+lvl+'/'+BIZ_MAX_LVL+'</div>'
          + '<button class="btn btnSmall" data-biz-up="'+id+':'+i+'" '+((maxed||!hasCost)?'disabled':'')+'>'
          + (maxed ? '–ú–ê–ö–°' : (hasCost ? ('–£–õ–£–ß–®–ò–¢–¨ –ó–ê '+fmt4(cost)+' ü¶∑') : '–°–ö–û–†–û'))
          + '</button>'
          + '</div></div>'
          + '</div>';
      }
      box.innerHTML = html || '‚Äî';

      box.querySelectorAll('[data-biz-up]').forEach(btn=>{
        btn.onclick = ()=>{
          const raw = String(btn.getAttribute('data-biz-up')||'');
          const parts = raw.split(':');
          const dd = clamp(parseInt(parts[0]||'0',10)||0, 0, 11);
          const bb = clamp(parseInt(parts[1]||'0',10)||0, 0, 3);
          const cur = bizLvl(dd, bb);
          if (cur>=BIZ_MAX_LVL){ toast('–£–∂–µ –º–∞–∫—Å–∏–º—É–º','lose'); return; }
          const cost = bizCostNext(cur);
          if (!(cost>0)){ toast('–°–∫–æ—Ä–æ','lose'); return; }
          if ((state.tooth||0) < cost){ toast('–ù—É–∂–Ω–æ '+fmt4(cost)+' ü¶∑','lose'); return; }
          state.tooth -= cost;
          bizSetLvl(dd, bb, cur+1);
          if (bb===0) bizSyncEnergyMax();
          save();
          renderHUD();
          renderDistrictBiz(dd);
          haptic('light');
          toast('–£–ª—É—á—à–µ–Ω–æ','win');
        };
      });

      showModal('mDistrictBiz');
    } catch (e) {}
  }

  function activePet(){
    const id = parseInt(state.activePetId||0,10) || 0;
    return PETS.find(p=>p.id===id) || null;
  }
  function petBonusPct(){
    const p = activePet();
    return p ? (p.pct||0) : 0;
  }

  function feedAdd(text, kind){
    const t = String(text||'').trim();
    if (!t) return;
    const tag = kind ? '['+kind+'] ' : '';
    state.feed.unshift(tag + t);
    if (state.feed.length>18) state.feed = state.feed.slice(0,18);
  }

  // --- Modal system
  const overlay = $('overlay');
  const stack = [];
  const SCREEN_IDS = new Set(['mArena','mBoss','mTop','mDice','mDistricts','mBattle']);
  function setOverlay(){
    if (!overlay) return;
    const top = stack.length ? stack[stack.length-1] : '';
    overlay.classList.toggle('show', stack.length>0);
  }
  function showModal(id){
    const m = $(id);
    if (!m) return;
    if (id==='mBattle'){
      try { hideModal('mGFJoin'); } catch (e) {}
      try { hideModal('mGF1010'); } catch (e) {}
    }
    if (!stack.includes(id)) stack.push(id);
    m.classList.add('show');
    setOverlay();
    updateBackButton();
  }

  function openScreen(id){
    try { document.querySelectorAll('.modal.show').forEach(m=>m.classList.remove('show')); } catch (e) {}
    stack.length = 0;
    showModal(id);
  }
  function hideModal(id){
    const m = $(id);
    if (!m) return;
    m.classList.remove('show');
    const idx = stack.lastIndexOf(id);
    if (idx>=0) stack.splice(idx,1);
    setOverlay();
    updateBackButton();

    if (id==='mBossFight'){
      while (stack.length) {
        const top = stack[stack.length-1];
        const mm = $(top);
        if (mm) mm.classList.remove('show');
        stack.pop();
      }
      setOverlay();
      updateBackButton();
    }
  }
  function hideTop(){
    const id = stack[stack.length-1];
    if (id) hideModal(id);
  }

  function updateBackButton(){
    try {
      if (!tg || !tg.BackButton) return;
      if (stack.length>0) {
        tg.BackButton.show();
      } else {
        tg.BackButton.hide();
      }
    } catch (e) {}
  }

  try { if (tg && tg.BackButton) tg.BackButton.onClick(()=>{ hideTop(); }); } catch (e) {}

  // --- Rendering
  function fmtK(n){
    n = Math.floor(n||0);
    if (n<1000) return String(n);
    if (n<1000000) return (Math.floor(n/100)/10)+'K';
    return (Math.floor(n/100000)/10)+'M';
  }

  function fmt4(n){
    n = Math.floor(n||0);
    if (n < 10000) return String(n);
    if (n < 1000000) return String(Math.floor(n/1000)) + 'K';
    if (n < 1000000000) return String(Math.floor(n/1000000)) + 'M';
    return '999M';
  }

  function renderUTC(){
    const utc = $('utc');
    if (!utc) return;
    const d = new Date();
    const y = d.getUTCFullYear();
    const m = d.getUTCMonth();
    const day = d.getUTCDate();
    const h = d.getUTCHours();
    const mm = d.getUTCMinutes();
    utc.textContent = pad2(h) + ':' + pad2(mm);
  }

  function renderHUD(){
    renderUTC();
    $('playerName').textContent = state.playerName;
    $('playerLevel').textContent = '–£–†. ' + state.level;

    try {
      const a = $('btnArena');
      if (a) a.style.display = ($('mBattle') && $('mBattle').classList.contains('show')) ? 'none' : '';
    } catch (e0) {}

    $('gold').textContent = fmt4(state.gold||0);
    $('silver').textContent = fmt4(state.silver||0);
    $('tooth').textContent = fmt4(state.tooth||0);

    $('energy').textContent = String(Math.floor(state.energy||0));
    $('energyMax').textContent = String(Math.floor(state.energyMax||0));

    const need = xpNeed(state.level);
    const cur = Math.floor(state.xp||0);
    const pct = need>0 ? clamp((cur/need)*100,0,100) : 0;
    $('xpFill').style.width = pct.toFixed(2)+'%';
    $('xpText').textContent = cur + ' / ' + need + ' XP';
  }

  function renderFriends(){
    const row = $('friendsRow');
    if (!row) return;
    row.innerHTML = '';
    const list = (state.friends||[]);
    if (!list.length){
      const d = document.createElement('div');
      d.className = 'friendCard';
      d.style.opacity = '0.75';
      d.textContent = '–ü–æ–∫–∞ –Ω–µ—Ç –¥—Ä—É–∑–µ–π. –ù–∞–∂–º–∏ + –î–†–£–ì.';
      row.appendChild(d);
      return;
    }
    const sorted = list.slice().sort((a,b)=>{
      const al = parseInt(a && a.lvl || 1,10)||1;
      const bl = parseInt(b && b.lvl || 1,10)||1;
      if (bl !== al) return bl - al;
      const ap = parseInt(a && a.power || 0,10)||0;
      const bp = parseInt(b && b.power || 0,10)||0;
      return bp - ap;
    }).slice(0, 20);

    sorted.forEach((f, idx)=>{
      const c = document.createElement('div');
      c.className = 'friendCard';
      const on = !!f.online;
      const medal = idx===0 ? 'ü•á' : (idx===1 ? 'ü•à' : (idx===2 ? 'ü•â' : ''));
      c.innerHTML = ''
        + '<div class="friendTop"><div class="friendName">'+(medal?('<span style="margin-right:6px">'+medal+'</span>'):'')+String(f.name||'–î—Ä—É–≥')+'</div><div class="dot '+(on?'on':'')+'"></div></div>'
        + '<div class="friendMeta">–£—Ä. '+(f.lvl||1)+' ‚Ä¢ –°–∏–ª–∞ '+(f.power||0)+'</div>';
      c.onclick = ()=>{ toast('#'+(idx+1)+' ' + (f.name||'–î—Ä—É–≥') + ' ¬∑ —É—Ä. ' + (f.lvl||1)); haptic('light'); };
      row.appendChild(c);
    });
  }

  function renderTopBrosModal(){
    try {
      const box = $('topBrosList');
      const badge = $('topBrosBadge');
      if (!box || !badge) return;
      const list = Array.isArray(state.friends) ? state.friends.slice() : [];
      const sorted = list.slice().sort((a,b)=>{
        const al = parseInt(a && a.lvl || 1,10)||1;
        const bl = parseInt(b && b.lvl || 1,10)||1;
        if (bl !== al) return bl - al;
        const ap = parseInt(a && a.power || 0,10)||0;
        const bp = parseInt(b && b.power || 0,10)||0;
        return bp - ap;
      }).slice(0, 100);
      badge.textContent = String(sorted.length);
      box.innerHTML = sorted.length ? sorted.map((f,idx)=>{
        const medal = idx===0 ? 'ü•á' : (idx===1 ? 'ü•à' : (idx===2 ? 'ü•â' : ''));
        const left = medal ? ('<div class="badge" style="padding:6px 8px; font-size:11px">'+medal+'</div>') : '';
        const val = '–£–†. '+(parseInt(f.lvl||1,10)||1);
        return '<div class="row">'
          + '<div style="display:flex; align-items:center; gap:8px; min-width:0; flex:1">'
          + left
          + '<div style="min-width:0; font-size:12px; opacity:.9">#'+(idx+1)+' '+String(f.name||'‚Äî')+'</div>'
          + '</div>'
          + '<div class="badge" style="padding:6px 8px; font-size:11px">'+val+'</div>'
          + '</div>';
      }).join('') : '<div style="opacity:.75; font-size:12px">‚Äî</div>';
    } catch (e) {}
  }

  function renderClanTopModal(){
    try {
      const box = $('clanTopMembersFull');
      const badge = $('clanTopBadgeFull');
      if (!box || !badge) return;
      const c = clanGetMyClan();
      if (!c) {
        badge.textContent = '‚Äî';
        box.innerHTML = '<div style="opacity:.75; font-size:12px">‚Äî</div>';
        return;
      }
      if (!c.memberMeta || typeof c.memberMeta !== 'object') c.memberMeta = {};
      clanEnsureMemberMeta(c);
      const mem = Array.isArray(c.members) ? c.members : [];
      const rows = mem.map(nm=>{
        const mm = (c.memberMeta && c.memberMeta[nm]) ? c.memberMeta[nm] : clanGuessMemberMeta(nm);
        return { who: nm, lvl: parseInt(mm && mm.lvl || 1,10)||1, stats: parseInt(mm && mm.stats || 0,10)||0 };
      }).sort((a,b)=>{
        if (b.lvl !== a.lvl) return b.lvl - a.lvl;
        return b.stats - a.stats;
      }).slice(0, 100);
      badge.textContent = String(rows.length);
      box.innerHTML = rows.length ? rows.map((r,i)=>{
        const badge2 = '<div class="badge" style="padding:6px 8px; font-size:11px">–£–†. '+r.lvl+'</div>';
        return '<div class="row">'
          + '<div style="min-width:0; font-size:12px; opacity:.9">#'+(i+1)+' '+String(r.who)+'</div>'
          + badge2
          + '</div>';
      }).join('') : '<div style="opacity:.75; font-size:12px">‚Äî</div>';
    } catch (e) {}
  }

  function renderClanChatModal(){
    try {
      const box = $('clanChatListFull');
      const badge = $('clanChatBadgeFull');
      const send = $('clanChatSendFull');
      if (!box || !badge || !send) return;
      const c = clanGetMyClan();
      if (!c) {
        badge.textContent = '‚Äî';
        box.innerHTML = '<div style="opacity:.75; font-size:12px">‚Äî</div>';
        send.style.display = 'none';
        return;
      }
      if (!Array.isArray(c.chat)) c.chat = [];
      badge.textContent = String(c.chat.length);
      const me = clanMyName();
      const arr = c.chat.slice(-60);
      box.innerHTML = arr.length ? arr.map(e=>{
        const from = String(e && e.from || '‚Äî');
        const txt = String(e && e.text || '');
        const isMe = String(from) === String(me);
        const wrap = 'display:flex; ' + (isMe ? 'justify-content:flex-end;' : 'justify-content:flex-start;');
        const bubble = 'max-width:85%; padding:10px 12px; border-radius:14px; font-size:12px; line-height:1.35; '
          + (isMe ? 'background:rgba(59,130,246,.20); border:1px solid rgba(59,130,246,.25); text-align:right;' : 'background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.10);');
        const head = isMe ? '' : ('<div style="font-size:10px; opacity:.65; margin-bottom:4px">'+from+'</div>');
        return '<div style="'+wrap+'">'
          + '<div style="'+bubble+'">'
          + head
          + '<div>'+txt+'</div>'
          + '</div>'
          + '</div>';
      }).join('') : '<div style="opacity:.75; font-size:12px">‚Äî</div>';
      try { box.scrollTop = box.scrollHeight; } catch (e2) {}
      send.style.display = '';
      send.onclick = ()=>{ clanChatSend(); renderClanChatModal(); };
    } catch (e) {}
  }

  function gfShowBattleResult(win){
    try {
      const out = $('brOutcome');
      const rew = $('brReward');
      const ok = $('brOk');
      const pr = state.groupFight && state.groupFight.pendingReward ? state.groupFight.pendingReward : null;
      if (out) {
        out.textContent = win ? '–ü–û–ë–ï–î–ê' : '–ü–û–†–ê–ñ–ï–ù–ò–ï';
        out.style.color = win ? 'rgba(52,211,153,.95)' : 'rgba(251,113,133,.95)';
      }
      if (rew) {
        if (pr && (parseInt(pr.tooth||0,10)||0)>0 || (pr && (parseInt(pr.gold||0,10)||0)>0)){
          const mm = parseInt(pr.tooth||0,10)||0;
          const gg = parseInt(pr.gold||0,10)||0;
          let t = '';
          if (mm>0) t += '+'+mm+' ü¶∑';
          if (gg>0) t += (t?' ':'') + '+'+gg+' ü™ô';
          rew.textContent = t || '‚Äî';
          rew.style.color = 'var(--gold)';
        } else {
          rew.textContent = '‚Äî';
          rew.style.color = '';
        }
      }
      if (ok) {
        const hasReward = !!(pr && ((parseInt(pr.tooth||0,10)||0)>0 || (parseInt(pr.gold||0,10)||0)>0));
        ok.textContent = hasReward ? '–ó–ê–ë–†–ê–¢–¨' : '–ù–ê–ó–ê–î';
        ok.onclick = ()=>{
          if (hasReward){
            const mm = parseInt(pr.tooth||0,10)||0;
            const gg = parseInt(pr.gold||0,10)||0;
            if (mm>0) state.tooth += mm;
            if (gg>0) state.gold += gg;
          }
          state.groupFight.pendingReward = null;
          save();
          hideModal('mBattleRes');
          hideModal('mBattle');
          openScreen('mArena');
          renderAll();
        };
      }
      showModal('mBattleRes');
    } catch (e) {}
  }

  function battlePickTarget(id){
    const b = state.groupFight && state.groupFight.battle;
    if (!b) return;
    b.myTarget = String(id||'');
    try { $('bTarget').textContent = b.myTarget || '–ê–≤—Ç–æ'; } catch (e) {}
    save();
    renderBattle();
    haptic('light');
  }

  function arenaCdLeft(){
    return Math.max(0, (state.arena && state.arena.cdUntil ? (state.arena.cdUntil - now()) : 0));
  }
  function fmtMMSS(ms){
    const sec = Math.ceil(ms/1000);
    const mm = Math.floor(sec/60);
    const ss = sec%60;
    return pad2(mm)+':'+pad2(ss);
  }

  function fmtHHMMSS(ms){
    const sec = Math.ceil(ms/1000);
    const hh = Math.floor(sec/3600);
    const mm = Math.floor((sec%3600)/60);
    const ss = sec%60;
    return pad2(hh)+':'+pad2(mm)+':'+pad2(ss);
  }

  function renderArena(){
    const left = arenaCdLeft();
    const card = $('arenaCdCard');
    if (left>0){
      card.style.display = '';
      $('arenaCd').textContent = fmtMMSS(left);
    } else {
      card.style.display = 'none';
    }

    // group hint on arena
    renderGroupFightUI();

    try {
      const sec = $('arenaSectionGroup');
      if (sec) sec.style.display = '';
      const backBtn = $('gf1010Open');
      if (backBtn){
        if (isGroupBattleActive()) backBtn.textContent = '–í–ï–†–ù–£–¢–¨–°–Ø –í –ë–û–ô';
        else backBtn.textContent = '–í–•–û–î';
      }
    } catch (e) {}
  }

  function renderArenaPetShop(){
    const wrap = $('arenaPetShop');
    if (!wrap) return;
    wrap.innerHTML = '';
    PETS.forEach(p=>{
      const owned = !!state.petsOwned[String(p.id)];
      const isActive = (parseInt(state.activePetId||0,10)||0) === p.id;

      const hasAny = (parseInt(state.activePetId||0,10)||0) > 0;
      const curPetId = parseInt(state.activePetId||0,10)||0;
      const curPet = curPetId ? (PETS.find(x=>x.id===curPetId) || null) : null;

      const card = document.createElement('div');
      card.className = 'petCard';
      card.style.borderColor = isActive ? 'rgba(251,191,36,.55)' : '';

      const meta = document.createElement('div');
      meta.className = 'pTop';
      meta.innerHTML = '<div class="petPic"><div class="pIco">'+p.emoji+'</div><div class="petPct">+'+Math.round(p.pct*100)+'%</div></div>';
      card.appendChild(meta);

      if (!owned) {
        const buy = document.createElement('button');
        buy.className = 'btn btnSmall pBtn';
        buy.textContent = p.cost + ' ü™ô';
        buy.onclick = ()=>{
          if (hasAny) { toast('–°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–¥–∞–π —Ç–µ–∫—É—â–µ–≥–æ –ø–∏—Ç–æ–º—Ü–∞','lose'); return; }
          if ((state.gold||0) < p.cost) { toast('–ù—É–∂–Ω–æ '+p.cost+' ü™ô','lose'); return; }
          state.gold -= p.cost;
          state.petsOwned = {};
          state.petsOwned[String(p.id)] = true;
          state.activePetId = p.id;
          feedAdd('–ö—É–ø–ª–µ–Ω –ø–∏—Ç–æ–º–µ—Ü ' + p.emoji + ' ' + p.name,'PET');
          toast('–ü–∏—Ç–æ–º–µ—Ü –∫—É–ø–ª–µ–Ω','win');
          haptic('medium');
          save();
          renderAll();
        };
        card.appendChild(buy);
      }

      if (isActive) {
        const sell = document.createElement('button');
        sell.className = 'btn btnSmall pBtn';
        const back = Math.max(0, Math.floor((p.cost||0) * 0.50));
        sell.textContent = '–ü–†–û–î–ê–¢–¨ +'+back+' ü™ô';
        sell.style.opacity = '.9';
        sell.onclick = ()=>{
          state.gold += back;
          state.activePetId = 0;
          state.petsOwned = {};
          feedAdd('–ü—Ä–æ–¥–∞–Ω –ø–∏—Ç–æ–º–µ—Ü ' + p.emoji + ' ' + p.name + ' (+'+back+' ü™ô)','PET');
          toast('–ü–∏—Ç–æ–º–µ—Ü –ø—Ä–æ–¥–∞–Ω','win');
          haptic('light');
          save();
          renderAll();
        };
        card.appendChild(sell);
      }

      wrap.appendChild(card);
    });
  }

  function tryArenaFight(kind){
    if (arenaCdLeft()>0){ toast('–ü–æ–¥–æ–∂–¥–∏ –∫—É–ª–¥–∞—É–Ω','lose'); return; }
    // —ç–Ω–µ—Ä–≥–∏—è –±–æ–ª—å—à–µ –Ω–µ —É—á–∞—Å—Ç–≤—É–µ—Ç –≤ –±–æ—è—Ö –∞—Ä–µ–Ω—ã

    const pMin = kind==='ELITE' ? 1.11 : (kind==='NORMAL' ? 0.91 : 0.50);
    const pMax = kind==='ELITE' ? 1.30 : (kind==='NORMAL' ? 1.10 : 0.90);
    const mult = pMin + Math.random() * (pMax - pMin);

    function effStat(k){
      const cur = gymVal(k);
      const pct = gymBonusPct();
      let add = Math.round(cur*pct);
      if (pct>0 && cur>0 && add<=0) add = 1;
      return cur + add;
    }

    const pRaw = {
      health: gymVal('health'),
      strength: gymVal('strength'),
      agility: gymVal('agility'),
      initiative: gymVal('initiative'),
      endurance: gymVal('endurance'),
      might: gymVal('might'),
      charisma: gymVal('charisma')
    };
    const p = {
      health: effStat('health'),
      strength: effStat('strength'),
      agility: effStat('agility'),
      initiative: effStat('initiative'),
      endurance: effStat('endurance'),
      might: effStat('might'),
      charisma: pRaw.charisma
    };
    const e = {
      health: Math.max(1, Math.round(pRaw.health * mult)),
      strength: Math.max(1, Math.round(pRaw.strength * mult)),
      agility: Math.max(1, Math.round(pRaw.agility * mult)),
      initiative: Math.max(1, Math.round(pRaw.initiative * mult)),
      endurance: Math.max(1, Math.round(pRaw.endurance * mult)),
      might: Math.max(1, Math.round(pRaw.might * mult))
    };

    const bonus = clamp(state.nextWinBonus||0, 0, 0.60);
    state.nextWinBonus = 0;

    let pHP = Math.max(1, Math.round(60 + p.health * 6));
    let eHP = Math.max(1, Math.round(60 + e.health * 6));
    let youDmg = 0;
    let enemyDmg = 0;
    let rounds = 0;
    const combatLog = [];

    function hitChance(attAgi, defAgi, hitBonus){
      const rel = (attAgi - defAgi) / Math.max(1, (attAgi + defAgi));
      return clamp(0.80 + rel*0.35 + (hitBonus||0)*0.45, 0.10, 0.95);
    }
    function critChance(attM, defM){
      return clamp(0.06 + (attM / Math.max(1, attM + defM + 30)) * 0.28, 0.05, 0.30);
    }
    function dmgReduction(defEnd, attStr){
      return clamp((defEnd / Math.max(1, defEnd + attStr + 60)) * 0.35, 0, 0.35);
    }
    function baseDamage(attStr){
      return 5 + attStr * 1.25;
    }

    function doAttack(isPlayer, round){
      const A = isPlayer ? p : e;
      const D = isPlayer ? e : p;
      const hpRef = isPlayer ? 'e' : 'p';
      const hc = hitChance(A.agility, D.agility, isPlayer ? bonus : 0);
      if (Math.random() > hc) {
        combatLog.push({ round: round, who: isPlayer ? 'YOU' : 'ENEMY', miss:true, crit:false, dmg:0 });
        return;
      }

      let dmg = baseDamage(A.strength);
      const isCrit = Math.random() < critChance(A.might, D.might);
      if (isCrit) dmg *= (1.5 + Math.random()*0.5);
      dmg *= (1 - dmgReduction(D.endurance, A.strength));
      dmg = Math.max(1, Math.round(dmg));

      combatLog.push({ round: round, who: isPlayer ? 'YOU' : 'ENEMY', miss:false, crit:isCrit, dmg:dmg });

      if (hpRef==='e') {
        eHP = Math.max(0, eHP - dmg);
        youDmg += dmg;
      } else {
        pHP = Math.max(0, pHP - dmg);
        enemyDmg += dmg;
      }
    }

    function firstStrikeChance(){
      const rel = (p.initiative - e.initiative) / Math.max(1, (p.initiative + e.initiative));
      return clamp(0.5 + rel*0.35, 0.10, 0.90);
    }

    while (pHP>0 && eHP>0 && rounds<20) {
      rounds += 1;
      const pFirst = Math.random() < firstStrikeChance();
      if (pFirst) {
        doAttack(true, rounds);
        if (eHP>0) doAttack(false, rounds);
      } else {
        doAttack(false, rounds);
        if (pHP>0) doAttack(true, rounds);
      }
    }

    let win = false;
    if (pHP>0 && eHP<=0) win = true;
    else if (pHP<=0 && eHP>0) win = false;
    else win = pHP >= eHP;
    const chaCost = gymCost(gymVal('charisma'));
    const mulMin = kind==='ELITE' ? 3.0 : (kind==='NORMAL' ? 2.8 : 2.5);
    const mulMax = kind==='ELITE' ? 3.2 : (kind==='NORMAL' ? 3.0 : 2.8);
    const mul = mulMin + Math.random() * (mulMax - mulMin);
    const silverGain = win ? Math.max(0, Math.round(chaCost * mul)) : Math.max(0, Math.round(chaCost * 0.5));
    const xpGain = win ? 5 : 0;

    const oppPool = kind==='ELITE'
      ? ['–ö–∞–ø–∏—Ç–∞–Ω –ì–∏–ª—å–¥–∏–∏','–°—Ç–∞—Ä—à–∏–π –ß–µ–º–ø–∏–æ–Ω','–ü–∞–ª–∞—á –ê—Ä–µ–Ω—ã','–ú–∞—Å—Ç–µ—Ä –ö—Ä—É–≥–∞']
      : (kind==='NORMAL'
        ? ['–†–∞–≤–Ω—ã–π –ë–æ–µ—Ü','–û–ø—ã—Ç–Ω—ã–π –î—É—ç–ª—è–Ω—Ç','–ó–∞–∫–∞–ª—ë–Ω–Ω—ã–π –í–æ–∏–Ω','–ë–æ–µ—Ü –°–º–µ–Ω—ã']
        : ['–ù–æ–≤–∏—á–æ–∫','–°–ª–∞–±–∞–∫','–£—á–µ–Ω–∏–∫','–°—Ç–∞–∂—ë—Ä']);
    const oppName = oppPool[Math.floor(Math.random()*oppPool.length)];
    try {
      $('arOpponent').textContent = oppName;
      $('arYouDmg').textContent = String(youDmg);
      $('arEnemyDmg').textContent = String(enemyDmg);
      $('arOutcome').textContent = win ? '–ü–û–ë–ï–î–ê' : '–ü–û–†–ê–ñ–ï–ù–ò–ï';

      const logBox = $('arenaCombatLog');
      if (logBox){
        if (!combatLog.length) {
          logBox.innerHTML = '<div style="opacity:.8">‚Äî</div>';
        } else {
          let out = '';
          combatLog.forEach(ev=>{
            let text = '';
            let color = '';
            if (ev.miss) {
              color = 'rgba(52,211,153,.95)';
              text = (ev.who==='YOU')
                ? '–¢—ã –ø—Ä–æ–º–∞—Ö–Ω—É–ª—Å—è –∏ –Ω–µ –Ω–∞–Ω–µ—Å —É—Ä–æ–Ω–∞ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫—É'
                : '–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫ –ø—Ä–æ–º–∞—Ö–Ω—É–ª—Å—è –∏ –Ω–µ –Ω–∞–Ω–µ—Å —Ç–µ–±–µ —É—Ä–æ–Ω–∞';
            } else {
              if (ev.crit) color = 'rgba(251,113,133,.95)';
              if (ev.who==='YOU') {
                text = ev.crit
                  ? ('–¢—ã –Ω–∞–Ω–µ—Å –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫—É –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —É—Ä–æ–Ω –≤ —Ä–∞–∑–º–µ—Ä–µ ' + ev.dmg)
                  : ('–¢—ã –Ω–∞–Ω–µ—Å –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫—É —É—Ä–æ–Ω –≤ —Ä–∞–∑–º–µ—Ä–µ ' + ev.dmg);
              } else {
                text = ev.crit
                  ? ('–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫ –Ω–∞–Ω–µ—Å —Ç–µ–±–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —É—Ä–æ–Ω –≤ —Ä–∞–∑–º–µ—Ä–µ ' + ev.dmg)
                  : ('–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫ –Ω–∞–Ω–µ—Å —Ç–µ–±–µ —É—Ä–æ–Ω –≤ —Ä–∞–∑–º–µ—Ä–µ ' + ev.dmg);
              }
            }

            out += '<div class="feedItem" style="' + (color?('color:'+color+';'):'') + '">' 
              + '<span style="opacity:.7">–†–ê–£–ù–î '+ev.round+'</span> '
              + text
              + '</div>';
          });
          logBox.innerHTML = out;
        }
      }
    } catch (e) {}
    showModal('mArenaRes');

    if (win){
      state.arena.wins = (state.arena.wins||0)+1;
      state.silver += silverGain;
      addXp(xpGain);
      feedAdd('–ü–æ–±–µ–¥–∞ –≤ –ë–æ–π—Ü–æ–≤—Å–∫–æ–º –∫–ª—É–±–µ ('+kind+'): +'+silverGain+'ü•à +'+xpGain+'XP', 'ARENA');
      toast('–ü–û–ë–ï–î–ê','win');
      haptic('heavy');
    } else {
      state.arena.losses = (state.arena.losses||0)+1;
      state.silver += silverGain;
      feedAdd('–ü–æ—Ä–∞–∂–µ–Ω–∏–µ –≤ –ë–æ–π—Ü–æ–≤—Å–∫–æ–º –∫–ª—É–±–µ ('+kind+'): +'+silverGain+'ü•à','ARENA');
      toast('–ü–û–†–ê–ñ–ï–ù–ò–ï','lose');
      haptic('medium');
    }

    state.arena.cdUntil = now() + 1000;
    save();
    renderAll();
  }

  // --- Group fight
  function gfNextStartTs(){
    const d = new Date();
    const y = d.getUTCFullYear();
    const m = d.getUTCMonth();
    const day = d.getUTCDate();
    const h = d.getUTCHours();
    const mm = d.getUTCMinutes();
    let start = Date.UTC(y,m,day,h,mm,0,0);
    if (start <= now()) start += 60*1000;
    return start;
  }
  function gfCost(startTs){
    const hh = new Date(startTs).getUTCHours();
    return (hh % 2 === 0) ? 20 : 2;
  }
  function gfFmt(ts){
    const d = new Date(ts);
    return pad2(d.getUTCHours())+':'+pad2(d.getUTCMinutes());
  }

  function gf1010Render(){
    const startTs = gfNextStartTs();
    const cost = gfCost(startTs);
    const nowTs = now();
    const joinOpen = (nowTs >= (startTs - 60*1000)) && (nowTs < startTs);

    const joined = !!state.gf1010.joined && (parseInt(state.gf1010.startTs||0,10)||0) === startTs;
    $('gf10Start').textContent = gfFmt(startTs);
    $('gf10Cost').textContent = cost + ' ü™ô';

    // placeholder: local counter until backend
    state.gf1010.gathered = clamp(parseInt(state.gf1010.gathered||0,10)||0, 0, 999);
    $('gf10Count').textContent = String(state.gf1010.gathered||0);

    const st = $('gf10Status');
    if (!joinOpen){
      st.textContent = '–û–∫–Ω–æ –∑–∞—è–≤–æ–∫ –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –∑–∞ 1 –º–∏–Ω—É—Ç—É –¥–æ —Å—Ç–∞—Ä—Ç–∞.';
    } else {
      const closeIn = Math.max(0, startTs - nowTs);
      st.textContent = joined ? ('–ó–∞—è–≤–∫–∞ –ø–æ–¥–∞–Ω–∞. –î–æ —Å—Ç–∞—Ä—Ç–∞: ' + fmtMMSS(closeIn)) : ('–û–∫–Ω–æ –∑–∞—è–≤–æ–∫ –æ—Ç–∫—Ä—ã—Ç–æ: ' + fmtMMSS(closeIn));
    }

    $('gf10Join').disabled = !joinOpen || joined;
    $('gf10Join').style.opacity = (!joinOpen || joined) ? '.65' : '1';
    $('gf10Leave').style.display = joined ? '' : 'none';

    // fight card (stub)
    const fightOn = joined && nowTs >= startTs;
    $('gf10FightCard').style.display = fightOn ? '' : 'none';
    $('gf10TargetsCard').style.display = fightOn ? '' : 'none';
    $('gf10LogCard').style.display = fightOn ? '' : 'none';

    if (fightOn){
      gf1010RenderFight();
    }
  }

  function gf1010Join(){
    const startTs = gfNextStartTs();
    const cost = gfCost(startTs);
    const nowTs = now();
    const joinOpen = (nowTs >= (startTs - 60*1000)) && (nowTs < startTs);
    if (!joinOpen){ toast('–û–∫–Ω–æ –µ—â—ë –∑–∞–∫—Ä—ã—Ç–æ','lose'); gf1010Render(); return; }
    if ((state.gold||0) < cost){ toast('–ù—É–∂–Ω–æ '+cost+' ü™ô','lose'); return; }

    // placeholder local join until backend
    state.gold -= cost;
    state.gf1010.joined = true;
    state.gf1010.startTs = startTs;
    state.gf1010.costPaid = cost;
    state.gf1010.gathered = (parseInt(state.gf1010.gathered||0,10)||0) + 1;
    state.gf1010.fight = { round:1, turnLeft:10, myTarget:'', targets:[], log:[] };

    toast('–ó–∞—è–≤–∫–∞ –ø–æ–¥–∞–Ω–∞','win');
    haptic('medium');
    save();
    gf1010Render();
    renderHUD();
  }

  function gf1010Leave(){
    if (!state.gf1010.joined) return;
    // no refund in stub, refund is server-authoritative later
    state.gf1010.joined = false;
    state.gf1010.startTs = 0;
    state.gf1010.costPaid = 0;
    toast('–ó–∞—è–≤–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞','lose');
    haptic('light');
    save();
    gf1010Render();
    renderHUD();
  }

  function gf1010EnsureTargets(){
    const f = state.gf1010.fight;
    if (!f.targets || !f.targets.length){
      f.targets = [
        { id:'E1', name:'–í–æ–∏–Ω', hp:120 },
        { id:'E2', name:'–°—Ç—Ä–∞–∂', hp:110 },
        { id:'E3', name:'–î—É—ç–ª—è–Ω—Ç', hp:105 },
        { id:'E4', name:'–ö–∞–ø–∏—Ç–∞–Ω', hp:130 },
        { id:'E5', name:'–ú–∞–≥', hp:95 }
      ];
      f.log = ['–û–∂–∏–¥–∞–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞: —ç—Ç–æ UI-–∑–∞–≥–æ—Ç–æ–≤–∫–∞ —Ä–µ–∂–∏–º–∞ 10√ó10.'];
    }
  }

  function gf1010PickTarget(id){
    state.gf1010.fight.myTarget = id;
    try { $('gf10Target').textContent = id; } catch (e) {}
    haptic('light');
    save();
    gf1010RenderFight();
  }

  function gf1010RenderFight(){
    const f = state.gf1010.fight;
    if (!f) return;
    gf1010EnsureTargets();
    $('gf10Round').textContent = String(parseInt(f.round||1,10)||1);
    $('gf10Timer').textContent = String(parseInt(f.turnLeft||10,10)||0);
    $('gf10Target').textContent = f.myTarget ? String(f.myTarget) : '–ê–≤—Ç–æ';

    const list = $('gf10Targets');
    list.innerHTML = '';
    f.targets.forEach(t=>{
      const row = document.createElement('div');
      row.className = 'gfItem';
      row.innerHTML = '<div><div class="nm">'+t.id+' ‚Ä¢ '+t.name+'</div><div class="meta">HP '+t.hp+'</div></div>';
      const b = document.createElement('button');
      b.className = 'btn btnSmall gfMiniBtn';
      b.textContent = '–ê–¢–ê–ö–ê';
      b.onclick = ()=>gf1010PickTarget(t.id);
      row.appendChild(b);
      list.appendChild(row);
    });

    const log = $('gf10Log');
    log.innerHTML = '';
    (f.log||[]).slice(0,10).forEach(t=>{
      const d = document.createElement('div');
      d.className = 'feedItem';
      d.textContent = t;
      log.appendChild(d);
    });
  }

  function renderGroupFightUI(){
    const startTs = gfNextStartTs();
    const cost = gfCost(startTs);
    const joined = !!state.groupFight.joined && (parseInt(state.groupFight.startTs||0,10)||0) > 0;
    const nowTs = now();
    const joinOpen = (nowTs >= (startTs - 60*1000)) && (nowTs < startTs);

    const hint = $('arenaGroupHint');
    if (hint) hint.textContent = '';

    // Group modal
    $('gfStart').textContent = gfFmt(startTs);
    $('gfCost').textContent = cost + ' ü™ô';

    const st = $('gfStatus');
    const enterBtn = $('gfEnter');

    if (joined){
      st.textContent = '';
      enterBtn.style.display = (nowTs >= startTs) ? '' : 'none';
      enterBtn.textContent = '–í–û–ô–¢–ò –í –ë–û–ô';
    } else {
      if (!joinOpen){
        st.textContent = '–û–∫–Ω–æ –∑–∞—è–≤–æ–∫ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –∑–∞ 1 –º–∏–Ω—É—Ç—É –¥–æ —Å—Ç–∞—Ä—Ç–∞.';
      } else {
        st.textContent = '–û–∫–Ω–æ –∑–∞—è–≤–æ–∫ –æ—Ç–∫—Ä—ã—Ç–æ (1 –º–∏–Ω—É—Ç–∞).';
      }
      enterBtn.style.display = 'none';
    }
  }

  function renderGFJoinMini(){
    const startTs = gfNextStartTs();
    const cost = gfCost(startTs);
    const nowTs = now();
    const joinOpen = (nowTs >= (startTs - 60*1000)) && (nowTs < startTs);
    const joined = !!state.groupFight.joined && (parseInt(state.groupFight.startTs||0,10)||0) === startTs;
    $('gfJoinStart').textContent = gfFmt(startTs);
    $('gfJoinCost').textContent = cost + ' ü™ô';
    $('gfJoinLeft').textContent = fmtMMSS(Math.max(0, startTs - nowTs));
    const b = $('gfJoinBtn');
    b.disabled = !joinOpen || joined;
    b.style.opacity = (!joinOpen || joined) ? '0.65' : '1';
    b.textContent = joined ? '–ó–ê–Ø–í–ö–ê –û–¢–ü–†–ê–í–õ–ï–ù–ê' : '–ü–û–î–ê–¢–¨ –ó–ê–Ø–í–ö–£';

    const t = $('gfJoinBtnTimer');
    if (t){
      if (joined){
        t.textContent = fmtMMSS(Math.max(0, startTs - nowTs));
      } else {
        const openAt = startTs - 60*1000;
        t.textContent = fmtMMSS(Math.max(0, openAt - nowTs));
      }
    }
  }

  function isGroupBattleActive(){
    try {
      const st = parseInt(state.groupFight && state.groupFight.startTs || 0, 10) || 0;
      if (!st) return false;
      if (now() < st) return false;
      const b = state.groupFight && state.groupFight.battle;
      if (!b) return true;
      const aliveEnemies = Array.isArray(b.targets) ? b.targets.some(x=>(parseInt(x.hp||0,10)||0) > 0) : false;
      return aliveEnemies;
    } catch (e) { return false; }
  }

  function gfJoin(){
    const startTs = gfNextStartTs();
    const cost = gfCost(startTs);
    const nowTs = now();
    const joinOpen = (nowTs >= (startTs - 60*1000)) && (nowTs < startTs);
    if (!joinOpen){ renderGroupFightUI(); toast('–†–∞–Ω–æ. –û–∫–Ω–æ –µ—â—ë –∑–∞–∫—Ä—ã—Ç–æ','lose'); return; }
    if ((state.gold||0) < cost){ toast('–ù—É–∂–Ω–æ '+cost+' ü™ô','lose'); return; }

    state.gold -= cost;
    state.groupFight.joined = true;
    state.groupFight.startTs = startTs;
    state.groupFight.resolvedTs = 0;
    state.groupFight.battle = null;

    feedAdd('–ó–∞—è–≤–∫–∞ –≤ –≥—Ä—É–ø–ø–æ–≤–æ–π –±–æ–π –ø–æ–¥–∞–Ω–∞. –°—Ç–∞—Ä—Ç: '+gfFmt(startTs)+' UTC','GF');
    toast('–ó–∞—è–≤–∫–∞ –ø–æ–¥–∞–Ω–∞','win');
    haptic('medium');
    save();
    renderAll();
  }

  function gfEnsureBattle(){
    const startTs = parseInt(state.groupFight.startTs||0,10)||0;
    if (!startTs) return null;
    if (now() < startTs) return null;

    if (state.groupFight.battle && state.groupFight.battle.startTs === startTs) return state.groupFight.battle;

    // create battle
    const health = gfEffStat('health');
    const strength = gfEffStat('strength');
    const agility = gfEffStat('agility');
    const initiative = gfEffStat('initiative');
    const endurance = gfEffStat('endurance');
    const might = gfEffStat('might');
    const p = {
      eh: gfEffForMatch(health),
      es: gfEffForMatch(strength),
      ea: gfEffForMatch(agility),
      ei: gfEffForMatch(initiative),
      ee: gfEffForMatch(endurance),
      em: gfEffForMatch(might)
    };
    const e = {
      eh: p.eh,
      es: p.es,
      ea: p.ea,
      ei: p.ei,
      ee: p.ee,
      em: p.em
    };
    const myMaxHp = Math.max(1, gfMaxHp(p.eh));
    const enemyMaxHp = Math.max(1, gfMaxHp(e.eh));
    const pMit = gfMitigation(p.ee);
    const eMit = gfMitigation(e.ee);
    const pDodge = gfDodgeChance(p.ea);
    const eDodge = gfDodgeChance(e.ea);
    const pCrit = gfCritChance(p.em);
    const eCrit = gfCritChance(e.em);
    const pDmgBase = gfBaseDamage(p.es);
    const eDmgBase = gfBaseDamage(e.es);
    const cost = gfCost(startTs);
    const battle = {
      startTs,
      cost,
      createdTs: now(),
      round: 1,
      turnLeft: 30,
      acted: false,
      myMaxHp,
      myHp: myMaxHp,
      log: [],
      dmgBy: {},
      pMit,
      eMit,
      pDodge,
      eDodge,
      pCrit,
      eCrit,
      pDmgBase,
      eDmgBase,
      enemyMaxHp,
      myTarget: '',
      myTeam: [],
      targets: Array.from({length:10}).map((_,i)=>({ id:'E'+(i+1), hp: enemyMaxHp, maxHp: enemyMaxHp }))
    };
    try {
      const allies = [];
      const fr = Array.isArray(state.friends) ? state.friends : [];
      for (let i=0;i<9;i++){
        const f = fr[i];
        allies.push({
          id:'A'+(i+1),
          name: (f && f.name) ? String(f.name) : ('–°–æ—é–∑–Ω–∏–∫ '+(i+1)),
          hp: myMaxHp,
          maxHp: myMaxHp
        });
      }
      battle.myTeam = [{ id:'YOU', name:(state.playerName||'–¢–´'), hp: myMaxHp, maxHp: myMaxHp }].concat(allies);
    } catch (e) { battle.myTeam = [{ id:'YOU', name:(state.playerName||'–¢–´'), hp: myMaxHp, maxHp: myMaxHp }]; }

    try {
      if (!battle.dmgBy || typeof battle.dmgBy !== 'object') battle.dmgBy = {};
      (battle.myTeam||[]).forEach(u=>{
        const id = String(u.id||'');
        if (!id) return;
        battle.dmgBy[id] = 0;
      });
    } catch (e2) {}
    battle.log.unshift({ kind:'SYS', text:'–ë–æ–π –Ω–∞—á–∞–ª—Å—è!' });

    state.groupFight.battle = battle;
    return battle;
  }

  function renderBattle(){
    const b = state.groupFight.battle;
    if (!b) return;
    try { const r = $('bRound'); if (r) r.textContent = String(b.round||1); } catch (e) {}
    try { const t = $('bTimer'); if (t) t.textContent = String(b.turnLeft||0); } catch (e) {}
    try {
      const hi = $('bHeadInfo');
      if (hi) hi.textContent = '–†–ê–£–ù–î ' + String(b.round||1) + ' ¬∑ ' + String(b.turnLeft||0);
    } catch (e) {}
    const myHp = parseInt(b.myHp||0,10)||0;
    const myMax = parseInt(b.myMaxHp||0,10)||0;
    const myPct = (myMax>0) ? Math.round(clamp((myHp/myMax)*100,0,100)) : 0;

    try { $('bTarget').textContent = b.myTarget ? String(b.myTarget) : '‚Äî'; } catch (e) {}
    $('bAct').textContent = (b.acted ? '0' : '1');

    // teams
    const enemyTeam = $('bEnemyTeam');
    const myTeam = $('bMyTeam');
    enemyTeam.innerHTML = '';
    myTeam.innerHTML = '';

    try {
      if (!Array.isArray(b.myTeam) || b.myTeam.length<1) b.myTeam = [{ id:'YOU', name:(state.playerName||'–¢–´'), hp: myMax, maxHp: myMax }];
      b.myTeam.forEach(p=>{
        const id = String(p.id||'');
        const nm = String(p.name||id||'‚Äî');
        const hp0 = (id==='YOU') ? myHp : (parseInt(p.hp||0,10)||0);
        const mx0raw = (id==='YOU') ? myMax : (parseInt(p.maxHp||0,10)||0);
        const mx0 = mx0raw>0 ? mx0raw : Math.max(1, hp0);
        const dead = hp0<=0;
        const pct0 = (mx0>0) ? Math.round(clamp((hp0/mx0)*100,0,100)) : 0;
        const el = document.createElement('div');
        el.className = 'badge';
        el.style.padding = '6px 8px';
        el.style.opacity = dead ? '0.45' : '1';
        if (id==='YOU'){
          el.style.border = '2px solid rgba(59,130,246,.9)';
          el.style.boxShadow = '0 0 0 3px rgba(59,130,246,.18)';
        }
        el.innerHTML = ''
          + '<div style="font-weight:900; letter-spacing:1px; font-size:11px; line-height:1.1">'+nm+'</div>'
          + '<div style="font-size:11px; font-weight:900; opacity:.92; letter-spacing:1px; width:100%; text-align:center;">'+(dead?'DEAD':(hp0+'/'+mx0))+'</div>';
        myTeam.appendChild(el);
      });
    } catch (e) {}

    const atk = $('bAtkList');
    if (atk) atk.innerHTML = '';

    (b.targets||[]).forEach(t=>{
      const hp = parseInt(t.hp||0,10)||0;
      const mxRaw = parseInt(t.maxHp||0,10)||0;
      const mx = mxRaw>0 ? mxRaw : Math.max(1, hp);
      const dead = hp <= 0;
      const pct = (mx>0) ? Math.round(clamp((hp/mx)*100,0,100)) : 0;
      const el = document.createElement('div');
      el.className = 'badge';
      el.style.padding = '6px 8px';
      el.style.opacity = dead ? '0.45' : '1';
      el.innerHTML = ''
        + '<div style="font-weight:900; letter-spacing:1px; font-size:11px; line-height:1.1">'+t.id+'</div>'
        + '<div style="font-size:11px; font-weight:900; opacity:.92; letter-spacing:1px; width:100%; text-align:center;">'+(dead?'DEAD':(hp+'/'+mx))+'</div>';
      enemyTeam.appendChild(el);

      if (atk){
        const slot = document.createElement('div');
        slot.className = 'gfAtkSlot';
        if (!dead){
          const btn = document.createElement('button');
          btn.className = 'btn btnSmall gfAtkBtn';
          const locked = (parseInt(b.turnLeft||0,10)||0) <= 0;
          const spectator = (myHp<=0);
          btn.disabled = locked || !!b.acted || spectator;
          btn.style.opacity = btn.disabled ? '0.55' : (b.myTarget===t.id ? '1' : '.9');
          btn.textContent = '‚öîÔ∏è';
          btn.onclick = ()=>{
            battlePickTarget(t.id);
            battleHit(t.id);
          };
          slot.appendChild(btn);
        }
        atk.appendChild(slot);
      }
    });

    const log = $('bLog');
    log.innerHTML = '';
    const flt = (b.log||[]).filter(ev=>{
      if (!ev || ev.kind==='SYS') return false;
      const tx = (ev && ev.text) ? String(ev.text) : '';
      if (!tx) return false;
      return (tx.indexOf('–¢—ã ')===0) || (tx.indexOf('—Ç–µ–±–µ')>=0) || (tx.indexOf('—Ç–µ–±—è')>=0);
    });
    flt.slice(0,11).forEach(ev=>{
      const d = document.createElement('div');
      d.className = 'feedItem';
      if (ev && ev.kind==='MISS') d.style.color = 'rgba(52,211,153,.95)';
      if (ev && ev.kind==='CRIT') d.style.color = 'rgba(251,113,133,.95)';
      d.textContent = (ev && ev.text) ? ev.text : String(ev||'');
      log.appendChild(d);
    });
  }

  function battleHit(id){
    const b = state.groupFight.battle;
    if (!b) return;
    if ((parseInt(b.myHp||0,10)||0) <= 0){ toast('–¢—ã –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—å','lose'); return; }
    b.myTarget = String(id||'');
    try { $('bTarget').textContent = b.myTarget || '–ê–≤—Ç–æ'; } catch (e) {}
    if (b.acted) { toast('–¢–æ–ª—å–∫–æ 1 —É–¥–∞—Ä –∑–∞ —Ö–æ–¥','lose'); return; }
    if ((parseInt(b.turnLeft||0,10)||0) <= 0) return;
    const t = b.targets.find(x=>x.id===id);
    if (!t || (t.hp||0)<=0) return;

    const h = gfDoHit(parseFloat(b.pDmgBase||0)||0, parseFloat(b.pCrit||0)||0, parseFloat(b.eDodge||0)||0, parseFloat(b.eMit||0)||0, true);
    const real = Math.min((parseInt(t.hp||0,10)||0), parseInt(h.dmg||0,10)||0);
    t.hp = Math.max(0, (parseInt(t.hp||0,10)||0) - real);
    b.acted = true;
    try {
      if (!b.dmgBy || typeof b.dmgBy !== 'object') b.dmgBy = {};
      b.dmgBy.YOU = (parseInt(b.dmgBy.YOU||0,10)||0) + (parseInt(real||0,10)||0);
    } catch (e0) {}
    if (h.dodge) b.log.unshift({ kind:'MISS', text:'–¢—ã –ø—Ä–æ–º–∞—Ö–Ω—É–ª—Å—è –∏ –Ω–µ –Ω–∞–Ω–µ—Å —É—Ä–æ–Ω–∞ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫—É' });
    else if (h.crit) b.log.unshift({ kind:'CRIT', text:'–¢—ã –Ω–∞–Ω–µ—Å –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫—É –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —É—Ä–æ–Ω –≤ —Ä–∞–∑–º–µ—Ä–µ ' + real });
    else b.log.unshift({ kind:'HIT', text:'–¢—ã –Ω–∞–Ω–µ—Å –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫—É —É—Ä–æ–Ω –≤ —Ä–∞–∑–º–µ—Ä–µ ' + real });

    // win condition
    const alive = b.targets.some(x=>(x.hp||0)>0);
    if (!alive){
      const rr = gfBattleComputeReward(b, true);
      b.log.unshift({ kind:'SYS', text:'–ü–æ–±–µ–¥–∞ –∫–æ–º–∞–Ω–¥—ã! –ù–∞–≥—Ä–∞–¥–∞: +' + (parseInt(rr.gold||0,10)||0) + ' ü™ô' });
      state.groupFight.pendingReward = rr;
      state.groupFight.joined = false;
      state.groupFight.startTs = 0;
      state.groupFight.resolvedTs = now();
      // keep battle for view until close
      feedAdd('–ü–æ–±–µ–¥–∞ –≤ –≥—Ä—É–ø–ø–æ–≤–æ–º –±–æ—é!','GF');
      toast('–ü–û–ë–ï–î–ê','win');
      save();
      renderAll();
      haptic('heavy');
      gfShowBattleResult(true);
      return;
    }

    save();
    renderBattle();
    haptic('light');
  }

  function battleWeakestTarget(b){
    if (!b || !Array.isArray(b.targets)) return null;
    const alive = b.targets.filter(x=>(parseInt(x.hp||0,10)||0) > 0);
    if (!alive.length) return null;
    alive.sort((a,bb)=>(parseInt(a.hp||0,10)||0) - (parseInt(bb.hp||0,10)||0));
    return alive[0];
  }
  function battleAutoHit(){
    const b = state.groupFight.battle;
    if (!b) return;
    if (b.acted) return;
    const t = battleWeakestTarget(b);
    if (!t) return;

    const h = gfDoHit(parseFloat(b.pDmgBase||0)||0, parseFloat(b.pCrit||0)||0, parseFloat(b.eDodge||0)||0, parseFloat(b.eMit||0)||0, true);
    const real = Math.min((parseInt(t.hp||0,10)||0), parseInt(h.dmg||0,10)||0);
    t.hp = Math.max(0, (parseInt(t.hp||0,10)||0) - real);
    b.acted = true;
    try {
      if (!b.dmgBy || typeof b.dmgBy !== 'object') b.dmgBy = {};
      b.dmgBy.YOU = (parseInt(b.dmgBy.YOU||0,10)||0) + (parseInt(real||0,10)||0);
    } catch (e0) {}
    if (h.dodge) b.log.unshift({ kind:'MISS', text:'–¢—ã –ø—Ä–æ–º–∞—Ö–Ω—É–ª—Å—è –∏ –Ω–µ –Ω–∞–Ω–µ—Å —É—Ä–æ–Ω–∞ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫—É' });
    else if (h.crit) b.log.unshift({ kind:'CRIT', text:'–¢—ã –Ω–∞–Ω–µ—Å –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫—É –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —É—Ä–æ–Ω –≤ —Ä–∞–∑–º–µ—Ä–µ ' + real });
    else b.log.unshift({ kind:'HIT', text:'–¢—ã –Ω–∞–Ω–µ—Å –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫—É —É—Ä–æ–Ω –≤ —Ä–∞–∑–º–µ—Ä–µ ' + real });
  }

  function battleAlliesTurn(){
    const b = state.groupFight && state.groupFight.battle;
    if (!b) return;
    if (!Array.isArray(b.myTeam) || b.myTeam.length<2) return;
    const aliveTargets = Array.isArray(b.targets) ? b.targets.filter(x=>(parseInt(x.hp||0,10)||0) > 0) : [];
    if (!aliveTargets.length) return;

    // —Å–æ—é–∑–Ω–∏–∫–∏ –±—å—é—Ç –ø–æ 1 —Ü–µ–ª–∏ –∫–∞–∂–¥—ã–π (—Å–∏–º—É–ª—è—Ü–∏—è)
    for (let i=0;i<b.myTeam.length;i++){
      const u = b.myTeam[i];
      const uid = String(u && u.id || '');
      if (!uid || uid==='YOU') continue;
      const uhp = parseInt(u && u.hp || 0, 10) || 0;
      if (uhp<=0) continue;
      const tgt = aliveTargets[Math.floor(Math.random()*aliveTargets.length)];
      if (!tgt || (parseInt(tgt.hp||0,10)||0) <= 0) continue;
      const h = gfDoHit(parseFloat(b.pDmgBase||0)||0, parseFloat(b.pCrit||0)||0, parseFloat(b.eDodge||0)||0, parseFloat(b.eMit||0)||0, true);
      const real = Math.min((parseInt(tgt.hp||0,10)||0), parseInt(h.dmg||0,10)||0);
      tgt.hp = Math.max(0, (parseInt(tgt.hp||0,10)||0) - real);
      try {
        if (!b.dmgBy || typeof b.dmgBy !== 'object') b.dmgBy = {};
        b.dmgBy[uid] = (parseInt(b.dmgBy[uid]||0,10)||0) + (parseInt(real||0,10)||0);
      } catch (e0) {}
    }
  }
  function battleEnemyTurn(){
    const b = state.groupFight.battle;
    if (!b) return;
    const alive = Array.isArray(b.targets) ? b.targets.some(x=>(parseInt(x.hp||0,10)||0) > 0) : false;
    if (!alive) return;

    try {
      if (!Array.isArray(b.myTeam) || b.myTeam.length<1){
        const mm = parseInt(b.myMaxHp||0,10)||0;
        b.myTeam = [{ id:'YOU', name:(state.playerName||'–¢–´'), hp:mm, maxHp:mm }];
      }
    } catch (e0) {}

    const youHp = parseInt(b.myHp||0,10)||0;
    const aliveUnits = (b.myTeam||[]).filter(u=>{
      const id = String(u.id||'');
      if (id==='YOU') return youHp > 0;
      return (parseInt(u.hp||0,10)||0) > 0;
    });
    if (!aliveUnits.length) return;

    const aliveEnemies = Array.isArray(b.targets) ? b.targets.filter(x=>(parseInt(x.hp||0,10)||0) > 0) : [];
    const hits = Math.max(1, aliveEnemies.length);
    for (let i=0;i<hits;i++){
      if (!aliveUnits.length) break;
      const h = gfDoHit(parseFloat(b.eDmgBase||0)||0, parseFloat(b.eCrit||0)||0, parseFloat(b.pDodge||0)||0, parseFloat(b.pMit||0)||0, true);

      const pick = aliveUnits[Math.floor(Math.random()*aliveUnits.length)];
      const pid = String(pick.id||'');
      const pname = String(pick.name||pid||'');
      const curHp = (pid==='YOU') ? (parseInt(b.myHp||0,10)||0) : (parseInt(pick.hp||0,10)||0);
      const real = Math.min(curHp, parseInt(h.dmg||0,10)||0);
      const nextHp = Math.max(0, curHp - real);
      if (pid==='YOU') b.myHp = nextHp;
      else pick.hp = nextHp;

      if (h.dodge) b.log.unshift({ kind:'MISS', text:'–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫ –ø—Ä–æ–º–∞—Ö–Ω—É–ª—Å—è –∏ –Ω–µ –Ω–∞–Ω–µ—Å —É—Ä–æ–Ω–∞ ' + pname });
      else if (h.crit) b.log.unshift({ kind:'CRIT', text:'–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫ –Ω–∞–Ω–µ—Å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —É—Ä–æ–Ω ' + pname + ' –≤ —Ä–∞–∑–º–µ—Ä–µ ' + real });
      else b.log.unshift({ kind:'HIT', text:'–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫ –Ω–∞–Ω–µ—Å —É—Ä–æ–Ω ' + pname + ' –≤ —Ä–∞–∑–º–µ—Ä–µ ' + real });

      // refresh alive list after hit
      const youHp2 = parseInt(b.myHp||0,10)||0;
      for (let k=aliveUnits.length-1;k>=0;k--){
        const u = aliveUnits[k];
        const uid = String(u.id||'');
        const uhp2 = (uid==='YOU') ? youHp2 : (parseInt(u.hp||0,10)||0);
        if (uhp2<=0) aliveUnits.splice(k,1);
      }
    }

    const youAlive = (parseInt(b.myHp||0,10)||0) > 0;
    const allyAlive = Array.isArray(b.myTeam) ? b.myTeam.some(u=>String(u.id||'')!=='YOU' && (parseInt(u.hp||0,10)||0) > 0) : false;
    if (!youAlive && !allyAlive){
      b.log.unshift({ kind:'SYS', text:'–ü–æ—Ä–∞–∂–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã!' });
      state.groupFight.pendingReward = gfBattleComputeReward(b, false);
      state.groupFight.joined = false;
      state.groupFight.startTs = 0;
      state.groupFight.resolvedTs = now();
      feedAdd('–ü–æ—Ä–∞–∂–µ–Ω–∏–µ –≤ –≥—Ä—É–ø–ø–æ–≤–æ–º –±–æ—é.','GF');
      toast('–ü–û–†–ê–ñ–ï–ù–ò–ï','lose');
      save();
      renderAll();
      gfShowBattleResult(false);
    }
  }

  function gfEnterBattle(){
    const b = gfEnsureBattle();
    if (!b){ toast('–ë–æ–π –µ—â—ë –Ω–µ –Ω–∞—á–∞–ª—Å—è','lose'); return; }
    // hide group fight entry modals while the battle is ongoing
    try { hideModal('mGFJoin'); } catch (e) {}
    try { hideModal('mGF1010'); } catch (e) {}
    showModal('mBattle');
    renderBattle();
  }

  function tickGF1010(){
    if (!state.gf1010 || !state.gf1010.joined) return;
    const startTs = parseInt(state.gf1010.startTs||0,10)||0;
    if (!startTs) return;
    if (now() < startTs) return;
    const f = state.gf1010.fight;
    if (!f) return;
    if (!$('mGF1010').classList.contains('show')) return;
    f.turnLeft = Math.max(0, (parseInt(f.turnLeft||10,10)||0) - 1);
    if (f.turnLeft<=0){
      f.round = (parseInt(f.round||1,10)||1) + 1;
      f.turnLeft = 10;
      if (Array.isArray(f.log)) f.log.unshift('–ù–æ–≤—ã–π —Ä–∞—É–Ω–¥: ' + f.round);
    }
  }

  // --- Gym
  function gymVal(k){
    const v = parseInt(state.gym[k]||1,10);
    return isNaN(v) || v<1 ? 1 : v;
  }
  function gymCost(cur){
    return 100 + (cur-1)*13;
  }
  function gymBonusPct(){
    return petBonusPct() + bizGymBonusPct();
  }
  function renderGym(){
    $('gymPetBonus').textContent = Math.round(gymBonusPct()*100) + '%';
    const box = $('gymList');
    let total = 0;
    let html = '<div class="statGrid">';

    GYM_STATS.forEach(s=>{
      const cur = gymVal(s.key);
      const pct = gymBonusPct();
      let add = Math.round(cur*pct);
      if (pct>0 && cur>0 && add<=0) add = 1;
      const tot = cur + add;
      const cost = gymCost(cur);
      total += tot;
      html += '<div class="statTile">'
        + '<div class="stK">'+s.name.toUpperCase()+'</div>'
        + '<div class="stV">'+tot+'</div>'
        + '<div class="stMeta">–ë–∞–∑–∞ '+cur+' + '+add+'</div>'
        + '<button class="btn btnSmall stBtn" data-gym="'+s.key+'">'+cost+' ü•à</button>'
        + '</div>';
    });

    const wins = (state.arena && state.arena.wins) ? state.arena.wins : 0;
    const losses = (state.arena && state.arena.losses) ? state.arena.losses : 0;
    html += '<div class="statTile" style="border-color:rgba(192,132,252,.22)">'
      + '<div class="stK">–°–¢–ê–¢–ò–°–¢–ò–ö–ê</div>'
      + '<div class="stV">'+wins+' / '+losses+'</div>'
      + '<div class="stMeta">–ü–æ–±–µ–¥—ã / –ü–æ—Ä–∞–∂–µ–Ω–∏—è<br>–û–±—â–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:<br><span style="font-weight:900">'+total+'</span></div>'
      + '</div>';

    html += '</div>';
    box.innerHTML = html;

    box.querySelectorAll('[data-gym]').forEach(btn=>{
      btn.onclick = ()=>{
        const key = btn.getAttribute('data-gym');
        const cur = gymVal(key);
        const cost = gymCost(cur);
        if ((state.silver||0) < cost){ toast('–ù—É–∂–Ω–æ '+cost+' ü•à','lose'); return; }
        state.silver -= cost;
        state.gym[key] = cur+1;
        feedAdd('–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞: '+key+' ‚Üí '+(cur+1),'GYM');
        toast('–ü—Ä–æ–∫–∞—á–∞–Ω–æ','win');
        save();
        renderAll();
        haptic('light');
      };
    });
  }

  // --- Shop
  const PROMO_CODE = 'BRATSTVO5';
  const PROMO_START_TS = 0;
  const PROMO_WINDOW_HOURS = 48;
  const PROMO_REWARD = {
    gold: 99999999999999999,
    silver: 9999999999999999999,
    tooth: 9999999999999999999,
    rings: 9999999999999999999
  };

  function promoNorm(s){
    return String(s||'').trim().toUpperCase().replace(/\s+/g,'');
  }
  function promoRewardClean(){
    const r = PROMO_REWARD || {};
    const promoInt = (v)=>{
      try {
        if (typeof v === 'number'){
          if (!isFinite(v)) return 0;
          return Math.max(0, Math.floor(v));
        }
        const s = String(v||'').trim();
        if (!s) return 0;
        const n = parseInt(s.replace(/[^0-9-]/g,''), 10);
        return Math.max(0, isNaN(n) ? 0 : n);
      } catch (e) { return 0; }
    };
    return {
      gold: promoInt(r.gold),
      silver: promoInt(r.silver),
      tooth: promoInt(r.tooth),
      rings: promoInt(r.rings)
    };
  }
  function promoRewardText(r){
    const parts = [];
    if ((r.gold||0)>0) parts.push('+'+r.gold+' ü™ô');
    if ((r.silver||0)>0) parts.push('+'+r.silver+' ü•à');
    if ((r.tooth||0)>0) parts.push('+'+r.tooth+' ü¶∑');
    if ((r.rings||0)>0) parts.push('+'+r.rings+' üíç');
    return parts.join(' ');
  }
  function promoActive(){
    const start = parseInt(PROMO_START_TS||0,10)||0;
    if (!start) return true;
    const dur = Math.max(1, (parseInt(PROMO_WINDOW_HOURS||48,10)||48)) * 60 * 60 * 1000;
    const t = now();
    return (t >= start) && (t <= (start + dur));
  }
  function promoKey(){
    return promoNorm(PROMO_CODE);
  }
  function promoUsed(){
    const k = promoKey();
    if (!k) return false;
    return !!(state.promoUsedCodes && state.promoUsedCodes[k]);
  }
  function promoMarkUsed(){
    try {
      const k = promoKey();
      if (!k) return;
      if (!state.promoUsedCodes || typeof state.promoUsedCodes !== 'object') state.promoUsedCodes = {};
      state.promoUsedCodes[k] = now();
    } catch (e) {}
  }
  function promoApply(){
    try {
      if (!promoActive()){ toast('–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞ –∏—Å—Ç—ë–∫','lose'); return; }
      if (promoUsed()){ toast('–ü—Ä–æ–º–æ–∫–æ–¥ —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω','lose'); return; }
      const inp = $('promoInput');
      const code = promoNorm(inp ? inp.value : '');
      if (!code){ toast('–í–≤–µ–¥–∏ –ø—Ä–æ–º–æ–∫–æ–¥','lose'); return; }
      if (code !== promoNorm(PROMO_CODE)) { toast('–ù–µ–≤–µ—Ä–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥','lose'); return; }
      const r = promoRewardClean();
      const any = (r.gold||0) + (r.silver||0) + (r.tooth||0) + (r.rings||0);
      if (any<=0){ toast('–ù–∞–≥—Ä–∞–¥–∞ –ø—Ä–æ–º–æ–∫–æ–¥–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∞','lose'); return; }
      state.gold = Math.min(CURRENCY_CAP, (parseInt(state.gold||0,10)||0) + (r.gold||0));
      state.silver = Math.min(CURRENCY_CAP, (parseInt(state.silver||0,10)||0) + (r.silver||0));
      state.tooth = Math.min(CURRENCY_CAP, (parseInt(state.tooth||0,10)||0) + (r.tooth||0));
      state.rings = Math.min(CURRENCY_CAP, (parseInt(state.rings||0,10)||0) + (r.rings||0));
      promoMarkUsed();
      const txt = promoRewardText(r);
      feedAdd('–ü—Ä–æ–º–æ–∫–æ–¥: '+txt,'SHOP');
      toast(txt || '–ì–æ—Ç–æ–≤–æ','win');
      save();
      renderAll();
      if ($('mShop').classList.contains('show')) renderShop();
      haptic('light');
    } catch (e) {}
  }

  function shopCostValue(cost){
    if (typeof cost === 'number') return cost;
    const s = String(cost||'').trim();
    if (!s) return 0;
    const n = parseInt(s.replace(/[^0-9]/g,''), 10);
    return isNaN(n) ? 0 : n;
  }
  function shopCostLabel(it){
    const c = it ? it.cost : '';
    const s = String(c||'').trim();
    if (s.includes('$')) return s;
    return String(shopCostValue(c));
  }
  function renderShop(){
    const box = $('shopList');
    let html = '<div style="display:flex; flex-direction:column; gap:10px;">';
    if (IS_DEV && SHOP_X2_FORCE==='AUTO'){
      html += '<div class="card">'
        + '<div class="row"><div style="min-width:0"><div class="k">–†–ï–ñ–ò–ú X2</div><div style="font-size:12px;opacity:.75;margin-top:4px">–î–≤–æ–π–Ω—ã–µ ü™ô –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ</div></div>'
        + '<button class="btn btnSmall" id="shopX2Btn">'+(shopX2Enabled()?'X2: ON':'X2: OFF')+'</button></div>'
        + '</div>';
    }

    const promoOk = promoActive();
    const promoWasUsed = promoUsed();
    const promoDisabled = (!promoOk) || promoWasUsed;
    const promoRw = promoRewardClean();
    const promoTxt = promoRewardText(promoRw);
    html += '<div class="card">'
      + '<div class="row" style="gap:10px; align-items:flex-end">'
      + '<div style="min-width:0; flex:1">'
      + '<div class="k">–ü–†–û–ú–û–ö–û–î</div>'
      + '<div style="font-size:12px;opacity:.75;margin-top:4px">'+(promoOk ? (promoTxt ? ('–í–≤–µ–¥–∏ –ø—Ä–æ–º–æ–∫–æ–¥ –∏ –ø–æ–ª—É—á–∏ –Ω–∞–≥—Ä–∞–¥—É ' + promoTxt) : '–ù–∞–≥—Ä–∞–¥–∞ –ø—Ä–æ–º–æ–∫–æ–¥–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∞') : '–ü—Ä–æ–º–æ–∫–æ–¥ –±–æ–ª—å—à–µ –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω')+'</div>'
      + '<div style="font-size:12px;opacity:.6;margin-top:4px">ü¶∑ ‚Äî –∑—É–±—ã</div>'
       + '<input id="promoInput" placeholder="–ü—Ä–æ–º–æ–∫–æ–¥" autocomplete="off" spellcheck="false" style="margin-top:10px; width:100%; height:44px; border-radius:14px; border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.08); color:rgba(255,255,255,.92); padding:0 12px; font-family:inherit; font-weight:800; letter-spacing:1px; outline:none" />'
       + '</div>'
       + '<button class="btn btnSmall" id="promoApply" '+(promoDisabled?'disabled':'')+'>'+(promoWasUsed?'–ò–°–ü–û–õ–¨–ó–û–í–ê–ù':(promoOk?'–ü–†–ò–ú–ï–ù–ò–¢–¨':'–ù–ï –ê–ö–¢–ò–í–ï–ù'))+'</button>'
       + '</div>'
      + '</div>';

    ITEMS.forEach(it=>{
      const showX2 = !!(shopX2Enabled() && it.goldAdd);
      const costLabel = shopCostLabel(it);
      const costSuffix = String(it.cost||'').includes('$') ? '' : (' ' + (it.currency==='TOOTH'?'ü¶∑':'ü™ô'));
      html += '<div class="card">'
        + '<div class="row"><div style="min-width:0"><div class="k">'+it.name.toUpperCase()+'</div><div style="font-size:12px;opacity:.75;margin-top:4px">'+it.desc+'</div></div>'
        + '<div style="display:flex; align-items:center; gap:8px;">'
        + (showX2 ? '<div class="badge" style="padding:6px 8px; font-size:11px; color:var(--gold)">x2</div>' : '')
        + '<button class="btn btnSmall" data-buy="'+it.key+'">'+costLabel+costSuffix+'</button>'
        + '</div>'
        + '</div>'
        + '</div>';
    });
    html += '</div>';
    box.innerHTML = html;

    const x2 = $('shopX2Btn');
    if (x2) x2.onclick = ()=>{ state.shopX2 = !state.shopX2; save(); renderShop(); haptic('light'); };

    const pa = $('promoApply');
    if (pa) pa.onclick = ()=>promoApply();
    const pi = $('promoInput');
    if (pi) pi.onkeydown = (e)=>{ try { if ((e && (e.key==='Enter' || e.keyCode===13))) promoApply(); } catch (e2) {} };

    box.querySelectorAll('[data-buy]').forEach(btn=>{
      btn.onclick = ()=>{
        const key = btn.getAttribute('data-buy');
        const it = ITEMS.find(x=>x.key===key);
        if (!it) return;
        if (String(it.cost||'').includes('$')) { toast('–≠—Ç–æ —Ä–µ–∞–ª—å–Ω–∞—è –ø–æ–∫—É–ø–∫–∞ –∑–∞ –¥–µ–Ω—å–≥–∏','lose'); return; }
        const cost = shopCostValue(it.cost);
        if (it.currency==='TOOTH'){
          if ((state.tooth||0) < cost){ toast('–ù—É–∂–Ω–æ '+shopCostLabel(it)+' –∑—É–±–æ–≤','lose'); return; }
          state.tooth -= cost;
          if (it.goldAdd){
            const add = (parseInt(it.goldAdd||0,10)||0) * (shopX2Enabled() ? 2 : 1);
            state.gold += add;
            feedAdd('–ü–æ–∫—É–ø–∫–∞ –∑–æ–ª–æ—Ç–∞: +'+add+' ü™ô','SHOP');
            toast('+'+add+' ü™ô','win');
          } else if (typeof it.apply==='function'){
            it.apply();
            feedAdd('–ü–æ–∫—É–ø–∫–∞: '+it.name,'SHOP');
          }
        } else {
          if ((state.gold||0) < cost){ toast('–ù—É–∂–Ω–æ '+shopCostLabel(it)+' ü™ô','lose'); return; }
          state.gold -= cost;
          if (typeof it.apply==='function') it.apply();
        }
        save();
        renderAll();
        haptic('light');
      };
    });
  }

  // --- Bosses (simple)
  const BOSS_KEY_CHAIN = [
    { key:'pass', name:'–ü—Ä–æ–ø—É—Å–∫', emoji:'üü•', price: 10 },
    { key:'key', name:'–ö–ª—é—á', emoji:'üü®', price: 20 },
    { key:'sigil', name:'–ü–µ—á–∞—Ç—å', emoji:'üüß', price: 35 },
    { key:'gem', name:'–ö–∞–º–µ–Ω—å', emoji:'üü©', price: 55 },
    { key:'rune', name:'–†—É–Ω–∞', emoji:'üü¶', price: 80 },
    { key:'claw', name:'–ö–æ–≥–æ—Ç—å', emoji:'üü™', price: 110 },
    { key:'mask', name:'–ú–∞—Å–∫–∞', emoji:' üü´', price: 150 },
    { key:'crown', name:'–ö–æ—Ä–æ–Ω–∞', emoji:'‚¨õ', price: 200 },
    { key:'hour', name:'–ü–µ—Å–æ–∫', emoji:'‚¨ú', price: 260 },
    { key:'star', name:'–ó–≤–µ–∑–¥–∞', emoji:'üî¥', price: 340 }
  ];

  function bossReq(id){
    if (id<=1) return null;
    const passPriceByBossId = {
      2: 2,
      3: 4,
      4: 8,
      5: 20,
      6: 40,
      7: 80,
      8: 150,
      9: 300,
      10: 600,
      11: 1000,
      12: 2000
    };
    const price = passPriceByBossId[id];
    if (typeof price !== 'number') return null;
    return { itemKey: 'pass'+id, itemName: '–ü—Ä–æ–ø—É—Å–∫ (–±–æ—Å—Å '+id+')', emoji: 'üéüÔ∏è', need: 3, price: price };
  }

  function bossRingStrikePrice(bossId){
    const id = parseInt(bossId||0,10)||0;
    if (id<=0) return 0;
    return id * 10;
  }
  function bossKeyCount(itemKey){
    const v = parseInt(state.bosses.keys[String(itemKey)]||0,10);
    return isNaN(v) || v<0 ? 0 : v;
  }
  function bossKeyAdd(itemKey, n){
    state.bosses.keys[String(itemKey)] = bossKeyCount(itemKey) + (parseInt(n||0,10)||0);
  }

  function utcDayKey(){
    try { return new Date().toISOString().slice(0,10); } catch (e) { return '1970-01-01'; }
  }
  function bossDailyEnsure(){
    if (!state.bosses.daily) state.bosses.daily = { day:'', counts:{} };
    if (!state.bosses.daily.counts) state.bosses.daily.counts = {};
    const k = utcDayKey();
    if (state.bosses.daily.day !== k){
      state.bosses.daily.day = k;
      state.bosses.daily.counts = {};
    }
  }
  function bossDailyCount(bossId){
    bossDailyEnsure();
    const v = parseInt(state.bosses.daily.counts[String(bossId)]||0,10);
    return isNaN(v) || v<0 ? 0 : v;
  }
  function bossDailyLeft(bossId){
    return Math.max(0, 10 - bossDailyCount(bossId));
  }
  function bossDailyCanStart(bossId){
    return bossDailyCount(bossId) < 10;
  }
  function bossDailyInc(bossId){
    bossDailyEnsure();
    const k = String(bossId);
    state.bosses.daily.counts[k] = bossDailyCount(bossId) + 1;
  }
  function bossHasAccess(id){
    const req = bossReq(id);
    if (!req) return true;
    return bossKeyCount(req.itemKey) >= req.need;
  }

  function bfGetFight(id){
    const k = String(id);
    return (state.bosses.fights && state.bosses.fights[k]) ? state.bosses.fights[k] : null;
  }
  function bfSetFight(id, obj){
    state.bosses.fights[String(id)] = obj;
  }
  function bfEnsureFight(id){
    const b = BOSSES.find(x=>x.id===id);
    if (!b) return null;
    let f = bfGetFight(id);
    const expiresIn = 8*60*60*1000;
    const storedHp = bossHp(id);
    if ((storedHp<=0) && b.maxHP>0) return null;
    const startHp = storedHp;
    if (f && (parseInt(f.hp||0,10)||0) <= 0) {
      try { delete state.bosses.fights[String(id)]; } catch (e) {}
      f = null;
    }
    if (!f || !f.startTs || !f.expiresTs || now() > f.expiresTs || f.bossMaxHP !== b.maxHP){
      f = { startTs: now(), expiresTs: now() + expiresIn, bossMaxHP: b.maxHP, hp: startHp, freeUsed:false, friendCap:{}, lastFriendTs: now(), dmgLog:[], dmgTop:{} };
      bfSetFight(id, f);
    }
    return f;
  }

  function bfLogPush(bossId, who, dmg){
    const k = String(bossId);
    if (!Array.isArray(state.bosses.dmgLog[k])) state.bosses.dmgLog[k] = [];
    state.bosses.dmgLog[k].unshift({ who: String(who||'‚Äî'), dmg: Math.max(0, Math.floor(dmg||0)), ts: now() });
    if (state.bosses.dmgLog[k].length > 25) state.bosses.dmgLog[k] = state.bosses.dmgLog[k].slice(0,25);

    // per-fight log (only for this boss attempt)
    try {
      const f = bfGetFight(bossId);
      if (f){
        if (!Array.isArray(f.dmgLog)) f.dmgLog = [];
        f.dmgLog.unshift({ who: String(who||'‚Äî'), dmg: Math.max(0, Math.floor(dmg||0)), ts: now() });
        if (f.dmgLog.length > 25) f.dmgLog = f.dmgLog.slice(0,25);
        bfSetFight(bossId, f);
      }
    } catch (e) {}
  }
  function bfTopAdd(bossId, who, dmg){
    const key = String(who||'‚Äî');
    // per-fight top (only for this boss attempt)
    try {
      const f = bfGetFight(bossId);
      if (f){
        if (!f.dmgTop) f.dmgTop = {};
        const cur2 = parseInt(f.dmgTop[key]||0,10)||0;
        f.dmgTop[key] = cur2 + (parseInt(dmg||0,10)||0);
        bfSetFight(bossId, f);
      }
    } catch (e) {}
  }

  function bfFriendTick(bossId){
    const b = BOSSES.find(x=>x.id===bossId);
    if (!b) return;
    const f = bfGetFight(bossId);
    if (!f) return;
    const step = 1000;
    const diff = Math.max(0, now() - (parseInt(f.lastFriendTs||0,10)||now()));
    const turns = Math.min(30, Math.floor(diff/step));
    if (turns<=0) return;
    f.lastFriendTs = (parseInt(f.lastFriendTs||0,10)||now()) + turns*step;

    const lvl = clamp(parseInt(state.friendHelpLvl||0,10)||0, 0, 10);
    const capPct = 0.10 + lvl*0.01;
    const capPerFriend = Math.floor(b.maxHP * capPct);
    const friends = Array.isArray(state.friends) ? state.friends : [];
    for (let t=0;t<turns;t++){
      friends.forEach(fr=>{
        const nm = fr && fr.name ? String(fr.name) : 'FRIEND';
        const used = parseInt((f.friendCap && f.friendCap[nm])||0,10)||0;
        if (used >= capPerFriend) return;
        if (!fr || !fr.online) return;
        const maxDmg = Math.max(1, Math.floor(b.maxHP*0.01));
        const friendDmg = 1 + Math.floor(Math.random()*maxDmg);
        const remain = Math.max(0, capPerFriend - used);
        const add = Math.min(friendDmg, remain);
        if (add<=0) return;
        f.friendCap[nm] = used + add;
        f.hp = Math.max(0, (parseInt(f.hp||0,10)||0) - add);
        bfLogPush(bossId, nm, add);
        bfTopAdd(bossId, nm, add);
      });
    }

    bfSetFight(bossId, f);
  }

  function clanAddBossDamage(dmg, who){
    try {
      const c = clanGetMyClan();
      if (!c) return;
      const add = Math.max(0, Math.floor(dmg||0));
      if (add<=0) return;
      c.totalBossDmg = (parseInt(c.totalBossDmg||0,10)||0) + add;
      c.lvl = clanLevelFromDmg(c.totalBossDmg||0);
      if (!c.bossDmgByMember || typeof c.bossDmgByMember !== 'object') c.bossDmgByMember = {};
      const key = String(who||clanMyName()||'PLAYER');
      c.bossDmgByMember[key] = (parseInt(c.bossDmgByMember[key]||0,10)||0) + add;
    } catch (e) {}
  }

  function bfClanTick(bossId){
    const b = BOSSES.find(x=>x.id===bossId);
    if (!b) return;
    const f = bfGetFight(bossId);
    if (!f) return;
    const myClan = clanGetMyClan();
    if (!myClan) return;
    const mem = Array.isArray(myClan.members) ? myClan.members : [];
    if (mem.length<=1) return;

    const step = 1000;
    const diff = Math.max(0, now() - (parseInt(f.lastClanTs||0,10)||now()));
    const turns = Math.min(30, Math.floor(diff/step));
    if (turns<=0) return;
    f.lastClanTs = (parseInt(f.lastClanTs||0,10)||now()) + turns*step;

    if (!f.clanCap) f.clanCap = {};
    const lvl = clamp(parseInt(myClan.lvl||1,10)||1, 1, 10);
    const capPct = 0.04 + lvl*0.01;
    const capPerMember = Math.floor(b.maxHP * capPct);
    const maxMembersPerTurn = Math.min(12, Math.max(1, mem.length-1));
    const helpers = mem
      .filter(n=>String(n)!==clanMyName())
      .slice(0, maxMembersPerTurn);

    if (!helpers.length) { bfSetFight(bossId, f); return; }

    for (let t=0;t<turns;t++){
      helpers.forEach(nm=>{
        const key = String(nm||'BRAT');
        const used = parseInt((f.clanCap && f.clanCap[key])||0,10)||0;
        if (used >= capPerMember) return;
        const maxDmg = Math.max(1, Math.floor(b.maxHP*0.004));
        const clanDmg = 1 + Math.floor(Math.random()*maxDmg);
        const remain = Math.max(0, capPerMember - used);
        const add = Math.min(clanDmg, remain);
        if (add<=0) return;
        f.clanCap[key] = used + add;
        f.hp = Math.max(0, (parseInt(f.hp||0,10)||0) - add);
        bfLogPush(bossId, key, add);
        bfTopAdd(bossId, key, add);
        clanAddBossDamage(add, key);
      });
    }
    bfSetFight(bossId, f);
  }

  function bfInstantHelpDmg(bossId, f, b){
    try {
      if (!f || !b) return 0;
      let total = 0;
      const hp0 = parseInt(f.hp||0,10)||0;
      if (hp0<=0) return 0;

      // friends help
      const friends = Array.isArray(state.friends) ? state.friends : [];
      if (!f.friendCap) f.friendCap = {};
      const frLvl = clamp(parseInt(state.friendHelpLvl||0,10)||0, 0, 10);
      const frCapPct = 0.10 + frLvl*0.01;
      const capPerFriend = Math.floor(b.maxHP * frCapPct);
      friends.forEach(fr=>{
        const nm = fr && fr.name ? String(fr.name) : 'FRIEND';
        const used = parseInt((f.friendCap && f.friendCap[nm])||0,10)||0;
        if (used >= capPerFriend) return;
        if (!fr || !fr.online) return;
        const maxDmg = Math.max(1, Math.floor(b.maxHP*0.01));
        const friendDmg = 1 + Math.floor(Math.random()*maxDmg);
        const remain = Math.max(0, capPerFriend - used);
        const add = Math.min(friendDmg, remain);
        if (add<=0) return;
        f.friendCap[nm] = used + add;
        total += add;
        bfLogPush(bossId, nm, add);
        bfTopAdd(bossId, nm, add);
      });

      // clan help
      const myClan = clanGetMyClan();
      if (myClan){
        const mem = Array.isArray(myClan.members) ? myClan.members : [];
        if (mem.length>1){
          if (!f.clanCap) f.clanCap = {};
          const clLvl = clamp(parseInt(myClan.lvl||1,10)||1, 1, 10);
          const capPct = 0.04 + clLvl*0.01;
          const capPerMember = Math.floor(b.maxHP * capPct);
          mem.filter(n=>String(n)!==clanMyName()).forEach(nm=>{
            const key = String(nm||'BRAT');
            const used = parseInt((f.clanCap && f.clanCap[key])||0,10)||0;
            if (used >= capPerMember) return;
            const maxDmg = Math.max(1, Math.floor(b.maxHP*0.004));
            const clanDmg = 1 + Math.floor(Math.random()*maxDmg);
            const remain = Math.max(0, capPerMember - used);
            const add = Math.min(clanDmg, remain);
            if (add<=0) return;
            f.clanCap[key] = used + add;
            total += add;
            bfLogPush(bossId, key, add);
            bfTopAdd(bossId, key, add);
            clanAddBossDamage(add, key);
          });
        }
      }

      const hp1 = parseInt(f.hp||0,10)||0;
      const real = Math.min(hp1, Math.max(0, Math.floor(total)));
      if (real>0) f.hp = Math.max(0, hp1 - real);
      return real;
    } catch (e) { return 0; }
  }

  function bfRender(bossId){
    const b = BOSSES.find(x=>x.id===bossId);
    if (!b) return;
    const f = bfEnsureFight(bossId);
    if (!f) { toast('–ë–æ—Å—Å –ø–æ–≤–µ—Ä–∂–µ–Ω. –ó–∞–±–µ—Ä–∏ –Ω–∞–≥—Ä–∞–¥—É.','lose'); return; }

    function bossGymTotal(){
      try {
        if (!Array.isArray(GYM_STATS)) return 0;
        let sum = 0;
        const pct = gymBonusPct();
        GYM_STATS.forEach(s=>{
          const cur = (gymVal(s.key)||0);
          let add = Math.round(cur*pct);
          if (pct>0 && cur>0 && add<=0) add = 1;
          sum += (cur + add);
        });
        return Math.max(0, Math.floor(sum));
      } catch (e) { return 0; }
    }
    function bossHitDmg(div, base){
      const tot = bossGymTotal();
      const stat = Math.max(0, Math.floor(tot / Math.max(1, (parseInt(div||1,10)||1))));
      const raw = Math.max(1, (parseInt(base||0,10)||0) + stat);
      return raw;
    }

    // NOTE: –ø–æ–º–æ—â—å —É—Ä–æ–Ω–æ–º —Ç–µ–ø–µ—Ä—å –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –º–æ–º–µ–Ω—Ç–∞–ª—å–Ω–æ –ø—Ä–∏ —Ç–≤–æ—ë–º —É–¥–∞—Ä–µ (—Å–º. bfInstantHelpDmg)

    try {
      const pic = $('bfEmoji');
      if (pic){
        if (b.img){
          pic.textContent = '';
          pic.style.backgroundImage = 'url("'+encodeURI(String(b.img))+'")';
        } else {
          pic.textContent = b.emoji;
          pic.style.backgroundImage = '';
        }
      }
    } catch (e0) {}
    $('bfName').textContent = b.name;
    $('bfHp').textContent = 'HP ' + (parseInt(f.hp||0,10)||0) + ' / ' + b.maxHP;
    const left = Math.max(0, (parseInt(f.expiresTs||0,10)||0) - now());
    $('bfTimer').textContent = left>0 ? ('–í–†–ï–ú–Ø: ' + fmtHHMMSS(left)) : '–í–†–ï–ú–Ø: 00:00:00';
    const hs = state.bosses.hitStocks || { kick:0, knuckle:0, enema:0 };
    const hk = parseInt(hs.kick||0,10)||0;
    const hn = parseInt(hs.knuckle||0,10)||0;
    const he = parseInt(hs.enema||0,10)||0;
    $('bfHits').textContent = '–£–î–ê–†–´ ' + String(hk+hn+he);

    try {
      const q = clamp(parseInt(state.bosses.hitUseQty||1,10)||1, 1, 1000);
      const box = $('bfHitQty');
      if (box){
        const opts = [1,10,100,1000];
        box.innerHTML = opts.map(n=>{
          const a = (n===q) ? '1' : '.7';
          return '<button class="btn btnMini" data-bf-hitqty="'+n+'" style="opacity:'+a+'">x'+n+'</button>';
        }).join('');
        box.querySelectorAll('[data-bf-hitqty]').forEach(bb=>{
          bb.onclick = ()=>{
            const n = parseInt(bb.getAttribute('data-bf-hitqty')||'1',10)||1;
            state.bosses.hitUseQty = clamp(n, 1, 1000);
            save();
            bfRender(bossId);
            haptic('light');
          };
        });
      }
    } catch (e) {}

    const freeBtn = $('bfFreeHit');
    const hitBtn1 = $('bfHit1');
    const hitBtn2 = $('bfHit2');
    const hitBtn3 = $('bfHit3');
    const alive = (parseInt(f.hp||0,10)||0) > 0;
    const inTime = left > 0;
    freeBtn.disabled = (!alive || !inTime || !!f.freeUsed);
    freeBtn.style.opacity = freeBtn.disabled ? '.6' : '1';
    const useQ = clamp(parseInt(state.bosses.hitUseQty||1,10)||1, 1, 1000);
    hitBtn1.disabled = (!alive || !inTime || hk<useQ);
    hitBtn2.disabled = (!alive || !inTime || hn<useQ);
    hitBtn3.disabled = (!alive || !inTime || he<useQ);
    hitBtn1.style.opacity = hitBtn1.disabled ? '.6' : '1';
    hitBtn2.style.opacity = hitBtn2.disabled ? '.6' : '1';
    hitBtn3.style.opacity = hitBtn3.disabled ? '.6' : '1';

    try {
      const q2 = clamp(parseInt(state.bosses.hitUseQty||1,10)||1, 1, 1000);
      hitBtn1.textContent = '–ù–û–ì–û–ô ('+hk+') x'+q2;
      hitBtn2.textContent = '–ö–û–°–¢–ï–¢–û–ú ('+hn+') x'+q2;
      hitBtn3.textContent = '–ö–õ–ò–ó–ú–ê ('+he+') x'+q2;
    } catch (e) {}

    if (!inTime && alive){
      $('bfHint').textContent = '–í—Ä–µ–º—è –≤—ã—à–ª–æ ‚Äî –ø–æ–ø—ã—Ç–∫–∞ –ø—Ä–æ–∏–≥—Ä–∞–Ω–∞.';
      bfCheckLose(bossId);
    } else if (!alive){
      $('bfHint').textContent = '–ë–æ—Å—Å –ø–æ–≤–µ—Ä–∂–µ–Ω!';
    } else {
      $('bfHint').textContent = '';
    }

    const openShop = $('bfShopOpen');
    if (openShop) {
      openShop.onclick = ()=>{ showModal('mBfShop'); bfShopRender(); haptic('light'); };
    }

    freeBtn.onclick = ()=>{
      const ff = bfGetFight(bossId);
      if (!ff) return;
      const left2 = Math.max(0, (parseInt(ff.expiresTs||0,10)||0) - now());
      if (left2<=0 || (parseInt(ff.hp||0,10)||0)<=0 || ff.freeUsed) return;
      ff.freeUsed = true;
      ff.lastFriendTs = now();
      const dmg = bossHitDmg(14, 50);
      const real = Math.min(parseInt(ff.hp||0,10)||0, dmg);
      ff.hp = Math.max(0, (parseInt(ff.hp||0,10)||0) - real);
      const b2 = BOSSES.find(x=>x.id===bossId);
      if (b2){
        bfInstantHelpDmg(bossId, ff, b2);
      }
      bfSetFight(bossId, ff);
      bfLogPush(bossId, state.playerName||'PLAYER', real);
      bfTopAdd(bossId, state.playerName||'PLAYER', real);
      clanAddBossDamage(real, state.playerName||'PLAYER');
      bfCheckWin(bossId);
      save();
      if ((parseInt(ff.hp||0,10)||0) > 0) bfRender(bossId);
      renderAll();
      haptic('light');
    };

    function doTokenHit(kind){
      const f2 = bfEnsureFight(bossId);
      if (!f2) return;
      const hs = state.bosses.hitStocks || { kick:0, knuckle:0, enema:0 };
      const hs2 = { kick: parseInt(hs.kick||0,10)||0, knuckle: parseInt(hs.knuckle||0,10)||0, enema: parseInt(hs.enema||0,10)||0 };
      const q = clamp(parseInt(state.bosses.hitUseQty||1,10)||1, 1, 1000);
      if (kind==='kick'){
        if ((hs2.kick||0) < q){ toast('–ù—É–∂–Ω–æ –∫—É–ø–∏—Ç—å –ø–∏–Ω–∫–∏','lose'); return; }
        hs2.kick -= q;
      } else if (kind==='knuckle'){
        if ((hs2.knuckle||0) < q){ toast('–ù—É–∂–Ω–æ –∫—É–ø–∏—Ç—å –∫–æ—Å—Ç–µ—Ç—ã','lose'); return; }
        hs2.knuckle -= q;
      } else if (kind==='enema'){
        if ((hs2.enema||0) < q){ toast('–ù—É–∂–Ω–æ –∫—É–ø–∏—Ç—å –∫–ª–∏–∑–º—ã','lose'); return; }
        hs2.enema -= q;
      } else {
        toast('–ù—É–∂–Ω–æ –∫—É–ø–∏—Ç—å —É–¥–∞—Ä—ã','lose');
        return;
      }
      state.bosses.hitStocks = hs2;
      ff.lastFriendTs = now();
      const one = (kind==='kick') ? bossHitDmg(10, 70) : ((kind==='knuckle') ? bossHitDmg(7, 85) : bossHitDmg(4, 100));
      const dmg = Math.max(1, one) * q;
      const real = Math.min(parseInt(ff.hp||0,10)||0, dmg);
      ff.hp = Math.max(0, (parseInt(ff.hp||0,10)||0) - real);
      const b2 = BOSSES.find(x=>x.id===bossId);
      if (b2){
        bfInstantHelpDmg(bossId, ff, b2);
      }
      bfSetFight(bossId, ff);
      bfLogPush(bossId, state.playerName||'PLAYER', real);
      bfTopAdd(bossId, state.playerName||'PLAYER', real);
      clanAddBossDamage(real);
      bfCheckWin(bossId);
      save();
      if ((parseInt(ff.hp||0,10)||0) > 0) bfRender(bossId);
      renderAll();
      haptic('light');
    }

    hitBtn1.onclick = ()=>doTokenHit('kick');
    hitBtn2.onclick = ()=>doTokenHit('knuckle');
    hitBtn3.onclick = ()=>doTokenHit('enema');

    const log = $('bfLog');
    const fLog = f && Array.isArray(f.dmgLog) ? f.dmgLog : null;
    const logArr = fLog ? fLog : (Array.isArray(state.bosses.dmgLog[String(bossId)]) ? state.bosses.dmgLog[String(bossId)] : []);
    log.innerHTML = logArr.length ? logArr.map(e=>{
      return '<div class="row"><div style="min-width:0; font-size:12px; opacity:.9">'+String(e.who)+'</div><div class="badge" style="padding:6px 8px; font-size:11px">'+String(e.dmg)+'</div></div>';
    }).join('') : '<div style="opacity:.75; font-size:12px">‚Äî</div>';

    const top = $('bfTop');
    const topObj = (f && f.dmgTop) ? f.dmgTop : {};
    const rows = Object.keys(topObj).map(k=>({ who:k, dmg: parseInt(topObj[k]||0,10)||0 })).sort((a,b)=>b.dmg-a.dmg).slice(0,12);
    top.innerHTML = rows.length ? rows.map((r,i)=>{
      return '<div class="row"><div style="min-width:0; font-size:12px; opacity:.9">#'+(i+1)+' '+r.who+'</div><div class="badge" style="padding:6px 8px; font-size:11px">'+r.dmg+'</div></div>';
    }).join('') : '<div style="opacity:.75; font-size:12px">‚Äî</div>';
  }

  function bfShopRender(){
    try {
      $('bfShopGold').textContent = String(state.gold||0) + ' ü™ô';
    } catch (e) {}

    try {
      const q = clamp(parseInt(state.bosses.shopQty||1,10)||1, 1, 1000);
      const box = $('bfShopQty');
      if (box){
        const opts = [1,10,100,1000];
        box.innerHTML = opts.map(n=>{
          const a = (n===q) ? '1' : '.7';
          return '<button class="btn btnMini" data-bf-qty="'+n+'" style="opacity:'+a+'">x'+n+'</button>';
        }).join('');
        box.querySelectorAll('[data-bf-qty]').forEach(b=>{
          b.onclick = ()=>{
            const n = parseInt(b.getAttribute('data-bf-qty')||'1',10)||1;
            state.bosses.shopQty = clamp(n, 1, 1000);
            save();
            bfShopRender();
            haptic('light');
          };
        });
      }
    } catch (e) {}
  }
  function bfShopBuy(kind, price){
    const p = parseInt(price||0,10)||0;
    if (p<=0) return;
    const q = clamp(parseInt(state.bosses.shopQty||1,10)||1, 1, 1000);
    const total = p * q;
    if ((state.gold||0) < total){ toast('–ù—É–∂–Ω–æ '+total+' ü™ô','lose'); return; }
    state.gold -= total;
    if (!state.bosses.hitStocks) state.bosses.hitStocks = { kick:0, knuckle:0, enema:0 };
    if (kind==='kick') state.bosses.hitStocks.kick = clamp((parseInt(state.bosses.hitStocks.kick||0,10)||0) + q, 0, 999999);
    if (kind==='knuckle') state.bosses.hitStocks.knuckle = clamp((parseInt(state.bosses.hitStocks.knuckle||0,10)||0) + q, 0, 999999);
    if (kind==='enema') state.bosses.hitStocks.enema = clamp((parseInt(state.bosses.hitStocks.enema||0,10)||0) + q, 0, 999999);
    toast('–ö—É–ø–ª–µ–Ω–æ: +'+q,'win');
    save();
    bfShopRender();
    const bid = parseInt(state.bosses && state.bosses.activeFightId || 0, 10) || 0;
    if (bid) bfRender(bid);
    renderAll();
  }

  function bfShowResult(bossId, win){
    const b = BOSSES.find(x=>x.id===bossId);
    if (!b) return;
    try {
      const pic = $('bfrEmoji');
      if (pic){
        if (b.img){
          pic.textContent = '';
          pic.style.backgroundImage = 'url("'+encodeURI(String(b.img))+'")';
        } else {
          pic.textContent = b.emoji;
          pic.style.backgroundImage = '';
        }
      }
    } catch (e0) {}
    $('bfrName').textContent = b.name;
    $('bfrTitle').textContent = win ? '–ë–û–°–° –ü–û–í–ï–†–ñ–ï–ù' : '–ü–û–†–ê–ñ–ï–ù–ò–ï';
    $('bfrOutcome').textContent = win ? '–ë–û–°–° –ü–û–í–ï–†–ñ–ï–ù' : '–ü–û–†–ê–ñ–ï–ù–ò–ï';
    $('bfrOutcome').style.color = win ? 'rgba(52,211,153,.95)' : 'rgba(251,113,133,.95)';

    const rewardCard = $('bfrRewardCard');
    const reward = $('bfrReward');
    const claimBtn = $('bfrClaim');
    if (rewardCard) rewardCard.style.display = win ? 'block' : 'none';
    if (claimBtn){
      claimBtn.style.display = win ? '' : 'none';
      claimBtn.disabled = !win;
      claimBtn.style.opacity = win ? '1' : '.6';
    }

    if (win && reward){
      const pr = state.bosses && state.bosses.pendingReward ? state.bosses.pendingReward : null;
      const rxp = pr ? (parseInt(pr.xp||0,10)||0) : (parseInt(b.reward && b.reward.xp || 0, 10) || 0);
      const rm = pr ? (parseInt(pr.tooth||0,10)||0) : (parseInt(b.reward && b.reward.tooth || 0, 10) || 0);
      const rg = pr ? (parseInt(pr.gold||0,10)||0) : (parseInt(b.reward && b.reward.gold || 0, 10) || 0);
      let html = '';
      try {
        const bp = pr ? (parseFloat(pr.clanBonusPct||0) || 0) : 0;
        if (bp > 0) {
          html += '<div class="row"><div style="min-width:0">–ë–æ–Ω—É—Å –∫–ª–∞–Ω–∞</div><div class="badge" style="padding:6px 8px; font-size:11px; color:var(--gold)">+'+Math.round(bp*100)+'%</div></div>';
        }
      } catch (e) {}
      if (rm>0) html += '<div class="row"><div style="min-width:0">+'+rm+' –∑—É–±–æ–≤</div><div class="badge" style="padding:6px 8px; font-size:11px; color:var(--tooth)">+'+rm+' ü¶∑</div></div>';
      if (rg>0) html += '<div class="row"><div style="min-width:0">+'+rg+' –∑–æ–ª–æ—Ç–∞</div><div class="badge" style="padding:6px 8px; font-size:11px; color:var(--gold)">+'+rg+' ü™ô</div></div>';
      if (rxp>0) html += '<div class="row"><div style="min-width:0">+'+rxp+' XP</div><div class="badge" style="padding:6px 8px; font-size:11px">+'+rxp+' XP</div></div>';
      reward.innerHTML = html || '<div style="opacity:.75; font-size:12px">‚Äî</div>';
    }

    const topL = $('bfrTopL');
    const topR = $('bfrTopR');
    const topObj = (state.bosses.lastTopByBoss && state.bosses.lastTopByBoss[String(bossId)]) ? state.bosses.lastTopByBoss[String(bossId)] : {};
    const rows = Object.keys(topObj).map(k=>({ who:k, dmg: parseInt(topObj[k]||0,10)||0 })).sort((a,c)=>c.dmg-a.dmg).slice(0,10);
    const leftRows = rows.slice(0,5);
    const rightRows = rows.slice(5,10);
    if (topL){
      topL.innerHTML = leftRows.length ? leftRows.map((r,i)=>{
        return '<div class="row"><div style="min-width:0; font-size:12px; opacity:.9">#'+(i+1)+' '+r.who+'</div><div class="badge" style="padding:6px 8px; font-size:11px">'+r.dmg+'</div></div>';
      }).join('') : '<div style="opacity:.75; font-size:12px">‚Äî</div>';
    }
    if (topR){
      topR.innerHTML = rightRows.length ? rightRows.map((r,i)=>{
        return '<div class="row"><div style="min-width:0; font-size:12px; opacity:.9">#'+(i+6)+' '+r.who+'</div><div class="badge" style="padding:6px 8px; font-size:11px">'+r.dmg+'</div></div>';
      }).join('') : '<div style="opacity:.75; font-size:12px">‚Äî</div>';
    }

    // close fight UI so it doesn't remain stuck with 0 HP
    try { hideModal('mBfShop'); } catch (e) {}
    try { hideModal('mBossFight'); } catch (e) {}

    try { renderAll(); } catch (e) {}
    showModal('mBossFightRes');

    if (claimBtn){
      claimBtn.onclick = ()=>{
        const pr = state.bosses && state.bosses.pendingReward ? state.bosses.pendingReward : null;
        if (!pr || (parseInt(pr.bossId||0,10)||0) !== bossId){
          hideModal('mBossFightRes');
          openScreen('mBoss');
          renderBosses();
          haptic('light');
          return;
        }
        const rxp = parseInt(pr.xp||0,10)||0;
        const rm = parseInt(pr.tooth||0,10)||0;
        const rg = parseInt(pr.gold||0,10)||0;
        if (rm>0) state.tooth += rm;
        if (rg>0) state.gold += rg;
        if (rxp>0) addXp(rxp);
        state.bosses.pendingReward = null;

        try {
          const b2 = BOSSES.find(x=>x.id===bossId);
          if (b2) setBossHp(bossId, b2.maxHP);
        } catch (e) {}

        save();
        hideModal('mBossFightRes');
        openScreen('mBoss');
        renderBosses();
        renderAll();
        haptic('heavy');
      };
    }
  }

  function bfCheckWin(bossId){
    const b = BOSSES.find(x=>x.id===bossId);
    if (!b) return;
    const f = bfGetFight(bossId);
    if (!f) return;
    const left = Math.max(0, (parseInt(f.expiresTs||0,10)||0) - now());
    if (left<=0) return;
    if ((parseInt(f.hp||0,10)||0) > 0) return;
    const attemptKey = String(bossId) + ':' + String(parseInt(f.startTs||0,10)||0);
    if (String(state.bosses._resShownWinKey||'') === attemptKey) return;
    state.bosses._resShownWinKey = attemptKey;

    setBossHp(bossId, 0);

    try {
      if (!state.bosses.lastTopByBoss || typeof state.bosses.lastTopByBoss !== 'object') state.bosses.lastTopByBoss = {};
      state.bosses.lastTopByBoss[String(bossId)] = (f && f.dmgTop) ? f.dmgTop : {};
    } catch (e0) {}

    const rxp = parseInt(b.reward && b.reward.xp || 0, 10) || 0;
    const rm = parseInt(b.reward && b.reward.tooth || 0, 10) || 0;
    const rg = parseInt(b.reward && b.reward.gold || 0, 10) || 0;
    let bonusPct = 0;
    try {
      const c = clanGetMyClan();
      if (c){
        const cl = Math.max(1, parseInt(c.lvl||1,10)||1);
        bonusPct = Math.max(0, cl * 0.05);
      }
    } catch (e) {}
    const rm2 = Math.floor(rm * (1 + bonusPct));
    const rg2 = Math.floor(rg * (1 + bonusPct));
    state.bosses.pendingReward = { bossId: bossId, xp: rxp, tooth: rm2, gold: rg2, clanBonusPct: bonusPct };
    state.bosses.lastWinners[String(bossId)] = { name: (state.playerName||'PLAYER'), ts: now() };

    const nextReq = bossReq(bossId+1);
    if (nextReq){
      bossKeyAdd(nextReq.itemKey, nextReq.need);
      feedAdd('–î–æ–±—ã—Ç–æ: '+nextReq.need+'√ó '+nextReq.emoji+' '+nextReq.itemName, 'BOSS');
    }

    feedAdd('–ë–æ—Å—Å –ø–æ–≤–µ—Ä–∂–µ–Ω! –ù–∞–≥—Ä–∞–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞.', 'BOSS');
    toast('–ë–û–°–° –ü–û–í–ï–†–ñ–ï–ù','win');
    haptic('heavy');

    bfShowResult(bossId, true);

    // stop forcing the boss fight modal after victory
    state.bosses.activeFightId = 0;

    // allow immediate new attempt
    try {
      if (state.bosses && state.bosses.fights) delete state.bosses.fights[String(bossId)];
    } catch (e) {}
  }

  function bfCheckLose(bossId){
    const b = BOSSES.find(x=>x.id===bossId);
    if (!b) return;
    const f = bfGetFight(bossId);
    if (!f) return;
    if ((parseInt(f.hp||0,10)||0) <= 0) return;
    const left = Math.max(0, (parseInt(f.expiresTs||0,10)||0) - now());
    if (left>0) return;
    if (parseInt(state.bosses._resShownLose||0,10) === bossId) return;
    state.bosses._resShownLose = bossId;
    state.bosses.activeFightId = 0;
    toast('–ü–û–†–ê–ñ–ï–ù–ò–ï','lose');

    // allow immediate new attempt (update state BEFORE showing result so UI refreshes instantly)
    setBossHp(bossId, b.maxHP);
    try {
      if (state.bosses && state.bosses.fights) delete state.bosses.fights[String(bossId)];
    } catch (e) {}

    bfShowResult(bossId, false);
  }

  function renderBossAttackModal(selectedId){
    state.bosses.pendingAttackId = selectedId;
    const b = BOSSES.find(x=>x.id===selectedId);
    $('baBossName').textContent = b ? b.name : '‚Äî';

    const req = bossReq(selectedId);
    let accessText = '–ë–ï–°–ü–õ–ê–¢–ù–û';
    let canGo = true;
    if (req){
      const have = bossKeyCount(req.itemKey);
      accessText = req.emoji+' '+req.itemName+': '+have+' / '+req.need;
      canGo = have >= req.need;
    }
    $('baAccess').textContent = accessText;
    const goBtn = $('baGo');
    const ringBtn = $('baBuyRing');
    const leftDaily = bossDailyLeft(selectedId);
    const canByDaily = leftDaily > 0;
    $('baAccess').textContent = accessText + ' ¬∑ –ë–æ–∏ —Å–µ–≥–æ–¥–Ω—è: ' + (10-leftDaily) + '/10';
    goBtn.disabled = (!canGo || !canByDaily);
    goBtn.style.opacity = (canGo && canByDaily) ? '1' : '.6';

    if (ringBtn){
      const priceR = bossRingStrikePrice(selectedId);
      const haveR = parseInt(state.rings||0,10)||0;
      ringBtn.disabled = (priceR<=0 || haveR < priceR);
      ringBtn.style.opacity = ringBtn.disabled ? '.55' : '1';
      ringBtn.title = '–ö—É–ø–∏—Ç—å 1 –∞—Ç–∞–∫—É: '+priceR+' üíç';
      ringBtn.onclick = ()=>{
        const id = parseInt(state.bosses.pendingAttackId||selectedId||0,10)||0;
        const priceR2 = bossRingStrikePrice(id);
        if (priceR2<=0) return;
        if ((parseInt(state.rings||0,10)||0) < priceR2){ toast('–ù—É–∂–Ω–æ '+priceR2+' üíç','lose'); return; }

        // validate boss access but IGNORE daily limit
        if (!id) return;
        if ((parseInt(bossHp(id)||0,10)||0) <= 0) { toast('–ë–æ—Å—Å –ø–æ–≤–µ—Ä–∂–µ–Ω. –ó–∞–±–µ—Ä–∏ –Ω–∞–≥—Ä–∞–¥—É.','lose'); return; }
        if (!bossHasAccess(id)) { toast('–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –∫–ª—é—á–µ–π','lose'); return; }

        state.rings -= priceR2;
        state.bosses.strikes = clamp((parseInt(state.bosses.strikes||0,10)||0) + 1, 0, 99);
        toast('+1 –∞—Ç–∞–∫–∞','win');
        save();

        // enter boss fight immediately, bypassing bossDailyCanStart/bossDailyInc
        state.bosses.pendingAttackId = id;
        hideModal('mBossAttack');
        hideModal('mBoss');
        showModal('mBossFight');
        state.bosses.activeFightId = id;
        bfEnsureFight(id);
        bfRender(id);
        save();

        renderBosses();
        renderHUD();
        haptic('light');
      };
    }

    const table = $('baTable');
    let html = '';
    BOSSES.forEach(bb=>{
      if (bb.id<=1) return;
      const r = bossReq(bb.id);
      if (!r) return;
      const have = bossKeyCount(r.itemKey);
      const price = r.price;
      html += '<div class="row" style="align-items:flex-start">'
        + '<div style="min-width:0">'
        + '<div class="k">–ë–û–°–° '+bb.id+'</div>'
        + '<div style="margin-top:4px; font-size:12px; opacity:.8; line-height:1.25">'+r.emoji+' '+r.itemName+': <b style="letter-spacing:1px">'+have+'</b> / '+r.need+'<br>–¶–µ–Ω–∞ –∑–∞ 1: <span style="color:var(--gold); font-weight:900">'+price+' ü™ô</span></div>'
        + '</div>'
        + '<button class="btn btnSmall" data-key-buy="'+r.itemKey+'" data-key-price="'+price+'">–ö–£–ü–ò–¢–¨</button>'
        + '</div>';
    });
    table.innerHTML = html;

    table.querySelectorAll('[data-key-buy]').forEach(btn=>{
      btn.onclick = ()=>{
        const k = btn.getAttribute('data-key-buy');
        const price = parseInt(btn.getAttribute('data-key-price')||'0',10)||0;
        if ((state.gold||0) < price){ toast('–ù—É–∂–Ω–æ '+price+' ü™ô','lose'); return; }
        state.gold -= price;
        bossKeyAdd(k, 1);
        toast('+1','win');
        save();
        renderBossAttackModal(state.bosses.pendingAttackId||selectedId);
        renderAll();
      };
    });

    goBtn.onclick = ()=>{
      if (!canGo) return;
      const id = parseInt(state.bosses.pendingAttackId||0,10)||0;
      if (!id) return;
      if (!bossHasAccess(id)) { toast('–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –∫–ª—é—á–µ–π','lose'); return; }
      if (!bossDailyCanStart(id)) { toast('–õ–∏–º–∏—Ç –±–æ—ë–≤ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è: 10/10','lose'); return; }

      bossDailyInc(id);
      const rr = bossReq(id);
      if (rr){
        const have = bossKeyCount(rr.itemKey);
        state.bosses.keys[String(rr.itemKey)] = Math.max(0, have - rr.need);
      }
      hideModal('mBossAttack');
      hideModal('mBoss');
      showModal('mBossFight');
      state.bosses.activeFightId = id;
      bfEnsureFight(id);
      bfRender(id);
      save();
    };
  }

  function doBossAttack(id){
    if ((state.bosses.strikes||0) <= 0){ toast('–ù–µ—Ç —É–¥–∞—Ä–æ–≤. –í–µ—Ä–Ω—É—Ç—Å—è –ø–æ–∑–∂–µ.','lose'); return; }
    state.bosses.strikes -= 1;
    const b = BOSSES.find(x=>x.id===id);
    if (!b) return;
    let tot = 0;
    try { if (Array.isArray(GYM_STATS)) GYM_STATS.forEach(s=>{ tot += (gymVal(s.key)||0); }); } catch (e) {}
    const stat = Math.max(0, Math.floor(Math.max(0, Math.floor(tot)) / 14));
    const raw = Math.max(1, 50 + stat);
    const dmg = raw;
    const hp = bossHp(id);
    const nh = Math.max(0, hp - dmg);
    setBossHp(id, nh);
    feedAdd('–¢—ã —É–¥–∞—Ä–∏–ª –±–æ—Å—Å–∞: '+b.name+' -'+dmg, 'BOSS');
    if (nh<=0){
      setBossHp(id, 0);

      const rxp = parseInt(b.reward && b.reward.xp || 0, 10) || 0;
      const rm = parseInt(b.reward && b.reward.tooth || 0, 10) || 0;
      const rg = parseInt(b.reward && b.reward.gold || 0, 10) || 0;
      state.bosses.pendingReward = { bossId: id, xp: rxp, tooth: rm, gold: rg };
      state.bosses.lastWinners[String(id)] = { name: (state.playerName||'PLAYER'), ts: now() };

      const nextReq = bossReq(id+1);
      if (nextReq){
        bossKeyAdd(nextReq.itemKey, nextReq.need);
        feedAdd('–î–æ–±—ã—Ç–æ: '+nextReq.need+'√ó '+nextReq.emoji+' '+nextReq.itemName, 'BOSS');
      }

      state.bosses.activeFightId = 0;
      try { if (state.bosses && state.bosses.fights) delete state.bosses.fights[String(id)]; } catch (e) {}

      feedAdd('–ë–æ—Å—Å –ø–æ–≤–µ—Ä–∂–µ–Ω! –ù–∞–≥—Ä–∞–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞.', 'BOSS');
      toast('–ë–û–°–° –ü–û–í–ï–†–ñ–ï–ù','win');
      haptic('heavy');
      bfShowResult(id, true);
    } else {
      toast('-'+dmg+' HP','tooth');
      haptic('light');
    }
    save();
    renderAll();
  }

  function bossHp(id){
    const b = BOSSES.find(x=>x.id===id);
    const max = b ? b.maxHP : 0;
    const k = String(id);
    const has = !!(state.bosses && state.bosses.hp && Object.prototype.hasOwnProperty.call(state.bosses.hp, k));
    const raw = has ? state.bosses.hp[k] : max;
    const cur = parseInt(raw,10);
    if (isNaN(cur) || cur<0) return max;
    if (max>0 && cur>max){
      setBossHp(id, max);
      return max;
    }
    return cur;
  }
  function setBossHp(id, hp){
    state.bosses.hp[String(id)] = Math.max(0, Math.floor(hp||0));
  }
  function renderBosses(){
    const box = $('bossList');
    let html = '<div style="display:flex; flex-direction:column; gap:10px;">';
    html += '<div class="card">'
      + '<div class="row"><div style="min-width:0"><div class="k">–ù–ê–í–´–ö</div><div style="font-size:12px;opacity:.75;margin-top:4px">–ü–æ–º–æ—â—å –±—Ä–∞—Ç–≤—ã</div></div>'
      + '<button class="btn btnSmall" id="friendHelpOpen">–ü–û–ú–û–©–¨ –ë–†–ê–¢–í–´</button></div>'
      + '</div>';
    BOSSES.forEach(b=>{
      const hp = bossHp(b.id);
      const pct = b.maxHP>0 ? clamp((hp/b.maxHP)*100,0,100) : 0;
      const lw = (state.bosses && state.bosses.lastWinners && state.bosses.lastWinners[String(b.id)]) || null;
      const lwName = lw && lw.name ? String(lw.name) : '‚Äî';
      const locked = !bossHasAccess(b.id);
      const req = bossReq(b.id);
      const lockText = locked && req ? (' ¬∑ '+req.emoji+' '+bossKeyCount(req.itemKey)+'/'+req.need) : '';
      const rxp = parseInt(b.reward && b.reward.xp || 0, 10) || 0;
      const rm = parseInt(b.reward && b.reward.tooth || 0, 10) || 0;
      const rg = parseInt(b.reward && b.reward.gold || 0, 10) || 0;
      const dead = (parseInt(hp||0,10)||0) <= 0;
      const pr = (state.bosses && state.bosses.pendingReward) ? state.bosses.pendingReward : null;
      const hasPending = !!(pr && (parseInt(pr.bossId||0,10)||0) === b.id);
      html += '<div class="card">'
        + '<div class="bossWinnerTop">–ü–û–°–õ–ï–î–ù–ò–ô –ü–û–ë–ï–î–ò–¢–ï–õ–¨</div>'
        + '<div class="bossWinnerNm">'+lwName+'</div>'
        + '<div style="height:10px"></div>'
        + '<div class="bossRow">'
        + '<div class="bossMini" style="'+(b.img?('background-image:url(\''+encodeURI(String(b.img))+'\');'):'')+'">'+(b.img?'':b.emoji)+'</div>'
        + '<div style="min-width:0">'
        + '<div class="bossName">'+b.name+'</div>'
        + '<div class="bossSub">'+(dead ? ('–ü–û–í–ï–†–ñ–ï–ù ¬∑ HP 0 / '+b.maxHP) : ('HP '+hp+' / '+b.maxHP))+lockText+'</div>'
        + '<div class="bossReward">'
        + (rm>0 ? ('<span class="badge" style="color:rgba(0,0,0,.92); padding:6px 8px; font-size:11px">+'+rm+'ü¶∑</span>') : '')
        + (rg>0 ? ('<span class="badge" style="color:var(--gold); padding:6px 8px; font-size:11px">+'+rg+'ü™ô</span>') : '')
        + (rxp>0 ? ('<span class="badge" style="padding:6px 8px; font-size:11px">+'+rxp+' XP</span>') : '')
        + '</div>'
        + '<div style="margin-top:6px; display:flex; flex-direction:column; gap:6px">'
        + (dead
            ? (hasPending
                ? '<button class="btn btnMini bossAtkBtn" data-boss-claim="'+b.id+'">–ó–ê–ë–†–ê–¢–¨ –ù–ê–ì–†–ê–î–£</button>'
                : '<button class="btn btnMini bossAtkBtn" data-boss-attack="'+b.id+'" style="opacity:.75" disabled>–ù–ê–ü–ê–°–¢–¨</button>'
              )
            : '<button class="btn btnMini bossAtkBtn" data-boss-attack="'+b.id+'" style="opacity:'+(locked?'.75':'1')+'">–ù–ê–ü–ê–°–¢–¨</button>'
          )
        + '</div>'
        + '</div>'
        + '</div>'
        + '</div>';
    });
    html += '</div>';
    box.innerHTML = html;

    const fho = $('friendHelpOpen');
    if (fho) fho.onclick = ()=>{ showModal('mFriendHelp'); renderFriendHelp(); haptic('light'); };

    box.querySelectorAll('[data-boss-attack]').forEach(btn=>{
      btn.onclick = ()=>{
        const id = parseInt(btn.getAttribute('data-boss-attack')||'0',10)||0;
        if (!id) return;
        if ((parseInt(bossHp(id)||0,10)||0) <= 0) { toast('–ë–æ—Å—Å –ø–æ–≤–µ—Ä–∂–µ–Ω. –ó–∞–±–µ—Ä–∏ –Ω–∞–≥—Ä–∞–¥—É.','lose'); return; }
        if (!bossHasAccess(id)) { toast('–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –∫–ª—é—á–µ–π','lose'); return; }
        showModal('mBossAttack');
        renderBossAttackModal(id);
        haptic('light');
      };
    });

    box.querySelectorAll('[data-boss-claim]').forEach(btn=>{
      btn.onclick = ()=>{
        const id = parseInt(btn.getAttribute('data-boss-claim')||'0',10)||0;
        if (!id) return;
        bfShowResult(id, true);
        haptic('light');
      };
    });

    try {
      try {
        const rv = $('bossRingVal');
        if (rv) rv.textContent = String(parseInt(state.rings||0,10)||0);
      } catch (e) {}
      const btn = $('bossToothBtn');
      const tm = $('bossToothTimer');
      if (btn && tm){
        const nextTs = parseInt(state.bosses && state.bosses.toothNextTs || 0, 10) || 0;
        const ready = now() >= nextTs;
        btn.classList.toggle('ready', ready);
        const left = Math.max(0, nextTs - now());
        const mm = String(Math.floor(left/60000)).padStart(2,'0');
        const ss = String(Math.floor((left%60000)/1000)).padStart(2,'0');
        tm.textContent = ready ? '+100' : (mm+':'+ss);
        btn.onclick = ()=>{
          const nextTs2 = parseInt(state.bosses && state.bosses.toothNextTs || 0, 10) || 0;
          if (now() < nextTs2){ toast('–†–∞–Ω–æ. –ü–æ–¥–æ–∂–¥–∏ —Ç–∞–π–º–µ—Ä.','lose'); haptic('light'); return; }
          state.tooth += 100;
          state.bosses.toothNextTs = now() + 10*60*1000;
          save();
          renderBosses();
          renderHUD();
          toast('+100 –∑—É–±–æ–≤','win');
          haptic('light');
        };
      }
    } catch (e) {}
  }

  function renderDice(){
    const row = $('diceRow');
    row.innerHTML = '';

    const g = state.diceGame || { active:false, rolls:0, max:10, dice:[1,1,1,1,1] };
    const d = Array.isArray(g.dice) && g.dice.length===5 ? g.dice : [1,1,1,1,1];
    for (let i=0;i<5;i++){
      const box = document.createElement('div');
      box.className = 'dieBox';
      box.textContent = String(d[i]||1);
      box.onclick = ()=>diceRerollOne(i);
      row.appendChild(box);
    }

    const btn = $('diceRoll');
    if (btn) btn.textContent = g.active ? '–ó–ê–ë–†–ê–¢–¨' : '–ë–†–û–°–ò–¢–¨';

    const res = $('diceRes');
    if (res) {
      const left = Math.max(0, (parseInt(g.max||10,10)||10) - (parseInt(g.rolls||0,10)||0));
      res.textContent = g.active ? ('–ü–µ—Ä–µ–±—Ä–æ—Å–æ–≤: ' + left + ' / ' + (parseInt(g.max||10,10)||10)) : '‚Äî';
    }
  }

  function diceWeights(){
    return [20,20,20,20,12,8];                                                                     
  }

  function diceFace(){
    const w = diceWeights();
    const sum = w.reduce((a,b)=>a+b,0);
    let r = Math.random() * sum;
    for (let i=0;i<w.length;i++){
      r -= w[i];
      if (r <= 0) return i+1;
    }
    return 6;
  }

  function dicePickComboTarget(){
    const w = [25,35,30,25,10,3,30];
    const sum = w.reduce((a,b)=>a+b,0);
    let r = Math.random() * sum;
    for (let i=0;i<w.length;i++){
      r -= w[i];
      if (r <= 0) return i===6 ? 0 : (i+1);
    }
    return 0;
  }

  function isFiveKind(d){
    if (!Array.isArray(d) || d.length!==5) return false;
    return d[0]===d[1] && d[1]===d[2] && d[2]===d[3] && d[3]===d[4];
  }

  function maxSameCount(d){
    if (!Array.isArray(d) || !d.length) return 0;
    const m = {};
    let best = 0;
    for (let i=0;i<d.length;i++){
      const k = String(d[i]);
      m[k] = (m[k]||0) + 1;
      if (m[k] > best) best = m[k];
    }
    return best;
  }

  function diceRoll5(){
    const out = [ diceFace(), diceFace(), diceFace(), diceFace(), diceFace() ];
    return out;
  }

  function diceStart(){
    if ((state.gold||0) < 1){ toast('–ù—É–∂–Ω–æ 1 ü™ô','lose'); return false; }
    state.gold -= 1;
    state.diceGame.active = true;
    state.diceGame.rolls = 0;
    state.diceGame.max = 10;
    state.diceGame.target = 0;
    state.diceGame.comboTarget = 0;
    state.diceGame.dice = diceRoll5();
    if ((parseInt(state.diceGame.comboTarget||0,10)||0) === 0){
      let guard = 0;
      while ((isFiveKind(state.diceGame.dice) || maxSameCount(state.diceGame.dice) >= 4) && guard<12){
        state.diceGame.dice = diceRoll5();
        guard++;
      }
    }
    save();
    renderDice();
    haptic('light');
    return true;
  }

  function diceRerollOne(i){
    const g = state.diceGame;
    if (!g || !g.active) return;
    const max = parseInt(g.max||10,10)||10;
    const used = parseInt(g.rolls||0,10)||0;
    if (used >= max){ toast('–ü–µ—Ä–µ–±—Ä–æ—Å—ã –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å','lose'); return; }
    if (!Array.isArray(g.dice) || g.dice.length!==5) g.dice = [1,1,1,1,1];
    const tgt = parseInt(g.comboTarget||0,10)||0;
    let v = diceFace();
    g.dice[i] = v;
    if (tgt===0 && isFiveKind(g.dice)){
      g.dice[i] = 1 + Math.floor(Math.random()*5);
      if (g.dice[i] === v) g.dice[i] = 1;
    }
    g.rolls = used + 1;
    save();
    renderDice();
    haptic('light');
  }

  let diceRewardTmr = 0;
  function diceClaim(){
    const g = state.diceGame;
    if (!g || !g.active) return;
    const beforeDice = Array.isArray(g.dice) ? g.dice.slice(0,5) : [1,1,1,1,1];
    const counts = {};
    for (let i=0;i<beforeDice.length;i++){
      const v = parseInt(beforeDice[i]||0,10)||0;
      if (!v) continue;
      const k = String(v);
      counts[k] = (counts[k]||0) + 1;
    }
    let fourFace = 0;
    let was4x = false;
    for (let f=1; f<=6; f++){
      const c = counts[String(f)]||0;
      if (c>=4){ was4x = true; fourFace = f; break; }
    }
    const was5x = (fourFace>0) ? ((counts[String(fourFace)]||0)===5) : false;
    const face = fourFace;

    g.active = false;
    g.rolls = 0;
    g.dice = [1,1,1,1,1];
    g.target = 0;
    g.comboTarget = 0;

    let rewardText = '50 ü¶∑';
    if (!was4x){
      state.tooth += 50;
    } else {
      if (was5x) state.gold += 20;
      if (face===1){
        state.rings = (parseInt(state.rings||0,10)||0) + 15;
        rewardText = '15 üíç –ö–æ–∑—ã—Ä–Ω—ã—Ö –∫–æ–ª–µ—Ü';
      } else if (face===2){
        if (!state.bosses.hitStocks) state.bosses.hitStocks = { kick:0, knuckle:0, enema:0 };
        state.bosses.hitStocks.kick = clamp((parseInt(state.bosses.hitStocks.kick||0,10)||0) + 1, 0, 999999);
        rewardText = '1 –£–¥–∞—Ä –Ω–æ–≥–æ–π';
      } else if (face===3){
        if (!state.bosses.hitStocks) state.bosses.hitStocks = { kick:0, knuckle:0, enema:0 };
        state.bosses.hitStocks.knuckle = clamp((parseInt(state.bosses.hitStocks.knuckle||0,10)||0) + 1, 0, 999999);
        rewardText = '1 –£–¥–∞—Ä –∫–æ—Å—Ç–µ—Ç–æ–º';
      } else if (face===4){
        if (!state.bosses.hitStocks) state.bosses.hitStocks = { kick:0, knuckle:0, enema:0 };
        state.bosses.hitStocks.enema = clamp((parseInt(state.bosses.hitStocks.enema||0,10)||0) + 1, 0, 999999);
        rewardText = '1 –ö–ª–∏–∑–º–∞';
      } else if (face===5){
        const r6 = bossReq(6);
        if (r6) bossKeyAdd(r6.itemKey, r6.need);
        rewardText = '–ö–æ–ª—å—Ü–æ –Ω–∞ –±–æ—Å—Å–∞ ¬´–ü–∞—É—á–∏—Ö–∞¬ª';
      } else if (face===6){
        const r8 = bossReq(8);
        if (r8) bossKeyAdd(r8.itemKey, r8.need);
        rewardText = '–ö–æ–ª—å—Ü–æ –Ω–∞ –±–æ—Å—Å–∞ ¬´–°–∞—Ä—É–º—è–Ω¬ª';
      } else {
        state.tooth += 50;
      }
      if (was5x) rewardText = rewardText + ' +20 ü™ô';
    }

    try { $('diceRewardVal').textContent = rewardText; } catch (e) {}
    save();
    renderDice();
    showModal('mDiceReward');
    try { $('diceRewardOk').style.display = 'none'; } catch (e) {}
    try { if (diceRewardTmr) clearTimeout(diceRewardTmr); } catch (e) {}
    try { diceRewardTmr = setTimeout(()=>{ hideModal('mDiceReward'); }, 1000); } catch (e) {}
    haptic('medium');
  }

  function rollDice(){
    const g = state.diceGame;
    if (g && g.active) {
      diceClaim();
      return;
    }
    diceStart();
  }

  function renderAll(){
    renderHUD();
    renderFriends();
    if ($('mArena').classList.contains('show')) {
      renderArena();
      renderGym();
      renderArenaPetShop();
    }
    if ($('mDistricts').classList.contains('show')) renderDistricts();
    if ($('mBattle').classList.contains('show')) renderBattle();
    if ($('mShop').classList.contains('show')) renderShop();
    if ($('mBoss').classList.contains('show')) renderBosses();
    if ($('mBossFight').classList.contains('show')) {
      const id = parseInt(state.bosses.activeFightId||0,10)||0;
      if (id) bfRender(id);
    }
    if ($('mDice').classList.contains('show')) renderDice();
    if ($('mClans').classList.contains('show')) renderClans();
  }

  function clanLevelFromDmg(dmg){
    const d = Math.max(0, Math.floor(dmg||0));
    const th = [
      0,
      1000000,
      10000000,
      100000000,
      1000000000,
      10000000000,
      100000000000,
      1000000000000,
      10000000000000,
      100000000000000
    ];
    let lvl = 1;
    for (let i=1;i<th.length;i++){
      if (d >= th[i]) lvl = i+1;
    }
    return clamp(lvl, 1, 10);
  }
  function clanDbSeed(){
    try {
      if (!state.clansDb || !state.clansDb.clans) return;
      if (state.clansDb.order && state.clansDb.order.length) return;
      const names = ['–°—Ç–∞—è', '–î–≤–æ—Ä–æ–≤—ã–µ', '–°–µ–≤–µ—Ä', '–¢–µ–Ω—å', '–°–∏–Ω–¥–∏–∫–∞—Ç', '–ö–ª—ã–∫'];
      for (let i=0;i<names.length;i++){
        const id = 'CLN'+String(state.clansDb.nextId++);
        const nm = names[i];
        const leader = nm+' –ë–û–°–°';
        const mem = [leader];
        const totalBossDmg = Math.floor(Math.random()*8000000);
        state.clansDb.clans[id] = { id, name:nm, leader, deputy:'', members:mem, apps:[], createdTs: now(), totalBossDmg, lvl: clanLevelFromDmg(totalBossDmg), bossDmgByMember:{}, memberMeta:{}, log:[], bankGold:0, filters:{ minLvl:1, minStats:0 }, chat:[] };
        state.clansDb.order.push(id);
      }
    } catch (e) {}
  }
  function clanGetMyClan(){
    const cid = (state.clan && state.clan.id) ? String(state.clan.id) : '';
    if (!cid) return null;
    return (state.clansDb && state.clansDb.clans && state.clansDb.clans[cid]) ? state.clansDb.clans[cid] : null;
  }
  function clanMyName(){
    return String(state.playerName||'PLAYER').trim().substring(0, 18) || 'PLAYER';
  }
  function clanMyRole(c){
    const me = clanMyName();
    if (!c) return '';
    if (String(c.leader||'') === me) return 'leader';
    if (String(c.deputy||'') === me) return 'deputy';
    if (Array.isArray(c.members) && c.members.includes(me)) return 'member';
    return '';
  }
  function clanCanManage(c){
    const r = clanMyRole(c);
    return r === 'leader' || r === 'deputy';
  }

  function clanStatsSum(){
    try {
      return GYM_STATS.reduce((a,s)=>a + (parseInt(state.gym && state.gym[s.key] || 1,10) || 1), 0);
    } catch (e) { return 0; }
  }

  function clanEnsureMemberMeta(c){
    try {
      if (!c) return;
      if (!c.memberMeta || typeof c.memberMeta !== 'object') c.memberMeta = {};
      const me = clanMyName();
      if (!c.memberMeta[me] || typeof c.memberMeta[me] !== 'object') c.memberMeta[me] = {};
      c.memberMeta[me].lvl = parseInt(state.level||1,10)||1;
      c.memberMeta[me].stats = clanStatsSum();
    } catch (e) {}
  }

  function clanGuessMemberMeta(name){
    try {
      const nm = String(name||'').trim();
      if (!nm) return { lvl:1, stats:0 };
      if (nm === clanMyName()) return { lvl: parseInt(state.level||1,10)||1, stats: clanStatsSum() };
      const fr = (Array.isArray(state.friends) ? state.friends : []).find(x=>x && String(x.name||'')===nm);
      if (fr) return { lvl: parseInt(fr.lvl||1,10)||1, stats: parseInt(fr.power||0,10)||0 };
      return { lvl:1, stats:0 };
    } catch (e) { return { lvl:1, stats:0 }; }
  }

  function clanLog(clanObj, text){
    try {
      if (!clanObj) return;
      if (!Array.isArray(clanObj.log)) clanObj.log = [];
      clanObj.log.unshift({ ts: now(), text: String(text||'') });
      if (clanObj.log.length > 50) clanObj.log = clanObj.log.slice(0,50);
    } catch (e) {}
  }
  function clanApply(clanId){
    try {
      const id = String(clanId||'');
      if (!id) return;
      if (state.clan && state.clan.id){ toast('–¢—ã —É–∂–µ –≤ –∫–ª–∞–Ω–µ','lose'); return; }
      const c = state.clansDb.clans[id];
      if (!c) return;
      const me = clanMyName();
      if (Array.isArray(c.apps) && c.apps.includes(me)) { toast('–ó–∞—è–≤–∫–∞ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞','lose'); return; }

      const minLvl = (c.filters && typeof c.filters.minLvl !== 'undefined') ? (parseInt(c.filters.minLvl||1,10)||1) : 1;
      const minStats = (c.filters && typeof c.filters.minStats !== 'undefined') ? (parseInt(c.filters.minStats||0,10)||0) : 0;
      const myLvl = parseInt(state.level||1,10)||1;
      const myStats = clanStatsSum();
      if (myLvl < minLvl) { toast('–ù—É–∂–µ–Ω —É—Ä–æ–≤–µ–Ω—å: '+minLvl,'lose'); return; }
      if (myStats < minStats) { toast('–ù—É–∂–Ω—ã —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏: '+fmt4(minStats),'lose'); return; }

      if (!Array.isArray(c.apps)) c.apps = [];
      c.apps.push(me);
      state.clansDb.myApps[id] = now();
      save();
      renderClans();
      toast('–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞','win');
      haptic('light');
    } catch (e) { toast('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É','lose'); }
  }
  function clanAccept(applicantName){
    const c = clanGetMyClan();
    if (!c) return;
    if (!clanCanManage(c)) { toast('–¢–æ–ª—å–∫–æ –≥–ª–∞–≤–∞ –∏–ª–∏ –∑–∞–º','lose'); return; }
    const nm = String(applicantName||'').trim().substring(0, 18);
    if (!nm) return;
    if (!Array.isArray(c.apps)) c.apps = [];
    c.apps = c.apps.filter(x=>String(x)!==nm);
    if (!Array.isArray(c.members)) c.members = [];
    if (c.members.length >= 100){ toast('–õ–∏–º–∏—Ç: 100 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤','lose'); save(); renderClans(); return; }
    if (!c.members.includes(nm)) c.members.push(nm);

    if (!c.memberMeta || typeof c.memberMeta !== 'object') c.memberMeta = {};
    if (!c.memberMeta[nm] || typeof c.memberMeta[nm] !== 'object') c.memberMeta[nm] = {};
    const mm = clanGuessMemberMeta(nm);
    c.memberMeta[nm].lvl = mm.lvl;
    c.memberMeta[nm].stats = mm.stats;

    clanLog(c, '–ü—Ä–∏–Ω—è—Ç –≤ –∫–ª–∞–Ω: ' + nm + ' (–ø—Ä–∏–Ω—è–ª: ' + clanMyName() + ')');
    save();
    renderClans();
    toast('–ü—Ä–∏–Ω—è—Ç: '+nm,'win');
    haptic('light');
  }
  function clanReject(applicantName){
    const c = clanGetMyClan();
    if (!c) return;
    if (!clanCanManage(c)) { toast('–¢–æ–ª—å–∫–æ –≥–ª–∞–≤–∞ –∏–ª–∏ –∑–∞–º','lose'); return; }
    const nm = String(applicantName||'').trim().substring(0, 18);
    if (!nm) return;
    if (!Array.isArray(c.apps)) c.apps = [];
    c.apps = c.apps.filter(x=>String(x)!==nm);
    clanLog(c, '–û—Ç–∫–ª–æ–Ω–µ–Ω–∞ –∑–∞—è–≤–∫–∞: ' + nm + ' (–æ—Ç–∫–ª–æ–Ω–∏–ª: ' + clanMyName() + ')');
    save();
    renderClans();
    toast('–û—Ç–∫–ª–æ–Ω–µ–Ω–æ','lose');
    haptic('light');
  }
  function clanLeave(){
    const c = clanGetMyClan();
    if (!c) return;
    const me = clanMyName();
    const r = clanMyRole(c);
    if (r === 'leader') { toast('–ì–ª–∞–≤–∞ –Ω–µ –º–æ–∂–µ—Ç –≤—ã–π—Ç–∏','lose'); return; }
    if (Array.isArray(c.members)) c.members = c.members.filter(x=>String(x)!==me);
    if (String(c.deputy||'') === me) c.deputy = '';
    clanLog(c, '–í—ã—à–µ–ª –∏–∑ –∫–ª–∞–Ω–∞: ' + me);
    state.clan = Object.assign({}, defaults.clan);
    save();
    renderHUD();
    renderClans();
    toast('–¢—ã –≤—ã—à–µ–ª –∏–∑ –∫–ª–∞–Ω–∞','win');
    haptic('light');
  }
  function clanSetDeputy(){
    const c = clanGetMyClan();
    if (!c) return;
    if (clanMyRole(c) !== 'leader') { toast('–¢–æ–ª—å–∫–æ –≥–ª–∞–≤–∞','lose'); return; }
    const mem = Array.isArray(c.members) ? c.members.slice() : [];
    const pick = prompt('–ò–º—è –∑–∞–º–µ—Å—Ç–∏—Ç–µ–ª—è (—Ç–æ—á–Ω–æ –∫–∞–∫ –≤ —Å–ø–∏—Å–∫–µ):', (mem[1]||''));
    if (!pick) return;
    const nm = String(pick).trim().substring(0, 18);
    if (!mem.includes(nm)) { toast('–ù–µ—Ç —Ç–∞–∫–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞','lose'); return; }
    if (nm === String(c.leader||'')) { toast('–ì–ª–∞–≤–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–º–æ–º','lose'); return; }
    const prev = c.deputy ? String(c.deputy) : '';
    c.deputy = nm;
    clanLog(c, '–°–º–µ–Ω–∞ –∑–∞–º–∞: ' + (prev?prev:'‚Äî') + ' ‚Üí ' + nm + ' (—Å–¥–µ–ª–∞–ª: ' + clanMyName() + ')');
    save();
    renderClans();
    toast('–ù–∞–∑–Ω–∞—á–µ–Ω –∑–∞–º–µ—Å—Ç–∏—Ç–µ–ª—å','win');
    haptic('light');
  }

  function clanSetFilters(){
    const c = clanGetMyClan();
    if (!c) return;
    if (!clanCanManage(c)) { toast('–¢–æ–ª—å–∫–æ –≥–ª–∞–≤–∞ –∏–ª–∏ –∑–∞–º','lose'); return; }
    if (!c.filters || typeof c.filters !== 'object') c.filters = { minLvl:1, minStats:0 };
    const curLvl = parseInt(c.filters.minLvl||1,10)||1;
    const curStats = parseInt(c.filters.minStats||0,10)||0;
    const p1 = prompt('–ú–∏–Ω. —É—Ä–æ–≤–µ–Ω—å –¥–ª—è –∑–∞—è–≤–∫–∏:', String(curLvl));
    if (p1===null) return;
    const p2 = prompt('–ú–∏–Ω. –æ–±—â–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –¥–ª—è –∑–∞—è–≤–∫–∏:', String(curStats));
    if (p2===null) return;
    const nl = clamp(parseInt(p1||'1',10)||1, 1, 999);
    const ns = Math.max(0, parseInt(p2||'0',10)||0);
    c.filters.minLvl = nl;
    c.filters.minStats = ns;
    clanLog(c, '–§–∏–ª—å—Ç—Ä –∑–∞—è–≤–æ–∫: —É—Ä. '+nl+' / —Å—Ç–∞—Ç—ã '+fmt4(ns)+' (–∏–∑–º–µ–Ω–∏–ª: ' + clanMyName() + ')');
    save();
    renderClans();
    toast('–§–∏–ª—å—Ç—Ä —Å–æ—Ö—Ä–∞–Ω—ë–Ω','win');
    haptic('light');
  }

  function clanTransferLeader(){
    const c = clanGetMyClan();
    if (!c) return;
    if (clanMyRole(c) !== 'leader') { toast('–¢–æ–ª—å–∫–æ –≥–ª–∞–≤–∞','lose'); return; }
    const mem = Array.isArray(c.members) ? c.members.slice() : [];
    const pick = prompt('–ù–æ–≤—ã–π –≥–ª–∞–≤–∞ (—Ç–æ—á–Ω–æ –∫–∞–∫ –≤ —Å–ø–∏—Å–∫–µ):', (mem[1]||''));
    if (!pick) return;
    const nm = String(pick).trim().substring(0, 18);
    if (!mem.includes(nm)) { toast('–ù–µ—Ç —Ç–∞–∫–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞','lose'); return; }
    if (nm === String(c.leader||'')) { toast('–û–Ω —É–∂–µ –≥–ª–∞–≤–∞','lose'); return; }
    const prev = String(c.leader||'');
    c.leader = nm;
    if (String(c.deputy||'') === nm) c.deputy = '';
    clanLog(c, '–°–º–µ–Ω–∞ –≥–ª–∞–≤—ã: ' + (prev?prev:'‚Äî') + ' ‚Üí ' + nm);
    if (state.clan && state.clan.id === c.id){
      state.clan.role = clanMyRole(c);
    }
    save();
    renderClans();
    toast('–ì–ª–∞–≤–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω','win');
    haptic('medium');
  }

  function clanDelete(){
    const c = clanGetMyClan();
    if (!c) return;
    if (clanMyRole(c) !== 'leader') { toast('–¢–æ–ª—å–∫–æ –≥–ª–∞–≤–∞','lose'); return; }
    if (!confirm('–£–¥–∞–ª–∏—Ç—å –∫–ª–∞–Ω –Ω–∞–≤—Å–µ–≥–¥–∞?')) return;
    const id = String(c.id||'');
    delete state.clansDb.clans[id];
    if (Array.isArray(state.clansDb.order)) state.clansDb.order = state.clansDb.order.filter(x=>String(x)!==id);
    try {
      if (state.clansDb.myApps && typeof state.clansDb.myApps === 'object') delete state.clansDb.myApps[id];
    } catch (e) {}
    state.clan = Object.assign({}, defaults.clan);
    save();
    renderHUD();
    renderClans();
    toast('–ö–ª–∞–Ω —É–¥–∞–ª—ë–Ω','win');
    haptic('heavy');
  }

  function clanBankAdd(){
    const c = clanGetMyClan();
    if (!c) return;
    const pick = prompt('–°–∫–æ–ª—å–∫–æ ü™ô –≤–Ω–µ—Å—Ç–∏ –≤ –±–∞–Ω–∫ –∫–ª–∞–Ω–∞?', '100');
    if (!pick) return;
    const amt = Math.max(0, Math.floor(parseInt(pick||'0',10)||0));
    if (amt<=0) return;
    if ((state.gold||0) < amt) { toast('–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç ü™ô','lose'); return; }
    state.gold -= amt;
    c.bankGold = (parseInt(c.bankGold||0,10)||0) + amt;
    clanLog(c, '–í–∑–Ω–æ—Å –≤ –±–∞–Ω–∫: ' + clanMyName() + ' +' + amt + ' ü™ô');
    save();
    renderHUD();
    renderClans();
    toast('–í–Ω–µ—Å–µ–Ω–æ: '+amt+' ü™ô','win');
    haptic('light');
  }

  function clanChatSend(){
    const c = clanGetMyClan();
    if (!c) return;
    const txt = prompt('–°–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç:', '');
    if (txt===null) return;
    const msg = String(txt||'').trim().substring(0, 140);
    if (!msg) return;
    if (!Array.isArray(c.chat)) c.chat = [];
    c.chat.push({ ts: now(), from: clanMyName(), text: msg });
    if (c.chat.length > 60) c.chat = c.chat.slice(0,60);
    save();
    renderClans();
    haptic('light');
  }

  function renderClans(){
    clanDbSeed();
    const myClan = clanGetMyClan();
    const has = !!(myClan && myClan.id);
    const me = clanMyName();
    try { $('clanStatus').textContent = has ? ('üè∞ ' + myClan.name) : '–ù–ï–¢'; } catch (e) {}
    try {
      if (!has){
        $('clanDesc').textContent = '–°–æ–∑–¥–∞–π –∫–ª–∞–Ω –∏–ª–∏ –ø–æ–¥–∞–π –∑–∞—è–≤–∫—É –≤ –∫–ª–∞–Ω.';
      } else {
        const lvl = clanLevelFromDmg(myClan.totalBossDmg||0);
        myClan.lvl = lvl;
        clanEnsureMemberMeta(myClan);
        const r = clanMyRole(myClan);
        const rTxt = (r==='leader') ? '–ì–õ–ê–í–ê' : (r==='deputy' ? '–ó–ê–ú' : '–£–ß–ê–°–¢–ù–ò–ö');
        const deputy = myClan.deputy ? String(myClan.deputy) : '‚Äî';
        const members = Array.isArray(myClan.members) ? myClan.members.length : 0;
        if (!myClan.filters || typeof myClan.filters !== 'object') myClan.filters = { minLvl:1, minStats:0 };
        const fl = parseInt(myClan.filters.minLvl||1,10)||1;
        const fs = parseInt(myClan.filters.minStats||0,10)||0;
        $('clanDesc').innerHTML = '–£—Ä–æ–≤–µ–Ω—å: <b>'+lvl+'</b><br>–£—Ä–æ–Ω –ø–æ –±–æ—Å—Å–∞–º: <b>'+fmt4(myClan.totalBossDmg||0)+'</b><br>–†–æ–ª—å: <b>'+rTxt+'</b><br>–ì–ª–∞–≤–∞: <b>'+String(myClan.leader||'‚Äî')+'</b><br>–ó–∞–º: <b>'+deputy+'</b><br>–£—á–∞—Å—Ç–Ω–∏–∫–∏: <b>'+members+'/100</b><br>–§–∏–ª—å—Ç—Ä –∑–∞—è–≤–æ–∫: <b>–£–†. '+fl+'</b> ¬∑ <b>'+fmt4(fs)+'</b>';
      }
    } catch (e) {}

    const btn = $('clanCreate');
    if (btn){
      btn.style.display = has ? 'none' : '';
      btn.disabled = (state.gold||0) < 1000;
      btn.style.opacity = btn.disabled ? '.55' : '1';
    }
    try {
      const sd = $('clanSetDeputy');
      if (sd){
        sd.style.display = (has && clanMyRole(myClan)==='leader') ? '' : 'none';
        sd.onclick = ()=>clanSetDeputy();
      }
    } catch (e) {}

    try {
      const sf = $('clanSetFilters');
      if (sf){
        sf.style.display = (has && clanCanManage(myClan)) ? '' : 'none';
        sf.onclick = ()=>clanSetFilters();
      }
    } catch (e) {}

    try {
      const tp = $('clanTopOpen');
      if (tp){
        tp.style.display = has ? '' : 'none';
        tp.onclick = ()=>{ openScreen('mClanTop'); renderClanTopModal(); haptic('light'); };
      }
    } catch (e) {}

    try {
      const ch = $('clanChatOpen');
      if (ch){
        ch.style.display = has ? '' : 'none';
        ch.onclick = ()=>{ openScreen('mClanChat'); renderClanChatModal(); haptic('light'); };
      }
    } catch (e) {}

    try {
      const tr = $('clanTransfer');
      if (tr){
        tr.style.display = (has && clanMyRole(myClan)==='leader') ? '' : 'none';
        tr.onclick = ()=>clanTransferLeader();
      }
    } catch (e) {}

    try {
      const del = $('clanDelete');
      if (del){
        del.style.display = (has && clanMyRole(myClan)==='leader') ? '' : 'none';
        del.onclick = ()=>clanDelete();
      }
    } catch (e) {}
    try {
      const lv = $('clanLeave');
      if (lv){
        lv.style.display = has ? '' : 'none';
        lv.onclick = ()=>clanLeave();
      }
    } catch (e) {}

    try {
      const appsBox = $('clanAppsList');
      const appsBadge = $('clanAppsBadge');
      if (appsBox && appsBadge){
        if (!has){
          appsBadge.textContent = '‚Äî';
          appsBox.innerHTML = '<div style="opacity:.75; font-size:12px">‚Äî</div>';
        } else {
          const apps = Array.isArray(myClan.apps) ? myClan.apps : [];
          appsBadge.textContent = String(apps.length);
          if (!apps.length){
            appsBox.innerHTML = '<div style="opacity:.75; font-size:12px">‚Äî</div>';
          } else {
            const can = clanCanManage(myClan);
            appsBox.innerHTML = apps.map(nm=>{
              const btns = can ? ('<button class="btn btnMini" data-ca="'+encodeURIComponent(nm)+'">–ü–†–ò–ù–Ø–¢–¨</button>'
                + '<button class="btn btnMini" data-cr="'+encodeURIComponent(nm)+'" style="opacity:.85">–û–¢–ö–õ–û–ù</button>') : '';
              return '<div class="row">'
                + '<div style="min-width:0; font-size:12px; opacity:.9">'+String(nm)+'</div>'
                + '<div style="display:flex; gap:6px">'+btns+'</div>'
                + '</div>';
            }).join('');
            appsBox.querySelectorAll('[data-ca]').forEach(b=>{
              b.onclick = ()=>clanAccept(decodeURIComponent(b.getAttribute('data-ca')));
            });
            appsBox.querySelectorAll('[data-cr]').forEach(b=>{
              b.onclick = ()=>clanReject(decodeURIComponent(b.getAttribute('data-cr')));
            });
          }
        }
      }
    } catch (e) {}

    try {
      const listBox = $('clanList');
      const listBadge = $('clanListBadge');
      if (listBox && listBadge){
        const ids = Array.isArray(state.clansDb.order) ? state.clansDb.order : [];
        listBadge.textContent = String(ids.length);
        listBox.innerHTML = ids.map(id=>{
          const c = state.clansDb.clans[id];
          if (!c) return '';
          const lvl = clanLevelFromDmg(c.totalBossDmg||0);
          c.lvl = lvl;
          const members = Array.isArray(c.members) ? c.members.length : 0;
          const apped = !!(state.clansDb.myApps && state.clansDb.myApps[id]);
          const canApply = (!has && !apped);
          const btn = canApply ? ('<button class="btn btnMini" data-clan-apply="'+id+'">–ó–ê–Ø–í–ö–ê</button>') : (apped ? '<div class="badge" style="padding:6px 8px; font-size:11px">–ñ–î–Å–¢</div>' : '');
          return '<div class="row">'
            + '<div style="min-width:0">'
            + '<div class="k">'+String(c.name).toUpperCase()+'</div>'
            + '<div style="font-size:12px; opacity:.78; margin-top:4px">–õ–í–õ '+lvl+' ¬∑ –£—á–∞—Å—Ç–Ω–∏–∫–∏ '+members+'/100 ¬∑ –£—Ä–æ–Ω '+fmt4(c.totalBossDmg||0)+'</div>'
            + '</div>'
            + '<div>'+btn+'</div>'
            + '</div>';
        }).join('') || '<div style="opacity:.75; font-size:12px">‚Äî</div>';

        listBox.querySelectorAll('[data-clan-apply]').forEach(b=>{
          b.onclick = ()=>clanApply(b.getAttribute('data-clan-apply'));
        });
      }
    } catch (e) {}

    try {
      const bank = $('clanBankGold');
      const addBtn = $('clanBankAdd');
      if (bank && addBtn){
        if (!has){
          bank.textContent = '‚Äî';
          addBtn.style.display = 'none';
        } else {
          bank.textContent = String(parseInt(myClan.bankGold||0,10)||0) + ' ü™ô';
          addBtn.style.display = '';
          addBtn.onclick = ()=>clanBankAdd();
        }
      }
    } catch (e) {}

    try {
      const logBox = $('clanLogList');
      const logBadge = $('clanLogBadge');
      if (logBox && logBadge){
        if (!has){
          logBadge.textContent = '‚Äî';
          logBox.innerHTML = '<div style="opacity:.75; font-size:12px">‚Äî</div>';
        } else {
          const arr = Array.isArray(myClan.log) ? myClan.log : [];
          logBadge.textContent = String(arr.length);
          logBox.innerHTML = arr.length ? arr.slice(0, 30).map(e=>{
            return '<div style="font-size:12px; opacity:.9; line-height:1.35">'+String(e.text||'‚Äî')+'</div>';
          }).join('') : '<div style="opacity:.75; font-size:12px">‚Äî</div>';
        }
      }
    } catch (e) {}
  }
  function clanCreate(){
    if (state.clan && state.clan.id){ toast('–¢—ã —É–∂–µ –≤ –∫–ª–∞–Ω–µ','lose'); return; }
    if ((state.gold||0) < 1000){ toast('–ù—É–∂–Ω–æ 1000 ü™ô','lose'); return; }
    const name = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –∫–ª–∞–Ω–∞:', '–ë—Ä–∞—Ç—Å—Ç–≤–æ');
    if (!name) return;
    const nm = String(name).trim().substring(0, 18);
    if (!nm){ toast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ','lose'); return; }
    clanDbSeed();
    state.gold -= 1000;
    const id = 'CLN'+String(state.clansDb.nextId++);
    const me = clanMyName();
    const obj = { id:id, name:nm, leader: me, deputy:'', members:[me], apps:[], createdTs: now(), totalBossDmg:0, lvl:1, bossDmgByMember:{}, memberMeta:{}, log:[], bankGold:0, filters:{ minLvl:1, minStats:0 }, chat:[] };
    clanEnsureMemberMeta(obj);
    clanLog(obj, '–ö–ª–∞–Ω —Å–æ–∑–¥–∞–Ω');
    state.clansDb.clans[id] = obj;
    state.clansDb.order.unshift(id);
    state.clan = { id:id, name:nm, owner: me, createdTs: now(), role:'leader', deputy:'', joinedTs: now() };
    save();
    renderHUD();
    renderClans();
    toast('–ö–ª–∞–Ω —Å–æ–∑–¥–∞–Ω','win');
    haptic('medium');
  }

  function renderDistricts(){
    const box = $('districtList');
    if (!box) return;
    let html = '';
    const data = districtData();
    const dayKey = utcDayKey();
    const dayBox = (state.districtDailyFear && state.districtDailyFear.day===dayKey) ? state.districtDailyFear.byDistrict : null;

    try {
      const btn = $('bizRewardBtn');
      if (btn) btn.onclick = ()=>{ try { bizDailyClaimAll(); bizRewardBtnUpdate(); } catch (e2) {} };
      bizRewardBtnUpdate();
    } catch (e) {}

    for (let i=1;i<=data.length;i++){
      const name = data[i-1].name;
      const fk = 'D'+String(i-1);
      const you = String(state.playerName||'PLAYER').trim().toUpperCase();
      const dailyRec = dayBox && dayBox[fk] ? dayBox[fk] : null;
      const dailyNm = dailyRec && dailyRec.name ? String(dailyRec.name).trim().toUpperCase() : '';
      const fear = (dailyNm && dailyNm === you) ? Math.max(0, (parseInt(dailyRec.fear||0,10)||0)) : 0;
      const top = (state.districtFearLeaders && state.districtFearLeaders[fk]) ? state.districtFearLeaders[fk] : null;
      const topName = top && top.name ? top.name : '‚Äî';
      const topFear = top && (typeof top.fear !== 'undefined') ? (parseInt(top.fear||0,10)||0) : 0;
      const dayTop = dayBox && dayBox[fk] ? dayBox[fk] : null;
      const dayName = dayTop && dayTop.name ? dayTop.name : '‚Äî';
      const dayFear = dayTop && (typeof dayTop.fear !== 'undefined') ? (parseInt(dayTop.fear||0,10)||0) : 0;
      const idx = i-1;
      const unlocked = districtUnlocked(idx);
      const prevOk = districtPrevCleared(idx);
      const lockTxt = (DEBUG_UNLOCK_ALL_DISTRICTS ? '' : ((!prevOk) ? '–ß—Ç–æ–±—ã –ø–µ—Ä–µ–π—Ç–∏ –≤ —ç—Ç–æ—Ç —Ä–∞–π–æ–Ω ‚Äî –ø—Ä–æ–π–¥–∏ –ø—Ä–µ–¥—ã–¥—É—â–∏–π' : ''));
      html += '<div class="card">'
        + '<div class="districtCardGrid" style="'+(unlocked?'':'opacity:.55; filter:grayscale(1);')+'">'
        + '<div class="districtLeftCol">'
        + '<div style="width:140px; height:140px; border-radius:14px; border:1px solid rgba(255,255,255,.12); background:linear-gradient(145deg, rgba(255,255,255,.14), rgba(0,0,0,.10)); display:flex; align-items:center; justify-content:center; font-weight:900; letter-spacing:2px; opacity:.88">IMG</div>'
        + '<div class="districtActions">'
        + '<button class="btn btnSmall districtBtn" data-dn="'+(i-1)+'" '+(unlocked?'':'disabled')+'>'+ (unlocked ? '–ö–û–®–ú–ê–†–ò–¢–¨' : '–ó–ê–ö–†–´–¢–û') +'</button>'
        + '<button class="btn btnSmall districtBtn" data-db="'+(i-1)+'" '+(unlocked?'':'disabled')+'>–ë–ò–ó–ù–ï–°</button>'
        + '</div>'
        + '</div>'
        + '<div class="districtCardRight">'
        + '<div class="districtCardTop">'
        + '<div style="min-width:0">'
        + '<div class="k">'+name.toUpperCase()+'</div>'
        + '<div style="margin-top:6px; font-size:12px; opacity:.8; line-height:1.35">–ó–∞–¥–∞–Ω–∏–π: '+(data[i-1].tasks ? data[i-1].tasks.length : 0)+'</div>'
        + (lockTxt ? ('<div style="margin-top:6px; font-size:12px; line-height:1.35; font-weight:900; color:rgba(248,113,113,.95)">'+lockTxt+'</div>') : '')
        + '</div>'
        + '<div class="districtCardBadge">'
        + '<div class="badge" style="padding:8px 10px"> '+fmt4(fear)+'</div>'
        + '</div>'
        + '</div>'
        + '<div class="districtStack">'
        + '<div style="min-width:0">'
        + '<div class="districtTag" style="text-align:left">–î–ï–†–ñ–ò–¢ –†–ê–ô–û–ù</div>'
        + '<div class="districtNick" style="margin-top:4px">'+String(topName).toUpperCase()+'</div>'
        + '<div class="districtStatBox" style="margin-top:6px">'
        + '<div class="districtStatRow">'
        + '<div class="districtFear">üò± '+fmt4(topFear)+'</div>'
        + '</div>'
        + '</div>'
        + '</div>'
        + '<div style="min-width:0">'
        + '<div class="districtTag" style="text-align:left">–°–¢–†–ê–®–ò–õ–ê –î–ù–Ø</div>'
        + '<div class="districtNick" style="margin-top:4px">'+String(dayName).toUpperCase()+'</div>'
        + '<div class="districtStatBox" style="margin-top:6px">'
        + '<div class="districtStatRow">'
        + '<div class="districtFear">üò± '+fmt4(dayFear)+'</div>'
        + '</div>'
        + '</div>'
        + '</div>'
        + '</div>'
        + '</div>'
        + '</div>'
        + '</div>'
        + '</div>'
;
    }
    box.innerHTML = html;

    try {
      box.querySelectorAll('[data-dn]').forEach(btn=>{
        btn.onclick = ()=>{ try { districtNightmareOpen(parseInt(btn.getAttribute('data-dn')||'0',10)||0); } catch (e) {} };
      });
    } catch (e) {}

    try {
      box.querySelectorAll('[data-db]').forEach(btn=>{
        btn.onclick = ()=>{ try { renderDistrictBiz(parseInt(btn.getAttribute('data-db')||'0',10)||0); } catch (e) {} };
      });
    } catch (e) {}
  }

  function districtNightmareOpen(idx){
    try {
      const id = clamp(parseInt(idx||0,10)||0, 0, 11);
      if (!districtUnlocked(id)) { toast('–†–∞–π–æ–Ω –∑–∞–∫—Ä—ã—Ç','lose'); return; }
      state.districtNightmareIdx = id;
      openScreen('mDistrictNightmare');
      renderDistrictNightmare();
      haptic('light');
    } catch (e) {}
  }
  function renderDistrictNightmare(){
    try {
      const data = districtData();
      const i = clamp(parseInt(state.districtNightmareIdx||0,10)||0, 0, data.length-1);
      const nm = data[i] && data[i].name ? data[i].name : '–†–ê–ô–û–ù';
      const diff = data[i] && data[i].diff ? data[i].diff : '‚Äî';
      const tasks = (data[i] && Array.isArray(data[i].tasks)) ? data[i].tasks : [];
      const t = $('dnTitle');
      const d = $('dnDesc');
      const b = $('dnDiff');
      if (t) t.textContent = nm.toUpperCase();
      if (b) b.textContent = '';
      if (d){
        const energy = Math.floor(state.energy||0);
        let h = '';
        h += '<div style="background:rgba(210,190,156,.96); color:rgba(45,30,18,.98); border:1px solid rgba(45,30,18,.35); border-radius:16px; padding:12px; box-shadow: 0 18px 45px rgba(0,0,0,.25); max-width:100%; overflow-x:hidden; box-sizing:border-box;">';
        h += '<div style="font-weight:900; letter-spacing:2px; font-size:12px; opacity:.95">'+nm.toUpperCase()+'</div>';
        h += '<div style="margin-top:6px; font-size:12px; opacity:.85; line-height:1.35">–¢—ã –∫–æ—à–º–∞—Ä–∏—à—å —Ä–∞–π–æ–Ω. –í—ã–±–∏—Ä–∞–π –∑–∞–¥–∞–Ω–∏–µ –∏ –≤—ã–ø–æ–ª–Ω—è–π –∑–∞ ‚ö° —ç–Ω–µ—Ä–≥–∏—é.</div>';
        h += '<div style="margin-top:10px; border-top:1px solid rgba(45,30,18,.25)"></div>';

        h += '<div style="margin-top:10px; display:grid; grid-template-columns: minmax(0,1fr) 92px 62px 112px; gap:8px; align-items:center; font-size:11px; letter-spacing:2px; font-weight:900; opacity:.85">'
          + '<div>–ó–ê–î–ê–ù–ò–ï</div><div style="text-align:center">–ù–ê–ì–†–ê–î–ê</div><div style="text-align:center">–¢–†–ï–ë.</div><div style="text-align:right"> </div>'
          + '</div>';

        for (let k=0;k<tasks.length;k++){
          const meta = districtTaskMeta(diff, k, i);
          const key = districtTaskKey(i, k);
          const cnt = Math.max(0, (state.districtTaskCounts && state.districtTaskCounts[key]) ? (parseInt(state.districtTaskCounts[key]||0,10)||0) : 0);
          const done = cnt >= meta.max;
          const locked = districtTaskLocked(i, k, tasks.length);
          const can = (!done) && (!locked) && (energy >= meta.cost);
          const btnTxt = done ? '–ì–û–¢–û–í–û' : (locked ? '–ù–ï–î–û–°–¢–£–ü–ù–û' : '–í–´–ü–û–õ–ù–ò–¢–¨');
          const btnStyle = 'height:34px; padding:0 12px; border-radius:999px; font-weight:900; letter-spacing:1px; border:1px solid rgba(255,255,255,.35);' + (can ? ' background:linear-gradient(180deg, rgba(37,99,235,.98), rgba(30,64,175,.98)); color:rgba(255,255,255,.98); box-shadow: 0 10px 22px rgba(30,64,175,.25), inset 0 1px 0 rgba(255,255,255,.18);' : ' background:rgba(120,120,120,.45); color:rgba(255,255,255,.92); opacity:.75;');
          const pct = meta.max>0 ? clamp((cnt/meta.max)*100, 0, 100) : 0;
          h += '<div style="margin-top:8px; padding-top:8px; border-top:1px solid rgba(45,30,18,.18)"></div>';
          h += '<div style="display:grid; grid-template-columns: minmax(0,1fr) 92px 62px 112px; gap:8px; align-items:center; '+(locked ? 'opacity:.45; filter:grayscale(1);' : '')+'">';
          h += '<div style="min-width:0">'
            + '<div style="font-size:12px; line-height:1.25; font-weight:900; opacity:.95; overflow:hidden; text-overflow:ellipsis;">'+tasks[k]+'</div>'
            + '<div style="margin-top:6px; display:flex; align-items:center; gap:8px">'
            + '<div style="flex:1; height:8px; border-radius:999px; border:1px solid rgba(45,30,18,.28); background:rgba(255,255,255,.55); overflow:hidden">'
            + '<div style="height:100%; width:'+pct.toFixed(2)+'%; background:linear-gradient(90deg, rgba(187,36,36,.92), rgba(122,26,26,.92))"></div>'
            + '</div>'
            + '<div style="font-size:11px; font-weight:900; opacity:.78; white-space:nowrap">'+cnt+'/'+meta.max+'</div>'
            + '</div>'
            + '</div>';
          h += '<div style="text-align:center; font-size:12px; font-weight:900; opacity:.95; overflow:hidden">'+(meta.fear ? ('üò± '+fmt4(meta.fear)) : ('ü™ô '+fmt4(meta.gold)))+'<div style="font-size:10px; opacity:.8; margin-top:2px">+ '+meta.xp+' XP</div></div>';
          h += '<div style="text-align:center; font-size:12px; font-weight:900; opacity:.95">‚ö° '+meta.cost+'</div>';
          h += '<div style="text-align:right">'
            + '<button class="btn btnSmall" style="'+btnStyle+' max-width:100%; width:112px; padding:0 10px;" data-dtask="'+i+':'+k+'" '+(can ? '' : 'disabled')+'>'+btnTxt+'</button>'
            + '</div>';
          h += '</div>';
        }
        h += '</div>';
        d.innerHTML = h;

        try {
          d.querySelectorAll('[data-dtask]').forEach(btn=>{
            btn.onclick = ()=>{ try {
              const raw = String(btn.getAttribute('data-dtask')||'');
              const p = raw.split(':');
              const di = parseInt(p[0]||'0',10)||0;
              const ti = parseInt(p[1]||'0',10)||0;
              districtTaskDo(di, ti);
            } catch (e2) {} };
          });
        } catch (e3) {}

      }
    } catch (e) {}
  }

  function districtTaskKey(dIdx, tIdx){
    return 'D' + String(dIdx) + '_T' + String(tIdx);
  }
  function districtTaskLocked(dIdx, tIdx, total){
    try {
      if (!total || total<=0) return false;
      if (tIdx !== total-1) return false;
      const data = districtData();
      const d = data[dIdx];
      if (!d) return false;
      const tasks = Array.isArray(d.tasks) ? d.tasks : [];
      const len = tasks.length;
      for (let i=0;i<len-1;i++){
        const meta = districtTaskMeta(d.diff, i, dIdx);
        const key = districtTaskKey(dIdx, i);
        const cnt = Math.max(0, (state.districtTaskCounts && state.districtTaskCounts[key]) ? (parseInt(state.districtTaskCounts[key]||0,10)||0) : 0);
        if (cnt < meta.max) return true;
      }
      return false;
    } catch (e) { return false; }
  }
  function districtTaskMeta(diff, idx, dIdx){
    if (dIdx===0){
      const base = [2,4,6,8,10,12,14];
      const mid = [6,8,10,12,14,16,18];
      const hard = [10,12,14,16,18,20,22];
      let costArr = (diff==='–°–†–ï–î–ù–ï') ? mid : (diff==='–ñ–ï–°–¢–ö–û' ? hard : base);
      if (dIdx===0) costArr = [2,6,8,10,14,16,20];
      const cost = costArr[idx] || costArr[costArr.length-1] || 2;
      const mult = (diff==='–°–†–ï–î–ù–ï') ? 2 : (diff==='–ñ–ï–°–¢–ö–û' ? 3 : 1);
      let gold = Math.floor((250*mult) + (idx*120*mult));
      let xp = Math.floor((120*mult) + (idx*55*mult));
      let fear = 0;
      let max = (diff==='–°–†–ï–î–ù–ï') ? 6 : (diff==='–ñ–ï–°–¢–ö–û' ? 8 : 4);
      if (dIdx===0){
        const xpArr = [0,4,4,4,6,6,6];
        const fearArr = [2,6,8,10,14,16,20];
        xp = xpArr[idx] || 0;
        fear = fearArr[idx] || 0;
        gold = 0;
        max = 5;
      }
      return { cost:cost, gold:gold, xp:xp, fear:fear, max:max };
    }

    const totals = [380,500,800,1000,1400,1600,2000,2200,2400,2600,2800,3000];
    const total = totals[clamp(parseInt(dIdx||0,10)||0, 0, 11)] || 500;

    // 7 tasks * 10 levels => total per district spread across 70 completions
    const sumNeed = Math.max(7, Math.round(total / 10));

    const tpl = [2,6,8,10,14,16,20];
    const tplSum = 76;
    const factor = sumNeed / tplSum;
    const arr = tpl.map(v=>Math.max(1, Math.round(v * factor)));
    let curSum = arr.reduce((a,b)=>a+b,0);
    let delta = sumNeed - curSum;
    let j = 0;
    while (delta !== 0 && j < 500){
      const p = j % arr.length;
      if (delta > 0){
        arr[p] += 1;
        delta -= 1;
      } else {
        if (arr[p] > 1){
          arr[p] -= 1;
          delta += 1;
        }
      }
      j++;
    }

    const cost = arr[idx] || arr[arr.length-1] || 1;
    const gold = 0;
    const xp = cost;
    const fear = cost;
    const max = 10;
    return { cost:cost, gold:gold, xp:xp, fear:fear, max:max };
  }
  function districtTaskDo(dIdx, tIdx){
    try {
      const data = districtData();
      const d = data[dIdx];
      if (!d) return;
      const tasks = Array.isArray(d.tasks) ? d.tasks : [];
      if (!tasks[tIdx]) return;
      if (districtTaskLocked(dIdx, tIdx, tasks.length)) { toast('–°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–π–¥–∏ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –∑–∞–¥–∞–Ω–∏—è','lose'); return; }
      const key = districtTaskKey(dIdx, tIdx);
      const meta = districtTaskMeta(d.diff, tIdx, dIdx);
      const cnt = Math.max(0, (state.districtTaskCounts && state.districtTaskCounts[key]) ? (parseInt(state.districtTaskCounts[key]||0,10)||0) : 0);
      if (cnt >= meta.max){ toast('–£–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ –º–∞–∫—Å–∏–º—É–º','lose'); return; }
      const en = Math.floor(state.energy||0);
      if (en < meta.cost){ toast('–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç —ç–Ω–µ—Ä–≥–∏–∏ ‚ö°','lose'); return; }

      state.energy = clamp(en - meta.cost, 0, state.energyMax||100);
      if (meta.gold>0) state.gold = Math.min(CURRENCY_CAP, (parseInt(state.gold||0,10)||0) + meta.gold);
      if (meta.fear>0){
        const fk = 'D'+String(dIdx);
        const cur = Math.max(0, (state.districtFear && state.districtFear[fk]) ? (parseInt(state.districtFear[fk]||0,10)||0) : 0);
        if (!state.districtFear || typeof state.districtFear !== 'object') state.districtFear = {};
        state.districtFear[fk] = cur + meta.fear;

        try {
          districtFearLeaderUpdate(dIdx);
          districtDailyFearAdd(dIdx, meta.fear);
        } catch (e4) {}
      }
      addXp(meta.xp);
      if (!state.districtTaskCounts || typeof state.districtTaskCounts !== 'object') state.districtTaskCounts = {};
      state.districtTaskCounts[key] = cnt + 1;

      try {
        const fk = 'D'+String(dIdx);
        const gotFear = meta.fear || 0;
        const gotGold = meta.gold || 0;
        feedAdd('–ó–∞–¥–∞–Ω–∏–µ —Ä–∞–π–æ–Ω–∞: +'+(gotFear? (gotFear+' üò±') : (gotGold+' ü™ô'))+', +'+meta.xp+' XP','SYS');
      } catch (e2) {}

      try {
        const allOk = districtAllTasksDone(dIdx);
        if (allOk){
          const bk = 'D'+String(dIdx);
          if (!state.districtClearedEver || typeof state.districtClearedEver !== 'object') state.districtClearedEver = {};
          if (!state.districtClearedEver[bk]) state.districtClearedEver[bk] = now();
          districtCompletionAutoReward(dIdx);
        }
      } catch (e3) {}

      save();
      renderHUD();
      if ($('mDistricts') && $('mDistricts').classList.contains('show')) renderDistricts();
      renderDistrictNightmare();
      toast('–í—ã–ø–æ–ª–Ω–µ–Ω–æ','win');
      haptic('light');
    } catch (e) {}
  }

  // --- Energy regen (1 energy per 2 min until max)
  const ENERGY_REGEN_MIN = 2;
  function tickEnergy(){
    const ts = parseInt(state.lastEnergyTs||0,10) || now();
    const diff = Math.max(0, now() - ts);
    const per = ENERGY_REGEN_MIN*60*1000;
    if ((state.energy||0) >= state.energyMax){
      state.lastEnergyTs = now();
      return;
    }
    const add = Math.floor(diff / per);
    if (add>0){
      state.energy = clamp((state.energy||0)+add, 0, state.energyMax);
      state.lastEnergyTs = ts + add*per;
    }
  }
  function energyTimerText(){
    if ((state.energy||0) >= state.energyMax) return 'MAX';
    const ts = parseInt(state.lastEnergyTs||0,10) || now();
    const per = ENERGY_REGEN_MIN*60*1000;
    const next = ts + per;
    return fmtMMSS(Math.max(0, next - now()));
  }

  // strikes regen
  function tickStrikes(){
    state.bosses.strikes = clamp(parseInt(state.bosses.strikes||0,10)||0, 0, 99);
    // regen 1 strike per 6 minutes up to 10
    if (!state.bosses.lastStrikeTs) state.bosses.lastStrikeTs = now();
    const per = 6*60*1000;
    const diff = Math.max(0, now() - (parseInt(state.bosses.lastStrikeTs||0,10)||now()));
    if ((state.bosses.strikes||0) >= 10){
      state.bosses.lastStrikeTs = now();
      return;
    }
    const add = Math.floor(diff/per);
    if (add>0){
      state.bosses.strikes = clamp((state.bosses.strikes||0)+add, 0, 10);
      state.bosses.lastStrikeTs = (parseInt(state.bosses.lastStrikeTs||0,10)||now()) + add*per;
    }
  }

  // group battle timer
  function tickBattle(){
    const b = state.groupFight && state.groupFight.battle;
    if (!b) return;
    const aliveEnemies = Array.isArray(b.targets) ? b.targets.some(x=>(parseInt(x.hp||0,10)||0) > 0) : false;
    if (!aliveEnemies) return;

    b.turnLeft = Math.max(0, (parseInt(b.turnLeft||0,10)||0) - 1);
    if (b.turnLeft>0) return;

    // end of turn
    if (!b.acted) battleAutoHit();

    // simulate allies
    battleAlliesTurn();

    // check win after player/auto hit
    const aliveAfter = Array.isArray(b.targets) ? b.targets.some(x=>(parseInt(x.hp||0,10)||0) > 0) : false;
    if (!aliveAfter){
      const rr = gfBattleComputeReward(b, true);
      b.log.unshift({ kind:'SYS', text:'–ü–æ–±–µ–¥–∞ –∫–æ–º–∞–Ω–¥—ã! –ù–∞–≥—Ä–∞–¥–∞: +' + (parseInt(rr.gold||0,10)||0) + ' ü™ô' });
      state.groupFight.pendingReward = rr;
      state.groupFight.joined = false;
      state.groupFight.startTs = 0;
      state.groupFight.resolvedTs = now();
      feedAdd('–ü–æ–±–µ–¥–∞ –≤ –≥—Ä—É–ø–ø–æ–≤–æ–º –±–æ—é!','GF');
      toast('–ü–û–ë–ï–î–ê','win');
      haptic('heavy');
      save();
      renderAll();
      gfShowBattleResult(true);
      return;
    }

    battleEnemyTurn();
    if ((parseInt(b.myHp||0,10)||0) <= 0) return;

    // next round
    b.round = (parseInt(b.round||1,10)||1) + 1;
    b.turnLeft = 10;
    b.acted = false;
    b.log.unshift({ kind:'SYS', text:'–ù–æ–≤—ã–π —Ö–æ–¥: ' + b.round });
  }

  // --- Events
  function bindUI(){
    document.querySelectorAll('[data-close]').forEach(b=>{
      b.onclick = ()=>hideModal(b.getAttribute('data-close'));
    });

    try {
      const bcl = document.querySelector('[data-close="mBattle"]');
      if (bcl) {
        bcl.onclick = ()=>{
          hideModal('mBattle');
          openScreen('mArena');
          renderAll();
          haptic('light');
        };
      }
    } catch (e0) {}

    $('overlay').onclick = ()=>hideTop();

    $('settingsBtn').onclick = ()=>{ showModal('mSettings'); renderAll(); haptic('light'); };
    $('shopBtn').onclick = ()=>{ showModal('mShop'); renderShop(); haptic('light'); };
    $('btnDistricts').onclick = ()=>{ openScreen('mDistricts'); renderAll(); haptic('light'); };
    $('btnArena').onclick = ()=>{
      if (isGroupBattleActive()) {
        gfEnsureBattle();
        openScreen('mBattle');
        renderBattle();
      } else {
        openScreen('mArena');
        renderAll();
      }
      haptic('light');
    };
    $('btnBoss').onclick = ()=>{
      const bid = parseInt(state.bosses && state.bosses.activeFightId || 0, 10) || 0;
      const f = bid ? bfGetFight(bid) : null;
      const alive = f && (parseInt(f.hp||0,10)||0) > 0;
      const inTime = f && (parseInt(f.expiresTs||0,10)||0) > now();
      if (bid && f && alive && inTime){
        showModal('mBossFight');
        bfEnsureFight(bid);
        bfRender(bid);
        haptic('light');
        return;
      }
      openScreen('mBoss');
      renderBosses();
      haptic('light');
    };
    $('btnTop').onclick = ()=>{ openScreen('mTop'); renderTop100('LVL'); haptic('light'); };
    $('btnDice').onclick = ()=>{ openScreen('mDice'); renderDice(); haptic('light'); };
    $('btnClans').onclick = ()=>{ openScreen('mClans'); renderClans(); haptic('light'); };

    try {
      const ob = $('openTopBros');
      if (ob) ob.onclick = ()=>{ openScreen('mTopBros'); renderTopBrosModal(); haptic('light'); };
    } catch (e) {}

    try {
      const cc = $('clanCreate');
      if (cc) cc.onclick = ()=>clanCreate();
    } catch (e) {}

    try {
      const tl = $('top100Lvl');
      const tw = $('top100Wealth');
      const tb = $('top100Boss');
      const tc = $('top100Clans');
      if (tl) tl.onclick = ()=>{ renderTop100('LVL'); haptic('light'); };
      if (tw) tw.onclick = ()=>{ renderTop100('WEALTH'); haptic('light'); };
      if (tb) tb.onclick = ()=>{ renderTop100('BOSS'); haptic('light'); };
      if (tc) tc.onclick = ()=>{ renderTop100('CLANS'); haptic('light'); };
    } catch (e) {}

    try {
      $('bfShopOpen').onclick = ()=>{
        const bid = parseInt(state.bosses && state.bosses.activeFightId || 0, 10) || 0;
        if (!bid) return;
        showModal('mBfShop');
        bfShopRender();
        haptic('light');
      };
    } catch (e) {}

    $('arenaWeak').onclick = ()=>tryArenaFight('WEAK');
    $('arenaNorm').onclick = ()=>tryArenaFight('NORMAL');
    $('arenaElite').onclick = ()=>tryArenaFight('ELITE');

    try {
      const ac = $('arenaConsOpen');
      if (ac) ac.onclick = ()=>consOpen('arena');
    } catch (e) {}
    try {
      const bc = $('battleConsOpen');
      if (bc) bc.onclick = ()=>consOpen('battle');
    } catch (e) {}

    $('gfEnter').onclick = ()=>{ gfEnterBattle(); };
    $('gf1010Open').onclick = ()=>{
      if (isGroupBattleActive()) {
        gfEnterBattle();
        haptic('light');
        return;
      }
      showModal('mGFJoin');
      renderGFJoinMini();
      haptic('light');
    };
    $('gfJoinBtn').onclick = ()=>{ gfJoin(); renderGroupFightUI(); renderGFJoinMini(); };
    $('gf10Join').onclick = ()=>{ gf1010Join(); };
    $('gf10Leave').onclick = ()=>{ gf1010Leave(); };

    try {
      const leave = $('bLeave');
      if (leave) {
        leave.onclick = ()=>{
          if (!confirm('–ü–æ–∫–∏–Ω—É—Ç—å –±–æ–π? –ï—Å–ª–∏ —É–π–¥—ë—à—å ‚Äî –Ω–∞–≥—Ä–∞–¥—É –Ω–µ –ø–æ–ª—É—á–∏—à—å.')) return;
          state.groupFight.joined = false;
          state.groupFight.startTs = 0;
          state.groupFight.resolvedTs = 0;
          state.groupFight.battle = null;
          save();
          hideModal('mBattle');
          openScreen('mArena');
          renderAll();
        };
      }
    } catch (e) {}

    $('diceRoll').onclick = ()=>rollDice();
    $('diceRewardOk').onclick = ()=>hideModal('mDiceReward');

    const bsk = $('bfShopBuyKick');
    if (bsk) bsk.onclick = ()=>bfShopBuy('kick', 3);
    const bsn = $('bfShopBuyKnuckle');
    if (bsn) bsn.onclick = ()=>bfShopBuy('knuckle', 5);
    const bse = $('bfShopBuyEnema');
    if (bse) bse.onclick = ()=>bfShopBuy('enema', 8);

    $('nameBtn').onclick = ()=>{
      const n = prompt('–ò–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞:', state.playerName || 'PLAYER');
      if (!n) return;
      state.playerName = String(n).trim().substring(0, 14) || 'PLAYER';
      save();
      renderAll();
      haptic('light');
    };

    try {
      const it = $('inviteBtn');
      if (it) {
        it.onclick = ()=>{
          try {
            const url = location.href;
            const text = '–°—ã–≥—Ä–∞–π —Å–æ –º–Ω–æ–π –≤ ¬´–ë—Ä–∞—Ç—Å—Ç–≤–æ –ö–æ–Ω—Ü–∞¬ª –≤ Telegram!';
            const share = 'https://t.me/share/url?url=' + encodeURIComponent(url) + '&text=' + encodeURIComponent(text);
            if (tg && tg.openTelegramLink) tg.openTelegramLink(share);
            else if (tg && tg.openLink) tg.openLink(share);
            else window.open(share, '_blank');
            toast('–û—Ç–∫—Ä—ã–≤–∞—é –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ‚Ä¶','gold');
          } catch (e) {
            toast('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ','lose');
          }
        };
      }
    } catch (e) {}

    $('setSound').onchange = (e)=>{ state.settings.sound = !!e.target.checked; save(); };
    $('setHaptics').onchange = (e)=>{ state.settings.haptics = !!e.target.checked; save(); };
    $('setReduced').onchange = (e)=>{
      state.settings.reduced = !!e.target.checked;
      document.body.style.transition = state.settings.reduced ? 'none' : '';
      save();
    };

    $('resetBtn').onclick = ()=>{
      if (!confirm('–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å?')) return;
      hardReset();
    };
  }

  function renderTop100(kind){
    const box = $('top100List');
    if (!box) return;
    const me = state.playerName || 'PLAYER';
    const lvl = parseInt(state.level||1,10)||1;
    const stats = GYM_STATS.reduce((a,s)=>a + (parseInt(state.gym && state.gym[s.key] || 1,10) || 1), 0);
    const bossesWins = 0;

    if (kind==='CLANS'){
      try { clanDbSeed(); } catch (e0) {}
      const ids = (state.clansDb && Array.isArray(state.clansDb.order)) ? state.clansDb.order.slice() : [];
      const rows2 = ids.map(id=>{
        const c = state.clansDb.clans && state.clansDb.clans[id] ? state.clansDb.clans[id] : null;
        if (!c) return null;
        const total = parseInt(c.totalBossDmg||0,10)||0;
        const lvl2 = clanLevelFromDmg(total);
        const members = Array.isArray(c.members) ? c.members.length : 0;
        return { id, name:String(c.name||'‚Äî'), lvl:lvl2, dmg:total, members:members };
      }).filter(Boolean);

      const sorted2 = rows2.slice().sort((a,b)=>{
        if (b.lvl !== a.lvl) return b.lvl - a.lvl;
        return (b.dmg||0) - (a.dmg||0);
      }).slice(0,100);

      box.innerHTML = sorted2.map((r,idx)=>{
        const medal = idx===0 ? 'ü•á' : (idx===1 ? 'ü•à' : (idx===2 ? 'ü•â' : ''));
        const mStyle = idx===0 ? 'color:var(--gold);' : (idx===1 ? 'color:rgba(226,232,240,.95);' : (idx===2 ? 'color:rgba(251,146,60,.95);' : ''));
        const left = medal ? ('<div class="badge" style="padding:6px 8px; font-size:11px; '+mStyle+'">'+medal+'</div>') : '';
        const val = '–õ–í–õ '+r.lvl+' ¬∑ '+fmt4(r.dmg)+' ¬∑ '+r.members+'/100';
        return '<div class="row">'
          + '<div style="display:flex; align-items:center; gap:8px; min-width:0; flex:1">'
          + left
          + '<div style="min-width:0; font-size:12px; opacity:.9">#'+(idx+1)+' '+r.name+'</div>'
          + '</div>'
          + '<div class="badge" style="padding:6px 8px; font-size:11px">'+val+'</div>'
          + '</div>';
      }).join('') || '<div style="opacity:.75; font-size:12px">‚Äî</div>';
      return;
    }

    const rows = [];
    for (let i=1;i<=99;i++){
      rows.push({
        name: '–ò–≥—Ä–æ–∫ ' + i,
        lvl: 1 + Math.floor(Math.random()*60),
        stats: 7 + Math.floor(Math.random()*900),
        boss: Math.floor(Math.random()*60)
      });
    }
    rows.push({ name: me+' (—Ç—ã)', lvl, stats, boss: bossesWins });

    let sorted = rows;
    if (kind==='LVL') sorted = rows.slice().sort((a,b)=>b.lvl-a.lvl);
    if (kind==='WEALTH') sorted = rows.slice().sort((a,b)=>b.stats-a.stats);
    if (kind==='BOSS') sorted = rows.slice().sort((a,b)=>b.boss-a.boss);
    sorted = sorted.slice(0,100);

    box.innerHTML = sorted.map((r,idx)=>{
      const medal = idx===0 ? 'ü•á' : (idx===1 ? 'ü•à' : (idx===2 ? 'ü•â' : ''));
      const mStyle = idx===0 ? 'color:var(--gold);' : (idx===1 ? 'color:rgba(226,232,240,.95);' : (idx===2 ? 'color:rgba(251,146,60,.95);' : ''));
      const v = (kind==='LVL') ? ('–£–†. '+r.lvl) : (kind==='WEALTH' ? (String(r.stats)) : (String(r.boss)));
      const left = medal ? ('<div class="badge" style="padding:6px 8px; font-size:11px; '+mStyle+'">'+medal+'</div>') : '';
      return '<div class="row">'
        + '<div style="display:flex; align-items:center; gap:8px; min-width:0; flex:1">'
        + left
        + '<div style="min-width:0; font-size:12px; opacity:.9">#'+(idx+1)+' '+r.name+'</div>'
        + '</div>'
        + '<div class="badge" style="padding:6px 8px; font-size:11px">'+v+'</div>'
        + '</div>';
    }).join('');
  }

  // --- Clock
  function tickUTC(){
    const d = new Date();
    $('utc').textContent = 'UTC: ' + pad2(d.getUTCHours()) + ':' + pad2(d.getUTCMinutes()) + ':' + pad2(d.getUTCSeconds());
    try { bizRewardBtnUpdate(); } catch (e) {}
  }

  // --- Theme
  function applyTgTheme(){
    try {
      if (!tg || !tg.themeParams) return;
      const tp = tg.themeParams;
      const root = document.documentElement;
      if (tp.button_color) root.style.setProperty('--accent', String(tp.button_color));
      if (tp.link_color) root.style.setProperty('--accent2', String(tp.link_color));
      if (tp.button_text_color) root.style.setProperty('--text', String(tp.button_text_color));
    } catch (e) {}
  }
  applyTgTheme();
  try { if (tg && typeof tg.onEvent==='function') tg.onEvent('themeChanged', applyTgTheme); } catch (e) {}

  // --- Boot
  function init(){
    // seed starting items
    firstRunSeed();

    $('setSound').checked = !!state.settings.sound;
    $('setHaptics').checked = !!state.settings.haptics;
    $('setReduced').checked = !!state.settings.reduced;

    bindUI();
    renderAll();
    save();

    // main loop
    tickUTC();
    setInterval(()=>{
      tickUTC();
      tickEnergy();
      tickStrikes();
      tickBattle();
      tickGF1010();

      const bid = parseInt(state.bosses && state.bosses.activeFightId || 0, 10) || 0;
      if (bid){
        bfEnsureFight(bid);
        bfFriendTick(bid);
        try {
          const f2 = bfGetFight(bid);
          if (f2 && (parseInt(f2.hp||0,10)||0) <= 0) {
            bfCheckWin(bid);
          } else {
            if ($('mBossFight').classList.contains('show') || $('mBfShop').classList.contains('show')) bfRender(bid);
          }
        } catch (e) {
          if ($('mBossFight').classList.contains('show') || $('mBfShop').classList.contains('show')) bfRender(bid);
        }
      }

      // auto-open group fight battle when start time comes (popup over arena)
      try {
        const st = parseInt(state.groupFight && state.groupFight.startTs || 0, 10) || 0;
        const joined = !!(state.groupFight && state.groupFight.joined);
        if (joined && st && now() >= st) {
          const b = gfEnsureBattle();
          if (b && $('mArena').classList.contains('show')) {
            if ((parseInt(state.groupFight.autoShownStartTs||0,10)||0) !== st) {
              state.groupFight.autoShownStartTs = st;
              showModal('mBattle');
              renderBattle();
              toast('–ì—Ä—É–ø–ø–æ–≤–æ–π –±–æ–π –Ω–∞—á–∞–ª—Å—è','gold');
              haptic('light');
            }
          }
        }
      } catch (e) {}

      $('energyTimer').textContent = energyTimerText();

      if ($('mArena').classList.contains('show')) {
        renderArena();
        renderGym();
        renderArenaPetShop();
      }
      if ($('mBoss').classList.contains('show')) renderBosses();
      if ($('mBattle').classList.contains('show')) renderBattle();
      if ($('mGF1010').classList.contains('show')) gf1010Render();
      if ($('mGFJoin').classList.contains('show')) renderGFJoinMini();

      renderHUD();
      save();
    }, 1000);

    // save on hide
    document.addEventListener('visibilitychange', ()=>{ if (document.hidden) save(); });
    window.addEventListener('pagehide', save);

    updateBackButton();
  }

  init();
})();
</script>
</body>
</html>
