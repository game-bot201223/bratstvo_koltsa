<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
 <meta name="theme-color" content="#3b2a1b" />
 <title>–ë—Ä–∞—Ç—Å—Ç–≤–æ –ö–æ–Ω—Ü–∞ ‚Äî Mobile TG Edition</title>
 <script src="https://telegram.org/js/telegram-web-app.js"></script>
 <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@500;700;900&display=swap" rel="stylesheet">
 <style>
 :root{
   --tg-vh: 100dvh;
   --bg0:#2a1e14; --bg1:#3b2a1b; --bg2:#4a3422;
   --glass:rgba(74,52,34,.74);
   --glass2:rgba(74,52,34,.54);
   --line:rgba(255,255,255,.16);
   --text:rgba(255,255,255,.92);
   --muted:rgba(255,255,255,.70);
   --accent:#c084fc;
   --accent2:#a855f7;
  --energy:#22d3ee;
  --gold:#fbbf24;
  --silver:#e2e8f0;
  --morin:#d946ef;
  --win:#34d399;
  --lose:#fb7185;
  --r:18px;
  --r2:14px;
  --shadow:0 18px 42px rgba(0,0,0,.55);
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
html,body{height:100%;}
body{
  font-family:'Cinzel',serif;
  color:var(--text);
  background:
    linear-gradient(180deg,var(--bg0) 0%, var(--bg1) 45%, var(--bg0) 100%);
  overflow:hidden;
}

/* Background grain */
body:before{content:'';position:fixed;inset:0;background:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.05'/%3E%3C/svg%3E");pointer-events:none;z-index:0;}

#app{
  position:relative;
  z-index:1;
  height:var(--tg-vh);
  display:flex;
  flex-direction:column;
  padding-top:env(safe-area-inset-top);
}

/* Top HUD */
.hud{
  padding:12px 14px 10px;
  background:linear-gradient(180deg, rgba(74,52,34,.86) 0%, rgba(42,30,20,.55) 100%);
  border-bottom:1px solid rgba(255,255,255,.06);
  backdrop-filter: blur(16px);
}
.hudRow{display:flex;align-items:center;justify-content:space-between;gap:10px;}
.name{
  display:flex;align-items:center;gap:10px;
  min-width:0;
  font-weight:900;
  letter-spacing:1.5px;
  cursor:pointer;
}
.name span{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:52vw;}
.utcMini{font-size:10px;opacity:.75;letter-spacing:2px;margin-left:6px;white-space:nowrap;}
.nameCol{display:flex;flex-direction:column;min-width:0;gap:2px;}
.nameLine{display:flex;align-items:center;gap:8px;min-width:0;}
.utcRow{display:flex;align-items:baseline;gap:6px;opacity:.78;}
.utcTag{font-size:9px;letter-spacing:2px;opacity:.75;}
 .lvl{font-size:11px;opacity:.85;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(0,0,0,.14)}

.pills{display:flex;align-items:center;gap:8px;}
 .pill{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(0,0,0,.14);font-size:12px;}
.energyPill{flex-direction:column;align-items:flex-start;gap:2px;line-height:1.05;}
.energyPill .eRow{display:flex;align-items:center;gap:8px;}
.energyPill .eTimer{font-size:10px;letter-spacing:2px;opacity:.70;margin-left:22px;}
.pill strong{font-weight:900;letter-spacing:1px;}

.xp{margin-top:3px;position:relative;height:22px;border-radius:999px;background:rgba(0,0,0,.22);border:1px solid rgba(255,255,255,.10);overflow:hidden;}
.xpFill{position:absolute;inset:0;width:0%;background:linear-gradient(90deg, rgba(234,214,191,.90), rgba(217,194,163,.92));box-shadow:0 0 24px rgba(217,194,163,.22);}
.xpText{position:relative;z-index:1;font-size:11px;letter-spacing:2px;text-align:center;line-height:22px;opacity:.92}

/* Main */
.main{
  padding: 0 14px 16px;
  flex:1;
  min-height:0;
  overflow:hidden;
  display:flex;
  flex-direction:column;
}
.hero{
  margin:12px 14px 0;
  border-radius:var(--r);
  border:1px solid rgba(255,255,255,.10);
  background:linear-gradient(145deg, rgba(74,52,34,.60), rgba(42,30,20,.72));
  box-shadow: var(--shadow);
  overflow:hidden;
  position:relative;
}
.heroTop{padding:14px 14px 12px;display:flex;align-items:center;justify-content:space-between;gap:10px;}
.heroTitle{font-weight:900;letter-spacing:4px;font-size:12px;opacity:.90}
.heroSub{font-size:11px;opacity:.75;margin-top:4px;letter-spacing:2px}

.timeCenter{margin:10px 14px 0;text-align:center;font-size:11px;letter-spacing:2px;opacity:.78;}
.timeTop{padding:8px 14px 0;text-align:center;font-size:11px;letter-spacing:2px;opacity:.78;}

.heroGrid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:4px;padding:0 8px 8px;}
.tile{border-radius:12px;border:1px solid rgba(255,255,255,.10);background:var(--glass2);padding:5px 5px;min-height:40px;display:flex;flex-direction:column;justify-content:center;gap:3px;}
.tile .k{font-size:10px;opacity:.78;letter-spacing:2px}
.tile .v{font-weight:900;letter-spacing:1px;font-size:9px;}
.tile.gold,.tile.silver,.tile.morin{align-items:center;text-align:center;}
.tile.gold .v,.tile.silver .v,.tile.morin .v{font-size:14px;line-height:1;}
.tile.shop{padding:8px;}
.tile.shop .k{margin-bottom:2px;}
.tile.shop{padding:6px;}
.tile.shop .k{font-size:9px;letter-spacing:2px;}
.tile.shop .shopMini{width:100%;height:28px;border-radius:10px;font-size:9px;letter-spacing:1px;padding:0 6px;}
.shopIconBtn{
  width:100%;
  height:28px;
  border-radius:10px;
  border:1px solid rgba(192,132,252,.28);
  background:
    radial-gradient(circle at 30% 30%, rgba(192,132,252,.22), transparent 60%),
    rgba(0,0,0,.20);
  box-shadow: 0 10px 28px rgba(58,36,18,.25), inset 0 1px 0 rgba(255,255,255,.06);
  cursor:pointer;
  padding:0;
  position:relative;
}
.shopIconBtn:active{transform:translateY(1px)}
.shopIconBtn:before{
  content:'';
  position:absolute;
  inset:0;
  background-repeat:no-repeat;
  background-position:center;
  background-size:18px 18px;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'%3E%3Cpath fill='white' fill-opacity='0.92' d='M6 7h15l-1.5 8.5a2 2 0 0 1-2 1.5H9a2 2 0 0 1-2-1.6L5.3 4H2V2h4a1 1 0 0 1 .97.76L7.4 5H22v2H6.6l.4 2z'/%3E%3Cpath fill='white' fill-opacity='0.92' d='M9 22a2 2 0 1 1 0-4a2 2 0 0 1 0 4zm10 0a2 2 0 1 1 0-4a2 2 0 0 1 0 4z'/%3E%3C/svg%3E");
}
.statGrid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:6px;margin-top:10px;}
.statTile{border-radius:14px;border:1px solid var(--line);background:rgba(0,0,0,.14);padding:8px;min-height:64px;display:flex;flex-direction:column;gap:5px;}
.statTile .stK{font-size:10px;letter-spacing:2px;opacity:.78;}
.statTile .stV{font-weight:900;letter-spacing:1px;font-size:12px;}
.statTile .stMeta{font-size:10px;opacity:.72;line-height:1.25;}
.statTile .stBtn{margin-top:auto;}

.petRow{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:6px;}
.petCard{border-radius:14px;border:1px solid var(--line);background:rgba(0,0,0,.14);padding:8px;display:flex;flex-direction:column;gap:6px;min-height:96px;}
.petCard .pTop{display:flex;align-items:center;justify-content:center;}
.petCard .petPic{position:relative;width:100%;aspect-ratio:1/1;border-radius:12px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.16);display:flex;align-items:center;justify-content:center;overflow:hidden;}
.petCard .pIco{font-size:28px;line-height:1;}
.petCard .petPct{position:absolute;left:0;right:0;bottom:0;padding:4px 6px;font-size:10px;letter-spacing:1px;text-align:center;background:linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(0,0,0,.65) 100%);}
.petCard .pBtn{margin-top:auto;}

.costRow{display:grid;grid-template-columns:1fr auto;align-items:center;gap:10px;}
.ctaMini{padding:9px 12px;border-radius:999px;font-size:11px;letter-spacing:1px;white-space:nowrap;justify-self:center;}

.feed{
  margin:12px 14px;
  border-radius:var(--r);
  border:1px solid var(--line);
  background:rgba(0,0,0,.14);
  overflow:hidden;
}
.feedHead{padding:12px 14px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;gap:10px;}
.feedHead .t{font-weight:900;letter-spacing:3px;font-size:11px;opacity:.88}
.feedBody{max-height:22vh;overflow:auto;padding:10px 14px;display:flex;flex-direction:column;gap:8px;}
.feedItem{font-size:11px;opacity:.90;line-height:1.35;padding:8px 10px;border-radius:14px;border:1px solid var(--line);background:var(--glass2)}

 .friendsPanel{margin:10px 14px 12px; flex:0 0 auto;}
 .friendsBody{padding:12px 14px;}
 .friendsRow{display:flex;gap:10px;overflow:auto;scroll-snap-type:x mandatory;touch-action:pan-x;-webkit-overflow-scrolling:touch;}
 .friendsRow::-webkit-scrollbar{height:6px;}
 .friendsRow::-webkit-scrollbar-thumb{background:var(--line);border-radius:999px;}
 .friendCard{scroll-snap-align:start;min-width:90px;max-width:90px;border-radius:18px;border:1px solid var(--line);background:var(--glass2);padding:12px;display:flex;flex-direction:column;gap:8px;}
 .friendTop{display:flex;align-items:center;justify-content:space-between;gap:10px;}
 .dot{width:10px;height:10px;border-radius:999px;background:rgba(255,255,255,.25);box-shadow:0 0 0 2px rgba(0,0,0,.15) inset;}
 .dot.on{background:rgba(52,211,153,.90);box-shadow:0 0 18px rgba(52,211,153,.35);}
 .friendName{font-weight:900;letter-spacing:1px;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
 .friendMeta{font-size:11px;opacity:.75;line-height:1.25}

/* Bottom dock */
.bottomStack{margin-top:auto;display:flex;flex-direction:column;}
.dock{
  padding:10px 12px calc(10px + env(safe-area-inset-bottom));
  background:linear-gradient(0deg, rgba(42,30,20,.96) 0%, rgba(74,52,34,.70) 100%);
  backdrop-filter: blur(16px);
}
.dockRow{display:grid;grid-template-columns:repeat(6,minmax(0,1fr));gap:8px;}
.btn{
  border:none;
  border-radius:999px;
  padding:10px 10px;
  background:linear-gradient(145deg, rgba(74,52,34,.92), rgba(42,30,20,.92));
  border:1px solid rgba(192,132,252,.25);
  box-shadow: 0 10px 26px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.06);
  color:var(--text);
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  font-weight:900;
  letter-spacing:1px;
  font-size:12px;
}
.btn:active{transform:translateY(1px)}
.btnSmall{font-size:11px;padding:9px 10px;opacity:.95}

 .diceTitle{display:flex; align-items:center; justify-content:center; gap:10px; letter-spacing:4px; font-weight:900; font-size:14px; opacity:.92; margin-top:2px;}
 .diceTitle .ico{font-size:18px;}
 .dicePrice{margin-top:10px; text-align:center; font-size:12px; opacity:.85;}
 .diceGrid{margin-top:14px; display:grid; grid-template-columns:repeat(5,1fr); gap:14px;}
 .dieBox{aspect-ratio:1/1; border-radius:14px; border:2px solid rgba(255,255,255,.85);
   background:rgba(0,0,0,.18);
   display:flex; align-items:center; justify-content:center;
   font-weight:900; font-size:30px; letter-spacing:2px;
   box-shadow: 0 18px 45px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.05);
   cursor:pointer;
 }
 .dieBox:active{ transform: translateY(1px); }
 .dicePrimary{ margin-top:24px; padding:14px 16px; font-size:12px; letter-spacing:4px; width:min(320px, 76%); margin-left:auto; margin-right:auto; display:block; }

 .bossRow{display:grid;grid-template-columns:140px 1fr;gap:12px;align-items:flex-start;}
 .bossMini{width:140px;height:140px;border-radius:26px;border:2px solid rgba(255,255,255,.14);background:linear-gradient(145deg, rgba(192,132,252,.18), rgba(0,0,0,.22));display:flex;align-items:center;justify-content:center;font-size:56px;}
  .bossName{font-weight:900;letter-spacing:2px;line-height:1.15;}
  .bossSub{font-size:11px;opacity:.75;margin-top:4px;}
  .bossReward{margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
 .bossWinnerTop{font-size:11px;letter-spacing:1px;opacity:.75;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
 .bossWinnerNm{font-size:12px;letter-spacing:1px;opacity:.9;white-space:nowrap;max-width:260px;overflow:hidden;text-overflow:ellipsis;}

 .bossFightHero{display:flex;align-items:center;justify-content:space-between;gap:12px;}
 .bossFightBig{width:180px;height:180px;border-radius:34px;border:2px solid rgba(255,255,255,.14);background:linear-gradient(145deg, rgba(192,132,252,.18), rgba(0,0,0,.22));display:flex;align-items:center;justify-content:center;font-size:78px;flex:0 0 auto;}
 .bossFightMeta{min-width:0;flex:1;}

 .toothBtn{position:relative; width:44px; height:40px; border-radius:14px; border:1px solid rgba(251,191,36,.55); background:linear-gradient(180deg, rgba(251,191,36,.24) 0%, rgba(42,30,20,.70) 100%); color:rgba(251,191,36,.95); cursor:pointer; display:flex; flex-direction:column; align-items:center; justify-content:center; line-height:1; box-shadow: 0 10px 26px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.06);}
 .toothBtn .ico{font-size:18px;}
 .toothBtn .tm{font-size:9px; opacity:.82; margin-top:2px; letter-spacing:1px; color:rgba(255,255,255,.92)}
 .toothBtn.ready{border-color: rgba(251,191,36,.95); box-shadow: 0 0 0 2px rgba(251,191,36,.18) inset, 0 0 22px rgba(251,191,36,.35), 0 10px 26px rgba(0,0,0,.45);}
 .toothBtn.ready .tm{opacity:1;}

/* Modals */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.46);backdrop-filter: blur(10px);display:none;z-index:4900;}
.overlay.show{display:block;}

.modal{
  position:fixed;
  inset:0;
  z-index:5000;
  display:none;
  padding: calc(14px + env(safe-area-inset-top)) 14px calc(14px + env(safe-area-inset-bottom));
}
.modalBossFight{ z-index: 5300; }
.modalBfShop{ z-index: 5400; }
.modalBossFightRes{ z-index: 5500; }
.modal.show{display:block;}
.modal.modalMini{ z-index: 5200; display:none; align-items:center; justify-content:center; }
.modal.modalMini.show{ display:flex; }
.modal.modalMini.modalBfShop{ z-index: 5400; }
.modal.modalMini.modalBossFightRes{ z-index: 5500; }
.sheet{
  height:100%;
  border-radius:22px;
  border:1px solid rgba(255,255,255,.14);
  background:linear-gradient(180deg, rgba(74,52,34,.85) 0%, rgba(42,30,20,.85) 100%);
  box-shadow: 0 30px 80px rgba(0,0,0,.65);
  overflow:hidden;
  display:flex;
  flex-direction:column;
}

.sheetScreen{
  border-radius:0;
  border:none;
  box-shadow:none;
}

 #mBoss .sheet{border-radius:0;border:none;box-shadow:none;}

.sheetScreen .sheetBody{
  padding:0;
}

 #mBattle .hpMini{display:flex;align-items:center;gap:10px;min-width:0;}
 #mBattle .hpBar{position:relative;width:120px;max-width:32vw;height:6px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.22);overflow:hidden;box-shadow: inset 0 1px 0 rgba(255,255,255,.06);}
 #mBattle .hpFill{height:100%;width:0%;background:linear-gradient(90deg, rgba(52,211,153,.95), rgba(34,211,238,.85));}
 #mBattle .hpIn{position:absolute;inset:-8px 0 auto 0;height:22px;display:flex;align-items:center;justify-content:center;font-size:10px;letter-spacing:1px;white-space:nowrap;color:rgba(255,255,255,.98);font-weight:900;text-shadow:0 2px 4px rgba(0,0,0,.95);pointer-events:none;}
 #mBattle .hpTxt{font-size:11px;letter-spacing:1px;white-space:nowrap;}
 #mBattle #bLog .feedItem{padding:6px 8px;border-radius:12px;font-size:11px;line-height:1.25;}

 #mConsumables.consFull{padding:0;}
 #mConsumables.consFull.modalMini{align-items:stretch;justify-content:stretch;}
 #mConsumables.consFull .sheet{width:100vw;max-width:none;height:100vh;max-height:none;border-radius:0;border:none;box-shadow:none;}
 #mConsumables.consFull .sheetBody{padding:12px;overflow:auto;}

 .modalPage{
  padding:0;
 }

.sheetMini{
  border:1px solid rgba(255,255,255,.18);
  background:linear-gradient(180deg, rgba(74,52,34,1) 0%, rgba(42,30,20,1) 100%);
  box-shadow: 0 28px 70px rgba(0,0,0,.70);
  height:auto;
  max-height: calc(100vh - 28px - env(safe-area-inset-top) - env(safe-area-inset-bottom));
}

.sheetOpaque{
  background:linear-gradient(180deg, rgba(74,52,34,1) 0%, rgba(42,30,20,1) 100%);
  box-shadow: 0 34px 90px rgba(0,0,0,.75);
}

/* Arena compact */
#mArena .sheetHead{padding:10px 10px;}
#mArena .sheetBody{padding:0;}
#mArena .card{padding:10px; margin-top:6px !important; border-radius:16px;}
#mArena .btn{padding:10px 10px;}
#mArena .btnSmall{padding:7px 9px;}
#mArena .badge{padding:6px 8px;}
#mArena #arenaSectionGroup .row{align-items:center;}
#mArena #arenaGroupHint{margin-top:6px !important;}
#mArena .grid3{gap:8px;}
.sheetHead{padding:12px 12px;border-bottom:1px solid rgba(255,255,255,.06);display:flex;align-items:center;justify-content:space-between;gap:10px;}
.sheetHead .title{font-weight:900;letter-spacing:4px;font-size:12px;opacity:.9}
.iconBtn{width:44px;height:40px;border-radius:14px;border:1px solid rgba(255,255,255,.16);background:rgba(0,0,0,.16);color:rgba(255,255,255,.92);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:20px;}
.sheetBody{flex:1;min-height:0;overflow:auto;padding:12px;}

.card{border-radius:18px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.16);padding:12px;}
.row{display:flex;align-items:center;justify-content:space-between;gap:12px;}
.k{font-size:11px;opacity:.78;letter-spacing:2px}
.v{font-weight:900;}

.grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;}
.slot{border-radius:16px;border:1px solid rgba(255,255,255,.10);background:var(--glass2);padding:10px;min-height:78px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;cursor:pointer;}
.slot .ico{font-size:28px;}
.slot .nm{font-size:10px;letter-spacing:1.5px;opacity:.88;text-align:center;line-height:1.2}

.toggle{display:flex;align-items:center;gap:10px;}
.toggle input{width:20px;height:20px;}

.badge{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:8px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.16);font-size:12px;}

.toastWrap{position:fixed;left:0;right:0;bottom:calc(84px + env(safe-area-inset-bottom));z-index:9000;display:flex;justify-content:center;pointer-events:none;padding:0 14px;}
.toast{max-width:min(92vw,520px);border-radius:16px;border:1px solid rgba(255,255,255,.12);background:rgba(42,30,20,.92);backdrop-filter: blur(16px);box-shadow:0 20px 60px rgba(0,0,0,.70);padding:12px 14px;font-size:12px;letter-spacing:1px;opacity:0;transform:translateY(8px);transition:opacity .18s ease, transform .18s ease;}
.toast.show{opacity:1;transform:translateY(0)}
.toast.win{border-color:rgba(52,211,153,.35)}
.toast.lose{border-color:rgba(251,113,133,.35)}
.toast.morin{border-color:rgba(217,70,239,.35)}
.toast.gold{border-color:rgba(251,191,36,.35)}

@media (max-width:420px){
  .dockRow{gap:6px}
  .btn{font-size:11px}
  .heroGrid{gap:4px;padding:0 8px 8px}
  .tile{min-height:38px;padding:5px}
  .tile.shop .shopMini{height:28px;font-size:9px}
}

@media (prefers-reduced-motion: reduce){
  *{scroll-behavior:auto !important;transition:none !important;animation:none !important;}
}
</style>
</head>
<body>
<div id="app">
  <div class="hud">
    <div class="hudRow">
      <div class="name" id="nameBtn">
        <div style="opacity:.9">üëë</div>
        <div class="nameCol">
          <div class="nameLine"><span id="playerName">PLAYER</span><div class="lvl" id="playerLevel">–£–†. 1</div></div>
          <div class="utcRow"><span class="utcMini" id="utc">00:00</span><span class="utcTag">UTC</span></div>
        </div>
      </div>
      <div class="pills">
        <div class="pill energyPill" style="border-color:rgba(34,211,238,.20)">
          <div class="eRow">‚ö° <strong id="energy">100</strong>/<span id="energyMax">100</span></div>
          <div class="eTimer" id="energyTimer">02:00</div>
        </div>
        <button class="iconBtn" id="settingsBtn" aria-label="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">‚öôÔ∏è</button>
        <div class="badge" id="syncState" style="opacity:.8; display:none;">–°–ï–ô–í: OK</div>
      </div>
    </div>
    <div class="xp">
      <div class="xpFill" id="xpFill"></div>
      <div class="xpText" id="xpText">0 / 0 XP</div>
    </div>

    <div class="heroGrid">
      <div class="tile gold" id="tileGold"><div class="v">ü™ô <span id="gold">0</span></div></div>
      <div class="tile silver" id="tileSilver"><div class="v">ü•à <span id="silver">0</span></div></div>
      <div class="tile morin" id="tileMorin"><div class="v">ü¶∑ <span id="morin">0</span></div></div>
      <div class="tile shop" id="tileShop"><button class="shopIconBtn" id="shopBtn" aria-label="–ú–∞–≥–∞–∑–∏–Ω"></button></div>
    </div>
  </div>

  <div class="main">
    <div class="bottomStack">
      <div class="dock">
        <div class="dockRow">
          <button class="btn" id="btnDistricts">üó∫Ô∏è –†–∞–π–æ–Ω—ã</button>
          <button class="btn" id="btnArena">‚öîÔ∏è –ê—Ä–µ–Ω–∞</button>
          <button class="btn" id="btnBoss">üëπ –ë–æ—Å—Å—ã</button>
          <button class="btn" id="btnDice">üé≤ –ö–æ—Å—Ç–∏</button>
          <button class="btn" id="btnTop">üèÜ –¢–æ–ø</button>
          <button class="btn" id="btnClans">üè∞ –ö–ª–∞–Ω—ã</button>
        </div>
      </div>

      <div class="feed friendsPanel">
        <div class="feedHead">
          <div class="t">–ë–†–ê–¢–í–ê –û–ù–õ–ê–ô–ù</div>
          <button class="btn btnSmall" id="inviteBtn">+ –î–†–£–ì</button>
        </div>
        <div class="friendsBody">
          <div class="friendsRow" id="friendsRow"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal modalMini" id="mGFJoin" role="dialog" aria-modal="true">
  <div class="sheet sheetMini">
    <div class="sheetHead">
      <button class="iconBtn" data-close="mGFJoin">‚Äπ</button>
      <div class="title">–ì–†–£–ü–ü–û–í–û–ô –ë–û–ô</div>
      <div style="width:44px"></div>
    </div>
    <div class="sheetBody">
      <div class="card">
        <div class="row"><div><div class="k">–°–¢–ê–†–¢ (UTC)</div><div style="font-size:12px;opacity:.75">–°–±–æ—Ä 1 –º–∏–Ω—É—Ç–∞</div></div><div class="badge" id="gfJoinStart">--:--</div></div>
        <div class="row" style="margin-top:10px;"><div><div class="k">–¶–ï–ù–ê –í–•–û–î–ê</div><div style="font-size:12px;opacity:.75">–ó–∞–≤–∏—Å–∏—Ç –æ—Ç —á–∞—Å–∞</div></div><div class="badge" style="color:var(--gold)" id="gfJoinCost">0 ü™ô</div></div>
        <div class="row" style="margin-top:10px;"><div class="k">–î–û –°–¢–ê–†–¢–ê</div><div class="badge" id="gfJoinLeft">--:--</div></div>
        <div style="margin-top:12px; display:flex; gap:10px; align-items:center;">
          <button class="btn" style="flex:1" id="gfJoinBtn">–ü–û–î–ê–¢–¨ –ó–ê–Ø–í–ö–£</button>
          <div class="badge" id="gfJoinBtnTimer">--:--</div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal" id="mGF1010" role="dialog" aria-modal="true">
  <div class="sheet">
    <div class="sheetHead">
      <button class="iconBtn" data-close="mGF1010">‚Äπ</button>
      <div class="title">–ì–†–£–ü–ü–û–í–û–ô –ë–û–ô 10√ó10</div>
      <div style="width:44px"></div>
    </div>
    <div class="sheetBody">
      <div class="card">
        <div class="row"><div><div class="k">–°–¢–ê–†–¢ (UTC)</div><div style="font-size:12px;opacity:.75">–°–±–æ—Ä 1 –º–∏–Ω—É—Ç–∞</div></div><div class="badge" id="gf10Start">--:--</div></div>
        <div class="row" style="margin-top:10px;"><div><div class="k">–¶–ï–ù–ê –í–•–û–î–ê</div><div style="font-size:12px;opacity:.75">–ß–µ—Ä–µ–¥–æ–≤–∞–Ω–∏–µ –ø–æ —á–∞—Å—É</div></div><div class="badge" style="color:var(--gold)" id="gf10Cost">0 ü™ô</div></div>
        <div class="row" style="margin-top:10px;"><div class="k">–°–û–ë–†–ê–ù–û</div><div class="badge" id="gf10Count">0</div></div>
        <div style="margin-top:10px; font-size:12px; opacity:.85; line-height:1.35" id="gf10Status">‚Äî</div>
        <div style="margin-top:10px; display:flex; gap:10px;">
          <button class="btn" id="gf10Join">–ü–û–î–ê–¢–¨ –ó–ê–Ø–í–ö–£</button>
          <button class="btn" id="gf10Leave" style="display:none; opacity:.85;">–û–¢–ú–ï–ù–ê</button>
        </div>
      </div>

      <div class="card" style="margin-top:12px; display:none;" id="gf10FightCard">
        <div class="row"><div class="k">–†–ê–£–ù–î</div><div class="badge" id="gf10Round">1</div></div>
        <div class="row" style="margin-top:10px;"><div class="k">–¢–ê–ô–ú–ï–†</div><div class="badge" id="gf10Timer">10</div></div>
        <div class="row" style="margin-top:10px;"><div class="k">–¶–ï–õ–¨</div><div class="badge" id="gf10Target">–ê–≤—Ç–æ</div></div>
      </div>

      <div class="card" style="margin-top:12px; display:none;" id="gf10TargetsCard">
        <div class="row"><div class="k">–í–†–ê–ì–ò</div><div style="font-size:12px;opacity:.75">–í—ã–±–µ—Ä–∏ —Ü–µ–ª—å –∑–∞ 10 —Å–µ–∫</div></div>
        <div class="gfList" id="gf10Targets"></div>
      </div>

      <div class="card" style="margin-top:12px; display:none;" id="gf10LogCard">
        <div class="row"><div class="k">–õ–û–ì</div></div>
        <div style="margin-top:10px; display:flex; flex-direction:column; gap:8px;" id="gf10Log"></div>
      </div>
    </div>
  </div>
</div>

<div class="overlay" id="overlay"></div>

<!-- Settings -->
<div class="modal" id="mSettings" role="dialog" aria-modal="true">
  <div class="sheet">
    <div class="sheetHead">
      <button class="iconBtn" data-close="mSettings">‚Äπ</button>
      <div class="title">–ù–ê–°–¢–†–û–ô–ö–ò</div>
      <div style="width:44px"></div>
    </div>
    <div class="sheetBody">
      <div class="card" style="display:flex; flex-direction:column; gap:12px;">
        <div class="row"><div><div class="k">–ó–í–£–ö</div><div style="font-size:12px; opacity:.75">–≠—Ñ—Ñ–µ–∫—Ç—ã</div></div><div class="toggle"><input id="setSound" type="checkbox"></div></div>
        <div class="row"><div><div class="k">–•–ê–ü–¢–ò–ö–ê</div><div style="font-size:12px; opacity:.75">–í–∏–±—Ä–æ</div></div><div class="toggle"><input id="setHaptics" type="checkbox"></div></div>
        <div class="row"><div><div class="k">–ú–ï–ù–¨–®–ï –ê–ù–ò–ú–ê–¶–ò–ô</div><div style="font-size:12px; opacity:.75">–î–ª—è —Å–ª–∞–±—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤</div></div><div class="toggle"><input id="setReduced" type="checkbox"></div></div>
      </div>
      <div class="card" style="margin-top:12px;">
        <div class="row"><div class="k">–°–ë–†–û–° –ü–†–û–ì–†–ï–°–°–ê</div><button class="btn btnSmall" id="resetBtn">–°–ë–†–û–°</button></div>
        <div style="margin-top:10px; font-size:12px; opacity:.75; line-height:1.35">–°–±—Ä–æ—Å —É–¥–∞–ª–∏—Ç –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–µ–π–≤ –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ.</div>
      </div>
    </div>
  </div>
</div>

<!-- Arena -->
<div class="modal modalPage" id="mArena" role="dialog" aria-modal="true">
  <div class="sheet sheetOpaque sheetScreen">
    <div class="sheetHead">
      <button class="iconBtn" data-close="mArena">‚Äπ</button>
      <div class="title">–ê–†–ï–ù–ê</div>
      <button class="iconBtn" id="arenaConsOpen" aria-label="–†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏">üéí</button>
    </div>
    <div class="sheetBody">
      <div class="card" style="margin-top:10px;">
        <div class="row"><div><div class="k">–ë–û–ô–¶–û–í–°–ö–ò–ô –ö–õ–£–ë</div></div><div class="badge" id="arenaCdCard" style="display:none; font-size:11px; padding:7px 9px;"><span style="opacity:.75; letter-spacing:1px;">–ö–£–õ–î–ê–£–ù</span> <span id="arenaCd">00:00</span></div></div>
        <div style="margin-top:10px; display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px;">
          <button class="btn btnSmall" id="arenaWeak">–°–ª–∞–±—ã–π</button>
          <button class="btn btnSmall" id="arenaNorm">–†–∞–≤–Ω—ã–π</button>
          <button class="btn btnSmall" id="arenaElite">–°–∏–ª—å–Ω—ã–π</button>
        </div>
      </div>

      <div class="card" style="margin-top:10px;" id="arenaSectionGroup">
        <div class="row"><div class="k">–ì–†–£–ü–ü–û–í–û–ô –ë–û–ô</div><button class="btn btnMini" id="gf1010Open">–í–•–û–î</button></div>
        <div style="margin-top:10px; font-size:12px; opacity:.8; line-height:1.35" id="arenaGroupHint"></div>
        <div style="margin-top:12px; display:flex; flex-direction:column; gap:10px;">
          <div class="row"><div><div class="k">–°–¢–ê–†–¢ (UTC)</div><div style="font-size:12px;opacity:.75">–ö–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É</div></div><div class="badge" id="gfStart">--:--</div></div>
          <div class="costRow">
            <div><div class="k">–¶–ï–ù–ê –í–•–û–î–ê</div><div style="font-size:12px;opacity:.75">–ó–∞–≤–∏—Å–∏—Ç –æ—Ç —á–∞—Å–∞</div></div>
            <div class="badge" style="color:var(--gold)" id="gfCost">0 ü™ô</div>
          </div>
          <div style="font-size:12px; opacity:.85; line-height:1.35" id="gfStatus">‚Äî</div>
          <button class="btn" id="gfEnter" style="display:none;">–í–û–ô–¢–ò –í –ë–û–ô</button>
        </div>
      </div>

      <div class="card" style="margin-top:10px;" id="arenaSectionGym">
        <div class="row"><div class="k">–°–ü–û–†–¢–ó–ê–õ</div><div style="display:flex; align-items:center; gap:8px;"><div class="k">–ü–ò–¢–û–ú–ï–¶ +</div><div class="badge" id="gymPetBonus">0%</div></div></div>
        <div id="gymList"></div>

        <div class="card" style="margin-top:8px;" id="arenaPetShopWrap">
          <div class="row"><div class="k">–ü–ò–¢–û–ú–¶–´</div><div style="font-size:12px;opacity:.75">–ö—É–ø–∏—Ç—å –∑–∞ –∑–æ–ª–æ—Ç–æ</div></div>
          <div style="margin-top:8px" class="petRow" id="arenaPetShop"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal" id="mArenaRes" role="dialog" aria-modal="true">
  <div class="sheet">
    <div class="sheetHead">
      <button class="iconBtn" data-close="mArenaRes">‚Äπ</button>
      <div class="title">–†–ï–ó–£–õ–¨–¢–ê–¢ –ë–û–Ø</div>
      <div style="width:44px"></div>
    </div>
    <div class="sheetBody">
      <div class="card">
        <div class="row"><div class="k">–ü–†–û–¢–ò–í–ù–ò–ö</div><div class="badge" id="arOpponent">‚Äî</div></div>
        <div class="row" style="margin-top:10px;"><div class="k">–¢–í–û–ô –£–†–û–ù</div><div class="badge" id="arYouDmg">0</div></div>
        <div class="row" style="margin-top:10px;"><div class="k">–£–†–û–ù –í–†–ê–ì–ê</div><div class="badge" id="arEnemyDmg">0</div></div>
        <div class="row" style="margin-top:10px;"><div class="k">–ò–¢–û–ì</div><div class="badge" id="arOutcome">‚Äî</div></div>
      </div>
      <div class="card" style="margin-top:12px;">
        <div class="row"><div class="k">–õ–û–ì –ü–û –†–ê–£–ù–î–ê–ú</div></div>
        <div id="arenaCombatLog" style="margin-top:10px; display:flex; flex-direction:column; gap:8px;"></div>
      </div>
    </div>
  </div>
</div>

<div class="modal modalMini" id="mBossAttack" role="dialog" aria-modal="true">
  <div class="sheet sheetMini">
    <div class="sheetHead">
      <button class="iconBtn" data-close="mBossAttack">‚Äπ</button>
      <div class="title">–ë–û–°–°</div>
      <div style="width:44px"></div>
    </div>
    <div class="sheetBody">
      <div class="card">
        <div class="row"><div class="k">–í–´–ë–†–ê–ù</div><div class="badge" id="baBossName">‚Äî</div></div>
        <div class="row" style="margin-top:10px;"><div class="k">–î–û–°–¢–£–ü</div><div class="badge" id="baAccess">‚Äî</div></div>
        <div style="margin-top:12px; display:flex; gap:10px; align-items:center;">
          <button class="btn" style="flex:1" id="baGo">–í –ë–û–ô</button>
          <button class="btn" style="width:56px; padding:0; font-size:20px; letter-spacing:0" id="baBuyRing" aria-label="–ö—É–ø–∏—Ç—å 1 –∞—Ç–∞–∫—É –∑–∞ –∫–æ–∑—ã—Ä–Ω—ã–µ –∫–æ–ª—å—Ü–∞">üíç</button>
        </div>
      </div>

      <div class="card" style="margin-top:12px;">
        <div class="row"><div class="k">–ö–õ–Æ–ß–ò –î–õ–Ø –ë–û–°–°–û–í</div></div>
        <div style="margin-top:10px; display:flex; flex-direction:column; gap:10px;" id="baTable"></div>
      </div>
    </div>
  </div>
</div>

<div class="modal modalBossFight" id="mBossFight" role="dialog" aria-modal="true">
  <div class="sheet sheetOpaque">
    <div class="sheetHead">
      <button class="iconBtn" data-close="mBossFight">‚Äπ</button>
      <div class="title">–ë–û–ô –° –ë–û–°–°–û–ú</div>
      <div style="width:44px"></div>
    </div>
    <div class="sheetBody">
      <div class="card">
        <div class="bossFightHero">
          <div class="bossFightBig" id="bfEmoji">üëπ</div>
          <div class="bossFightMeta">
            <div class="bossName" id="bfName">–ë–û–°–°</div>
            <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; align-items:center">
              <div class="badge" id="bfHp">HP ‚Äî</div>
              <div class="badge" id="bfTimer">‚Äî</div>
              <div class="badge" style="color:var(--gold)" id="bfHits">–£–î–ê–†–´ x0</div>
            </div>
            <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end" id="bfHitQty"></div>
          </div>
        </div>

        <div style="margin-top:12px; display:flex; flex-direction:column; gap:10px;">
          <button class="btn" id="bfFreeHit">–ü–ò–ù–û–ö –ü–û–î –ó–ê–î (–ë–ï–°–ü–õ–ê–¢–ù–û)</button>
          <button class="btn" id="bfHit1">–£–î–ê–† 2 (–ù–û–ì–û–ô)</button>
          <button class="btn" id="bfHit2">–£–î–ê–† 3 (–ö–û–°–¢–ï–¢–û–ú)</button>
          <button class="btn" id="bfHit3">–£–î–ê–† 4 (–ö–õ–ò–ó–ú–ê)</button>
        </div>

        <div style="margin-top:10px; font-size:12px; opacity:.8; line-height:1.3" id="bfHint">‚Äî</div>
      </div>

      <div class="card" style="margin-top:12px;">
        <div class="row"><div class="k">–£–î–ê–†–´</div><button class="btn btnSmall" id="bfShopOpen">–ú–ê–ì–ê–ó–ò–ù</button></div>
      </div>

      <div class="card" style="margin-top:12px;">
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; align-items:start;">
          <div>
            <div class="row"><div class="k">–õ–û–ì –£–†–û–ù–ê</div></div>
            <div style="margin-top:10px; display:flex; flex-direction:column; gap:8px;" id="bfLog"></div>
          </div>
          <div>
            <div class="row"><div class="k">–¢–û–ü –£–†–û–ù–ê</div></div>
            <div style="margin-top:10px; display:flex; flex-direction:column; gap:8px;" id="bfTop"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal modalMini modalBfShop" id="mBfShop" role="dialog" aria-modal="true">
  <div class="sheet sheetMini">
    <div class="sheetHead">
      <button class="iconBtn" data-close="mBfShop">‚Äπ</button>
      <div class="title">–ú–ê–ì–ê–ó–ò–ù –£–î–ê–†–û–í</div>
      <div style="width:44px"></div>
    </div>
    <div class="sheetBody">
      <div class="card">
        <div class="row"><div class="k">–¢–í–û–ò –ú–û–ù–ï–¢–´</div><div class="badge" style="color:var(--gold)" id="bfShopGold">0 ü™ô</div></div>
        <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end" id="bfShopQty"></div>
        <div style="margin-top:12px; display:flex; flex-direction:column; gap:10px;">
          <button class="btn" id="bfShopBuyKick">–ü–ò–ù–û–ö: +1 –∑–∞ 3 ü™ô</button>
          <button class="btn" id="bfShopBuyKnuckle">–ö–û–°–¢–ï–¢: +1 –∑–∞ 5 ü™ô</button>
          <button class="btn" id="bfShopBuyEnema">–ö–õ–ò–ó–ú–ê: +1 –∑–∞ 8 ü™ô</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal modalMini modalBossFightRes" id="mBossFightRes" role="dialog" aria-modal="true">
  <div class="sheet sheetMini">
    <div class="sheetHead">
      <div style="width:44px"></div>
      <div class="title" id="bfrTitle">–†–ï–ó–£–õ–¨–¢–ê–¢</div>
      <div style="width:44px"></div>
    </div>
    <div class="sheetBody">
      <div class="card">
        <div class="bossFightHero">
          <div class="bossFightBig" id="bfrEmoji">üëπ</div>
          <div class="bossFightMeta">
            <div class="k">–ë–û–°–°</div>
            <div style="margin-top:6px; font-weight:900; letter-spacing:2px; line-height:1.2" id="bfrName">‚Äî</div>
            <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; align-items:center">
              <div class="badge" id="bfrOutcome">‚Äî</div>
            </div>
          </div>
        </div>
      </div>
      <div class="card" style="margin-top:12px;" id="bfrRewardCard">
        <div class="row"><div class="k">–ù–ê–ì–†–ê–î–ê</div></div>
        <div style="margin-top:10px; display:flex; flex-direction:column; gap:8px;" id="bfrReward">‚Äî</div>
        <button class="btn" style="margin-top:12px; display:none;" id="bfrClaim">–ó–ê–ë–†–ê–¢–¨ –ù–ê–ì–†–ê–î–£</button>
      </div>
      <div class="card" style="margin-top:12px;">
        <div class="row"><div class="k">–¢–û–ü-10 –£–†–û–ù–ê</div></div>
        <div style="margin-top:10px; display:grid; grid-template-columns:1fr 1fr; gap:12px;" id="bfrTop">
          <div id="bfrTopL" style="display:flex; flex-direction:column; gap:8px;">‚Äî</div>
          <div id="bfrTopR" style="display:flex; flex-direction:column; gap:8px;">‚Äî</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Group Fight Battle -->
<div class="modal modalPage" id="mBattle" role="dialog" aria-modal="true">
  <div class="sheet sheetOpaque sheetScreen">
    <div class="sheetHead">
      <button class="iconBtn" data-close="mBattle">‚Äπ</button>
      <div class="title" id="bHeadInfo">–†–ê–£–ù–î 1 ¬∑ 30</div>
      <button class="btn btnMini" id="bLeave" type="button">–ü–û–ö–ò–ù–£–¢–¨</button>
    </div>
    <div class="sheetBody">
      <div class="card">
        <div class="row" style="margin-top:3px;"><div class="k">–¢–í–û–ô HP</div><div class="hpMini" id="bHp"><div class="hpBar"><div class="hpFill" id="bHpFill"></div><div class="hpIn" id="bHpIn">‚Äî</div></div></div></div>
        <div class="row" style="margin-top:3px;"><div class="k">–¢–´ –ê–¢–ê–ö–£–ï–®–¨</div><div class="badge" id="bTarget">–ê–≤—Ç–æ</div></div>
        <div class="row" style="margin-top:3px;"><div class="k">–ê–¢–ê–ö–ê –ó–ê –•–û–î</div><div class="badge" id="bAct">‚Äî</div></div>
      </div>

      <div class="card" style="margin-top:10px;">
        <div class="row"><div class="k">–ö–û–ú–ê–ù–î–´</div><button class="btn btnMini" id="battleConsOpen" type="button">üéí</button></div>
        <div style="margin-top:5px; display:grid; grid-template-columns:1fr 1fr; gap:3px;">
          <div>
            <div style="font-size:8px;opacity:.55; margin-bottom:8px;">–¢–í–û–Ø –ö–û–ú–ê–ù–î–ê</div>
            <div id="bMyTeam" style="display:flex; flex-direction:column; gap:2px;"></div>
          </div>
          <div>
            <div style="font-size:8px;opacity:.55; margin-bottom:8px; text-align:right;">–ü–†–û–¢–ò–í–ù–ò–ö</div>
            <div id="bEnemyTeam" style="display:flex; flex-direction:column; gap:2px;"></div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:10px;">
        <div class="row"><div class="k">–¶–ï–õ–ò</div><div style="font-size:12px;opacity:.75">–ù–∞–∂–º–∏ –¥–ª—è —É–¥–∞—Ä–∞</div></div>
        <div style="margin-top:10px; display:flex; flex-wrap:wrap; gap:8px; justify-content:center;" id="bTargets"></div>
      </div>
      <div class="card" style="margin-top:10px;">
        <div class="row"><div class="k">–õ–û–ì –ë–û–Ø</div></div>
        <div style="margin-top:8px; display:flex; flex-direction:column; gap:4px;" id="bLog"></div>
      </div>
    </div>
  </div>
</div>

<div class="modal modalMini" id="mBattleRes" role="dialog" aria-modal="true">
  <div class="sheet sheetMini">
    <div class="sheetHead">
      <div style="width:44px"></div>
      <div class="title" id="brTitle">–†–ï–ó–£–õ–¨–¢–ê–¢</div>
      <div style="width:44px"></div>
    </div>
    <div class="sheetBody">
      <div class="card">
        <div class="row"><div class="k">–ò–¢–û–ì</div><div class="badge" id="brOutcome">‚Äî</div></div>
        <div class="row" style="margin-top:10px;"><div class="k">–ù–ê–ì–†–ê–î–ê</div><div class="badge" id="brReward">‚Äî</div></div>
        <button class="btn" style="margin-top:12px" id="brOk">–ù–ê–ó–ê–î</button>
      </div>
    </div>
  </div>
</div>

<div class="modal modalMini" id="mConsumables" role="dialog" aria-modal="true">
  <div class="sheet sheetMini">
    <div class="sheetHead">
      <button class="iconBtn" data-close="mConsumables">‚Äπ</button>
      <div class="title">–†–ê–°–•–û–î–ù–ò–ö–ò</div>
      <div style="width:44px"></div>
    </div>
    <div class="sheetBody">
      <div class="card">
        <div class="row"><div class="k">–¢–í–û–ô –ò–ù–í–ï–ù–¢–ê–†–¨</div><div class="badge" id="consCtx">‚Äî</div></div>
        <div style="margin-top:10px; display:flex; flex-direction:column; gap:10px;" id="consList">‚Äî</div>
      </div>
      <div class="card" style="margin-top:12px;" id="consShopCard">
        <div class="row"><div class="k">–ú–ê–ì–ê–ó–ò–ù (–ê–†–ï–ù–ê)</div><div class="badge" style="color:var(--gold)" id="consGold">0 ü™ô</div></div>
        <div style="margin-top:10px; display:flex; flex-direction:column; gap:10px;" id="consShop">‚Äî</div>
      </div>
    </div>
  </div>
</div>

<!-- Clans -->
<div class="modal modalPage" id="mClans" role="dialog" aria-modal="true">
  <div class="sheet sheetOpaque sheetScreen">
    <div class="sheetHead">
      <button class="iconBtn" data-close="mClans">‚Äπ</button>
      <div class="title">–ö–õ–ê–ù–´</div>
      <div style="width:44px"></div>
    </div>
    <div class="sheetBody">
      <div class="card">
        <div class="row"><div class="k">–¢–í–û–ô –ö–õ–ê–ù</div><div class="badge" id="clanStatus">‚Äî</div></div>
        <div style="margin-top:10px; font-size:12px; opacity:.8; line-height:1.35" id="clanDesc">‚Äî</div>
        <button class="btn" style="margin-top:12px;" id="clanCreate">–°–û–ó–î–ê–¢–¨ –ö–õ–ê–ù –ó–ê 1000 ü™ô</button>
      </div>
      <div class="card" style="margin-top:12px;">
        <div class="row"><div class="k">–°–ö–û–†–û</div></div>
        <div style="margin-top:10px; font-size:12px; opacity:.8; line-height:1.35">–†–µ–π—Ç–∏–Ω–≥–∏ –∫–ª–∞–Ω–æ–≤, –∑–∞–¥–∞–Ω–∏—è –∏ —á–∞—Ç –ø–æ—è–≤—è—Ç—Å—è –≤ —Å–ª–µ–¥—É—é—â–µ–π –≤–µ—Ä—Å–∏–∏.</div>
      </div>
    </div>
  </div>
</div>


<!-- Shop -->
<div class="modal" id="mShop" role="dialog" aria-modal="true">
  <div class="sheet">
    <div class="sheetHead">
      <button class="iconBtn" data-close="mShop">‚Äπ</button>
      <div class="title">–ú–ê–ì–ê–ó–ò–ù</div>
      <div style="width:44px"></div>
    </div>
    <div class="sheetBody" id="shopList"></div>
  </div>
</div>

<!-- Districts -->
<div class="modal modalPage" id="mDistricts" role="dialog" aria-modal="true">
  <div class="sheet sheetOpaque sheetScreen">
    <div class="sheetHead">
      <button class="iconBtn" data-close="mDistricts">‚Äπ</button>
      <div class="title">–†–ê–ô–û–ù–´</div>
      <div style="width:44px"></div>
    </div>
    <div class="sheetBody">
      <div style="margin:10px; display:flex; flex-direction:column; gap:10px;" id="districtList"></div>
    </div>
  </div>
</div>

<!-- Bosses -->
<div class="modal modalPage" id="mBoss" role="dialog" aria-modal="true">
  <div class="sheet sheetOpaque sheetScreen">
    <div class="sheetHead">
      <button class="iconBtn" data-close="mBoss">‚Äπ</button>
      <div class="title">–ë–û–°–°–´</div>
      <div style="display:flex; gap:8px; align-items:center;">
        <div class="badge" id="bossRingBadge" style="padding:8px 10px; border-color:rgba(255,255,255,.10); background:rgba(0,0,0,.18)">üíç <b id="bossRingVal" style="letter-spacing:1px">0</b></div>
        <button class="toothBtn" id="bossToothBtn" type="button"><div class="ico">ü¶∑</div><div class="tm" id="bossToothTimer">00:00</div></button>
      </div>
    </div>
    <div class="sheetBody" id="bossList"></div>
  </div>
</div>

<div class="modal modalMini" id="mFriendHelp" role="dialog" aria-modal="true">
  <div class="sheet sheetMini">
    <div class="sheetHead">
      <button class="iconBtn" data-close="mFriendHelp">‚Äπ</button>
      <div class="title">–ü–û–ú–û–©–¨ –î–†–£–ó–ï–ô</div>
      <div style="width:44px"></div>
    </div>
    <div class="sheetBody">
      <div class="card">
        <div class="row"><div class="k">–£–†–û–í–ï–ù–¨</div><div class="badge" id="fhLvl">0</div></div>
        <div class="row" style="margin-top:10px;"><div class="k">–õ–ò–ú–ò–¢ –ù–ê –î–†–£–ì–ê</div><div class="badge" id="fhPct">10%</div></div>
        <div style="margin-top:10px; font-size:12px; opacity:.8; line-height:1.35">–ö–∞–∂–¥—ã–π —É—Ä–æ–≤–µ–Ω—å —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –ª–∏–º–∏—Ç –ø–æ–º–æ—â–∏ –¥—Ä—É–∑–µ–π –≤ –±–æ—é —Å –±–æ—Å—Å–æ–º –Ω–∞ +1%.</div>
        <button class="btn" style="margin-top:12px;" id="fhUp">–ü–†–û–ö–ê–ß–ê–¢–¨</button>
      </div>
    </div>
  </div>
</div>

<!-- Top -->
<div class="modal modalPage" id="mTop" role="dialog" aria-modal="true">
  <div class="sheet sheetOpaque sheetScreen">
    <div class="sheetHead">
      <button class="iconBtn" data-close="mTop">‚Äπ</button>
      <div class="title">–¢–û–ü</div>
      <div style="width:44px"></div>
    </div>
    <div class="sheetBody">
      <div class="card" style="font-size:12px; opacity:.8; line-height:1.35">–î–ª—è –∏–¥–µ–∞–ª—å–Ω–æ–≥–æ mobile-first —Å–¥–µ–ª–∞—é Supabase-—Ç–æ–ø –≤–æ 2-–π –∏—Ç–µ—Ä–∞—Ü–∏–∏. –°–µ–π—á–∞—Å ‚Äî –ª–æ–∫–∞–ª—å–Ω—ã–π —Ç–æ–ø-100.</div>
      <div class="card" style="margin-top:12px;">
        <div class="row"><div class="k">–¢–û–ü-100</div><div style="font-size:12px;opacity:.75">–ª–æ–∫–∞–ª—å–Ω–æ</div></div>
        <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
          <button class="btn btnSmall" id="top100Lvl">–£–†–û–í–ï–ù–¨</button>
          <button class="btn btnSmall" id="top100Wealth">–•–ê–†–ê–ö–¢–ï–†–ò–°–¢–ò–ö–ò</button>
          <button class="btn btnSmall" id="top100Boss">–ë–û–°–°–´</button>
        </div>
        <div style="margin-top:10px; display:flex; flex-direction:column; gap:8px;" id="top100List"></div>
      </div>
    </div>
  </div>
</div>

<!-- Dice -->
<div class="modal modalPage" id="mDice" role="dialog" aria-modal="true">
  <div class="sheet sheetOpaque sheetScreen">
    <div class="sheetHead">
      <button class="iconBtn" data-close="mDice">‚Äπ</button>
      <div class="title">–ö–û–°–¢–ò</div>
      <div style="width:44px"></div>
    </div>
    <div class="sheetBody">
      <div class="card">
        <div class="diceTitle"><span class="ico">üé≤</span><span>–ë–†–ê–¢–°–¢–í–û –ö–û–ù–¶–ê</span></div>
        <div class="dicePrice">–¶–µ–Ω–∞: <span style="color:var(--gold); font-weight:900">1 ü™ô</span></div>
        <div class="diceGrid" id="diceRow"></div>
        <button class="btn dicePrimary" id="diceRoll">–ë–†–û–°–ò–¢–¨</button>
        <div style="margin-top:12px; font-size:12px; opacity:.85; text-align:center" id="diceRes">‚Äî</div>
      </div>

      <div class="card" style="margin-top:12px;">
        <div class="row"><div class="k">–ù–ê–ì–†–ê–î–´</div><div style="font-size:12px;opacity:.75">–∑–∞ 4 –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö</div></div>
        <div style="margin-top:10px; display:flex; flex-direction:column; gap:8px; font-size:12px; opacity:.9; line-height:1.25">
          <div class="row"><div style="min-width:0">4√ó1</div><div class="badge">15 üíç –ö–æ–∑—ã—Ä–Ω—ã—Ö –∫–æ–ª–µ—Ü</div></div>
          <div class="row"><div style="min-width:0">4√ó2</div><div class="badge">+1 –ü–∏–Ω–æ–∫</div></div>
          <div class="row"><div style="min-width:0">4√ó3</div><div class="badge">+1 –ö–æ—Å—Ç–µ—Ç</div></div>
          <div class="row"><div style="min-width:0">4√ó4</div><div class="badge">+1 –ö–ª–∏–∑–º–∞</div></div>
          <div class="row"><div style="min-width:0">4√ó5</div><div class="badge">–ö–æ–ª—å—Ü–æ –Ω–∞ –±–æ—Å—Å–∞ ¬´–ü–∞—É—á–∏—Ö–∞¬ª</div></div>
          <div class="row"><div style="min-width:0">4√ó6</div><div class="badge">–ö–æ–ª—å—Ü–æ –Ω–∞ –±–æ—Å—Å–∞ ¬´–°–∞—Ä—É–º—è–Ω¬ª</div></div>
        </div>
        <div style="margin-top:10px; font-size:11px; opacity:.75; line-height:1.35">–ï—Å–ª–∏ 4 –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö –Ω–µ —Å–æ–±—Ä–∞–Ω—ã ‚Äî –Ω–∞–≥—Ä–∞–¥–∞: <b>+50 –∑–æ–ª–æ—Ç—ã—Ö –∑—É–±–æ–≤</b></div>
        <div style="margin-top:8px; font-size:11px; opacity:.75; line-height:1.35">–ï—Å–ª–∏ —Å–æ–±—Ä–∞–Ω—ã <b>5 –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö</b> ‚Äî –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ: <b>+20 ü™ô</b></div>
      </div>
    </div>
  </div>
</div>

<div class="modal modalMini" id="mDiceReward" role="dialog" aria-modal="true">
  <div class="sheet sheetMini">
    <div class="sheetHead">
      <div style="width:44px"></div>
      <div class="title">–ù–ê–ì–†–ê–î–ê</div>
      <div style="width:44px"></div>
    </div>
    <div class="sheetBody">
      <div class="card">
        <div class="row"><div class="k">–ü–û–õ–£–ß–ï–ù–û</div><div class="badge" style="color:var(--gold)" id="diceRewardVal">50 ü¶∑</div></div>
        <button class="btn" style="margin-top:12px" id="diceRewardOk">–û–ö</button>
      </div>
    </div>
  </div>
</div>

<div class="toastWrap"><div class="toast" id="toast"></div></div>

<script>
(function(){
  'use strict';

  const tg = window.Telegram && window.Telegram.WebApp;
  if (tg && tg.ready) tg.ready();
  try { if (tg) tg.expand(); } catch (e) {}

  const IS_DEV = (function(){
    try {
      const qs = new URLSearchParams(location.search||'');
      if (qs.get('dev')==='1') return true;
      if (localStorage && localStorage.getItem('dev')==='1') return true;
    } catch (e) {}
    return false;
  })();

  const SHOP_X2_FORCE = 'OFF'; // 'AUTO' | 'ON' | 'OFF' !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! –ú –ù –û –ñ –ò –¢ –ï –õ –¨ !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  function shopX2Enabled(){
    if (SHOP_X2_FORCE==='ON') return true;
    if (SHOP_X2_FORCE==='OFF') return false;
    return !!state.shopX2;
  }

  function consOpen(ctx){
    state._consCtx = String(ctx||'');
    try {
      const m = $('mConsumables');
      if (m) m.classList.toggle('consFull', String(ctx||'')==='arena');
    } catch (e) {}
    showModal('mConsumables');
    renderConsumables();
    haptic('light');
  }
  function renderConsumables(){
    const ctx = String(state._consCtx||'');
    try { $('consCtx').textContent = (ctx==='arena' ? '–ü–û–ö–£–ü–ö–ê' : '–ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï'); } catch (e) {}
    try { $('consGold').textContent = String(state.gold||0) + ' ü™ô'; } catch (e) {}

    const med = parseInt(state.consumables && state.consumables.med || 0, 10) || 0;
    const nade = parseInt(state.consumables && state.consumables.nade || 0, 10) || 0;

    const list = $('consList');
    if (list){
      list.innerHTML = '';

      const row1 = document.createElement('div');
      row1.className = 'row';
      row1.innerHTML = '<div><div class="k">ü©π –ê–ü–¢–ï–ß–ö–ê</div><div style="font-size:12px;opacity:.75;line-height:1.25">–õ–µ—á–∏—Ç —Ç–µ–±—è –Ω–∞ 30% HP</div></div>';
      const b1 = document.createElement('button');
      b1.className = 'btn btnSmall';
      b1.textContent = '–ò–°–ü. ('+med+')';
      b1.disabled = (med<=0) || (ctx!=='battle');
      b1.onclick = ()=>consUse('med');
      row1.appendChild(b1);
      list.appendChild(row1);

      const row2 = document.createElement('div');
      row2.className = 'row';
      row2.innerHTML = '<div><div class="k">üí£ –ì–†–ê–ù–ê–¢–ê</div><div style="font-size:12px;opacity:.75;line-height:1.25">–ù–∞–Ω–æ—Å–∏—Ç 25 —É—Ä–æ–Ω–∞ —Ü–µ–ª–∏</div></div>';
      const b2 = document.createElement('button');
      b2.className = 'btn btnSmall';
      b2.textContent = '–ò–°–ü. ('+nade+')';
      b2.disabled = (nade<=0) || (ctx!=='battle');
      b2.onclick = ()=>consUse('nade');
      row2.appendChild(b2);
      list.appendChild(row2);
    }

    const shopCard = $('consShopCard');
    if (shopCard) shopCard.style.display = (ctx==='arena' ? '' : 'none');
    const shop = $('consShop');
    if (shop){
      shop.innerHTML = '';
      if (ctx==='arena'){
        const s1 = document.createElement('div');
        s1.className = 'row';
        s1.innerHTML = '<div><div class="k">ü©π –ê–ü–¢–ï–ß–ö–ê</div><div style="font-size:12px;opacity:.75">–¶–µ–Ω–∞: 30 ü™ô</div></div>';
        const sb1 = document.createElement('button');
        sb1.className = 'btn btnSmall';
        sb1.textContent = '–ö–£–ü–ò–¢–¨';
        sb1.disabled = (state.gold||0) < 30;
        sb1.onclick = ()=>consBuy('med', 30);
        s1.appendChild(sb1);
        shop.appendChild(s1);

        const s2 = document.createElement('div');
        s2.className = 'row';
        s2.innerHTML = '<div><div class="k">üí£ –ì–†–ê–ù–ê–¢–ê</div><div style="font-size:12px;opacity:.75">–¶–µ–Ω–∞: 50 ü™ô</div></div>';
        const sb2 = document.createElement('button');
        sb2.className = 'btn btnSmall';
        sb2.textContent = '–ö–£–ü–ò–¢–¨';
        sb2.disabled = (state.gold||0) < 50;
        sb2.onclick = ()=>consBuy('nade', 50);
        s2.appendChild(sb2);
        shop.appendChild(s2);
      }
    }
  }
  function consBuy(kind, cost){
    if (String(state._consCtx||'')!=='arena'){ toast('–ü–æ–∫—É–ø–∫–∞ —Ç–æ–ª—å–∫–æ –Ω–∞ –ê—Ä–µ–Ω–µ','lose'); return; }
    const c = parseInt(cost||0,10)||0;
    if ((state.gold||0) < c){ toast('–ù—É–∂–Ω–æ '+c+' ü™ô','lose'); return; }
    state.gold -= c;
    if (!state.consumables) state.consumables = { med:0, nade:0 };
    if (kind==='med') state.consumables.med = (parseInt(state.consumables.med||0,10)||0) + 1;
    if (kind==='nade') state.consumables.nade = (parseInt(state.consumables.nade||0,10)||0) + 1;
    save();
    renderAll();
    renderConsumables();
    toast('–ö—É–ø–ª–µ–Ω–æ','win');
    haptic('light');
  }
  function consUse(kind){
    if (String(state._consCtx||'')!=='battle'){ toast('–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–æ–ª—å–∫–æ –≤ –±–æ—é','lose'); return; }
    const b = state.groupFight && state.groupFight.battle;
    if (!b){ toast('–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –±–æ—è','lose'); return; }
    if ((parseInt(b.myHp||0,10)||0) <= 0){ toast('–¢—ã –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—å','lose'); return; }
    if (b.acted){ toast('–£–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –¥–µ–π—Å—Ç–≤–∏–µ –≤ —ç—Ç–æ—Ç —Ö–æ–¥','lose'); return; }
    if (!state.consumables) state.consumables = { med:0, nade:0 };

    if (kind==='med'){
      const have = parseInt(state.consumables.med||0,10)||0;
      if (have<=0){ toast('–ù–µ—Ç –∞–ø—Ç–µ—á–µ–∫','lose'); return; }
      state.consumables.med = have - 1;
      const heal = Math.max(1, Math.round((parseInt(b.myMaxHp||0,10)||0) * 0.30));
      const before = parseInt(b.myHp||0,10)||0;
      b.myHp = clamp(before + heal, 0, parseInt(b.myMaxHp||0,10)||0);
      b.acted = true;
      b.log.unshift({ kind:'SYS', text:'–¢—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª –∞–ø—Ç–µ—á–∫—É –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–ª ' + (b.myHp-before) + ' HP' });
      save();
      renderBattle();
      renderConsumables();
      haptic('light');
      return;
    }

    if (kind==='nade'){
      const have = parseInt(state.consumables.nade||0,10)||0;
      if (have<=0){ toast('–ù–µ—Ç –≥—Ä–∞–Ω–∞—Ç','lose'); return; }
      const t = (b.myTarget ? (b.targets||[]).find(x=>x.id===b.myTarget) : null) || battleWeakestTarget(b);
      if (!t || (parseInt(t.hp||0,10)||0) <= 0){ toast('–ù–µ—Ç —Ü–µ–ª–∏','lose'); return; }
      state.consumables.nade = have - 1;
      const dmg = 25;
      const real = Math.min(parseInt(t.hp||0,10)||0, dmg);
      t.hp = Math.max(0, (parseInt(t.hp||0,10)||0) - real);
      b.acted = true;
      b.log.unshift({ kind:'HIT', text:'–¢—ã –±—Ä–æ—Å–∏–ª –≥—Ä–∞–Ω–∞—Ç—É –∏ –Ω–∞–Ω–µ—Å ' + real + ' —É—Ä–æ–Ω–∞ —Ü–µ–ª–∏ ' + t.id });
      save();
      renderBattle();
      renderConsumables();
      haptic('light');
      return;
    }
  }

  function renderFriendHelp(){
    try {
      const lvl = clamp(parseInt(state.friendHelpLvl||0,10)||0, 0, 10);
      $('fhLvl').textContent = String(lvl);
      $('fhPct').textContent = String(10 + lvl) + '%';
      const btn = $('fhUp');
      if (btn) {
        const cost = (lvl>=10) ? 0 : (20 * (lvl+1));
        btn.textContent = (lvl>=10) ? '–ú–ê–ö–°. –£–†–û–í–ï–ù–¨' : ('–ü–†–û–ö–ê–ß–ê–¢–¨ –ó–ê ' + cost + ' –∑–æ–ª–æ—Ç—ã—Ö –∑—É–±–æ–≤');
        btn.disabled = lvl>=10;
        btn.style.opacity = btn.disabled ? '.6' : '1';
        btn.onclick = ()=>{
          const cur = clamp(parseInt(state.friendHelpLvl||0,10)||0, 0, 10);
          if (cur>=10) return;
          const cost2 = 20 * (cur+1);
          if ((state.morin||0) < cost2){ toast('–ù—É–∂–Ω–æ '+cost2+' –∑–æ–ª–æ—Ç—ã—Ö –∑—É–±–æ–≤','lose'); return; }
          state.morin -= cost2;
          state.friendHelpLvl = cur + 1;
          save();
          renderFriendHelp();
          renderHUD();
          haptic('light');
        };
      }
    } catch (e) {}
  }

  function firstRunSeed(){
    if (state.inventory && Array.isArray(state.inventory) && state.inventory.every(x=>x===' ')){
      state.inventory[0] = '‚ù§Ô∏è';
      state.inventory[1] = 'üìú';
    }
    feedAdd('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Enhanced Mobile TG Edition','SYS');
  }

  function hardReset(){
    try { localStorage.removeItem(SAVE_KEY); } catch (e) {}
    state = JSON.parse(JSON.stringify(defaults));
    try {
      while (stack.length) {
        const id = stack.pop();
        const mm = $(id);
        if (mm) mm.classList.remove('show');
      }
    } catch (e) {}
    try { document.querySelectorAll('.modal.show').forEach(m=>m.classList.remove('show')); } catch (e) {}
    try { setOverlay(); } catch (e) {}
    try { updateBackButton(); } catch (e) {}
    firstRunSeed();
    toast('–°–±—Ä–æ—à–µ–Ω–æ','lose');
    save();
    renderAll();
  }


  // --- Telegram viewport binding
  function updateTgVh(){
    try {
      let h = 0;
      if (tg) {
        if (typeof tg.viewportStableHeight === 'number' && tg.viewportStableHeight > 0) h = tg.viewportStableHeight;
        if (typeof tg.viewportHeight === 'number' && tg.viewportHeight > 0) h = Math.max(h, tg.viewportHeight);
      }
      if (window.visualViewport && typeof window.visualViewport.height === 'number' && window.visualViewport.height > 0) h = Math.max(h, window.visualViewport.height);
      if (!h) h = window.innerHeight || 0;
      if (h) document.documentElement.style.setProperty('--tg-vh', h + 'px');
    } catch (e) {}
  }
  updateTgVh();
  try { window.addEventListener('resize', updateTgVh); } catch (e) {}
  try { if (window.visualViewport) window.visualViewport.addEventListener('resize', updateTgVh); } catch (e) {}
  try { if (tg && typeof tg.onEvent === 'function') tg.onEvent('viewportChanged', updateTgVh); } catch (e) {}

  // --- Utilities
  const $ = (id)=>document.getElementById(id);
  const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
  const pad2 = (n)=>String(n).padStart(2,'0');
  const now = ()=>Date.now();

  function toast(msg, kind){
    const el = $('toast');
    if (!el) return;
    el.className = 'toast ' + (kind||'');
    el.textContent = String(msg||'');
    el.classList.add('show');
    clearTimeout(window.__toastT);
    window.__toastT = setTimeout(()=>{ el.classList.remove('show'); }, 1400);
  }

  function haptic(style){
    try {
      if (!tg || !tg.HapticFeedback) return;
      if (!state.settings.haptics) return;
      tg.HapticFeedback.impactOccurred(style||'light');
    } catch (e) {}
  }

  // --- Storage
  const SAVE_KEY = 'mora_mobile_save_v2';
  const CURRENCY_CAP = 999999999999;
  function load(){
    try { return JSON.parse(localStorage.getItem(SAVE_KEY) || 'null'); } catch (e) { return null; }
  }
  function save(){
    try {
      state.gold = Math.min(CURRENCY_CAP, Math.max(0, Math.floor(state.gold||0)));
      state.silver = Math.min(CURRENCY_CAP, Math.max(0, Math.floor(state.silver||0)));
      state.morin = Math.min(CURRENCY_CAP, Math.max(0, Math.floor(state.morin||0)));
      state.rings = Math.min(CURRENCY_CAP, Math.max(0, Math.floor(state.rings||0)));
      localStorage.setItem(SAVE_KEY, JSON.stringify(state));
      $('syncState').textContent = '–°–ï–ô–í: OK';
      $('syncState').style.opacity = '.85';
    } catch (e) {
      try {
        $('syncState').textContent = '–°–ï–ô–í: ERR';
        $('syncState').style.opacity = '1';
      } catch (e2) {}
    }
  }

  // --- Game data
  const ITEMS = [
    { key:'VIP', name:'VIP —Å—Ç–∞—Ç—É—Å', desc:'–û—Ç–∫—Ä—ã–≤–∞–µ—Ç VIP –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏', cost:500, currency:'MORIN', apply:()=>{ if (state.vip){ toast('VIP —É–∂–µ –∞–∫—Ç–∏–≤–µ–Ω','lose'); return; } state.vip = true; toast('VIP –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω','win'); } },
    { key:'G1', name:'–ó–æ–ª–æ—Ç–æ', desc:'+50 ü™ô', cost:'1$', currency:'MORIN', goldAdd:50 },
    { key:'G2', name:'–ó–æ–ª–æ—Ç–æ', desc:'+100 ü™ô', cost:'2$', currency:'MORIN', goldAdd:100 },
    { key:'G3', name:'–ó–æ–ª–æ—Ç–æ', desc:'+300 ü™ô', cost:'6$', currency:'MORIN', goldAdd:300 },
    { key:'G4', name:'–ó–æ–ª–æ—Ç–æ', desc:'+500 ü™ô', cost:'10$', currency:'MORIN', goldAdd:500 },
    { key:'G5', name:'–ó–æ–ª–æ—Ç–æ', desc:'+1 000 ü™ô', cost:'20$', currency:'MORIN', goldAdd:1000 },
    { key:'G6', name:'–ó–æ–ª–æ—Ç–æ', desc:'+2 500 ü™ô', cost:'50$', currency:'MORIN', goldAdd:2500 },
    { key:'G7', name:'–ó–æ–ª–æ—Ç–æ', desc:'+5 000 ü™ô', cost:'100$', currency:'MORIN', goldAdd:5000 },
    { key:'G8', name:'–ó–æ–ª–æ—Ç–æ', desc:'+10 000 ü™ô', cost:'200$', currency:'MORIN', goldAdd:10000 }
  ];

  const PETS = [
    { id:1, name:'–°—Ç—Ä–∞–∂ –ü–µ–ø–ª–∞', emoji:'üêæ', cost:100, pct:0.20 },
    { id:2, name:'–í–æ–ª–∫ –ù–æ—á–∏', emoji:'üê∫', cost:300, pct:0.30 },
    { id:3, name:'–¢–µ–Ω—å –î—Ä–∞–∫–æ–Ω–∞', emoji:'üêâ', cost:700, pct:0.40 },
    { id:4, name:'–ú–æ—Ä—Å–∫–æ–π –§–µ–Ω–∏–∫—Å', emoji:'ü¶Ö', cost:1500, pct:0.50 }
  ];

  const BOSSES = [
    { id:1, name:'–§—ë–¥–æ—Ä', emoji:'ü¶à', maxHP:1000, reward:{ xp:50, morin:100, gold:0 } },
    { id:2, name:'–ì–∏–≤–∏', emoji:'üß®', maxHP:5000, reward:{ xp:100, morin:300, gold:0 } },
    { id:3, name:'–õ–æ–≥–æ–≤–∞–∑', emoji:'ü¶¥', maxHP:10000, reward:{ xp:200, morin:500, gold:0 } },
    { id:4, name:'–¢–µ–æ–¥–µ–¥', emoji:'ü™ì', maxHP:30000, reward:{ xp:300, morin:1500, gold:0 } },
    { id:5, name:'–§–∞—Ä–∞', emoji:'üî•', maxHP:70000, reward:{ xp:700, morin:3500, gold:0 } },
    { id:6, name:'–ü–∞—É—á–∏—Ö–∞', emoji:'üï∑Ô∏è', maxHP:150000, reward:{ xp:1500, morin:7500, gold:0 } },
    { id:7, name:'–ë–æ—Ä—è –ú–µ–º', emoji:'üå™Ô∏è', maxHP:300000, reward:{ xp:3000, morin:15000, gold:0 } },
    { id:8, name:'–°–∞—Ä—É–º—è–Ω', emoji:'üßø', maxHP:500000, reward:{ xp:5000, morin:25000, gold:0 } },
    { id:9, name:'–î—Ä–æ–≤–æ—Ä—É–±', emoji:'ü™µ', maxHP:1000000, reward:{ xp:10000, morin:0, gold:50000 } },
    { id:10, name:'–ü–µ–Ω–¥–∞–ª—å—Ñ', emoji:'üßô', maxHP:2000000, reward:{ xp:20000, morin:0, gold:100000 } },
    { id:11, name:'–≠–ª—Ä–æ–Ω–¥ –í–µ—á–Ω–æ–ø—Ä–∞–≤', emoji:'üó°Ô∏è', maxHP:5000000, reward:{ xp:50000, morin:0, gold:250000 } },
    { id:12, name:'–ù–∞–∑–≥—É–ª', emoji:'üó°Ô∏è', maxHP:10000000, reward:{ xp:100000, morin:500000, gold:0 } }
  ];

  const GYM_STATS = [
    { key:'health', name:'–ó–¥–æ—Ä–æ–≤—å–µ' },
    { key:'strength', name:'–°–∏–ª–∞' },
    { key:'agility', name:'–õ–æ–≤–∫–æ—Å—Ç—å' },
    { key:'initiative', name:'–ò–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞' },
    { key:'endurance', name:'–í—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å' },
    { key:'might', name:'–ú–æ—â—å' },
    { key:'charisma', name:'–•–∞—Ä–∏–∑–º–∞' }
  ];

  // --- State
  const defaults = {
    v:2,
    playerName:'PLAYER',
    level:1,
    xp:0,
    gold:1000000,
    silver:5200,
    morin:12,
    rings:0,
    energy:100,
    energyMax:100,
    lastEnergyTs: now(),
    nextWinBonus:0,
    settings:{ sound:true, haptics:true, reduced:false },
    inventory: Array(9).fill(' '),
    petsOwned:{},
    activePetId:0,
    gym:{},
    arena:{ cdUntil:0, wins:0, losses:0 },
    groupFight:{ joined:false, startTs:0, resolvedTs:0, battle:null, autoShownStartTs:0, pendingReward:null },
    gf1010:{ joined:false, startTs:0, costPaid:0, gathered:0, matchId:'', fight:{ round:1, turnLeft:10, myTarget:'', targets:[], log:[] } },
    diceGame:{ active:false, rolls:0, max:10, dice:[1,1,1,1,1] },
    consumables:{ med:0, nade:0 },
    clan:{ id:'', name:'', owner:'', createdTs:0 },
    promoUsedCodes:{},
    bosses:{ hp:{}, strikes:10, lastWinners:{}, keys:{}, hitStocks:{ kick:0, knuckle:0, enema:0 }, shopQty:1, hitUseQty:1, fights:{}, dmgLog:{}, dmgTop:{}, daily:{ day:'', counts:{} }, toothNextTs:0 },
    friendHelpLvl:0,
    vip:false,
    shopX2:false,
    feed:[],
    friends:[
      { id:1, name:'–õ–æ—Ä–¥ –¢–µ–Ω–∏', lvl:12, power:1540, online:true },
      { id:2, name:'–ö—Ä–∏—Å—Ç–∞–ª–ª', lvl:7, power:980, online:true },
      { id:3, name:'–í–æ–ª–∫', lvl:19, power:2100, online:false },
      { id:4, name:'–ú–æ—Ä–∞', lvl:3, power:420, online:true },
      { id:5, name:'–§–µ–Ω–∏–∫—Å', lvl:25, power:3200, online:false },
      { id:6, name:'–°—Ñ–µ—Ä–∞', lvl:10, power:1100, online:true }
    ]
  };

  let state = Object.assign({}, defaults, load()||{});
  // normalize
  if (!state.settings) state.settings = Object.assign({}, defaults.settings);
  if (!Array.isArray(state.inventory)) state.inventory = Array(9).fill(' ');
  if (!state.petsOwned) state.petsOwned = {};
  if (!state.gym) state.gym = {};
  if (!state.arena) state.arena = Object.assign({}, defaults.arena);
  if (!state.groupFight) state.groupFight = Object.assign({}, defaults.groupFight);
  if (typeof state.groupFight.autoShownStartTs !== 'number') state.groupFight.autoShownStartTs = 0;
  if (typeof state.groupFight.resolvedTs !== 'number') state.groupFight.resolvedTs = 0;
  if (typeof state.groupFight.pendingReward === 'undefined') state.groupFight.pendingReward = null;
  if (!state.gf1010) state.gf1010 = Object.assign({}, defaults.gf1010);
  if (!state.diceGame) state.diceGame = Object.assign({}, defaults.diceGame);
  if (!state.consumables) state.consumables = Object.assign({}, defaults.consumables);
  if (typeof state.consumables.med !== 'number') state.consumables.med = 0;
  if (typeof state.consumables.nade !== 'number') state.consumables.nade = 0;
  if (!state.clan) state.clan = Object.assign({}, defaults.clan);
  if (typeof state.clan.createdTs !== 'number') state.clan.createdTs = 0;
  if (typeof state.clan.id !== 'string') state.clan.id = '';
  if (typeof state.clan.name !== 'string') state.clan.name = '';
  if (typeof state.clan.owner !== 'string') state.clan.owner = '';
  if (!state.bosses) state.bosses = Object.assign({}, defaults.bosses);
  if (!state.bosses.hp) state.bosses.hp = {};
  if (!state.bosses.lastWinners) state.bosses.lastWinners = {};
  if (!state.bosses.keys) state.bosses.keys = {};
  if (!state.bosses.fights) state.bosses.fights = {};
  if (!state.bosses.dmgLog) state.bosses.dmgLog = {};
  if (!state.bosses.dmgTop) state.bosses.dmgTop = {};
  if (!state.bosses.daily) state.bosses.daily = { day:'', counts:{} };
  if (!state.bosses.daily.counts) state.bosses.daily.counts = {};
  if (!state.bosses.hitStocks) state.bosses.hitStocks = { kick:0, knuckle:0, enema:0 };
  if (!state.bosses || typeof state.bosses.toothNextTs === 'undefined') state.bosses.toothNextTs = 0;
  if (typeof state.bosses.shopQty !== 'number') state.bosses.shopQty = 1;
  if (typeof state.bosses.hitUseQty !== 'number') state.bosses.hitUseQty = 1;
  if (typeof state.rings !== 'number') state.rings = 0;
  if (!state.promoUsedCodes || typeof state.promoUsedCodes !== 'object') state.promoUsedCodes = {};

  // migration: old boss key 'ring' conflicted with currency üíç (state.rings)
  try {
    const oldRingKey = parseInt(state.bosses.keys['ring']||0,10)||0;
    if (oldRingKey>0 && (typeof state.bosses.keys['pass'] === 'undefined')) {
      state.bosses.keys['pass'] = oldRingKey;
      delete state.bosses.keys['ring'];
    }
  } catch (e) {}

  state.bosses.hitStocks.kick = clamp(parseInt(state.bosses.hitStocks.kick||0,10)||0, 0, 999999);
  state.bosses.hitStocks.knuckle = clamp(parseInt(state.bosses.hitStocks.knuckle||0,10)||0, 0, 999999);
  state.bosses.hitStocks.enema = clamp(parseInt(state.bosses.hitStocks.enema||0,10)||0, 0, 999999);
  state.bosses.shopQty = clamp(parseInt(state.bosses.shopQty||1,10)||1, 1, 1000);
  state.friendHelpLvl = clamp(parseInt(state.friendHelpLvl||0,10)||0, 0, 10);
  if (!Array.isArray(state.feed)) state.feed = [];
  if (!Array.isArray(state.friends)) state.friends = defaults.friends.slice();

  state.gold = Math.min(CURRENCY_CAP, Math.max(0, Math.floor(state.gold||0)));
  state.silver = Math.min(CURRENCY_CAP, Math.max(0, Math.floor(state.silver||0)));
  state.morin = Math.min(CURRENCY_CAP, Math.max(0, Math.floor(state.morin||0)));
  state.rings = Math.min(CURRENCY_CAP, Math.max(0, Math.floor(state.rings||0)));

  // --- Core math
  function xpNeed(level){
    return 2000 + (level-1)*650;
  }
  function addXp(n){
    state.xp = Math.max(0, (state.xp||0) + (n||0));
    while (state.xp >= xpNeed(state.level)) {
      state.xp -= xpNeed(state.level);
      state.level += 1;
      toast('–£—Ä–æ–≤–µ–Ω—å –ø–æ–≤—ã—à–µ–Ω: ' + state.level,'win');
      haptic('heavy');
    }
  }

  function activePet(){
    const id = parseInt(state.activePetId||0,10) || 0;
    return PETS.find(p=>p.id===id) || null;
  }
  function petBonusPct(){
    const p = activePet();
    return p ? (p.pct||0) : 0;
  }

  function feedAdd(text, kind){
    const t = String(text||'').trim();
    if (!t) return;
    const tag = kind ? '['+kind+'] ' : '';
    state.feed.unshift(tag + t);
    if (state.feed.length>18) state.feed = state.feed.slice(0,18);
  }

  // --- Modal system
  const overlay = $('overlay');
  const stack = [];
  const SCREEN_IDS = new Set(['mArena','mBoss','mTop','mDice','mDistricts','mBattle']);
  function setOverlay(){
    if (!overlay) return;
    const top = stack.length ? stack[stack.length-1] : '';
    overlay.classList.toggle('show', stack.length>0);
  }
  function showModal(id){
    const m = $(id);
    if (!m) return;
    if (id==='mBattle'){
      try { hideModal('mGFJoin'); } catch (e) {}
      try { hideModal('mGF1010'); } catch (e) {}
    }
    if (!stack.includes(id)) stack.push(id);
    m.classList.add('show');
    setOverlay();
    updateBackButton();
  }

  function openScreen(id){
    try { document.querySelectorAll('.modal.show').forEach(m=>m.classList.remove('show')); } catch (e) {}
    stack.length = 0;
    showModal(id);
  }
  function hideModal(id){
    const m = $(id);
    if (!m) return;
    m.classList.remove('show');
    const idx = stack.lastIndexOf(id);
    if (idx>=0) stack.splice(idx,1);
    setOverlay();
    updateBackButton();

    if (id==='mBossFight'){
      while (stack.length) {
        const top = stack[stack.length-1];
        const mm = $(top);
        if (mm) mm.classList.remove('show');
        stack.pop();
      }
      setOverlay();
      updateBackButton();
    }
  }
  function hideTop(){
    const id = stack[stack.length-1];
    if (id) hideModal(id);
  }

  function updateBackButton(){
    try {
      if (!tg || !tg.BackButton) return;
      if (stack.length>0) {
        tg.BackButton.show();
      } else {
        tg.BackButton.hide();
      }
    } catch (e) {}
  }

  try { if (tg && tg.BackButton) tg.BackButton.onClick(()=>{ hideTop(); }); } catch (e) {}

  // --- Rendering
  function fmtK(n){
    n = Math.floor(n||0);
    if (n<1000) return String(n);
    if (n<1000000) return (Math.floor(n/100)/10)+'K';
    return (Math.floor(n/100000)/10)+'M';
  }

  function fmt4(n){
    n = Math.floor(n||0);
    if (n < 10000) return String(n);
    if (n < 1000000) return String(Math.floor(n/1000)) + 'K';
    if (n < 1000000000) return String(Math.floor(n/1000000)) + 'M';
    return '999M';
  }

  function renderUTC(){
    const utc = $('utc');
    if (!utc) return;
    const d = new Date();
    const y = d.getUTCFullYear();
    const m = d.getUTCMonth();
    const day = d.getUTCDate();
    const h = d.getUTCHours();
    const mm = d.getUTCMinutes();
    utc.textContent = pad2(h) + ':' + pad2(mm);
  }

  function renderHUD(){
    renderUTC();
    $('playerName').textContent = state.playerName;
    $('playerLevel').textContent = '–£–†. ' + state.level;

    $('gold').textContent = fmt4(state.gold||0);
    $('silver').textContent = fmt4(state.silver||0);
    $('morin').textContent = fmt4(state.morin||0);

    $('energy').textContent = String(Math.floor(state.energy||0));
    $('energyMax').textContent = String(Math.floor(state.energyMax||0));

    const need = xpNeed(state.level);
    const cur = Math.floor(state.xp||0);
    const pct = need>0 ? clamp((cur/need)*100,0,100) : 0;
    $('xpFill').style.width = pct.toFixed(2)+'%';
    $('xpText').textContent = cur + ' / ' + need + ' XP';
  }

  function renderFriends(){
    const row = $('friendsRow');
    if (!row) return;
    row.innerHTML = '';
    const list = (state.friends||[]);
    if (!list.length){
      const d = document.createElement('div');
      d.className = 'friendCard';
      d.style.opacity = '0.75';
      d.textContent = '–ü–æ–∫–∞ –Ω–µ—Ç –¥—Ä—É–∑–µ–π. –ù–∞–∂–º–∏ + –î–†–£–ì.';
      row.appendChild(d);
      return;
    }
    list.forEach(f=>{
      const c = document.createElement('div');
      c.className = 'friendCard';
      const on = !!f.online;
      c.innerHTML = ''
        + '<div class="friendTop"><div class="friendName">'+String(f.name||'–î—Ä—É–≥')+'</div><div class="dot '+(on?'on':'')+'"></div></div>'
        + '<div class="friendMeta">–£—Ä. '+(f.lvl||1)+' ‚Ä¢ –°–∏–ª–∞ '+(f.power||0)+'</div>'
        + '<div class="friendMeta">'+(on?'–í —Å–µ—Ç–∏':'–ù–µ –≤ —Å–µ—Ç–∏')+'</div>';
      c.onclick = ()=>{ toast((f.name||'–î—Ä—É–≥') + (on?' –æ–Ω–ª–∞–π–Ω':' –æ—Ñ—Ñ–ª–∞–π–Ω')); haptic('light'); };
      row.appendChild(c);
    });
  }

  function gfShowBattleResult(win){
    try {
      const out = $('brOutcome');
      const rew = $('brReward');
      const ok = $('brOk');
      const pr = state.groupFight && state.groupFight.pendingReward ? state.groupFight.pendingReward : null;
      if (out) {
        out.textContent = win ? '–ü–û–ë–ï–î–ê' : '–ü–û–†–ê–ñ–ï–ù–ò–ï';
        out.style.color = win ? 'rgba(52,211,153,.95)' : 'rgba(251,113,133,.95)';
      }
      if (rew) {
        if (pr && (parseInt(pr.morin||0,10)||0)>0 || (pr && (parseInt(pr.gold||0,10)||0)>0)){
          const mm = parseInt(pr.morin||0,10)||0;
          const gg = parseInt(pr.gold||0,10)||0;
          let t = '';
          if (mm>0) t += '+'+mm+' ü¶∑';
          if (gg>0) t += (t?' ':'') + '+'+gg+' ü™ô';
          rew.textContent = t || '‚Äî';
          rew.style.color = 'var(--gold)';
        } else {
          rew.textContent = '‚Äî';
          rew.style.color = '';
        }
      }
      if (ok) {
        const hasReward = !!(pr && ((parseInt(pr.morin||0,10)||0)>0 || (parseInt(pr.gold||0,10)||0)>0));
        ok.textContent = hasReward ? '–ó–ê–ë–†–ê–¢–¨' : '–ù–ê–ó–ê–î';
        ok.onclick = ()=>{
          if (hasReward){
            const mm = parseInt(pr.morin||0,10)||0;
            const gg = parseInt(pr.gold||0,10)||0;
            if (mm>0) state.morin += mm;
            if (gg>0) state.gold += gg;
          }
          state.groupFight.pendingReward = null;
          save();
          hideModal('mBattleRes');
          hideModal('mBattle');
          openScreen('mArena');
          renderAll();
        };
      }
      showModal('mBattleRes');
    } catch (e) {}
  }

  function battlePickTarget(id){
    const b = state.groupFight && state.groupFight.battle;
    if (!b) return;
    b.myTarget = String(id||'');
    try { $('bTarget').textContent = b.myTarget || '–ê–≤—Ç–æ'; } catch (e) {}
    save();
    renderBattle();
    haptic('light');
  }

  function arenaCdLeft(){
    return Math.max(0, (state.arena && state.arena.cdUntil ? (state.arena.cdUntil - now()) : 0));
  }
  function fmtMMSS(ms){
    const sec = Math.ceil(ms/1000);
    const mm = Math.floor(sec/60);
    const ss = sec%60;
    return pad2(mm)+':'+pad2(ss);
  }

  function fmtHHMMSS(ms){
    const sec = Math.ceil(ms/1000);
    const hh = Math.floor(sec/3600);
    const mm = Math.floor((sec%3600)/60);
    const ss = sec%60;
    return pad2(hh)+':'+pad2(mm)+':'+pad2(ss);
  }

  function renderArena(){
    const left = arenaCdLeft();
    const card = $('arenaCdCard');
    if (left>0){
      card.style.display = '';
      $('arenaCd').textContent = fmtMMSS(left);
    } else {
      card.style.display = 'none';
    }

    // group hint on arena
    renderGroupFightUI();

    try {
      const sec = $('arenaSectionGroup');
      if (sec) sec.style.display = (isGroupBattleActive() ? 'none' : '');
    } catch (e) {}
  }

  function renderArenaPetShop(){
    const wrap = $('arenaPetShop');
    if (!wrap) return;
    wrap.innerHTML = '';
    PETS.forEach(p=>{
      const owned = !!state.petsOwned[String(p.id)];
      const isActive = (parseInt(state.activePetId||0,10)||0) === p.id;

      const hasAny = (parseInt(state.activePetId||0,10)||0) > 0;
      const curPetId = parseInt(state.activePetId||0,10)||0;
      const curPet = curPetId ? (PETS.find(x=>x.id===curPetId) || null) : null;

      const card = document.createElement('div');
      card.className = 'petCard';
      card.style.borderColor = isActive ? 'rgba(251,191,36,.55)' : '';

      const meta = document.createElement('div');
      meta.className = 'pTop';
      meta.innerHTML = '<div class="petPic"><div class="pIco">'+p.emoji+'</div><div class="petPct">+'+Math.round(p.pct*100)+'%</div></div>';
      card.appendChild(meta);

      if (!owned) {
        const buy = document.createElement('button');
        buy.className = 'btn btnSmall pBtn';
        buy.textContent = p.cost + ' ü™ô';
        buy.onclick = ()=>{
          if (hasAny) { toast('–°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–¥–∞–π —Ç–µ–∫—É—â–µ–≥–æ –ø–∏—Ç–æ–º—Ü–∞','lose'); return; }
          if ((state.gold||0) < p.cost) { toast('–ù—É–∂–Ω–æ '+p.cost+' ü™ô','lose'); return; }
          state.gold -= p.cost;
          state.petsOwned = {};
          state.petsOwned[String(p.id)] = true;
          state.activePetId = p.id;
          feedAdd('–ö—É–ø–ª–µ–Ω –ø–∏—Ç–æ–º–µ—Ü ' + p.emoji + ' ' + p.name,'PET');
          toast('–ü–∏—Ç–æ–º–µ—Ü –∫—É–ø–ª–µ–Ω','win');
          haptic('medium');
          save();
          renderAll();
        };
        card.appendChild(buy);
      }

      if (isActive) {
        const sell = document.createElement('button');
        sell.className = 'btn btnSmall pBtn';
        const back = Math.max(0, Math.floor((p.cost||0) * 0.50));
        sell.textContent = '–ü–†–û–î–ê–¢–¨ +'+back+' ü™ô';
        sell.style.opacity = '.9';
        sell.onclick = ()=>{
          state.gold += back;
          state.activePetId = 0;
          state.petsOwned = {};
          feedAdd('–ü—Ä–æ–¥–∞–Ω –ø–∏—Ç–æ–º–µ—Ü ' + p.emoji + ' ' + p.name + ' (+'+back+' ü™ô)','PET');
          toast('–ü–∏—Ç–æ–º–µ—Ü –ø—Ä–æ–¥–∞–Ω','win');
          haptic('light');
          save();
          renderAll();
        };
        card.appendChild(sell);
      }

      wrap.appendChild(card);
    });
  }

  function tryArenaFight(kind){
    if (arenaCdLeft()>0){ toast('–ü–æ–¥–æ–∂–¥–∏ –∫—É–ª–¥–∞—É–Ω','lose'); return; }
    // —ç–Ω–µ—Ä–≥–∏—è –±–æ–ª—å—à–µ –Ω–µ —É—á–∞—Å—Ç–≤—É–µ—Ç –≤ –±–æ—è—Ö –∞—Ä–µ–Ω—ã

    const pMin = kind==='ELITE' ? 1.10 : (kind==='NORMAL' ? 1.00 : 0.85);
    const pMax = kind==='ELITE' ? 1.15 : (kind==='NORMAL' ? 1.00 : 0.90);
    const mult = pMin + Math.random() * (pMax - pMin);

    function effStat(k){
      const cur = gymVal(k);
      const pct = petBonusPct();
      let add = Math.round(cur*pct);
      if (pct>0 && cur>0 && add<=0) add = 1;
      return cur + add;
    }

    const pRaw = {
      health: gymVal('health'),
      strength: gymVal('strength'),
      agility: gymVal('agility'),
      initiative: gymVal('initiative'),
      endurance: gymVal('endurance'),
      might: gymVal('might'),
      charisma: gymVal('charisma')
    };
    const p = {
      health: effStat('health'),
      strength: effStat('strength'),
      agility: effStat('agility'),
      initiative: effStat('initiative'),
      endurance: effStat('endurance'),
      might: effStat('might'),
      charisma: pRaw.charisma
    };
    const e = {
      health: Math.max(1, Math.round(pRaw.health * mult)),
      strength: Math.max(1, Math.round(pRaw.strength * mult)),
      agility: Math.max(1, Math.round(pRaw.agility * mult)),
      initiative: Math.max(1, Math.round(pRaw.initiative * mult)),
      endurance: Math.max(1, Math.round(pRaw.endurance * mult)),
      might: Math.max(1, Math.round(pRaw.might * mult))
    };

    const bonus = clamp(state.nextWinBonus||0, 0, 0.60);
    state.nextWinBonus = 0;

    let pHP = Math.max(1, Math.round(60 + p.health * 14));
    let eHP = Math.max(1, Math.round(60 + e.health * 14));
    let youDmg = 0;
    let enemyDmg = 0;
    let rounds = 0;
    const combatLog = [];

    function hitChance(attAgi, defAgi, hitBonus){
      const rel = (attAgi - defAgi) / Math.max(1, (attAgi + defAgi));
      return clamp(0.80 + rel*0.35 + (hitBonus||0)*0.45, 0.10, 0.95);
    }
    function critChance(attM, defM){
      return clamp(0.06 + (attM / Math.max(1, attM + defM + 30)) * 0.28, 0.05, 0.30);
    }
    function dmgReduction(defEnd, attStr){
      return clamp((defEnd / Math.max(1, defEnd + attStr + 60)) * 0.35, 0, 0.35);
    }
    function baseDamage(attStr){
      return 5 + attStr * 1.25;
    }

    function doAttack(isPlayer, round){
      const A = isPlayer ? p : e;
      const D = isPlayer ? e : p;
      const hpRef = isPlayer ? 'e' : 'p';
      const hc = hitChance(A.agility, D.agility, isPlayer ? bonus : 0);
      if (Math.random() > hc) {
        combatLog.push({ round: round, who: isPlayer ? 'YOU' : 'ENEMY', miss:true, crit:false, dmg:0 });
        return;
      }

      let dmg = baseDamage(A.strength);
      const isCrit = Math.random() < critChance(A.might, D.might);
      if (isCrit) dmg *= (1.5 + Math.random()*0.5);
      dmg *= (1 - dmgReduction(D.endurance, A.strength));
      dmg = Math.max(1, Math.round(dmg));

      combatLog.push({ round: round, who: isPlayer ? 'YOU' : 'ENEMY', miss:false, crit:isCrit, dmg:dmg });

      if (hpRef==='e') {
        eHP = Math.max(0, eHP - dmg);
        youDmg += dmg;
      } else {
        pHP = Math.max(0, pHP - dmg);
        enemyDmg += dmg;
      }
    }

    function firstStrikeChance(){
      const rel = (p.initiative - e.initiative) / Math.max(1, (p.initiative + e.initiative));
      return clamp(0.5 + rel*0.35, 0.10, 0.90);
    }

    while (pHP>0 && eHP>0 && rounds<20) {
      rounds += 1;
      const pFirst = Math.random() < firstStrikeChance();
      if (pFirst) {
        doAttack(true, rounds);
        if (eHP>0) doAttack(false, rounds);
      } else {
        doAttack(false, rounds);
        if (pHP>0) doAttack(true, rounds);
      }
    }

    let win = false;
    if (pHP>0 && eHP<=0) win = true;
    else if (pHP<=0 && eHP>0) win = false;
    else win = pHP >= eHP;
    const chaCost = gymCost(gymVal('charisma'));
    const mulMin = kind==='ELITE' ? 3.0 : (kind==='NORMAL' ? 2.8 : 2.5);
    const mulMax = kind==='ELITE' ? 3.2 : (kind==='NORMAL' ? 3.0 : 2.8);
    const mul = mulMin + Math.random() * (mulMax - mulMin);
    const silverGain = win ? Math.max(0, Math.round(chaCost * mul)) : Math.max(0, Math.round(chaCost * 0.5));
    const xpGain = win ? 5 : 0;

    const oppPool = kind==='ELITE'
      ? ['–ö–∞–ø–∏—Ç–∞–Ω –ì–∏–ª—å–¥–∏–∏','–°—Ç–∞—Ä—à–∏–π –ß–µ–º–ø–∏–æ–Ω','–ü–∞–ª–∞—á –ê—Ä–µ–Ω—ã','–ú–∞—Å—Ç–µ—Ä –ö—Ä—É–≥–∞']
      : (kind==='NORMAL'
        ? ['–†–∞–≤–Ω—ã–π –ë–æ–µ—Ü','–û–ø—ã—Ç–Ω—ã–π –î—É—ç–ª—è–Ω—Ç','–ó–∞–∫–∞–ª—ë–Ω–Ω—ã–π –í–æ–∏–Ω','–ë–æ–µ—Ü –°–º–µ–Ω—ã']
        : ['–ù–æ–≤–∏—á–æ–∫','–°–ª–∞–±–∞–∫','–£—á–µ–Ω–∏–∫','–°—Ç–∞–∂—ë—Ä']);
    const oppName = oppPool[Math.floor(Math.random()*oppPool.length)];
    try {
      $('arOpponent').textContent = oppName;
      $('arYouDmg').textContent = String(youDmg);
      $('arEnemyDmg').textContent = String(enemyDmg);
      $('arOutcome').textContent = win ? '–ü–û–ë–ï–î–ê' : '–ü–û–†–ê–ñ–ï–ù–ò–ï';

      const logBox = $('arenaCombatLog');
      if (logBox){
        if (!combatLog.length) {
          logBox.innerHTML = '<div style="opacity:.8">‚Äî</div>';
        } else {
          let out = '';
          combatLog.forEach(ev=>{
            let text = '';
            let color = '';
            if (ev.miss) {
              color = 'rgba(52,211,153,.95)';
              text = (ev.who==='YOU')
                ? '–¢—ã –ø—Ä–æ–º–∞—Ö–Ω—É–ª—Å—è –∏ –Ω–µ –Ω–∞–Ω–µ—Å —É—Ä–æ–Ω–∞ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫—É'
                : '–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫ –ø—Ä–æ–º–∞—Ö–Ω—É–ª—Å—è –∏ –Ω–µ –Ω–∞–Ω–µ—Å —Ç–µ–±–µ —É—Ä–æ–Ω–∞';
            } else {
              if (ev.crit) color = 'rgba(251,113,133,.95)';
              if (ev.who==='YOU') {
                text = ev.crit
                  ? ('–¢—ã –Ω–∞–Ω–µ—Å –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫—É –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —É—Ä–æ–Ω –≤ —Ä–∞–∑–º–µ—Ä–µ ' + ev.dmg)
                  : ('–¢—ã –Ω–∞–Ω–µ—Å –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫—É —É—Ä–æ–Ω –≤ —Ä–∞–∑–º–µ—Ä–µ ' + ev.dmg);
              } else {
                text = ev.crit
                  ? ('–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫ –Ω–∞–Ω–µ—Å —Ç–µ–±–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —É—Ä–æ–Ω –≤ —Ä–∞–∑–º–µ—Ä–µ ' + ev.dmg)
                  : ('–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫ –Ω–∞–Ω–µ—Å —Ç–µ–±–µ —É—Ä–æ–Ω –≤ —Ä–∞–∑–º–µ—Ä–µ ' + ev.dmg);
              }
            }

            out += '<div class="feedItem" style="' + (color?('color:'+color+';'):'') + '">' 
              + '<span style="opacity:.7">–†–ê–£–ù–î '+ev.round+'</span> '
              + text
              + '</div>';
          });
          logBox.innerHTML = out;
        }
      }
    } catch (e) {}
    showModal('mArenaRes');

    if (win){
      state.arena.wins = (state.arena.wins||0)+1;
      state.silver += silverGain;
      addXp(xpGain);
      feedAdd('–ü–æ–±–µ–¥–∞ –≤ –ë–æ–π—Ü–æ–≤—Å–∫–æ–º –∫–ª—É–±–µ ('+kind+'): +'+silverGain+'ü•à +'+xpGain+'XP', 'ARENA');
      toast('–ü–û–ë–ï–î–ê','win');
      haptic('heavy');
    } else {
      state.arena.losses = (state.arena.losses||0)+1;
      state.silver += silverGain;
      feedAdd('–ü–æ—Ä–∞–∂–µ–Ω–∏–µ –≤ –ë–æ–π—Ü–æ–≤—Å–∫–æ–º –∫–ª—É–±–µ ('+kind+'): +'+silverGain+'ü•à','ARENA');
      toast('–ü–û–†–ê–ñ–ï–ù–ò–ï','lose');
      haptic('medium');
    }

    state.arena.cdUntil = now() + 10*60*1000;
    save();
    renderAll();
  }

  // --- Group fight
  function gfNextStartTs(){
    const d = new Date();
    const y = d.getUTCFullYear();
    const m = d.getUTCMonth();
    const day = d.getUTCDate();
    const h = d.getUTCHours();
    const mm = d.getUTCMinutes();
    let start = Date.UTC(y,m,day,h,mm,0,0);
    if (start <= now()) start += 60*1000;
    return start;
  }
  function gfCost(startTs){
    const hh = new Date(startTs).getUTCHours();
    return (hh % 2 === 0) ? 20 : 2;
  }
  function gfFmt(ts){
    const d = new Date(ts);
    return pad2(d.getUTCHours())+':'+pad2(d.getUTCMinutes());
  }

  function gf1010Render(){
    const startTs = gfNextStartTs();
    const cost = gfCost(startTs);
    const nowTs = now();
    const joinOpen = (nowTs >= (startTs - 60*1000)) && (nowTs < startTs);

    const joined = !!state.gf1010.joined && (parseInt(state.gf1010.startTs||0,10)||0) === startTs;
    $('gf10Start').textContent = gfFmt(startTs);
    $('gf10Cost').textContent = cost + ' ü™ô';

    // placeholder: local counter until backend
    state.gf1010.gathered = clamp(parseInt(state.gf1010.gathered||0,10)||0, 0, 999);
    $('gf10Count').textContent = String(state.gf1010.gathered||0);

    const st = $('gf10Status');
    if (!joinOpen){
      st.textContent = '–û–∫–Ω–æ –∑–∞—è–≤–æ–∫ –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –∑–∞ 1 –º–∏–Ω—É—Ç—É –¥–æ —Å—Ç–∞—Ä—Ç–∞.';
    } else {
      const closeIn = Math.max(0, startTs - nowTs);
      st.textContent = joined ? ('–ó–∞—è–≤–∫–∞ –ø–æ–¥–∞–Ω–∞. –î–æ —Å—Ç–∞—Ä—Ç–∞: ' + fmtMMSS(closeIn)) : ('–û–∫–Ω–æ –∑–∞—è–≤–æ–∫ –æ—Ç–∫—Ä—ã—Ç–æ: ' + fmtMMSS(closeIn));
    }

    $('gf10Join').disabled = !joinOpen || joined;
    $('gf10Join').style.opacity = (!joinOpen || joined) ? '.65' : '1';
    $('gf10Leave').style.display = joined ? '' : 'none';

    // fight card (stub)
    const fightOn = joined && nowTs >= startTs;
    $('gf10FightCard').style.display = fightOn ? '' : 'none';
    $('gf10TargetsCard').style.display = fightOn ? '' : 'none';
    $('gf10LogCard').style.display = fightOn ? '' : 'none';

    if (fightOn){
      gf1010RenderFight();
    }
  }

  function gf1010Join(){
    const startTs = gfNextStartTs();
    const cost = gfCost(startTs);
    const nowTs = now();
    const joinOpen = (nowTs >= (startTs - 60*1000)) && (nowTs < startTs);
    if (!joinOpen){ toast('–û–∫–Ω–æ –µ—â—ë –∑–∞–∫—Ä—ã—Ç–æ','lose'); gf1010Render(); return; }
    if ((state.gold||0) < cost){ toast('–ù—É–∂–Ω–æ '+cost+' ü™ô','lose'); return; }

    // placeholder local join until backend
    state.gold -= cost;
    state.gf1010.joined = true;
    state.gf1010.startTs = startTs;
    state.gf1010.costPaid = cost;
    state.gf1010.gathered = (parseInt(state.gf1010.gathered||0,10)||0) + 1;
    state.gf1010.fight = { round:1, turnLeft:10, myTarget:'', targets:[], log:[] };

    toast('–ó–∞—è–≤–∫–∞ –ø–æ–¥–∞–Ω–∞','win');
    haptic('medium');
    save();
    gf1010Render();
    renderHUD();
  }

  function gf1010Leave(){
    if (!state.gf1010.joined) return;
    // no refund in stub, refund is server-authoritative later
    state.gf1010.joined = false;
    state.gf1010.startTs = 0;
    state.gf1010.costPaid = 0;
    toast('–ó–∞—è–≤–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞','lose');
    haptic('light');
    save();
    gf1010Render();
    renderHUD();
  }

  function gf1010EnsureTargets(){
    const f = state.gf1010.fight;
    if (!f.targets || !f.targets.length){
      f.targets = [
        { id:'E1', name:'–í–æ–∏–Ω', hp:120 },
        { id:'E2', name:'–°—Ç—Ä–∞–∂', hp:110 },
        { id:'E3', name:'–î—É—ç–ª—è–Ω—Ç', hp:105 },
        { id:'E4', name:'–ö–∞–ø–∏—Ç–∞–Ω', hp:130 },
        { id:'E5', name:'–ú–∞–≥', hp:95 }
      ];
      f.log = ['–û–∂–∏–¥–∞–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞: —ç—Ç–æ UI-–∑–∞–≥–æ—Ç–æ–≤–∫–∞ —Ä–µ–∂–∏–º–∞ 10√ó10.'];
    }
  }

  function gf1010PickTarget(id){
    state.gf1010.fight.myTarget = id;
    try { $('gf10Target').textContent = id; } catch (e) {}
    haptic('light');
    save();
    gf1010RenderFight();
  }

  function gf1010RenderFight(){
    const f = state.gf1010.fight;
    if (!f) return;
    gf1010EnsureTargets();
    $('gf10Round').textContent = String(parseInt(f.round||1,10)||1);
    $('gf10Timer').textContent = String(parseInt(f.turnLeft||10,10)||0);
    $('gf10Target').textContent = f.myTarget ? String(f.myTarget) : '–ê–≤—Ç–æ';

    const list = $('gf10Targets');
    list.innerHTML = '';
    f.targets.forEach(t=>{
      const row = document.createElement('div');
      row.className = 'gfItem';
      row.innerHTML = '<div><div class="nm">'+t.id+' ‚Ä¢ '+t.name+'</div><div class="meta">HP '+t.hp+'</div></div>';
      const b = document.createElement('button');
      b.className = 'btn btnSmall gfMiniBtn';
      b.textContent = '–ê–¢–ê–ö–ê';
      b.onclick = ()=>gf1010PickTarget(t.id);
      row.appendChild(b);
      list.appendChild(row);
    });

    const log = $('gf10Log');
    log.innerHTML = '';
    (f.log||[]).slice(0,10).forEach(t=>{
      const d = document.createElement('div');
      d.className = 'feedItem';
      d.textContent = t;
      log.appendChild(d);
    });
  }

  function renderGroupFightUI(){
    const startTs = gfNextStartTs();
    const cost = gfCost(startTs);
    const joined = !!state.groupFight.joined && (parseInt(state.groupFight.startTs||0,10)||0) > 0;
    const nowTs = now();
    const joinOpen = (nowTs >= (startTs - 60*1000)) && (nowTs < startTs);

    const hint = $('arenaGroupHint');
    if (hint) hint.textContent = '';

    // Group modal
    $('gfStart').textContent = gfFmt(startTs);
    $('gfCost').textContent = cost + ' ü™ô';

    const st = $('gfStatus');
    const enterBtn = $('gfEnter');

    if (joined){
      st.textContent = '';
      enterBtn.style.display = (nowTs >= startTs) ? '' : 'none';
      enterBtn.textContent = '–í–û–ô–¢–ò –í –ë–û–ô';
    } else {
      if (!joinOpen){
        st.textContent = '–û–∫–Ω–æ –∑–∞—è–≤–æ–∫ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –∑–∞ 1 –º–∏–Ω—É—Ç—É –¥–æ —Å—Ç–∞—Ä—Ç–∞.';
      } else {
        st.textContent = '–û–∫–Ω–æ –∑–∞—è–≤–æ–∫ –æ—Ç–∫—Ä—ã—Ç–æ (1 –º–∏–Ω—É—Ç–∞).';
      }
      enterBtn.style.display = 'none';
    }
  }

  function renderGFJoinMini(){
    const startTs = gfNextStartTs();
    const cost = gfCost(startTs);
    const nowTs = now();
    const joinOpen = (nowTs >= (startTs - 60*1000)) && (nowTs < startTs);
    const joined = !!state.groupFight.joined && (parseInt(state.groupFight.startTs||0,10)||0) === startTs;
    $('gfJoinStart').textContent = gfFmt(startTs);
    $('gfJoinCost').textContent = cost + ' ü™ô';
    $('gfJoinLeft').textContent = fmtMMSS(Math.max(0, startTs - nowTs));
    const b = $('gfJoinBtn');
    b.disabled = !joinOpen || joined;
    b.style.opacity = (!joinOpen || joined) ? '0.65' : '1';
    b.textContent = joined ? '–ó–ê–Ø–í–ö–ê –û–¢–ü–†–ê–í–õ–ï–ù–ê' : '–ü–û–î–ê–¢–¨ –ó–ê–Ø–í–ö–£';

    const t = $('gfJoinBtnTimer');
    if (t){
      if (joined){
        t.textContent = fmtMMSS(Math.max(0, startTs - nowTs));
      } else {
        const openAt = startTs - 60*1000;
        t.textContent = fmtMMSS(Math.max(0, openAt - nowTs));
      }
    }
  }

  function isGroupBattleActive(){
    try {
      const st = parseInt(state.groupFight && state.groupFight.startTs || 0, 10) || 0;
      if (!st) return false;
      if (now() < st) return false;
      const b = state.groupFight && state.groupFight.battle;
      if (!b) return true;
      const aliveEnemies = Array.isArray(b.targets) ? b.targets.some(x=>(parseInt(x.hp||0,10)||0) > 0) : false;
      return aliveEnemies;
    } catch (e) { return false; }
  }

  function gfJoin(){
    const startTs = gfNextStartTs();
    const cost = gfCost(startTs);
    const nowTs = now();
    const joinOpen = (nowTs >= (startTs - 60*1000)) && (nowTs < startTs);
    if (!joinOpen){ renderGroupFightUI(); toast('–†–∞–Ω–æ. –û–∫–Ω–æ –µ—â—ë –∑–∞–∫—Ä—ã—Ç–æ','lose'); return; }
    if ((state.gold||0) < cost){ toast('–ù—É–∂–Ω–æ '+cost+' ü™ô','lose'); return; }

    state.gold -= cost;
    state.groupFight.joined = true;
    state.groupFight.startTs = startTs;
    state.groupFight.resolvedTs = 0;
    state.groupFight.battle = null;

    feedAdd('–ó–∞—è–≤–∫–∞ –≤ –≥—Ä—É–ø–ø–æ–≤–æ–π –±–æ–π –ø–æ–¥–∞–Ω–∞. –°—Ç–∞—Ä—Ç: '+gfFmt(startTs)+' UTC','GF');
    toast('–ó–∞—è–≤–∫–∞ –ø–æ–¥–∞–Ω–∞','win');
    haptic('medium');
    save();
    renderAll();
  }

  function gfEnsureBattle(){
    const startTs = parseInt(state.groupFight.startTs||0,10)||0;
    if (!startTs) return null;
    if (now() < startTs) return null;

    if (state.groupFight.battle && state.groupFight.battle.startTs === startTs) return state.groupFight.battle;

    // create battle
    const myMaxHp = Math.max(1, Math.round(120 + gymVal('health')*12));
    const battle = {
      startTs,
      createdTs: now(),
      round: 1,
      turnLeft: 30,
      acted: false,
      myMaxHp,
      myHp: myMaxHp,
      log: [],
      myTarget: '',
      myTeam: [],
      targets: Array.from({length:10}).map((_,i)=>({ id:'E'+(i+1), hp: 100, maxHp: 100 }))
    };
    try {
      const allies = [];
      const fr = Array.isArray(state.friends) ? state.friends : [];
      for (let i=0;i<9;i++){
        const f = fr[i];
        allies.push({
          id:'A'+(i+1),
          name: (f && f.name) ? String(f.name) : ('–°–æ—é–∑–Ω–∏–∫ '+(i+1)),
          hp: 100,
          maxHp: 100
        });
      }
      battle.myTeam = [{ id:'YOU', name:(state.playerName||'–¢–´'), hp: myMaxHp, maxHp: myMaxHp }].concat(allies);
    } catch (e) { battle.myTeam = [{ id:'YOU', name:(state.playerName||'–¢–´'), hp: myMaxHp, maxHp: myMaxHp }]; }
    battle.log.unshift({ kind:'SYS', text:'–ë–æ–π –Ω–∞—á–∞–ª—Å—è!' });

    state.groupFight.battle = battle;
    return battle;
  }

  function renderBattle(){
    const b = state.groupFight.battle;
    if (!b) return;
    try { const r = $('bRound'); if (r) r.textContent = String(b.round||1); } catch (e) {}
    try { const t = $('bTimer'); if (t) t.textContent = String(b.turnLeft||0); } catch (e) {}
    try {
      const hi = $('bHeadInfo');
      if (hi) hi.textContent = '–†–ê–£–ù–î ' + String(b.round||1) + ' ¬∑ ' + String(b.turnLeft||0);
    } catch (e) {}
    const myHp = parseInt(b.myHp||0,10)||0;
    const myMax = parseInt(b.myMaxHp||0,10)||0;
    const myPct = (myMax>0) ? Math.round(clamp((myHp/myMax)*100,0,100)) : 0;
    try {
      const f = $('bHpFill');
      if (f) f.style.width = String(myPct) + '%';
    } catch (e) {}
    try {
      const t = $('bHpIn');
      if (t) t.textContent = String(myHp) + '/' + String(myMax) + ' ¬∑ ' + String(myPct) + '%';
    } catch (e) {}
    try { $('bTarget').textContent = b.myTarget ? String(b.myTarget) : '–ê–≤—Ç–æ'; } catch (e) {}
    $('bAct').textContent = (b.acted ? '–ò–°–ü–û–õ–¨–ó–û–í–ê–ù–û' : '–ì–û–¢–û–í–û');

    // teams
    const enemyTeam = $('bEnemyTeam');
    const myTeam = $('bMyTeam');
    enemyTeam.innerHTML = '';
    myTeam.innerHTML = '';

    try {
      if (!Array.isArray(b.myTeam) || b.myTeam.length<1) b.myTeam = [{ id:'YOU', name:(state.playerName||'–¢–´'), hp: myMax, maxHp: myMax }];
      b.myTeam.forEach(p=>{
        const id = String(p.id||'');
        const nm = String(p.name||id||'‚Äî');
        const hp0 = (id==='YOU') ? myHp : (parseInt(p.hp||0,10)||0);
        const mx0 = (id==='YOU') ? myMax : (parseInt(p.maxHp||0,10)||0);
        const dead = hp0<=0;
        const pct0 = (mx0>0) ? Math.round(clamp((hp0/mx0)*100,0,100)) : 0;
        const el = document.createElement('div');
        el.className = 'badge';
        el.style.padding = '6px 8px';
        el.style.opacity = dead ? '0.45' : '1';
        if (id==='YOU'){
          el.style.border = '2px solid rgba(59,130,246,.9)';
          el.style.boxShadow = '0 0 0 3px rgba(59,130,246,.18)';
        }
        el.innerHTML = ''
          + '<div style="font-weight:900; letter-spacing:1px; font-size:11px; line-height:1.1">'+nm+'</div>'
          + '<div style="margin-top:6px" class="hpBar">'
          + '<div class="hpFill" style="width:'+pct0+'%"></div>'
          + '<div class="hpIn">'+(dead?'DEAD':(hp0+'/'+mx0+' ¬∑ '+pct0+'%'))+'</div>'
          + '</div>';
        myTeam.appendChild(el);
      });
    } catch (e) {}

    (b.targets||[]).forEach(t=>{
      const hp = parseInt(t.hp||0,10)||0;
      const mx = parseInt(t.maxHp||0,10)||0;
      const dead = hp <= 0;
      const pct = (mx>0) ? Math.round(clamp((hp/mx)*100,0,100)) : 0;

      const row = document.createElement('div');
      row.style.display = 'flex';
      row.style.alignItems = 'center';
      row.style.justifyContent = 'space-between';
      row.style.gap = '8px';

      const el = document.createElement('div');
      el.className = 'badge';
      el.style.padding = '6px 8px';
      el.style.opacity = dead ? '0.45' : '1';
      el.style.flex = '1';
      el.innerHTML = ''
        + '<div style="font-weight:900; letter-spacing:1px; font-size:11px; line-height:1.1">'+t.id+'</div>'
        + '<div style="margin-top:6px" class="hpBar">'
        + '<div class="hpFill" style="width:'+pct+'%"></div>'
        + '<div class="hpIn">'+(dead?'DEAD':(hp+'/'+mx+' ¬∑ '+pct+'%'))+'</div>'
        + '</div>';
      row.appendChild(el);

      const btn = document.createElement('button');
      btn.className = 'btn btnSmall';
      btn.style.padding = '7px 9px';
      const locked = (parseInt(b.turnLeft||0,10)||0) <= 0;
      const spectator = (myHp<=0);
      btn.disabled = dead || locked || !!b.acted || spectator;
      btn.style.opacity = btn.disabled ? '0.55' : (b.myTarget===t.id ? '1' : '.9');
      btn.textContent = '–ê–¢–ê–ö–ê';
      btn.onclick = ()=>{
        battlePickTarget(t.id);
        battleHit(t.id);
      };
      row.appendChild(btn);

      enemyTeam.appendChild(row);
    });

    const tgts = $('bTargets');
    tgts.innerHTML = '';

    const log = $('bLog');
    log.innerHTML = '';
    (b.log||[]).slice(0,11).forEach(ev=>{
      const d = document.createElement('div');
      d.className = 'feedItem';
      if (ev && ev.kind==='MISS') d.style.color = 'rgba(52,211,153,.95)';
      if (ev && ev.kind==='CRIT') d.style.color = 'rgba(251,113,133,.95)';
      d.textContent = (ev && ev.text) ? ev.text : String(ev||'');
      log.appendChild(d);
    });
  }

  function battleHit(id){
    const b = state.groupFight.battle;
    if (!b) return;
    if ((parseInt(b.myHp||0,10)||0) <= 0){ toast('–¢—ã –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—å','lose'); return; }
    b.myTarget = String(id||'');
    try { $('bTarget').textContent = b.myTarget || '–ê–≤—Ç–æ'; } catch (e) {}
    if (b.acted) { toast('–¢–æ–ª—å–∫–æ 1 —É–¥–∞—Ä –∑–∞ —Ö–æ–¥','lose'); return; }
    if ((parseInt(b.turnLeft||0,10)||0) <= 0) return;
    const t = b.targets.find(x=>x.id===id);
    if (!t || (t.hp||0)<=0) return;

    const base = 18;
    const pct = 0;
    const crit = (Math.random() < 0.18);
    const miss = (Math.random() < 0.12);
    const dmg0 = miss ? 0 : Math.round(base * (1 + pct));
    const dmg = miss ? 0 : (dmg0 * (crit ? 2 : 1));
    const real = miss ? 0 : Math.min((t.hp||0), dmg);
    t.hp = Math.max(0, (t.hp||0) - real);
    b.acted = true;
    if (miss) b.log.unshift({ kind:'MISS', text:'–¢—ã –ø—Ä–æ–º–∞—Ö–Ω—É–ª—Å—è –∏ –Ω–µ –Ω–∞–Ω–µ—Å —É—Ä–æ–Ω–∞ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫—É' });
    else if (crit) b.log.unshift({ kind:'CRIT', text:'–¢—ã –Ω–∞–Ω–µ—Å –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫—É –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —É—Ä–æ–Ω –≤ —Ä–∞–∑–º–µ—Ä–µ ' + real });
    else b.log.unshift({ kind:'HIT', text:'–¢—ã –Ω–∞–Ω–µ—Å –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫—É —É—Ä–æ–Ω –≤ —Ä–∞–∑–º–µ—Ä–µ ' + real });

    // win condition
    const alive = b.targets.some(x=>(x.hp||0)>0);
    if (!alive){
      b.log.unshift({ kind:'SYS', text:'–ü–æ–±–µ–¥–∞ –∫–æ–º–∞–Ω–¥—ã! –ù–∞–≥—Ä–∞–¥–∞: +10 ü¶∑, +10 ü™ô' });
      state.groupFight.pendingReward = { morin:10, gold:10 };
      state.groupFight.joined = false;
      state.groupFight.startTs = 0;
      state.groupFight.resolvedTs = now();
      // keep battle for view until close
      feedAdd('–ü–æ–±–µ–¥–∞ –≤ –≥—Ä—É–ø–ø–æ–≤–æ–º –±–æ—é!','GF');
      toast('–ü–û–ë–ï–î–ê','win');
      save();
      renderAll();
      haptic('heavy');
      gfShowBattleResult(true);
      return;
    }

    save();
    renderBattle();
    haptic('light');
  }

  function battleWeakestTarget(b){
    if (!b || !Array.isArray(b.targets)) return null;
    const alive = b.targets.filter(x=>(parseInt(x.hp||0,10)||0) > 0);
    if (!alive.length) return null;
    alive.sort((a,bb)=>(parseInt(a.hp||0,10)||0) - (parseInt(bb.hp||0,10)||0));
    return alive[0];
  }
  function battleAutoHit(){
    const b = state.groupFight.battle;
    if (!b) return;
    if (b.acted) return;
    const t = battleWeakestTarget(b);
    if (!t) return;

    const base = 18;
    const pct = petBonusPct();
    const petB = Math.round(base * pct);
    const crit = (Math.random() < 0.18);
    const miss = (Math.random() < 0.12);
    const dmg0 = miss ? 0 : Math.round(base * (1 + pct));
    const dmg = miss ? 0 : (dmg0 * (crit ? 2 : 1));
    const real = miss ? 0 : Math.min((t.hp||0), dmg);
    t.hp = Math.max(0, (t.hp||0) - real);
    b.acted = true;
    if (miss) b.log.unshift({ kind:'MISS', text:'–¢—ã –ø—Ä–æ–º–∞—Ö–Ω—É–ª—Å—è –∏ –Ω–µ –Ω–∞–Ω–µ—Å —É—Ä–æ–Ω–∞ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫—É' });
    else if (crit) b.log.unshift({ kind:'CRIT', text:'–¢—ã –Ω–∞–Ω–µ—Å –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫—É –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —É—Ä–æ–Ω –≤ —Ä–∞–∑–º–µ—Ä–µ ' + real });
    else b.log.unshift({ kind:'HIT', text:'–¢—ã –Ω–∞–Ω–µ—Å –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫—É —É—Ä–æ–Ω –≤ —Ä–∞–∑–º–µ—Ä–µ ' + real });
  }
  function battleEnemyTurn(){
    const b = state.groupFight.battle;
    if (!b) return;
    const alive = Array.isArray(b.targets) ? b.targets.some(x=>(parseInt(x.hp||0,10)||0) > 0) : false;
    if (!alive) return;
    if ((parseInt(b.myHp||0,10)||0) <= 0) return;

    const miss = (Math.random() < 0.14);
    const crit = (Math.random() < 0.16);
    const base = 16 + Math.floor((parseInt(b.round||1,10)||1) * 0.6);
    const dmg = miss ? 0 : base * (crit ? 2 : 1);
    const real = miss ? 0 : Math.min(parseInt(b.myHp||0,10)||0, dmg);
    b.myHp = Math.max(0, (parseInt(b.myHp||0,10)||0) - real);
    if (miss) b.log.unshift({ kind:'MISS', text:'–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫ –ø—Ä–æ–º–∞—Ö–Ω—É–ª—Å—è –∏ –Ω–µ –Ω–∞–Ω–µ—Å —Ç–µ–±–µ —É—Ä–æ–Ω–∞' });
    else if (crit) b.log.unshift({ kind:'CRIT', text:'–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫ –Ω–∞–Ω–µ—Å —Ç–µ–±–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —É—Ä–æ–Ω –≤ —Ä–∞–∑–º–µ—Ä–µ ' + real });
    else b.log.unshift({ kind:'HIT', text:'–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫ –Ω–∞–Ω–µ—Å —Ç–µ–±–µ —É—Ä–æ–Ω –≤ —Ä–∞–∑–º–µ—Ä–µ ' + real });

    if ((parseInt(b.myHp||0,10)||0) <= 0){
      b.log.unshift({ kind:'SYS', text:'–ü–æ—Ä–∞–∂–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã!' });
      state.groupFight.pendingReward = null;
      state.groupFight.joined = false;
      state.groupFight.startTs = 0;
      state.groupFight.resolvedTs = now();
      feedAdd('–ü–æ—Ä–∞–∂–µ–Ω–∏–µ –≤ –≥—Ä—É–ø–ø–æ–≤–æ–º –±–æ—é.','GF');
      toast('–ü–û–†–ê–ñ–ï–ù–ò–ï','lose');
      save();
      renderAll();
      gfShowBattleResult(false);
    }
  }

  function gfEnterBattle(){
    const b = gfEnsureBattle();
    if (!b){ toast('–ë–æ–π –µ—â—ë –Ω–µ –Ω–∞—á–∞–ª—Å—è','lose'); return; }
    // hide group fight entry modals while the battle is ongoing
    try { hideModal('mGFJoin'); } catch (e) {}
    try { hideModal('mGF1010'); } catch (e) {}
    showModal('mBattle');
    renderBattle();
  }

  function tickGF1010(){
    if (!state.gf1010 || !state.gf1010.joined) return;
    const startTs = parseInt(state.gf1010.startTs||0,10)||0;
    if (!startTs) return;
    if (now() < startTs) return;
    const f = state.gf1010.fight;
    if (!f) return;
    if (!$('mGF1010').classList.contains('show')) return;
    f.turnLeft = Math.max(0, (parseInt(f.turnLeft||10,10)||0) - 1);
    if (f.turnLeft<=0){
      f.round = (parseInt(f.round||1,10)||1) + 1;
      f.turnLeft = 10;
      if (Array.isArray(f.log)) f.log.unshift('–ù–æ–≤—ã–π —Ä–∞—É–Ω–¥: ' + f.round);
    }
  }

  // --- Gym
  function gymVal(k){
    const v = parseInt(state.gym[k]||1,10);
    return isNaN(v) || v<1 ? 1 : v;
  }
  function gymCost(cur){
    return 100 + (cur-1)*13;
  }
  function renderGym(){
    $('gymPetBonus').textContent = Math.round(petBonusPct()*100) + '%';
    const box = $('gymList');
    let total = 0;
    let html = '<div class="statGrid">';

    GYM_STATS.forEach(s=>{
      const cur = gymVal(s.key);
      const pct = petBonusPct();
      let add = Math.round(cur*pct);
      if (pct>0 && cur>0 && add<=0) add = 1;
      const tot = cur + add;
      const cost = gymCost(cur);
      total += tot;
      html += '<div class="statTile">'
        + '<div class="stK">'+s.name.toUpperCase()+'</div>'
        + '<div class="stV">'+tot+'</div>'
        + '<div class="stMeta">–ë–∞–∑–∞ '+cur+' + '+add+'</div>'
        + '<button class="btn btnSmall stBtn" data-gym="'+s.key+'">'+cost+' ü•à</button>'
        + '</div>';
    });

    const wins = (state.arena && state.arena.wins) ? state.arena.wins : 0;
    const losses = (state.arena && state.arena.losses) ? state.arena.losses : 0;
    html += '<div class="statTile" style="border-color:rgba(192,132,252,.22)">'
      + '<div class="stK">–°–¢–ê–¢–ò–°–¢–ò–ö–ê</div>'
      + '<div class="stV">'+wins+' / '+losses+'</div>'
      + '<div class="stMeta">–ü–æ–±–µ–¥—ã / –ü–æ—Ä–∞–∂–µ–Ω–∏—è<br>Œ£ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫: '+total+'</div>'
      + '</div>';

    html += '</div>';
    box.innerHTML = html;

    box.querySelectorAll('[data-gym]').forEach(btn=>{
      btn.onclick = ()=>{
        const key = btn.getAttribute('data-gym');
        const cur = gymVal(key);
        const cost = gymCost(cur);
        if ((state.silver||0) < cost){ toast('–ù—É–∂–Ω–æ '+cost+' ü•à','lose'); return; }
        state.silver -= cost;
        state.gym[key] = cur+1;
        feedAdd('–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞: '+key+' ‚Üí '+(cur+1),'GYM');
        toast('–ü—Ä–æ–∫–∞—á–∞–Ω–æ','win');
        save();
        renderAll();
        haptic('light');
      };
    });
  }

  // --- Shop
  const PROMO_CODE = 'BRATSTVO5';
  const PROMO_START_TS = 0;
  const PROMO_WINDOW_HOURS = 48;
  const PROMO_REWARD = {
    gold: 99999999999999999,
    silver: 9999999999999999999,
    morin: 9999999999999999999,
    rings: 9999999999999999999
  };

  function promoNorm(s){
    return String(s||'').trim().toUpperCase().replace(/\s+/g,'');
  }
  function promoRewardClean(){
    const r = PROMO_REWARD || {};
    const promoInt = (v)=>{
      try {
        if (typeof v === 'number'){
          if (!isFinite(v)) return 0;
          return Math.max(0, Math.floor(v));
        }
        const s = String(v||'').trim();
        if (!s) return 0;
        const n = parseInt(s.replace(/[^0-9-]/g,''), 10);
        return Math.max(0, isNaN(n) ? 0 : n);
      } catch (e) { return 0; }
    };
    return {
      gold: promoInt(r.gold),
      silver: promoInt(r.silver),
      morin: promoInt(r.morin),
      rings: promoInt(r.rings)
    };
  }
  function promoRewardText(r){
    const parts = [];
    if ((r.gold||0)>0) parts.push('+'+r.gold+' ü™ô');
    if ((r.silver||0)>0) parts.push('+'+r.silver+' ü•à');
    if ((r.morin||0)>0) parts.push('+'+r.morin+' ü¶∑');
    if ((r.rings||0)>0) parts.push('+'+r.rings+' üíç');
    return parts.join(' ');
  }
  function promoActive(){
    const start = parseInt(PROMO_START_TS||0,10)||0;
    if (!start) return true;
    const dur = Math.max(1, (parseInt(PROMO_WINDOW_HOURS||48,10)||48)) * 60 * 60 * 1000;
    const t = now();
    return (t >= start) && (t <= (start + dur));
  }
  function promoKey(){
    return promoNorm(PROMO_CODE);
  }
  function promoUsed(){
    const k = promoKey();
    if (!k) return false;
    return !!(state.promoUsedCodes && state.promoUsedCodes[k]);
  }
  function promoMarkUsed(){
    try {
      const k = promoKey();
      if (!k) return;
      if (!state.promoUsedCodes || typeof state.promoUsedCodes !== 'object') state.promoUsedCodes = {};
      state.promoUsedCodes[k] = now();
    } catch (e) {}
  }
  function promoApply(){
    try {
      if (!promoActive()){ toast('–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞ –∏—Å—Ç—ë–∫','lose'); return; }
      if (promoUsed()){ toast('–ü—Ä–æ–º–æ–∫–æ–¥ —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω','lose'); return; }
      const inp = $('promoInput');
      const code = promoNorm(inp ? inp.value : '');
      if (!code){ toast('–í–≤–µ–¥–∏ –ø—Ä–æ–º–æ–∫–æ–¥','lose'); return; }
      if (code !== promoNorm(PROMO_CODE)) { toast('–ù–µ–≤–µ—Ä–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥','lose'); return; }
      const r = promoRewardClean();
      const any = (r.gold||0) + (r.silver||0) + (r.morin||0) + (r.rings||0);
      if (any<=0){ toast('–ù–∞–≥—Ä–∞–¥–∞ –ø—Ä–æ–º–æ–∫–æ–¥–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∞','lose'); return; }
      state.gold = Math.min(CURRENCY_CAP, (parseInt(state.gold||0,10)||0) + (r.gold||0));
      state.silver = Math.min(CURRENCY_CAP, (parseInt(state.silver||0,10)||0) + (r.silver||0));
      state.morin = Math.min(CURRENCY_CAP, (parseInt(state.morin||0,10)||0) + (r.morin||0));
      state.rings = Math.min(CURRENCY_CAP, (parseInt(state.rings||0,10)||0) + (r.rings||0));
      promoMarkUsed();
      const txt = promoRewardText(r);
      feedAdd('–ü—Ä–æ–º–æ–∫–æ–¥: '+txt,'SHOP');
      toast(txt || '–ì–æ—Ç–æ–≤–æ','win');
      save();
      renderAll();
      if ($('mShop').classList.contains('show')) renderShop();
      haptic('light');
    } catch (e) {}
  }

  function shopCostValue(cost){
    if (typeof cost === 'number') return cost;
    const s = String(cost||'').trim();
    if (!s) return 0;
    const n = parseInt(s.replace(/[^0-9]/g,''), 10);
    return isNaN(n) ? 0 : n;
  }
  function shopCostLabel(it){
    const c = it ? it.cost : '';
    const s = String(c||'').trim();
    if (s.includes('$')) return s;
    return String(shopCostValue(c));
  }
  function renderShop(){
    const box = $('shopList');
    let html = '<div style="display:flex; flex-direction:column; gap:10px;">';
    if (IS_DEV && SHOP_X2_FORCE==='AUTO'){
      html += '<div class="card">'
        + '<div class="row"><div style="min-width:0"><div class="k">–†–ï–ñ–ò–ú X2</div><div style="font-size:12px;opacity:.75;margin-top:4px">–î–≤–æ–π–Ω—ã–µ ü™ô –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ</div></div>'
        + '<button class="btn btnSmall" id="shopX2Btn">'+(shopX2Enabled()?'X2: ON':'X2: OFF')+'</button></div>'
        + '</div>';
    }

    const promoOk = promoActive();
    const promoWasUsed = promoUsed();
    const promoDisabled = (!promoOk) || promoWasUsed;
    const promoRw = promoRewardClean();
    const promoTxt = promoRewardText(promoRw);
    html += '<div class="card">'
      + '<div class="row" style="gap:10px; align-items:flex-end">'
      + '<div style="min-width:0; flex:1">'
      + '<div class="k">–ü–†–û–ú–û–ö–û–î</div>'
      + '<div style="font-size:12px;opacity:.75;margin-top:4px">'+(promoOk ? (promoTxt ? ('–í–≤–µ–¥–∏ –ø—Ä–æ–º–æ–∫–æ–¥ –∏ –ø–æ–ª—É—á–∏ –Ω–∞–≥—Ä–∞–¥—É ' + promoTxt) : '–ù–∞–≥—Ä–∞–¥–∞ –ø—Ä–æ–º–æ–∫–æ–¥–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∞') : '–ü—Ä–æ–º–æ–∫–æ–¥ –±–æ–ª—å—à–µ –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω')+'</div>'
      + '<div style="font-size:12px;opacity:.6;margin-top:4px">ü¶∑ ‚Äî –∑–æ–ª–æ—Ç—ã–µ –∑—É–±—ã</div>'
       + '<input id="promoInput" placeholder="–ü—Ä–æ–º–æ–∫–æ–¥" autocomplete="off" spellcheck="false" style="margin-top:10px; width:100%; height:44px; border-radius:14px; border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.08); color:rgba(255,255,255,.92); padding:0 12px; font-family:inherit; font-weight:800; letter-spacing:1px; outline:none" />'
       + '</div>'
       + '<button class="btn btnSmall" id="promoApply" '+(promoDisabled?'disabled':'')+'>'+(promoWasUsed?'–ò–°–ü–û–õ–¨–ó–û–í–ê–ù':(promoOk?'–ü–†–ò–ú–ï–ù–ò–¢–¨':'–ù–ï –ê–ö–¢–ò–í–ï–ù'))+'</button>'
       + '</div>'
      + '</div>';

    ITEMS.forEach(it=>{
      const showX2 = !!(shopX2Enabled() && it.goldAdd);
      const costLabel = shopCostLabel(it);
      const costSuffix = String(it.cost||'').includes('$') ? '' : (' ' + (it.currency==='MORIN'?'ü¶∑':'ü™ô'));
      html += '<div class="card">'
        + '<div class="row"><div style="min-width:0"><div class="k">'+it.name.toUpperCase()+'</div><div style="font-size:12px;opacity:.75;margin-top:4px">'+it.desc+'</div></div>'
        + '<div style="display:flex; align-items:center; gap:8px;">'
        + (showX2 ? '<div class="badge" style="padding:6px 8px; font-size:11px; color:var(--gold)">x2</div>' : '')
        + '<button class="btn btnSmall" data-buy="'+it.key+'">'+costLabel+costSuffix+'</button>'
        + '</div>'
        + '</div>'
        + '</div>';
    });
    html += '</div>';
    box.innerHTML = html;

    const x2 = $('shopX2Btn');
    if (x2) x2.onclick = ()=>{ state.shopX2 = !state.shopX2; save(); renderShop(); haptic('light'); };

    const pa = $('promoApply');
    if (pa) pa.onclick = ()=>promoApply();
    const pi = $('promoInput');
    if (pi) pi.onkeydown = (e)=>{ try { if ((e && (e.key==='Enter' || e.keyCode===13))) promoApply(); } catch (e2) {} };

    box.querySelectorAll('[data-buy]').forEach(btn=>{
      btn.onclick = ()=>{
        const key = btn.getAttribute('data-buy');
        const it = ITEMS.find(x=>x.key===key);
        if (!it) return;
        if (String(it.cost||'').includes('$')) { toast('–≠—Ç–æ —Ä–µ–∞–ª—å–Ω–∞—è –ø–æ–∫—É–ø–∫–∞ –∑–∞ –¥–µ–Ω—å–≥–∏','lose'); return; }
        const cost = shopCostValue(it.cost);
        if (it.currency==='MORIN'){
          if ((state.morin||0) < cost){ toast('–ù—É–∂–Ω–æ '+shopCostLabel(it)+' –∑–æ–ª–æ—Ç—ã—Ö –∑—É–±–æ–≤','lose'); return; }
          state.morin -= cost;
          if (it.goldAdd){
            const add = (parseInt(it.goldAdd||0,10)||0) * (shopX2Enabled() ? 2 : 1);
            state.gold += add;
            feedAdd('–ü–æ–∫—É–ø–∫–∞ –∑–æ–ª–æ—Ç–∞: +'+add+' ü™ô','SHOP');
            toast('+'+add+' ü™ô','win');
          } else if (typeof it.apply==='function'){
            it.apply();
            feedAdd('–ü–æ–∫—É–ø–∫–∞: '+it.name,'SHOP');
          }
        } else {
          if ((state.gold||0) < cost){ toast('–ù—É–∂–Ω–æ '+shopCostLabel(it)+' ü™ô','lose'); return; }
          state.gold -= cost;
          if (typeof it.apply==='function') it.apply();
        }
        save();
        renderAll();
        haptic('light');
      };
    });
  }

  // --- Bosses (simple)
  const BOSS_KEY_CHAIN = [
    { key:'pass', name:'–ü—Ä–æ–ø—É—Å–∫', emoji:'üéüÔ∏è', price: 10 },
    { key:'key', name:'–ö–ª—é—á', emoji:'üóùÔ∏è', price: 20 },
    { key:'sigil', name:'–ü–µ—á–∞—Ç—å', emoji:'üî∞', price: 35 },
    { key:'gem', name:'–ö–∞–º–µ–Ω—å', emoji:'üí†', price: 55 },
    { key:'rune', name:'–†—É–Ω–∞', emoji:'üî∑', price: 80 },
    { key:'claw', name:'–ö–æ–≥–æ—Ç—å', emoji:'ü¶¥', price: 110 },
    { key:'mask', name:'–ú–∞—Å–∫–∞', emoji:'üé≠', price: 150 },
    { key:'crown', name:'–ö–æ—Ä–æ–Ω–∞', emoji:'üëë', price: 200 },
    { key:'hour', name:'–ü–µ—Å–æ–∫', emoji:'‚åõ', price: 260 },
    { key:'star', name:'–ó–≤–µ–∑–¥–∞', emoji:'‚≠ê', price: 340 }
  ];

  function bossReq(id){
    if (id<=1) return null;
    const idx = id-2;
    const it = BOSS_KEY_CHAIN[idx] || null;
    if (!it) return null;
    return { itemKey: it.key, itemName: it.name, emoji: it.emoji, need: 3, price: it.price };
  }

  function bossRingStrikePrice(bossId){
    const id = parseInt(bossId||0,10)||0;
    if (id<=0) return 0;
    return id * 10;
  }
  function bossKeyCount(itemKey){
    const v = parseInt(state.bosses.keys[String(itemKey)]||0,10);
    return isNaN(v) || v<0 ? 0 : v;
  }
  function bossKeyAdd(itemKey, n){
    state.bosses.keys[String(itemKey)] = bossKeyCount(itemKey) + (parseInt(n||0,10)||0);
  }

  function utcDayKey(){
    try { return new Date().toISOString().slice(0,10); } catch (e) { return '1970-01-01'; }
  }
  function bossDailyEnsure(){
    if (!state.bosses.daily) state.bosses.daily = { day:'', counts:{} };
    if (!state.bosses.daily.counts) state.bosses.daily.counts = {};
    const k = utcDayKey();
    if (state.bosses.daily.day !== k){
      state.bosses.daily.day = k;
      state.bosses.daily.counts = {};
    }
  }
  function bossDailyCount(bossId){
    bossDailyEnsure();
    const v = parseInt(state.bosses.daily.counts[String(bossId)]||0,10);
    return isNaN(v) || v<0 ? 0 : v;
  }
  function bossDailyLeft(bossId){
    return Math.max(0, 10 - bossDailyCount(bossId));
  }
  function bossDailyCanStart(bossId){
    return bossDailyCount(bossId) < 10;
  }
  function bossDailyInc(bossId){
    bossDailyEnsure();
    const k = String(bossId);
    state.bosses.daily.counts[k] = bossDailyCount(bossId) + 1;
  }
  function bossHasAccess(id){
    const req = bossReq(id);
    if (!req) return true;
    return bossKeyCount(req.itemKey) >= req.need;
  }

  function bfGetFight(id){
    const k = String(id);
    return (state.bosses.fights && state.bosses.fights[k]) ? state.bosses.fights[k] : null;
  }
  function bfSetFight(id, obj){
    state.bosses.fights[String(id)] = obj;
  }
  function bfEnsureFight(id){
    const b = BOSSES.find(x=>x.id===id);
    if (!b) return null;
    let f = bfGetFight(id);
    const expiresIn = 8*60*60*1000;
    const storedHp = bossHp(id);
    if ((storedHp<=0) && b.maxHP>0) return null;
    const startHp = storedHp;
    if (f && (parseInt(f.hp||0,10)||0) <= 0) {
      try { delete state.bosses.fights[String(id)]; } catch (e) {}
      f = null;
    }
    if (!f || !f.startTs || !f.expiresTs || now() > f.expiresTs || f.bossMaxHP !== b.maxHP){
      f = { startTs: now(), expiresTs: now() + expiresIn, bossMaxHP: b.maxHP, hp: startHp, freeUsed:false, friendCap:{}, lastFriendTs: now(), dmgLog:[], dmgTop:{} };
      bfSetFight(id, f);
    }
    return f;
  }

  function bfLogPush(bossId, who, dmg){
    const k = String(bossId);
    if (!Array.isArray(state.bosses.dmgLog[k])) state.bosses.dmgLog[k] = [];
    state.bosses.dmgLog[k].unshift({ who: String(who||'‚Äî'), dmg: Math.max(0, Math.floor(dmg||0)), ts: now() });
    if (state.bosses.dmgLog[k].length > 25) state.bosses.dmgLog[k] = state.bosses.dmgLog[k].slice(0,25);

    // per-fight log (only for this boss attempt)
    try {
      const f = bfGetFight(bossId);
      if (f){
        if (!Array.isArray(f.dmgLog)) f.dmgLog = [];
        f.dmgLog.unshift({ who: String(who||'‚Äî'), dmg: Math.max(0, Math.floor(dmg||0)), ts: now() });
        if (f.dmgLog.length > 25) f.dmgLog = f.dmgLog.slice(0,25);
        bfSetFight(bossId, f);
      }
    } catch (e) {}
  }
  function bfTopAdd(bossId, who, dmg){
    const k = String(bossId);
    if (!state.bosses.dmgTop[k]) state.bosses.dmgTop[k] = {};
    const key = String(who||'‚Äî');
    const cur = parseInt(state.bosses.dmgTop[k][key]||0,10)||0;
    state.bosses.dmgTop[k][key] = cur + (parseInt(dmg||0,10)||0);

    // per-fight top (only for this boss attempt)
    try {
      const f = bfGetFight(bossId);
      if (f){
        if (!f.dmgTop) f.dmgTop = {};
        const cur2 = parseInt(f.dmgTop[key]||0,10)||0;
        f.dmgTop[key] = cur2 + (parseInt(dmg||0,10)||0);
        bfSetFight(bossId, f);
      }
    } catch (e) {}
  }

  function bfFriendTick(bossId){
    const b = BOSSES.find(x=>x.id===bossId);
    if (!b) return;
    const f = bfGetFight(bossId);
    if (!f) return;
    const step = 1000;
    const diff = Math.max(0, now() - (parseInt(f.lastFriendTs||0,10)||now()));
    const turns = Math.min(30, Math.floor(diff/step));
    if (turns<=0) return;
    f.lastFriendTs = (parseInt(f.lastFriendTs||0,10)||now()) + turns*step;

    const lvl = clamp(parseInt(state.friendHelpLvl||0,10)||0, 0, 10);
    const capPct = 0.10 + lvl*0.01;
    const capPerFriend = Math.floor(b.maxHP * capPct);
    const friends = Array.isArray(state.friends) ? state.friends : [];
    for (let t=0;t<turns;t++){
      friends.forEach(fr=>{
        const nm = fr && fr.name ? String(fr.name) : 'FRIEND';
        const used = parseInt((f.friendCap && f.friendCap[nm])||0,10)||0;
        if (used >= capPerFriend) return;
        if (!fr || !fr.online) return;
        const maxDmg = Math.max(1, Math.floor(b.maxHP*0.01));
        const friendDmg = 1 + Math.floor(Math.random()*maxDmg);
        const remain = Math.max(0, capPerFriend - used);
        const add = Math.min(friendDmg, remain);
        if (add<=0) return;
        f.friendCap[nm] = used + add;
        f.hp = Math.max(0, (parseInt(f.hp||0,10)||0) - add);
        bfLogPush(bossId, nm, add);
        bfTopAdd(bossId, nm, add);
      });
    }

    bfSetFight(bossId, f);
  }

  function bfRender(bossId){
    const b = BOSSES.find(x=>x.id===bossId);
    if (!b) return;
    const f = bfEnsureFight(bossId);
    if (!f) { toast('–ë–æ—Å—Å –ø–æ–≤–µ—Ä–∂–µ–Ω. –ó–∞–±–µ—Ä–∏ –Ω–∞–≥—Ä–∞–¥—É.','lose'); return; }

    function bossGymTotal(){
      try {
        if (!Array.isArray(GYM_STATS)) return 0;
        let sum = 0;
        GYM_STATS.forEach(s=>{ sum += (gymVal(s.key)||0); });
        return Math.max(0, Math.floor(sum));
      } catch (e) { return 0; }
    }
    function bossHitDmg(div, base){
      const tot = bossGymTotal();
      const stat = Math.max(0, Math.floor(tot / Math.max(1, (parseInt(div||1,10)||1))));
      const raw = Math.max(1, (parseInt(base||0,10)||0) + stat);
      return raw;
    }

    bfFriendTick(bossId);

    // friends could finish the boss between renders
    try {
      const ff2 = bfGetFight(bossId);
      if (ff2 && (parseInt(ff2.hp||0,10)||0) <= 0) {
        bfCheckWin(bossId);
        return;
      }
    } catch (e) {}

    $('bfEmoji').textContent = b.emoji;
    $('bfName').textContent = b.name;
    $('bfHp').textContent = 'HP ' + (parseInt(f.hp||0,10)||0) + ' / ' + b.maxHP;
    const left = Math.max(0, (parseInt(f.expiresTs||0,10)||0) - now());
    $('bfTimer').textContent = left>0 ? ('–í–†–ï–ú–Ø: ' + fmtHHMMSS(left)) : '–í–†–ï–ú–Ø: 00:00:00';
    const hs = state.bosses.hitStocks || { kick:0, knuckle:0, enema:0 };
    const hk = parseInt(hs.kick||0,10)||0;
    const hn = parseInt(hs.knuckle||0,10)||0;
    const he = parseInt(hs.enema||0,10)||0;
    $('bfHits').textContent = '–£–î–ê–†–´ ' + String(hk+hn+he);

    try {
      const q = clamp(parseInt(state.bosses.hitUseQty||1,10)||1, 1, 1000);
      const box = $('bfHitQty');
      if (box){
        const opts = [1,10,100,1000];
        box.innerHTML = opts.map(n=>{
          const a = (n===q) ? '1' : '.7';
          return '<button class="btn btnMini" data-bf-hitqty="'+n+'" style="opacity:'+a+'">x'+n+'</button>';
        }).join('');
        box.querySelectorAll('[data-bf-hitqty]').forEach(bb=>{
          bb.onclick = ()=>{
            const n = parseInt(bb.getAttribute('data-bf-hitqty')||'1',10)||1;
            state.bosses.hitUseQty = clamp(n, 1, 1000);
            save();
            bfRender(bossId);
            haptic('light');
          };
        });
      }
    } catch (e) {}

    const freeBtn = $('bfFreeHit');
    const hitBtn1 = $('bfHit1');
    const hitBtn2 = $('bfHit2');
    const hitBtn3 = $('bfHit3');
    const alive = (parseInt(f.hp||0,10)||0) > 0;
    const inTime = left > 0;
    freeBtn.disabled = (!alive || !inTime || !!f.freeUsed);
    freeBtn.style.opacity = freeBtn.disabled ? '.6' : '1';
    const useQ = clamp(parseInt(state.bosses.hitUseQty||1,10)||1, 1, 1000);
    hitBtn1.disabled = (!alive || !inTime || hk<useQ);
    hitBtn2.disabled = (!alive || !inTime || hn<useQ);
    hitBtn3.disabled = (!alive || !inTime || he<useQ);
    hitBtn1.style.opacity = hitBtn1.disabled ? '.6' : '1';
    hitBtn2.style.opacity = hitBtn2.disabled ? '.6' : '1';
    hitBtn3.style.opacity = hitBtn3.disabled ? '.6' : '1';

    try {
      const q2 = clamp(parseInt(state.bosses.hitUseQty||1,10)||1, 1, 1000);
      hitBtn1.textContent = '–ù–û–ì–û–ô ('+hk+') x'+q2;
      hitBtn2.textContent = '–ö–û–°–¢–ï–¢–û–ú ('+hn+') x'+q2;
      hitBtn3.textContent = '–ö–õ–ò–ó–ú–û–ô ('+he+') x'+q2;
    } catch (e) {}

    if (!inTime && alive){
      $('bfHint').textContent = '–í—Ä–µ–º—è –≤—ã—à–ª–æ ‚Äî –ø–æ–ø—ã—Ç–∫–∞ –ø—Ä–æ–∏–≥—Ä–∞–Ω–∞.';
      bfCheckLose(bossId);
    } else if (!alive){
      $('bfHint').textContent = '–ë–æ—Å—Å –ø–æ–≤–µ—Ä–∂–µ–Ω!';
    } else {
      $('bfHint').textContent = '';
    }

    const openShop = $('bfShopOpen');
    if (openShop) {
      openShop.onclick = ()=>{ showModal('mBfShop'); bfShopRender(); haptic('light'); };
    }

    freeBtn.onclick = ()=>{
      const ff = bfGetFight(bossId);
      if (!ff) return;
      const left2 = Math.max(0, (parseInt(ff.expiresTs||0,10)||0) - now());
      if (left2<=0 || (parseInt(ff.hp||0,10)||0)<=0 || ff.freeUsed) return;
      ff.freeUsed = true;
      ff.lastFriendTs = now();
      const dmg = bossHitDmg(14, 50);
      const real = Math.min(parseInt(ff.hp||0,10)||0, dmg);
      ff.hp = Math.max(0, (parseInt(ff.hp||0,10)||0) - real);
      bfSetFight(bossId, ff);
      bfLogPush(bossId, state.playerName||'PLAYER', real);
      bfTopAdd(bossId, state.playerName||'PLAYER', real);
      bfCheckWin(bossId);
      save();
      if ((parseInt(ff.hp||0,10)||0) > 0) bfRender(bossId);
      renderAll();
      haptic('light');
    };

    function doTokenHit(kind){
      const ff = bfGetFight(bossId);
      if (!ff) return;
      const left2 = Math.max(0, (parseInt(ff.expiresTs||0,10)||0) - now());
      if (left2<=0 || (parseInt(ff.hp||0,10)||0)<=0) return;
      const hs2 = state.bosses.hitStocks || { kick:0, knuckle:0, enema:0 };
      const q = clamp(parseInt(state.bosses.hitUseQty||1,10)||1, 1, 1000);
      if (kind==='kick'){
        if ((hs2.kick||0) < q){ toast('–ù—É–∂–Ω–æ –∫—É–ø–∏—Ç—å –ø–∏–Ω–∫–∏','lose'); return; }
        hs2.kick -= q;
      } else if (kind==='knuckle'){
        if ((hs2.knuckle||0) < q){ toast('–ù—É–∂–Ω–æ –∫—É–ø–∏—Ç—å –∫–æ—Å—Ç–µ—Ç—ã','lose'); return; }
        hs2.knuckle -= q;
      } else if (kind==='enema'){
        if ((hs2.enema||0) < q){ toast('–ù—É–∂–Ω–æ –∫—É–ø–∏—Ç—å –∫–ª–∏–∑–º—ã','lose'); return; }
        hs2.enema -= q;
      } else {
        toast('–ù—É–∂–Ω–æ –∫—É–ø–∏—Ç—å —É–¥–∞—Ä—ã','lose');
        return;
      }
      state.bosses.hitStocks = hs2;
      ff.lastFriendTs = now();
      const one = (kind==='kick') ? bossHitDmg(10, 70) : ((kind==='knuckle') ? bossHitDmg(7, 85) : bossHitDmg(4, 100));
      const dmg = Math.max(1, one) * q;
      const real = Math.min(parseInt(ff.hp||0,10)||0, dmg);
      ff.hp = Math.max(0, (parseInt(ff.hp||0,10)||0) - real);
      bfSetFight(bossId, ff);
      bfLogPush(bossId, state.playerName||'PLAYER', real);
      bfTopAdd(bossId, state.playerName||'PLAYER', real);
      bfCheckWin(bossId);
      save();
      if ((parseInt(ff.hp||0,10)||0) > 0) bfRender(bossId);
      renderAll();
      haptic('light');
    }

    hitBtn1.onclick = ()=>doTokenHit('kick');
    hitBtn2.onclick = ()=>doTokenHit('knuckle');
    hitBtn3.onclick = ()=>doTokenHit('enema');

    const log = $('bfLog');
    const fLog = f && Array.isArray(f.dmgLog) ? f.dmgLog : null;
    const logArr = fLog ? fLog : (Array.isArray(state.bosses.dmgLog[String(bossId)]) ? state.bosses.dmgLog[String(bossId)] : []);
    log.innerHTML = logArr.length ? logArr.map(e=>{
      return '<div class="row"><div style="min-width:0; font-size:12px; opacity:.9">'+String(e.who)+'</div><div class="badge" style="padding:6px 8px; font-size:11px">'+String(e.dmg)+'</div></div>';
    }).join('') : '<div style="opacity:.75; font-size:12px">‚Äî</div>';

    const top = $('bfTop');
    const topObj = (f && f.dmgTop) ? f.dmgTop : (state.bosses.dmgTop[String(bossId)] || {});
    const rows = Object.keys(topObj).map(k=>({ who:k, dmg: parseInt(topObj[k]||0,10)||0 })).sort((a,b)=>b.dmg-a.dmg).slice(0,12);
    top.innerHTML = rows.length ? rows.map((r,i)=>{
      return '<div class="row"><div style="min-width:0; font-size:12px; opacity:.9">#'+(i+1)+' '+r.who+'</div><div class="badge" style="padding:6px 8px; font-size:11px">'+r.dmg+'</div></div>';
    }).join('') : '<div style="opacity:.75; font-size:12px">‚Äî</div>';
  }

  function bfShopRender(){
    try {
      $('bfShopGold').textContent = String(state.gold||0) + ' ü™ô';
    } catch (e) {}

    try {
      const q = clamp(parseInt(state.bosses.shopQty||1,10)||1, 1, 1000);
      const box = $('bfShopQty');
      if (box){
        const opts = [1,10,100,1000];
        box.innerHTML = opts.map(n=>{
          const a = (n===q) ? '1' : '.7';
          return '<button class="btn btnMini" data-bf-qty="'+n+'" style="opacity:'+a+'">x'+n+'</button>';
        }).join('');
        box.querySelectorAll('[data-bf-qty]').forEach(b=>{
          b.onclick = ()=>{
            const n = parseInt(b.getAttribute('data-bf-qty')||'1',10)||1;
            state.bosses.shopQty = clamp(n, 1, 1000);
            save();
            bfShopRender();
            haptic('light');
          };
        });
      }
    } catch (e) {}
  }
  function bfShopBuy(kind, price){
    const p = parseInt(price||0,10)||0;
    if (p<=0) return;
    const q = clamp(parseInt(state.bosses.shopQty||1,10)||1, 1, 1000);
    const total = p * q;
    if ((state.gold||0) < total){ toast('–ù—É–∂–Ω–æ '+total+' ü™ô','lose'); return; }
    state.gold -= total;
    if (!state.bosses.hitStocks) state.bosses.hitStocks = { kick:0, knuckle:0, enema:0 };
    if (kind==='kick') state.bosses.hitStocks.kick = clamp((parseInt(state.bosses.hitStocks.kick||0,10)||0) + q, 0, 999999);
    if (kind==='knuckle') state.bosses.hitStocks.knuckle = clamp((parseInt(state.bosses.hitStocks.knuckle||0,10)||0) + q, 0, 999999);
    if (kind==='enema') state.bosses.hitStocks.enema = clamp((parseInt(state.bosses.hitStocks.enema||0,10)||0) + q, 0, 999999);
    toast('–ö—É–ø–ª–µ–Ω–æ: +'+q,'win');
    save();
    bfShopRender();
    const bid = parseInt(state.bosses && state.bosses.activeFightId || 0, 10) || 0;
    if (bid) bfRender(bid);
    renderAll();
  }

  function bfShowResult(bossId, win){
    const b = BOSSES.find(x=>x.id===bossId);
    if (!b) return;
    $('bfrEmoji').textContent = b.emoji;
    $('bfrName').textContent = b.name;
    $('bfrTitle').textContent = win ? '–ë–û–°–° –ü–û–í–ï–†–ñ–ï–ù' : '–ü–û–†–ê–ñ–ï–ù–ò–ï';
    $('bfrOutcome').textContent = win ? '–ë–û–°–° –ü–û–í–ï–†–ñ–ï–ù' : '–ü–û–†–ê–ñ–ï–ù–ò–ï';
    $('bfrOutcome').style.color = win ? 'rgba(52,211,153,.95)' : 'rgba(251,113,133,.95)';

    const rewardCard = $('bfrRewardCard');
    const reward = $('bfrReward');
    const claimBtn = $('bfrClaim');
    if (rewardCard) rewardCard.style.display = win ? 'block' : 'none';
    if (claimBtn){
      claimBtn.style.display = win ? '' : 'none';
      claimBtn.disabled = !win;
      claimBtn.style.opacity = win ? '1' : '.6';
    }

    if (win && reward){
      const pr = state.bosses && state.bosses.pendingReward ? state.bosses.pendingReward : null;
      const rxp = pr ? (parseInt(pr.xp||0,10)||0) : (parseInt(b.reward && b.reward.xp || 0, 10) || 0);
      const rm = pr ? (parseInt(pr.morin||0,10)||0) : (parseInt(b.reward && b.reward.morin || 0, 10) || 0);
      const rg = pr ? (parseInt(pr.gold||0,10)||0) : (parseInt(b.reward && b.reward.gold || 0, 10) || 0);
      let html = '';
      if (rm>0) html += '<div class="row"><div style="min-width:0">+'+rm+' –∑–æ–ª–æ—Ç—ã—Ö –∑—É–±–æ–≤</div><div class="badge" style="padding:6px 8px; font-size:11px; color:var(--morin)">+'+rm+' ü¶∑</div></div>';
      if (rg>0) html += '<div class="row"><div style="min-width:0">+'+rg+' –∑–æ–ª–æ—Ç–∞</div><div class="badge" style="padding:6px 8px; font-size:11px; color:var(--gold)">+'+rg+' ü™ô</div></div>';
      if (rxp>0) html += '<div class="row"><div style="min-width:0">+'+rxp+' XP</div><div class="badge" style="padding:6px 8px; font-size:11px">+'+rxp+' XP</div></div>';
      reward.innerHTML = html || '<div style="opacity:.75; font-size:12px">‚Äî</div>';
    }

    const topL = $('bfrTopL');
    const topR = $('bfrTopR');
    const topObj = state.bosses.dmgTop[String(bossId)] || {};
    const rows = Object.keys(topObj).map(k=>({ who:k, dmg: parseInt(topObj[k]||0,10)||0 })).sort((a,c)=>c.dmg-a.dmg).slice(0,10);
    const leftRows = rows.slice(0,5);
    const rightRows = rows.slice(5,10);
    if (topL){
      topL.innerHTML = leftRows.length ? leftRows.map((r,i)=>{
        return '<div class="row"><div style="min-width:0; font-size:12px; opacity:.9">#'+(i+1)+' '+r.who+'</div><div class="badge" style="padding:6px 8px; font-size:11px">'+r.dmg+'</div></div>';
      }).join('') : '<div style="opacity:.75; font-size:12px">‚Äî</div>';
    }
    if (topR){
      topR.innerHTML = rightRows.length ? rightRows.map((r,i)=>{
        return '<div class="row"><div style="min-width:0; font-size:12px; opacity:.9">#'+(i+6)+' '+r.who+'</div><div class="badge" style="padding:6px 8px; font-size:11px">'+r.dmg+'</div></div>';
      }).join('') : '<div style="opacity:.75; font-size:12px">‚Äî</div>';
    }

    // close fight UI so it doesn't remain stuck with 0 HP
    try { hideModal('mBfShop'); } catch (e) {}
    try { hideModal('mBossFight'); } catch (e) {}

    try { renderAll(); } catch (e) {}
    showModal('mBossFightRes');

    if (claimBtn){
      claimBtn.onclick = ()=>{
        const pr = state.bosses && state.bosses.pendingReward ? state.bosses.pendingReward : null;
        if (!pr || (parseInt(pr.bossId||0,10)||0) !== bossId){
          hideModal('mBossFightRes');
          openScreen('mBoss');
          renderBosses();
          haptic('light');
          return;
        }
        const rxp = parseInt(pr.xp||0,10)||0;
        const rm = parseInt(pr.morin||0,10)||0;
        const rg = parseInt(pr.gold||0,10)||0;
        if (rm>0) state.morin += rm;
        if (rg>0) state.gold += rg;
        if (rxp>0) addXp(rxp);
        state.bosses.pendingReward = null;

        try {
          const b2 = BOSSES.find(x=>x.id===bossId);
          if (b2) setBossHp(bossId, b2.maxHP);
        } catch (e) {}

        save();
        hideModal('mBossFightRes');
        openScreen('mBoss');
        renderBosses();
        renderAll();
        haptic('heavy');
      };
    }
  }

  function bfCheckWin(bossId){
    const b = BOSSES.find(x=>x.id===bossId);
    if (!b) return;
    const f = bfGetFight(bossId);
    if (!f) return;
    const left = Math.max(0, (parseInt(f.expiresTs||0,10)||0) - now());
    if (left<=0) return;
    if ((parseInt(f.hp||0,10)||0) > 0) return;
    const attemptKey = String(bossId) + ':' + String(parseInt(f.startTs||0,10)||0);
    if (String(state.bosses._resShownWinKey||'') === attemptKey) return;
    state.bosses._resShownWinKey = attemptKey;

    setBossHp(bossId, 0);

    const rxp = parseInt(b.reward && b.reward.xp || 0, 10) || 0;
    const rm = parseInt(b.reward && b.reward.morin || 0, 10) || 0;
    const rg = parseInt(b.reward && b.reward.gold || 0, 10) || 0;
    state.bosses.pendingReward = { bossId: bossId, xp: rxp, morin: rm, gold: rg };
    state.bosses.lastWinners[String(bossId)] = { name: (state.playerName||'PLAYER'), ts: now() };

    const nextReq = bossReq(bossId+1);
    if (nextReq){
      bossKeyAdd(nextReq.itemKey, nextReq.need);
      feedAdd('–î–æ–±—ã—Ç–æ: '+nextReq.need+'√ó '+nextReq.emoji+' '+nextReq.itemName, 'BOSS');
    }

    feedAdd('–ë–æ—Å—Å –ø–æ–≤–µ—Ä–∂–µ–Ω! –ù–∞–≥—Ä–∞–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞.', 'BOSS');
    toast('–ë–û–°–° –ü–û–í–ï–†–ñ–ï–ù','win');
    haptic('heavy');

    bfShowResult(bossId, true);

    // stop forcing the boss fight modal after victory
    state.bosses.activeFightId = 0;

    // allow immediate new attempt
    try {
      if (state.bosses && state.bosses.fights) delete state.bosses.fights[String(bossId)];
    } catch (e) {}
  }

  function bfCheckLose(bossId){
    const b = BOSSES.find(x=>x.id===bossId);
    if (!b) return;
    const f = bfGetFight(bossId);
    if (!f) return;
    if ((parseInt(f.hp||0,10)||0) <= 0) return;
    const left = Math.max(0, (parseInt(f.expiresTs||0,10)||0) - now());
    if (left>0) return;
    if (parseInt(state.bosses._resShownLose||0,10) === bossId) return;
    state.bosses._resShownLose = bossId;
    state.bosses.activeFightId = 0;
    toast('–ü–û–†–ê–ñ–ï–ù–ò–ï','lose');

    // allow immediate new attempt (update state BEFORE showing result so UI refreshes instantly)
    setBossHp(bossId, b.maxHP);
    try {
      if (state.bosses && state.bosses.fights) delete state.bosses.fights[String(bossId)];
    } catch (e) {}

    bfShowResult(bossId, false);
  }

  function renderBossAttackModal(selectedId){
    state.bosses.pendingAttackId = selectedId;
    const b = BOSSES.find(x=>x.id===selectedId);
    $('baBossName').textContent = b ? b.name : '‚Äî';

    const req = bossReq(selectedId);
    let accessText = '–ë–ï–°–ü–õ–ê–¢–ù–û';
    let canGo = true;
    if (req){
      const have = bossKeyCount(req.itemKey);
      accessText = req.emoji+' '+req.itemName+': '+have+' / '+req.need;
      canGo = have >= req.need;
    }
    $('baAccess').textContent = accessText;
    const goBtn = $('baGo');
    const ringBtn = $('baBuyRing');
    const leftDaily = bossDailyLeft(selectedId);
    const canByDaily = leftDaily > 0;
    $('baAccess').textContent = accessText + ' ¬∑ –ë–æ–∏ —Å–µ–≥–æ–¥–Ω—è: ' + (10-leftDaily) + '/10';
    goBtn.disabled = (!canGo || !canByDaily);
    goBtn.style.opacity = (canGo && canByDaily) ? '1' : '.6';

    if (ringBtn){
      const priceR = bossRingStrikePrice(selectedId);
      const haveR = parseInt(state.rings||0,10)||0;
      ringBtn.disabled = (priceR<=0 || haveR < priceR);
      ringBtn.style.opacity = ringBtn.disabled ? '.55' : '1';
      ringBtn.title = '–ö—É–ø–∏—Ç—å 1 –∞—Ç–∞–∫—É: '+priceR+' üíç';
      ringBtn.onclick = ()=>{
        const id = parseInt(state.bosses.pendingAttackId||selectedId||0,10)||0;
        const priceR2 = bossRingStrikePrice(id);
        if (priceR2<=0) return;
        if ((parseInt(state.rings||0,10)||0) < priceR2){ toast('–ù—É–∂–Ω–æ '+priceR2+' üíç','lose'); return; }

        // validate boss access but IGNORE daily limit
        if (!id) return;
        if ((parseInt(bossHp(id)||0,10)||0) <= 0) { toast('–ë–æ—Å—Å –ø–æ–≤–µ—Ä–∂–µ–Ω. –ó–∞–±–µ—Ä–∏ –Ω–∞–≥—Ä–∞–¥—É.','lose'); return; }
        if (!bossHasAccess(id)) { toast('–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –∫–ª—é—á–µ–π','lose'); return; }

        state.rings -= priceR2;
        state.bosses.strikes = clamp((parseInt(state.bosses.strikes||0,10)||0) + 1, 0, 99);
        toast('+1 –∞—Ç–∞–∫–∞','win');
        save();

        // enter boss fight immediately, bypassing bossDailyCanStart/bossDailyInc
        state.bosses.pendingAttackId = id;
        hideModal('mBossAttack');
        hideModal('mBoss');
        showModal('mBossFight');
        state.bosses.activeFightId = id;
        bfEnsureFight(id);
        bfRender(id);
        save();

        renderBosses();
        renderHUD();
        haptic('light');
      };
    }

    const table = $('baTable');
    let html = '';
    BOSSES.forEach(bb=>{
      if (bb.id<=1) return;
      const r = bossReq(bb.id);
      if (!r) return;
      const have = bossKeyCount(r.itemKey);
      const price = r.price;
      html += '<div class="row" style="align-items:flex-start">'
        + '<div style="min-width:0">'
        + '<div class="k">–ë–û–°–° '+bb.id+'</div>'
        + '<div style="margin-top:4px; font-size:12px; opacity:.8; line-height:1.25">'+r.emoji+' '+r.itemName+': <b style="letter-spacing:1px">'+have+'</b> / '+r.need+'<br>–¶–µ–Ω–∞ –∑–∞ 1: <span style="color:var(--gold); font-weight:900">'+price+' ü™ô</span></div>'
        + '</div>'
        + '<button class="btn btnSmall" data-key-buy="'+r.itemKey+'" data-key-price="'+price+'">–ö–£–ü–ò–¢–¨</button>'
        + '</div>';
    });
    table.innerHTML = html;

    table.querySelectorAll('[data-key-buy]').forEach(btn=>{
      btn.onclick = ()=>{
        const k = btn.getAttribute('data-key-buy');
        const price = parseInt(btn.getAttribute('data-key-price')||'0',10)||0;
        if ((state.gold||0) < price){ toast('–ù—É–∂–Ω–æ '+price+' ü™ô','lose'); return; }
        state.gold -= price;
        bossKeyAdd(k, 1);
        toast('+1','win');
        save();
        renderBossAttackModal(state.bosses.pendingAttackId||selectedId);
        renderAll();
      };
    });

    goBtn.onclick = ()=>{
      if (!canGo) return;
      const id = parseInt(state.bosses.pendingAttackId||0,10)||0;
      if (!id) return;
      if (!bossHasAccess(id)) { toast('–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –∫–ª—é—á–µ–π','lose'); return; }
      if (!bossDailyCanStart(id)) { toast('–õ–∏–º–∏—Ç –±–æ—ë–≤ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è: 10/10','lose'); return; }

      bossDailyInc(id);
      const rr = bossReq(id);
      if (rr){
        const have = bossKeyCount(rr.itemKey);
        state.bosses.keys[String(rr.itemKey)] = Math.max(0, have - rr.need);
      }
      hideModal('mBossAttack');
      hideModal('mBoss');
      showModal('mBossFight');
      state.bosses.activeFightId = id;
      bfEnsureFight(id);
      bfRender(id);
      save();
    };
  }

  function doBossAttack(id){
    if ((state.bosses.strikes||0) <= 0){ toast('–ù–µ—Ç —É–¥–∞—Ä–æ–≤. –í–µ—Ä–Ω—É—Ç—Å—è –ø–æ–∑–∂–µ.','lose'); return; }
    state.bosses.strikes -= 1;
    const b = BOSSES.find(x=>x.id===id);
    if (!b) return;
    let tot = 0;
    try { if (Array.isArray(GYM_STATS)) GYM_STATS.forEach(s=>{ tot += (gymVal(s.key)||0); }); } catch (e) {}
    const stat = Math.max(0, Math.floor(Math.max(0, Math.floor(tot)) / 14));
    const raw = Math.max(1, 50 + stat);
    const dmg = raw;
    const hp = bossHp(id);
    const nh = Math.max(0, hp - dmg);
    setBossHp(id, nh);
    feedAdd('–¢—ã —É–¥–∞—Ä–∏–ª –±–æ—Å—Å–∞: '+b.name+' -'+dmg, 'BOSS');
    if (nh<=0){
      setBossHp(id, 0);

      const rxp = parseInt(b.reward && b.reward.xp || 0, 10) || 0;
      const rm = parseInt(b.reward && b.reward.morin || 0, 10) || 0;
      const rg = parseInt(b.reward && b.reward.gold || 0, 10) || 0;
      state.bosses.pendingReward = { bossId: id, xp: rxp, morin: rm, gold: rg };
      state.bosses.lastWinners[String(id)] = { name: (state.playerName||'PLAYER'), ts: now() };

      const nextReq = bossReq(id+1);
      if (nextReq){
        bossKeyAdd(nextReq.itemKey, nextReq.need);
        feedAdd('–î–æ–±—ã—Ç–æ: '+nextReq.need+'√ó '+nextReq.emoji+' '+nextReq.itemName, 'BOSS');
      }

      state.bosses.activeFightId = 0;
      try { if (state.bosses && state.bosses.fights) delete state.bosses.fights[String(id)]; } catch (e) {}

      feedAdd('–ë–æ—Å—Å –ø–æ–≤–µ—Ä–∂–µ–Ω! –ù–∞–≥—Ä–∞–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞.', 'BOSS');
      toast('–ë–û–°–° –ü–û–í–ï–†–ñ–ï–ù','win');
      haptic('heavy');
      bfShowResult(id, true);
    } else {
      toast('-'+dmg+' HP','morin');
      haptic('light');
    }
    save();
    renderAll();
  }

  function bossHp(id){
    const b = BOSSES.find(x=>x.id===id);
    const max = b ? b.maxHP : 0;
    const k = String(id);
    const has = !!(state.bosses && state.bosses.hp && Object.prototype.hasOwnProperty.call(state.bosses.hp, k));
    const raw = has ? state.bosses.hp[k] : max;
    const cur = parseInt(raw,10);
    if (isNaN(cur) || cur<0) return max;
    if (max>0 && cur>max){
      setBossHp(id, max);
      return max;
    }
    return cur;
  }
  function setBossHp(id, hp){
    state.bosses.hp[String(id)] = Math.max(0, Math.floor(hp||0));
  }
  function renderBosses(){
    const box = $('bossList');
    let html = '<div style="display:flex; flex-direction:column; gap:10px;">';
    html += '<div class="card">'
      + '<div class="row"><div style="min-width:0"><div class="k">–ù–ê–í–´–ö</div><div style="font-size:12px;opacity:.75;margin-top:4px">–ü–æ–º–æ—â—å –¥—Ä—É–∑–µ–π</div></div>'
      + '<button class="btn btnSmall" id="friendHelpOpen">–ü–û–ú–û–©–¨ –î–†–£–ó–ï–ô</button></div>'
      + '</div>';
    BOSSES.forEach(b=>{
      const hp = bossHp(b.id);
      const pct = b.maxHP>0 ? clamp((hp/b.maxHP)*100,0,100) : 0;
      const lw = (state.bosses && state.bosses.lastWinners && state.bosses.lastWinners[String(b.id)]) || null;
      const lwName = lw && lw.name ? String(lw.name) : '‚Äî';
      const locked = !bossHasAccess(b.id);
      const req = bossReq(b.id);
      const lockText = locked && req ? (' ¬∑ '+req.emoji+' '+bossKeyCount(req.itemKey)+'/'+req.need) : '';
      const rxp = parseInt(b.reward && b.reward.xp || 0, 10) || 0;
      const rm = parseInt(b.reward && b.reward.morin || 0, 10) || 0;
      const rg = parseInt(b.reward && b.reward.gold || 0, 10) || 0;
      const dead = (parseInt(hp||0,10)||0) <= 0;
      const pr = (state.bosses && state.bosses.pendingReward) ? state.bosses.pendingReward : null;
      const hasPending = !!(pr && (parseInt(pr.bossId||0,10)||0) === b.id);
      html += '<div class="card">'
        + '<div class="bossWinnerTop">–ü–û–°–õ–ï–î–ù–ò–ô –ü–û–ë–ï–î–ò–¢–ï–õ–¨</div>'
        + '<div class="bossWinnerNm">'+lwName+'</div>'
        + '<div style="height:10px"></div>'
        + '<div class="bossRow">'
        + '<div class="bossMini">'+b.emoji+'</div>'
        + '<div style="min-width:0">'
        + '<div class="bossName">'+b.name+'</div>'
        + '<div class="bossSub">'+(dead ? ('–ü–û–í–ï–†–ñ–ï–ù ¬∑ HP 0 / '+b.maxHP) : ('HP '+hp+' / '+b.maxHP))+lockText+'</div>'
        + '<div class="bossReward">'
        + (rm>0 ? ('<span class="badge" style="color:var(--morin); padding:6px 8px; font-size:11px">+'+rm+'ü¶∑</span>') : '')
        + (rg>0 ? ('<span class="badge" style="color:var(--gold); padding:6px 8px; font-size:11px">+'+rg+'ü™ô</span>') : '')
        + (rxp>0 ? ('<span class="badge" style="padding:6px 8px; font-size:11px">+'+rxp+' XP</span>') : '')
        + (dead
            ? (hasPending
                ? '<button class="btn btnSmall" data-boss-claim="'+b.id+'">–ó–ê–ë–†–ê–¢–¨ –ù–ê–ì–†–ê–î–£</button>'
                : '<button class="btn btnSmall" data-boss-attack="'+b.id+'" style="opacity:.75" disabled>–ù–ê–ü–ê–°–¢–¨</button>'
              )
            : '<button class="btn btnSmall" data-boss-attack="'+b.id+'" style="opacity:'+(locked?'.75':'1')+'">–ù–ê–ü–ê–°–¢–¨</button>'
          )
        + '</div>'
        + '</div>'
        + '</div>'
        + '</div>';
    });
    html += '</div>';
    box.innerHTML = html;

    const fho = $('friendHelpOpen');
    if (fho) fho.onclick = ()=>{ showModal('mFriendHelp'); renderFriendHelp(); haptic('light'); };

    box.querySelectorAll('[data-boss-attack]').forEach(btn=>{
      btn.onclick = ()=>{
        const id = parseInt(btn.getAttribute('data-boss-attack')||'0',10)||0;
        if (!id) return;
        if ((parseInt(bossHp(id)||0,10)||0) <= 0) { toast('–ë–æ—Å—Å –ø–æ–≤–µ—Ä–∂–µ–Ω. –ó–∞–±–µ—Ä–∏ –Ω–∞–≥—Ä–∞–¥—É.','lose'); return; }
        if (!bossHasAccess(id)) { toast('–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –∫–ª—é—á–µ–π','lose'); return; }
        showModal('mBossAttack');
        renderBossAttackModal(id);
        haptic('light');
      };
    });

    box.querySelectorAll('[data-boss-claim]').forEach(btn=>{
      btn.onclick = ()=>{
        const id = parseInt(btn.getAttribute('data-boss-claim')||'0',10)||0;
        if (!id) return;
        bfShowResult(id, true);
        haptic('light');
      };
    });

    try {
      try {
        const rv = $('bossRingVal');
        if (rv) rv.textContent = String(parseInt(state.rings||0,10)||0);
      } catch (e) {}
      const btn = $('bossToothBtn');
      const tm = $('bossToothTimer');
      if (btn && tm){
        const nextTs = parseInt(state.bosses && state.bosses.toothNextTs || 0, 10) || 0;
        const ready = now() >= nextTs;
        btn.classList.toggle('ready', ready);
        const left = Math.max(0, nextTs - now());
        const mm = String(Math.floor(left/60000)).padStart(2,'0');
        const ss = String(Math.floor((left%60000)/1000)).padStart(2,'0');
        tm.textContent = ready ? '+100' : (mm+':'+ss);
        btn.onclick = ()=>{
          const nextTs2 = parseInt(state.bosses && state.bosses.toothNextTs || 0, 10) || 0;
          if (now() < nextTs2){ toast('–†–∞–Ω–æ. –ü–æ–¥–æ–∂–¥–∏ —Ç–∞–π–º–µ—Ä.','lose'); haptic('light'); return; }
          state.morin += 100;
          state.bosses.toothNextTs = now() + 10*60*1000;
          save();
          renderBosses();
          renderHUD();
          toast('+100 –∑–æ–ª–æ—Ç—ã—Ö –∑—É–±–æ–≤','win');
          haptic('light');
        };
      }
    } catch (e) {}
  }

  function renderDice(){
    const row = $('diceRow');
    row.innerHTML = '';

    const g = state.diceGame || { active:false, rolls:0, max:10, dice:[1,1,1,1,1] };
    const d = Array.isArray(g.dice) && g.dice.length===5 ? g.dice : [1,1,1,1,1];
    for (let i=0;i<5;i++){
      const box = document.createElement('div');
      box.className = 'dieBox';
      box.textContent = String(d[i]||1);
      box.onclick = ()=>diceRerollOne(i);
      row.appendChild(box);
    }

    const btn = $('diceRoll');
    if (btn) btn.textContent = g.active ? '–ó–ê–ë–†–ê–¢–¨' : '–ë–†–û–°–ò–¢–¨';

    const res = $('diceRes');
    if (res) {
      const left = Math.max(0, (parseInt(g.max||10,10)||10) - (parseInt(g.rolls||0,10)||0));
      res.textContent = g.active ? ('–ü–µ—Ä–µ–±—Ä–æ—Å–æ–≤: ' + left + ' / ' + (parseInt(g.max||10,10)||10)) : '‚Äî';
    }
  }

  function diceWeights(){
    return [20,20,20,20,12,8];                                                                     
  }

  function diceFace(){
    const w = diceWeights();
    const sum = w.reduce((a,b)=>a+b,0);
    let r = Math.random() * sum;
    for (let i=0;i<w.length;i++){
      r -= w[i];
      if (r <= 0) return i+1;
    }
    return 6;
  }

  function dicePickComboTarget(){
    const w = [25,35,30,25,10,3,30];
    const sum = w.reduce((a,b)=>a+b,0);
    let r = Math.random() * sum;
    for (let i=0;i<w.length;i++){
      r -= w[i];
      if (r <= 0) return i===6 ? 0 : (i+1);
    }
    return 0;
  }

  function isFiveKind(d){
    if (!Array.isArray(d) || d.length!==5) return false;
    return d[0]===d[1] && d[1]===d[2] && d[2]===d[3] && d[3]===d[4];
  }

  function maxSameCount(d){
    if (!Array.isArray(d) || !d.length) return 0;
    const m = {};
    let best = 0;
    for (let i=0;i<d.length;i++){
      const k = String(d[i]);
      m[k] = (m[k]||0) + 1;
      if (m[k] > best) best = m[k];
    }
    return best;
  }

  function diceRoll5(){
    const out = [ diceFace(), diceFace(), diceFace(), diceFace(), diceFace() ];
    return out;
  }

  function diceStart(){
    if ((state.gold||0) < 1){ toast('–ù—É–∂–Ω–æ 1 ü™ô','lose'); return false; }
    state.gold -= 1;
    state.diceGame.active = true;
    state.diceGame.rolls = 0;
    state.diceGame.max = 10;
    state.diceGame.target = 0;
    state.diceGame.comboTarget = 0;
    state.diceGame.dice = diceRoll5();
    if ((parseInt(state.diceGame.comboTarget||0,10)||0) === 0){
      let guard = 0;
      while ((isFiveKind(state.diceGame.dice) || maxSameCount(state.diceGame.dice) >= 4) && guard<12){
        state.diceGame.dice = diceRoll5();
        guard++;
      }
    }
    save();
    renderDice();
    haptic('light');
    return true;
  }

  function diceRerollOne(i){
    const g = state.diceGame;
    if (!g || !g.active) return;
    const max = parseInt(g.max||10,10)||10;
    const used = parseInt(g.rolls||0,10)||0;
    if (used >= max){ toast('–ü–µ—Ä–µ–±—Ä–æ—Å—ã –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å','lose'); return; }
    if (!Array.isArray(g.dice) || g.dice.length!==5) g.dice = [1,1,1,1,1];
    const tgt = parseInt(g.comboTarget||0,10)||0;
    let v = diceFace();
    g.dice[i] = v;
    if (tgt===0 && isFiveKind(g.dice)){
      g.dice[i] = 1 + Math.floor(Math.random()*5);
      if (g.dice[i] === v) g.dice[i] = 1;
    }
    g.rolls = used + 1;
    save();
    renderDice();
    haptic('light');
  }

  let diceRewardTmr = 0;
  function diceClaim(){
    const g = state.diceGame;
    if (!g || !g.active) return;
    const beforeDice = Array.isArray(g.dice) ? g.dice.slice(0,5) : [1,1,1,1,1];
    const counts = {};
    for (let i=0;i<beforeDice.length;i++){
      const v = parseInt(beforeDice[i]||0,10)||0;
      if (!v) continue;
      const k = String(v);
      counts[k] = (counts[k]||0) + 1;
    }
    let fourFace = 0;
    let was4x = false;
    for (let f=1; f<=6; f++){
      const c = counts[String(f)]||0;
      if (c>=4){ was4x = true; fourFace = f; break; }
    }
    const was5x = (fourFace>0) ? ((counts[String(fourFace)]||0)===5) : false;
    const face = fourFace;

    g.active = false;
    g.rolls = 0;
    g.dice = [1,1,1,1,1];
    g.target = 0;
    g.comboTarget = 0;

    let rewardText = '50 ü¶∑';
    if (!was4x){
      state.morin += 50;
    } else {
      if (was5x) state.gold += 20;
      if (face===1){
        state.rings = (parseInt(state.rings||0,10)||0) + 15;
        rewardText = '15 üíç –ö–æ–∑—ã—Ä–Ω—ã—Ö –∫–æ–ª–µ—Ü';
      } else if (face===2){
        if (!state.bosses.hitStocks) state.bosses.hitStocks = { kick:0, knuckle:0, enema:0 };
        state.bosses.hitStocks.kick = clamp((parseInt(state.bosses.hitStocks.kick||0,10)||0) + 1, 0, 999999);
        rewardText = '1 –£–¥–∞—Ä –Ω–æ–≥–æ–π';
      } else if (face===3){
        if (!state.bosses.hitStocks) state.bosses.hitStocks = { kick:0, knuckle:0, enema:0 };
        state.bosses.hitStocks.knuckle = clamp((parseInt(state.bosses.hitStocks.knuckle||0,10)||0) + 1, 0, 999999);
        rewardText = '1 –£–¥–∞—Ä –∫–æ—Å—Ç–µ—Ç–æ–º';
      } else if (face===4){
        if (!state.bosses.hitStocks) state.bosses.hitStocks = { kick:0, knuckle:0, enema:0 };
        state.bosses.hitStocks.enema = clamp((parseInt(state.bosses.hitStocks.enema||0,10)||0) + 1, 0, 999999);
        rewardText = '1 –ö–ª–∏–∑–º–∞';
      } else if (face===5){
        const r6 = bossReq(6);
        if (r6) bossKeyAdd(r6.itemKey, r6.need);
        rewardText = '–ö–æ–ª—å—Ü–æ –Ω–∞ –±–æ—Å—Å–∞ ¬´–ü–∞—É—á–∏—Ö–∞¬ª';
      } else if (face===6){
        const r8 = bossReq(8);
        if (r8) bossKeyAdd(r8.itemKey, r8.need);
        rewardText = '–ö–æ–ª—å—Ü–æ –Ω–∞ –±–æ—Å—Å–∞ ¬´–°–∞—Ä—É–º—è–Ω¬ª';
      } else {
        state.morin += 50;
      }
      if (was5x) rewardText = rewardText + ' +20 ü™ô';
    }

    try { $('diceRewardVal').textContent = rewardText; } catch (e) {}
    save();
    renderDice();
    showModal('mDiceReward');
    try { $('diceRewardOk').style.display = 'none'; } catch (e) {}
    try { if (diceRewardTmr) clearTimeout(diceRewardTmr); } catch (e) {}
    try { diceRewardTmr = setTimeout(()=>{ hideModal('mDiceReward'); }, 1000); } catch (e) {}
    haptic('medium');
  }

  function rollDice(){
    const g = state.diceGame;
    if (g && g.active) {
      diceClaim();
      return;
    }
    diceStart();
  }

  function renderAll(){
    renderHUD();
    renderFriends();
    if ($('mArena').classList.contains('show')) {
      renderArena();
      renderGym();
      renderArenaPetShop();
    }
    if ($('mDistricts').classList.contains('show')) renderDistricts();
    if ($('mBattle').classList.contains('show')) renderBattle();
    if ($('mShop').classList.contains('show')) renderShop();
    if ($('mBoss').classList.contains('show')) renderBosses();
    if ($('mBossFight').classList.contains('show')) {
      const id = parseInt(state.bosses.activeFightId||0,10)||0;
      if (id) bfRender(id);
    }
    if ($('mDice').classList.contains('show')) renderDice();
    if ($('mClans').classList.contains('show')) renderClans();
  }

  function renderClans(){
    const c = state.clan || { id:'', name:'', owner:'', createdTs:0 };
    const has = !!(c && c.id && c.name);
    try { $('clanStatus').textContent = has ? ('üè∞ ' + c.name) : '–ù–ï–¢'; } catch (e) {}
    try { $('clanDesc').textContent = has ? ('–°–æ–∑–¥–∞—Ç–µ–ª—å: ' + (c.owner||'‚Äî')) : '–°–æ–∑–¥–∞–π —Å–≤–æ–π –∫–ª–∞–Ω –∏ —Å–æ–±–∏—Ä–∞–π –±—Ä–∞—Ç–≤—É.'; } catch (e) {}
    const btn = $('clanCreate');
    if (btn){
      btn.style.display = has ? 'none' : '';
      btn.disabled = (state.gold||0) < 1000;
      btn.style.opacity = btn.disabled ? '.55' : '1';
    }
  }
  function clanCreate(){
    if (state.clan && state.clan.id){ toast('–¢—ã —É–∂–µ –≤ –∫–ª–∞–Ω–µ','lose'); return; }
    if ((state.gold||0) < 1000){ toast('–ù—É–∂–Ω–æ 1000 ü™ô','lose'); return; }
    const name = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –∫–ª–∞–Ω–∞:', '–ë—Ä–∞—Ç—Å—Ç–≤–æ');
    if (!name) return;
    const nm = String(name).trim().substring(0, 18);
    if (!nm){ toast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ','lose'); return; }
    state.gold -= 1000;
    const id = 'CL' + String(now()) + String(Math.floor(Math.random()*1000));
    state.clan = { id:id, name:nm, owner:(state.playerName||'PLAYER'), createdTs: now() };
    save();
    renderHUD();
    renderClans();
    toast('–ö–ª–∞–Ω —Å–æ–∑–¥–∞–Ω','win');
    haptic('medium');
  }

  function renderDistricts(){
    const box = $('districtList');
    if (!box) return;
    let html = '';
    const names = [
      '–®–∏—Ä—Å–∫–∏–π –∫—Ä–∞–π',
      '–ë—Ä–∏–π—Å–∫–∏–µ –∑–µ–º–ª–∏',
      '–†–∏–≤–µ–Ω–¥–µ–ª–ª',
      '–ú–æ—Ä–∏–π—Å–∫–∏–µ –∫–æ–ø–∏',
      '–õ–æ—Ç–ª–æ—Ä–∏—ç–Ω',
      '–ò–∑–µ–Ω–≥–∞—Ä–¥',
      '–†–æ—Ö–∞–Ω',
      '–ì–æ–Ω–¥–æ—Ä',
      '–û—Å–≥–∏–ª–∏–∞—Ç',
      '–ú–∏–Ω–∞—Å –ú–æ—Ä–≥—É–ª',
      '–ú–æ—Ä–¥–æ—Ä',
      '–ë–∞—Ä–∞–¥-–î—É—Ä'
    ];
    for (let i=1;i<=names.length;i++){
      const name = names[i-1];
      html += '<div class="card">'
        + '<div class="row"><div style="min-width:0">'
        + '<div class="k">'+name.toUpperCase()+'</div>'
        + '<div style="margin-top:6px; font-size:12px; opacity:.8; line-height:1.35">–°–∫–æ—Ä–æ</div>'
        + '</div>'
        + '<div class="badge" style="padding:8px 10px">'+(i<=4 ? '–õ–ï–ì–ö–û' : (i<=8 ? '–°–†–ï–î–ù–ï' : '–ñ–ï–°–¢–ö–û'))+'</div>'
        + '</div>'
        + '</div>';
    }
    box.innerHTML = html;
  }

  // --- Energy regen (1 energy per 2 min until max)
  const ENERGY_REGEN_MIN = 2;
  function tickEnergy(){
    const ts = parseInt(state.lastEnergyTs||0,10) || now();
    const diff = Math.max(0, now() - ts);
    const per = ENERGY_REGEN_MIN*60*1000;
    if ((state.energy||0) >= state.energyMax){
      state.lastEnergyTs = now();
      return;
    }
    const add = Math.floor(diff / per);
    if (add>0){
      state.energy = clamp((state.energy||0)+add, 0, state.energyMax);
      state.lastEnergyTs = ts + add*per;
    }
  }
  function energyTimerText(){
    if ((state.energy||0) >= state.energyMax) return 'MAX';
    const ts = parseInt(state.lastEnergyTs||0,10) || now();
    const per = ENERGY_REGEN_MIN*60*1000;
    const next = ts + per;
    return fmtMMSS(Math.max(0, next - now()));
  }

  // strikes regen
  function tickStrikes(){
    state.bosses.strikes = clamp(parseInt(state.bosses.strikes||0,10)||0, 0, 99);
    // regen 1 strike per 6 minutes up to 10
    if (!state.bosses.lastStrikeTs) state.bosses.lastStrikeTs = now();
    const per = 6*60*1000;
    const diff = Math.max(0, now() - (parseInt(state.bosses.lastStrikeTs||0,10)||now()));
    if ((state.bosses.strikes||0) >= 10){
      state.bosses.lastStrikeTs = now();
      return;
    }
    const add = Math.floor(diff/per);
    if (add>0){
      state.bosses.strikes = clamp((state.bosses.strikes||0)+add, 0, 10);
      state.bosses.lastStrikeTs = (parseInt(state.bosses.lastStrikeTs||0,10)||now()) + add*per;
    }
  }

  // group battle timer
  function tickBattle(){
    const b = state.groupFight && state.groupFight.battle;
    if (!b) return;
    const aliveEnemies = Array.isArray(b.targets) ? b.targets.some(x=>(parseInt(x.hp||0,10)||0) > 0) : false;
    if (!aliveEnemies) return;

    b.turnLeft = Math.max(0, (parseInt(b.turnLeft||0,10)||0) - 1);
    if (b.turnLeft>0) return;

    // end of turn
    if (!b.acted) battleAutoHit();

    // check win after player/auto hit
    const aliveAfter = Array.isArray(b.targets) ? b.targets.some(x=>(parseInt(x.hp||0,10)||0) > 0) : false;
    if (!aliveAfter){
      b.log.unshift({ kind:'SYS', text:'–ü–æ–±–µ–¥–∞ –∫–æ–º–∞–Ω–¥—ã! –ù–∞–≥—Ä–∞–¥–∞: +10 ü¶∑, +10 ü™ô' });
      state.groupFight.pendingReward = { morin:10, gold:10 };
      state.groupFight.joined = false;
      state.groupFight.startTs = 0;
      state.groupFight.resolvedTs = now();
      feedAdd('–ü–æ–±–µ–¥–∞ –≤ –≥—Ä—É–ø–ø–æ–≤–æ–º –±–æ—é!','GF');
      toast('–ü–û–ë–ï–î–ê','win');
      haptic('heavy');
      save();
      renderAll();
      gfShowBattleResult(true);
      return;
    }

    battleEnemyTurn();
    if ((parseInt(b.myHp||0,10)||0) <= 0) return;

    // next round
    b.round = (parseInt(b.round||1,10)||1) + 1;
    b.turnLeft = 10;
    b.acted = false;
    b.log.unshift({ kind:'SYS', text:'–ù–æ–≤—ã–π —Ö–æ–¥: ' + b.round });
  }

  // --- Events
  function bindUI(){
    document.querySelectorAll('[data-close]').forEach(b=>{
      b.onclick = ()=>hideModal(b.getAttribute('data-close'));
    });

    $('overlay').onclick = ()=>hideTop();

    $('settingsBtn').onclick = ()=>{ showModal('mSettings'); renderAll(); haptic('light'); };
    $('shopBtn').onclick = ()=>{ showModal('mShop'); renderShop(); haptic('light'); };
    $('btnDistricts').onclick = ()=>{ openScreen('mDistricts'); renderAll(); haptic('light'); };
    $('btnArena').onclick = ()=>{
      if (isGroupBattleActive()) {
        gfEnsureBattle();
        openScreen('mBattle');
        renderBattle();
      } else {
        openScreen('mArena');
        renderAll();
      }
      haptic('light');
    };
    $('btnBoss').onclick = ()=>{
      const bid = parseInt(state.bosses && state.bosses.activeFightId || 0, 10) || 0;
      const f = bid ? bfGetFight(bid) : null;
      const alive = f && (parseInt(f.hp||0,10)||0) > 0;
      const inTime = f && (parseInt(f.expiresTs||0,10)||0) > now();
      if (bid && f && alive && inTime){
        showModal('mBossFight');
        bfEnsureFight(bid);
        bfRender(bid);
        haptic('light');
        return;
      }
      openScreen('mBoss');
      renderBosses();
      haptic('light');
    };
    $('btnTop').onclick = ()=>{ openScreen('mTop'); renderTop100('LVL'); haptic('light'); };
    $('btnDice').onclick = ()=>{ openScreen('mDice'); renderDice(); haptic('light'); };
    $('btnClans').onclick = ()=>{ openScreen('mClans'); renderClans(); haptic('light'); };

    try {
      const cc = $('clanCreate');
      if (cc) cc.onclick = ()=>clanCreate();
    } catch (e) {}

    try {
      const tl = $('top100Lvl');
      const tw = $('top100Wealth');
      const tb = $('top100Boss');
      if (tl) tl.onclick = ()=>{ renderTop100('LVL'); haptic('light'); };
      if (tw) tw.onclick = ()=>{ renderTop100('WEALTH'); haptic('light'); };
      if (tb) tb.onclick = ()=>{ renderTop100('BOSS'); haptic('light'); };
    } catch (e) {}

    try {
      $('bfShopOpen').onclick = ()=>{
        const bid = parseInt(state.bosses && state.bosses.activeFightId || 0, 10) || 0;
        if (!bid) return;
        showModal('mBfShop');
        bfShopRender();
        haptic('light');
      };
    } catch (e) {}

    $('arenaWeak').onclick = ()=>tryArenaFight('WEAK');
    $('arenaNorm').onclick = ()=>tryArenaFight('NORMAL');
    $('arenaElite').onclick = ()=>tryArenaFight('ELITE');

    try {
      const ac = $('arenaConsOpen');
      if (ac) ac.onclick = ()=>consOpen('arena');
    } catch (e) {}
    try {
      const bc = $('battleConsOpen');
      if (bc) bc.onclick = ()=>consOpen('battle');
    } catch (e) {}

    $('gfEnter').onclick = ()=>{ gfEnterBattle(); };
    $('gf1010Open').onclick = ()=>{
      if (isGroupBattleActive()) {
        gfEnterBattle();
        haptic('light');
        return;
      }
      showModal('mGFJoin');
      renderGFJoinMini();
      haptic('light');
    };
    $('gfJoinBtn').onclick = ()=>{ gfJoin(); renderGroupFightUI(); renderGFJoinMini(); };
    $('gf10Join').onclick = ()=>{ gf1010Join(); };
    $('gf10Leave').onclick = ()=>{ gf1010Leave(); };

    try {
      const leave = $('bLeave');
      if (leave) {
        leave.onclick = ()=>{
          if (!confirm('–ü–æ–∫–∏–Ω—É—Ç—å –±–æ–π? –ï—Å–ª–∏ —É–π–¥—ë—à—å ‚Äî –Ω–∞–≥—Ä–∞–¥—É –Ω–µ –ø–æ–ª—É—á–∏—à—å.')) return;
          state.groupFight.joined = false;
          state.groupFight.startTs = 0;
          state.groupFight.resolvedTs = 0;
          state.groupFight.battle = null;
          save();
          hideModal('mBattle');
          renderAll();
        };
      }
    } catch (e) {}

    $('diceRoll').onclick = ()=>rollDice();
    $('diceRewardOk').onclick = ()=>hideModal('mDiceReward');

    const bsk = $('bfShopBuyKick');
    if (bsk) bsk.onclick = ()=>bfShopBuy('kick', 3);
    const bsn = $('bfShopBuyKnuckle');
    if (bsn) bsn.onclick = ()=>bfShopBuy('knuckle', 5);
    const bse = $('bfShopBuyEnema');
    if (bse) bse.onclick = ()=>bfShopBuy('enema', 8);

    $('nameBtn').onclick = ()=>{
      const n = prompt('–ò–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞:', state.playerName || 'PLAYER');
      if (!n) return;
      state.playerName = String(n).trim().substring(0, 14) || 'PLAYER';
      save();
      renderAll();
      haptic('light');
    };

    $('inviteBtn').onclick = ()=>{
      try {
        const url = location.href;
        const text = '–°—ã–≥—Ä–∞–π —Å–æ –º–Ω–æ–π –≤ ¬´–ë—Ä–∞—Ç—Å—Ç–≤–æ –ö–æ–Ω—Ü–∞¬ª –≤ Telegram!';
        const share = 'https://t.me/share/url?url=' + encodeURIComponent(url) + '&text=' + encodeURIComponent(text);
        if (tg && tg.openTelegramLink) tg.openTelegramLink(share);
        else if (tg && tg.openLink) tg.openLink(share);
        else window.open(share, '_blank');
        toast('–û—Ç–∫—Ä—ã–≤–∞—é –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ‚Ä¶','gold');
      } catch (e) {
        toast('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ','lose');
      }
    };

    $('setSound').onchange = (e)=>{ state.settings.sound = !!e.target.checked; save(); };
    $('setHaptics').onchange = (e)=>{ state.settings.haptics = !!e.target.checked; save(); };
    $('setReduced').onchange = (e)=>{
      state.settings.reduced = !!e.target.checked;
      document.body.style.transition = state.settings.reduced ? 'none' : '';
      save();
    };

    $('resetBtn').onclick = ()=>{
      if (!confirm('–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å?')) return;
      hardReset();
    };
  }

  function renderTop100(kind){
    const box = $('top100List');
    if (!box) return;
    const me = state.playerName || 'PLAYER';
    const lvl = parseInt(state.level||1,10)||1;
    const stats = GYM_STATS.reduce((a,s)=>a + (parseInt(state.gym && state.gym[s.key] || 1,10) || 1), 0);
    const bossesWins = 0;

    const rows = [];
    for (let i=1;i<=99;i++){
      rows.push({
        name: '–ò–≥—Ä–æ–∫ ' + i,
        lvl: 1 + Math.floor(Math.random()*60),
        stats: 7 + Math.floor(Math.random()*900),
        boss: Math.floor(Math.random()*60)
      });
    }
    rows.push({ name: me+' (—Ç—ã)', lvl, stats, boss: bossesWins });

    let sorted = rows;
    if (kind==='LVL') sorted = rows.slice().sort((a,b)=>b.lvl-a.lvl);
    if (kind==='WEALTH') sorted = rows.slice().sort((a,b)=>b.stats-a.stats);
    if (kind==='BOSS') sorted = rows.slice().sort((a,b)=>b.boss-a.boss);
    sorted = sorted.slice(0,100);

    box.innerHTML = sorted.map((r,idx)=>{
      const medal = idx===0 ? 'ü•á' : (idx===1 ? 'ü•à' : (idx===2 ? 'ü•â' : ''));
      const mStyle = idx===0 ? 'color:var(--gold);' : (idx===1 ? 'color:rgba(226,232,240,.95);' : (idx===2 ? 'color:rgba(251,146,60,.95);' : ''));
      const v = (kind==='LVL') ? ('–£–†. '+r.lvl) : (kind==='WEALTH' ? (String(r.stats)) : (String(r.boss)));
      const left = medal ? ('<div class="badge" style="padding:6px 8px; font-size:11px; '+mStyle+'">'+medal+'</div>') : '';
      return '<div class="row">'
        + '<div style="display:flex; align-items:center; gap:8px; min-width:0; flex:1">'
        + left
        + '<div style="min-width:0; font-size:12px; opacity:.9">#'+(idx+1)+' '+r.name+'</div>'
        + '</div>'
        + '<div class="badge" style="padding:6px 8px; font-size:11px">'+v+'</div>'
        + '</div>';
    }).join('');
  }

  // --- Clock
  function tickUTC(){
    const d = new Date();
    $('utc').textContent = 'UTC: ' + pad2(d.getUTCHours()) + ':' + pad2(d.getUTCMinutes()) + ':' + pad2(d.getUTCSeconds());
  }

  // --- Theme
  function applyTgTheme(){
    try {
      if (!tg || !tg.themeParams) return;
      const tp = tg.themeParams;
      const root = document.documentElement;
      if (tp.button_color) root.style.setProperty('--accent', String(tp.button_color));
      if (tp.link_color) root.style.setProperty('--accent2', String(tp.link_color));
      if (tp.button_text_color) root.style.setProperty('--text', String(tp.button_text_color));
    } catch (e) {}
  }
  applyTgTheme();
  try { if (tg && typeof tg.onEvent==='function') tg.onEvent('themeChanged', applyTgTheme); } catch (e) {}

  // --- Boot
  function init(){
    // seed starting items
    firstRunSeed();

    $('setSound').checked = !!state.settings.sound;
    $('setHaptics').checked = !!state.settings.haptics;
    $('setReduced').checked = !!state.settings.reduced;

    bindUI();
    renderAll();
    save();

    // main loop
    tickUTC();
    setInterval(()=>{
      tickUTC();
      tickEnergy();
      tickStrikes();
      tickBattle();
      tickGF1010();

      const bid = parseInt(state.bosses && state.bosses.activeFightId || 0, 10) || 0;
      if (bid){
        bfEnsureFight(bid);
        bfFriendTick(bid);
        try {
          const f2 = bfGetFight(bid);
          if (f2 && (parseInt(f2.hp||0,10)||0) <= 0) {
            bfCheckWin(bid);
          } else {
            if ($('mBossFight').classList.contains('show') || $('mBfShop').classList.contains('show')) bfRender(bid);
          }
        } catch (e) {
          if ($('mBossFight').classList.contains('show') || $('mBfShop').classList.contains('show')) bfRender(bid);
        }
      }

      // auto-open group fight battle when start time comes (popup over arena)
      try {
        const st = parseInt(state.groupFight && state.groupFight.startTs || 0, 10) || 0;
        const joined = !!(state.groupFight && state.groupFight.joined);
        if (joined && st && now() >= st) {
          const b = gfEnsureBattle();
          if (b && $('mArena').classList.contains('show')) {
            if ((parseInt(state.groupFight.autoShownStartTs||0,10)||0) !== st) {
              state.groupFight.autoShownStartTs = st;
              showModal('mBattle');
              renderBattle();
              toast('–ì—Ä—É–ø–ø–æ–≤–æ–π –±–æ–π –Ω–∞—á–∞–ª—Å—è','gold');
              haptic('light');
            }
          }
        }
      } catch (e) {}

      $('energyTimer').textContent = energyTimerText();

      if ($('mArena').classList.contains('show')) {
        renderArena();
        renderGym();
        renderArenaPetShop();
      }
      if ($('mBoss').classList.contains('show')) renderBosses();
      if ($('mBattle').classList.contains('show')) renderBattle();
      if ($('mGF1010').classList.contains('show')) gf1010Render();
      if ($('mGFJoin').classList.contains('show')) renderGFJoinMini();

      renderHUD();
      save();
    }, 1000);

    // save on hide
    document.addEventListener('visibilitychange', ()=>{ if (document.hidden) save(); });
    window.addEventListener('pagehide', save);

    updateBackButton();
  }

  init();
})();
</script>
</body>
</html>
